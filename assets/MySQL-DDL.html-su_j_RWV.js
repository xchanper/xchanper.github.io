import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as o,d as i,a as l,f as e,e as p,w as r,r as D,o as s}from"./app-CN1e8mfj.js";const L="/assets/mysql-ddl-copy-CpwtlNND.svg",c="/assets/mysql-ddl-view-DKn8L4qL.webp",d={};function y(m,t){const n=D("RouteLink");return s(),o("div",null,[i("p",null,[t[1]||(t[1]=e("本篇文章主要是由于近期组内线上的 MySQL 变更，导致主从延迟，产生业务问题，而引发的思考，重新复习了一下 ",-1)),p(n,{to:"/coding/MySQL-Lock.html"},{default:r(()=>[...t[0]||(t[0]=[e("MySQL 锁机制",-1)])]),_:1}),t[2]||(t[2]=e("，以及主从延迟和 DDL 语句的执行方式。",-1))]),t[3]||(t[3]=l('<h2 id="ddl-执行原理" tabindex="-1"><a class="header-anchor" href="#ddl-执行原理"><span>DDL 执行原理</span></a></h2><h3 id="copy" tabindex="-1"><a class="header-anchor" href="#copy"><span>Copy</span></a></h3><p>在MySQL 5.6.7 版本之前，DDL 操作采用 Copy 方式执行:</p><ol><li>创建新的临时表，复制原表结构，并执行 DDL 语句（如新增表字段、索引）</li><li>把原表中数据导入到临时表</li><li>删除原表</li><li>最后重命名临时表为原表名</li></ol><p><img src="'+L+'" alt="Copy 方式"></p><p>COPY 操作由 Server 层实现，当采用 COPY 模式时，一旦 DDL 操作开始，原表仅能进行只读操作，其它 DML 会被堵塞。并且，在清理旧表结构和表定义缓存时还会阻塞只读操作。可以看出，5.6.7 之前的 MySQL 增添索引、增删字段都会加元数据排他锁，阻塞表的写操作。</p><h3 id="online-ddl-in-place" tabindex="-1"><a class="header-anchor" href="#online-ddl-in-place"><span>Online DDL - In Place</span></a></h3><p>MySQL 在 5.6.7 至 8.0.12 版本之间，使用 In Place 代替了 Copy 方式，减少了对业务的影响。In Place 主要是通过临时文件重建原表：</p><ol><li>新建临时文件，.frm和.ibd，临时文件的表结构包含新增的列</li><li>扫描原表的所有数据页，基于原表生成新的 B+树结构，存储到临时文件中</li><li>在重建临时文件时，原表DML 语句会记录到 日志文件中（row log）</li><li>原表数据全部重建完成后，将日志文件（row log）应用到临时文件中。此时该日志文件相比原表增加了一列</li><li>使用临时文件替换原表的数据文件和表结构文件</li></ol><p>In Place 操作位于 InnoDB 引擎层，执行会申请 MDL 共享锁，阻止其它 DDL 语句，但不阻止 DML 语句，原表可并发写入数据。但在最后提交阶段，会短暂申请 MDL 排他锁，阻止 DML 语句。</p><p>In Place 存在的问题：</p><ol><li>主从延迟：长时间运行的 DDL 操作可能会导致主从复制滞后。DDL 操作必须在主服务器上完成，然后才能在从服务器上执行。此外，主服务器上并发处理的 DML 仅在从服务器上的 DDL 操作完成后才会在从服务器上处理。</li><li>无法对 DDL 限速</li><li>DDL 期间如果出现唯一键冲突，会导致 DDL 失败</li></ol><h3 id="online-ddl-instant" tabindex="-1"><a class="header-anchor" href="#online-ddl-instant"><span>Online DDL - Instant</span></a></h3><p>MySQL 8.0.12 版本提供了 Instant 方式执行 DDL，并且在 8.0.29 得到了进一步的完善。Instant方式只需修改数据字典中的元数据，无需拷贝数据也无需重建整表，整个DDL过程几乎是瞬间完成的，也不会阻塞DML，解决了上述 In Place 存在的问题。（由腾讯游戏 DBA 团队贡献的特性）</p><p>需要注意的是，并不是所有 DDL 语句都支持 Instant 方式，Instant 的实现是基于 MySQL 8.0 引入的数据字典实现的。一个原子DDL语句将与DDL操作相关的数据字典更新、存储引擎操作和二进制日志写入组合成一个单独的原子操作。该操作要么提交，将更改持久保存到数据字典、存储引擎和二进制日志中；要么回滚，即使在操作过程中服务器停机。</p><p><img src="'+c+'" alt="MySQL DDL 方式演进"></p>',16))])}const g=a(d,[["render",y]]),S=JSON.parse('{"path":"/coding/MySQL-DDL.html","title":"MySQL DDL 执行方式","lang":"zh-CN","frontmatter":{"title":"MySQL DDL 执行方式","date":"2025-05-25T00:00:00.000Z","category":["数据库"],"tag":["MySQL"],"description":"本篇文章主要是由于近期组内线上的 MySQL 变更，导致主从延迟，产生业务问题，而引发的思考，重新复习了一下 ，以及主从延迟和 DDL 语句的执行方式。 DDL 执行原理 Copy 在MySQL 5.6.7 版本之前，DDL 操作采用 Copy 方式执行: 创建新的临时表，复制原表结构，并执行 DDL 语句（如新增表字段、索引） 把原表中数据导入到临时...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MySQL DDL 执行方式\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-05-25T00:00:00.000Z\\",\\"dateModified\\":\\"2026-01-11T09:16:05.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://xchanper.github.io/coding/MySQL-DDL.html"}],["meta",{"property":"og:site_name","content":"chanper"}],["meta",{"property":"og:title","content":"MySQL DDL 执行方式"}],["meta",{"property":"og:description","content":"本篇文章主要是由于近期组内线上的 MySQL 变更，导致主从延迟，产生业务问题，而引发的思考，重新复习了一下 ，以及主从延迟和 DDL 语句的执行方式。 DDL 执行原理 Copy 在MySQL 5.6.7 版本之前，DDL 操作采用 Copy 方式执行: 创建新的临时表，复制原表结构，并执行 DDL 语句（如新增表字段、索引） 把原表中数据导入到临时..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-11T09:16:05.000Z"}],["meta",{"property":"article:tag","content":"MySQL"}],["meta",{"property":"article:published_time","content":"2025-05-25T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2026-01-11T09:16:05.000Z"}]]},"git":{"createdTime":1768122965000,"updatedTime":1768122965000,"contributors":[{"name":"chanper","username":"chanper","email":"qianchaosolo@gmail.com","commits":1,"url":"https://github.com/chanper"}]},"filePathRelative":"coding/MySQL-DDL.md","autoDesc":true}');export{g as comp,S as data};

<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.96" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"é¢è¯•å…«è‚¡","image":["https://xchanper.github.io/img/HTTP%E6%BC%94%E8%BF%9B.webp#id=D7LAB&originHeight=366&originWidth=782&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png#id=N9ti5&originHeight=1081&originWidth=1296&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png#id=kVjem&originHeight=794&originWidth=753&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/DNS%E6%9F%A5%E8%AF%A2.webp#id=l92M7&originHeight=1095&originWidth=1505&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%86%AF%E8%AF%BA%E4%BE%9D%E6%9B%BC%E6%A8%A1%E5%9E%8B.webp#id=Rdt00&originHeight=271&originWidth=613&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.webp#id=puypr&originHeight=854&originWidth=962&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%86%85%E5%AD%98%E5%88%86%E6%AE%B5.webp#id=Ed6yQ&originHeight=1004&originWidth=1382&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%86%85%E5%AD%98%E5%88%86%E9%A1%B5.webp#id=zADBN&originHeight=561&originWidth=935&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E6%AE%B5%E9%A1%B5%E5%BC%8F%E5%86%85%E5%AD%98.webp#id=pGugH&originHeight=699&originWidth=1452&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/32%E4%BD%8D%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.webp#id=cOAL8&originHeight=976&originWidth=1210&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81.webp#id=gi9T3&originHeight=722&originWidth=1166&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E7%9B%AE%E5%BD%95%E9%A1%B9%E5%92%8C%E7%B4%A2%E5%BC%95%E5%85%B3%E7%B3%BB%E5%9B%BE.webp#id=mkdtI&originHeight=842&originWidth=1172&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.webp#id=N5wFA&originHeight=1262&originWidth=962&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/I_O%E8%BD%AF%E4%BB%B6%E5%88%86%E5%B1%82.webp#id=aTZtk&originHeight=842&originWidth=500&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%8D%95Reactor%E5%8D%95%E8%BF%9B%E7%A8%8B.webp#id=Xhd2m&originHeight=834&originWidth=1427&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%8D%95Reactor%E5%A4%9A%E7%BA%BF%E7%A8%8B.webp#id=cxi30&originHeight=1277&originWidth=1514&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E4%B8%BB%E4%BB%8EReactor%E5%A4%9A%E7%BA%BF%E7%A8%8B.webp#id=ZGkWX&originHeight=1262&originWidth=1772&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/Proactor.webp#id=sbg1q&originHeight=654&originWidth=1427&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C.webp#id=oVxf2&originHeight=560&originWidth=587&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/Executor%E6%A1%86%E6%9E%B6.png#id=GBk0x&originHeight=380&originWidth=561&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/ThreadLocal%E7%BB%93%E6%9E%84.png#id=s38Y5&originHeight=794&originWidth=1072&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/CLH%E9%98%9F%E5%88%97.png#id=ixnaN&originHeight=304&originWidth=1181&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/MySQL%E6%9E%B6%E6%9E%84.webp#id=DyVTi&originHeight=1440&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4.webp#id=AzFfx&originHeight=1131&originWidth=1440&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.webp#id=PE5BI&originHeight=856&originWidth=1142&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.jpg#id=JyJIF&originHeight=303&originWidth=720&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.webp#id=vQ1zV&originHeight=619&originWidth=1440&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/RabbitMQ%E6%A8%A1%E5%9E%8B.jpg#id=q62UK&originHeight=306&originWidth=687&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=","https://xchanper.github.io/img/SSO.png#id=IasZY&originHeight=931&originWidth=737&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="],"datePublished":"2023-03-10T00:00:00.000Z","dateModified":"2026-01-11T09:16:05.000Z","author":[]}</script><meta property="og:url" content="https://xchanper.github.io/coding/interview-java.html"><meta property="og:site_name" content="chanper"><meta property="og:title" content="é¢è¯•å…«è‚¡"><meta property="og:description" content="å®ä¹  -- ç›®çš„åœ°æœç´¢ä¼˜åŒ– ä»¥å‰ç”¨æˆ·åœ¨æœç´¢æœºåœºæ•°æ®æ—¶ï¼Œåªä¼šå±•ç¤ºå¯¹åº”çš„åŸå¸‚æœºåœºä¿¡æ¯ï¼Œæ–°çš„éœ€æ±‚æ˜¯ç”¨æˆ·åœ¨æœç´¢æŸä¸ªæ™¯ç‚¹ä¿¡æ¯æ—¶ï¼Œå±•ç¤ºå¯¹åº”åŸå¸‚çš„æœºåœºä¿¡æ¯ã€‚å¦å¤–ä¼˜åŒ–äº†ä¸¤ä¸ªé—®é¢˜ï¼š é‚»è¿‘æœºåœºè·ç¦»ç”±æœºåœº-é‚»è¿‘åŸå¸‚ -> æœºåœº-é‚»è¿‘æœºåœºï¼šå¢åŠ near_airport_distanceçš„jsonæ ¼å¼ä¸² åŒéŸ³ä¸åŒå­—çš„åŸå¸‚æœºåœºæœç´¢ï¼šcityPinyin -> æœºåœº çš„ Map åˆ‡..."><meta property="og:type" content="article"><meta property="og:image" content="https://xchanper.github.io/img/HTTP%E6%BC%94%E8%BF%9B.webp#id=D7LAB&originHeight=366&originWidth=782&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-01-11T09:16:05.000Z"><meta property="article:tag" content="é¢è¯•"><meta property="article:published_time" content="2023-03-10T00:00:00.000Z"><meta property="article:modified_time" content="2026-01-11T09:16:05.000Z"><script type="text/javascript" src="//js.users.51.la/21843597.js"></script><script src="https://www.googletagmanager.com/gtag/js?id=G-MXLC6EJHG0"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){ dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-MXLC6EJHG0');
            </script><link rel="icon" href="/assets/favicon.ico"><title>é¢è¯•å…«è‚¡ | chanper</title><meta name="description" content="å®ä¹  -- ç›®çš„åœ°æœç´¢ä¼˜åŒ– ä»¥å‰ç”¨æˆ·åœ¨æœç´¢æœºåœºæ•°æ®æ—¶ï¼Œåªä¼šå±•ç¤ºå¯¹åº”çš„åŸå¸‚æœºåœºä¿¡æ¯ï¼Œæ–°çš„éœ€æ±‚æ˜¯ç”¨æˆ·åœ¨æœç´¢æŸä¸ªæ™¯ç‚¹ä¿¡æ¯æ—¶ï¼Œå±•ç¤ºå¯¹åº”åŸå¸‚çš„æœºåœºä¿¡æ¯ã€‚å¦å¤–ä¼˜åŒ–äº†ä¸¤ä¸ªé—®é¢˜ï¼š é‚»è¿‘æœºåœºè·ç¦»ç”±æœºåœº-é‚»è¿‘åŸå¸‚ -> æœºåœº-é‚»è¿‘æœºåœºï¼šå¢åŠ near_airport_distanceçš„jsonæ ¼å¼ä¸² åŒéŸ³ä¸åŒå­—çš„åŸå¸‚æœºåœºæœç´¢ï¼šcityPinyin -> æœºåœº çš„ Map åˆ‡...">
    <link rel="preload" href="/assets/style-CRt3joe8.css" as="style"><link rel="stylesheet" href="/assets/style-CRt3joe8.css">
    <link rel="modulepreload" href="/assets/app-CN1e8mfj.js"><link rel="modulepreload" href="/assets/interview-java.html-CC9v6yHP.js"><link rel="modulepreload" href="/assets/Executoræ¡†æ¶-BNad5lzh.js"><link rel="modulepreload" href="/assets/SSO-JHFvDKUB.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-BmPvoMbW.js" as="script"><link rel="prefetch" href="/assets/intro.html-27oR49U9.js" as="script"><link rel="prefetch" href="/assets/AQS.html-BdRPKp7R.js" as="script"><link rel="prefetch" href="/assets/Authorization.html-8n3Wwp5s.js" as="script"><link rel="prefetch" href="/assets/Elasticsearch.html-B4-XAhWG.js" as="script"><link rel="prefetch" href="/assets/Guava.html-dKCx7Bmj.js" as="script"><link rel="prefetch" href="/assets/Guide-RPC.html-C7eSYbvX.js" as="script"><link rel="prefetch" href="/assets/Hive-SQL.html-CBEbsC0v.js" as="script"><link rel="prefetch" href="/assets/JUC.html-DcxQsXt9.js" as="script"><link rel="prefetch" href="/assets/JVM-GC.html-Mj38p8-g.js" as="script"><link rel="prefetch" href="/assets/JVM-reference-type.html-Balw31Mg.js" as="script"><link rel="prefetch" href="/assets/JVM-runtime-memory.html-CSjoETyh.js" as="script"><link rel="prefetch" href="/assets/JVM.html-DWZNuORZ.js" as="script"><link rel="prefetch" href="/assets/Java_base.html-DrR-VXJo.js" as="script"><link rel="prefetch" href="/assets/LockSupport.html-BVZUi_hF.js" as="script"><link rel="prefetch" href="/assets/Logging.html-Cyj4C9fX.js" as="script"><link rel="prefetch" href="/assets/MQ_Abstract.html-8VWOKfiY.js" as="script"><link rel="prefetch" href="/assets/MQ_Kafka.html-D7Kvbo82.js" as="script"><link rel="prefetch" href="/assets/MyBatis.html-5o8cQqrU.js" as="script"><link rel="prefetch" href="/assets/MySQL-DDL.html-su_j_RWV.js" as="script"><link rel="prefetch" href="/assets/MySQL-Lock.html-CrWQCG_o.js" as="script"><link rel="prefetch" href="/assets/MySQL01.html-BUaxKQhJ.js" as="script"><link rel="prefetch" href="/assets/MySQL02.html-Bn6PMR49.js" as="script"><link rel="prefetch" href="/assets/NIO.html-CZd-DKTl.js" as="script"><link rel="prefetch" href="/assets/Netty01.html-Ba28vv9c.js" as="script"><link rel="prefetch" href="/assets/Netty02.html-CNKOtx4e.js" as="script"><link rel="prefetch" href="/assets/index.html-Be18E0QA.js" as="script"><link rel="prefetch" href="/assets/Redis01.html-AHBb09LK.js" as="script"><link rel="prefetch" href="/assets/Redis02.html-CEVriksw.js" as="script"><link rel="prefetch" href="/assets/Redis03.html-CyHXmtDp.js" as="script"><link rel="prefetch" href="/assets/Redis04.html-Bp5w9fs2.js" as="script"><link rel="prefetch" href="/assets/Shred_Algorithm.html-BlSY5EHe.js" as="script"><link rel="prefetch" href="/assets/SmallSpring.html-BodnO6Bg.js" as="script"><link rel="prefetch" href="/assets/SpringTransaction.html-Bl35AREM.js" as="script"><link rel="prefetch" href="/assets/Synchronized.html-D1Uh2Eox.js" as="script"><link rel="prefetch" href="/assets/Thread.html-DJm4zCb2.js" as="script"><link rel="prefetch" href="/assets/ThreadPoolExecutor.html-BCDkPRmW.js" as="script"><link rel="prefetch" href="/assets/Thrift.html-7HtISXTV.js" as="script"><link rel="prefetch" href="/assets/Unsafe.html-CQOeLmRq.js" as="script"><link rel="prefetch" href="/assets/Windows-WSL-MySQL.html-BMPX-i8-.js" as="script"><link rel="prefetch" href="/assets/Zookeeper.html-B4LHaz01.js" as="script"><link rel="prefetch" href="/assets/bigdata-hadoop.html-DgBcaXVR.js" as="script"><link rel="prefetch" href="/assets/cache-migration.html-CEAntTRZ.js" as="script"><link rel="prefetch" href="/assets/code-review.html-CEu90Kru.js" as="script"><link rel="prefetch" href="/assets/ddd.html-CpnadELy.js" as="script"><link rel="prefetch" href="/assets/distributed-cache.html-DfHeCFFR.js" as="script"><link rel="prefetch" href="/assets/distributed-transaction.html-BqwkkGg9.js" as="script"><link rel="prefetch" href="/assets/gateway.html-CJAV5SP8.js" as="script"><link rel="prefetch" href="/assets/git-pro.html-BEY_k5D2.js" as="script"><link rel="prefetch" href="/assets/java-stream.html-D8f-aaFr.js" as="script"><link rel="prefetch" href="/assets/java-threadlocal.html-BrT6jBTM.js" as="script"><link rel="prefetch" href="/assets/leetcode-bitcalc.html-Cm52hdvW.js" as="script"><link rel="prefetch" href="/assets/leetcode-permutation.html-BIyN2Qji.js" as="script"><link rel="prefetch" href="/assets/linux-cmd.html-Bpe27oo4.js" as="script"><link rel="prefetch" href="/assets/mock-test.html-Bb5smL4l.js" as="script"><link rel="prefetch" href="/assets/AirBiz.html-BZjKSY6Y.js" as="script"><link rel="prefetch" href="/assets/index.html-B4KIeZvU.js" as="script"><link rel="prefetch" href="/assets/arabs-history.html-Ca48KuvG.js" as="script"><link rel="prefetch" href="/assets/beijing-intern.html-DNBVwZJO.js" as="script"><link rel="prefetch" href="/assets/blog-actions.html-DqVviibn.js" as="script"><link rel="prefetch" href="/assets/cycling.html-UKMN0uJ6.js" as="script"><link rel="prefetch" href="/assets/first-camera.html-Cvlmk1z4.js" as="script"><link rel="prefetch" href="/assets/movie-guide.html-Bz7ExgyN.js" as="script"><link rel="prefetch" href="/assets/summary_2023.html-BnR5iYmP.js" as="script"><link rel="prefetch" href="/assets/summary_2024.html-Bxk9K1xi.js" as="script"><link rel="prefetch" href="/assets/travel-tibet.html-DKmt8KpS.js" as="script"><link rel="prefetch" href="/assets/webrtc-study.html-czUKRnDk.js" as="script"><link rel="prefetch" href="/assets/windows-dash.html-Cm1fuC68.js" as="script"><link rel="prefetch" href="/assets/youtube-dl-ffmpeg.html-NTUGLuak.js" as="script"><link rel="prefetch" href="/assets/404.html-Ch_ZDWMd.js" as="script"><link rel="prefetch" href="/assets/index.html-DEZtHevL.js" as="script"><link rel="prefetch" href="/assets/index.html-DSsix5XN.js" as="script"><link rel="prefetch" href="/assets/index.html-BJdyjURo.js" as="script"><link rel="prefetch" href="/assets/index.html-DU6-2_Z9.js" as="script"><link rel="prefetch" href="/assets/index.html-BObuwQO5.js" as="script"><link rel="prefetch" href="/assets/index.html-DlSW0shp.js" as="script"><link rel="prefetch" href="/assets/index.html-CGbS1IB3.js" as="script"><link rel="prefetch" href="/assets/index.html-BhX6d3KI.js" as="script"><link rel="prefetch" href="/assets/index.html-Dxior03t.js" as="script"><link rel="prefetch" href="/assets/index.html-DGdfrg_L.js" as="script"><link rel="prefetch" href="/assets/index.html-mD5pX2ZQ.js" as="script"><link rel="prefetch" href="/assets/index.html-BBLjkXYO.js" as="script"><link rel="prefetch" href="/assets/index.html-CK3tFXHf.js" as="script"><link rel="prefetch" href="/assets/index.html-HJHyB42B.js" as="script"><link rel="prefetch" href="/assets/index.html-Pw9AiiPM.js" as="script"><link rel="prefetch" href="/assets/index.html-DkUdoB1S.js" as="script"><link rel="prefetch" href="/assets/index.html-CQQEa9N1.js" as="script"><link rel="prefetch" href="/assets/index.html-BSBbUb_s.js" as="script"><link rel="prefetch" href="/assets/index.html-BjmV72av.js" as="script"><link rel="prefetch" href="/assets/index.html-RvUXq-7N.js" as="script"><link rel="prefetch" href="/assets/index.html-DqZHOXfM.js" as="script"><link rel="prefetch" href="/assets/index.html-BkTb4Xvg.js" as="script"><link rel="prefetch" href="/assets/index.html-C6Ga4SEa.js" as="script"><link rel="prefetch" href="/assets/index.html-DE1LZuxM.js" as="script"><link rel="prefetch" href="/assets/index.html-BmxKNSvn.js" as="script"><link rel="prefetch" href="/assets/index.html-CFPcY5VI.js" as="script"><link rel="prefetch" href="/assets/index.html-DG8YE-J9.js" as="script"><link rel="prefetch" href="/assets/index.html-C9lzzV0X.js" as="script"><link rel="prefetch" href="/assets/index.html-DkCxAG18.js" as="script"><link rel="prefetch" href="/assets/index.html-zp213SZ0.js" as="script"><link rel="prefetch" href="/assets/index.html-DKzb9uNt.js" as="script"><link rel="prefetch" href="/assets/index.html-mOnZKDxl.js" as="script"><link rel="prefetch" href="/assets/index.html-B1U8z6yE.js" as="script"><link rel="prefetch" href="/assets/index.html-fXDVMZSF.js" as="script"><link rel="prefetch" href="/assets/index.html-CUjAnJ4F.js" as="script"><link rel="prefetch" href="/assets/index.html-T99Zchb2.js" as="script"><link rel="prefetch" href="/assets/index.html-BEL4QnB-.js" as="script"><link rel="prefetch" href="/assets/index.html-BNcNnPpn.js" as="script"><link rel="prefetch" href="/assets/index.html-Bi7zYpxL.js" as="script"><link rel="prefetch" href="/assets/index.html-B5xZ3QSc.js" as="script"><link rel="prefetch" href="/assets/index.html-DQCce9ld.js" as="script"><link rel="prefetch" href="/assets/index.html-eOUzFk1y.js" as="script"><link rel="prefetch" href="/assets/index.html-CE6nz6Zt.js" as="script"><link rel="prefetch" href="/assets/index.html-dvy5_NwG.js" as="script"><link rel="prefetch" href="/assets/index.html-DRiD8NLZ.js" as="script"><link rel="prefetch" href="/assets/index.html-CE96vdOY.js" as="script"><link rel="prefetch" href="/assets/index.html-D_vLVvh7.js" as="script"><link rel="prefetch" href="/assets/index.html-CVTaHIJd.js" as="script"><link rel="prefetch" href="/assets/index.html-BYmhtyDd.js" as="script"><link rel="prefetch" href="/assets/index.html-CK1mInmY.js" as="script"><link rel="prefetch" href="/assets/index.html-BSgA1J8O.js" as="script"><link rel="prefetch" href="/assets/index.html-DYcorc7V.js" as="script"><link rel="prefetch" href="/assets/index.html-Co8UFVmJ.js" as="script"><link rel="prefetch" href="/assets/index.html-TC4GT7WO.js" as="script"><link rel="prefetch" href="/assets/index.html-CNOwF1nk.js" as="script"><link rel="prefetch" href="/assets/flowchart-G1WAoCnn.js" as="script"><link rel="prefetch" href="/assets/index-DpSA5j23.js" as="script"><link rel="prefetch" href="/assets/index-DMDrkyre.js" as="script"><link rel="prefetch" href="/assets/index-BPAdBlYL.js" as="script"><link rel="prefetch" href="/assets/mermaid.esm.min-TGuK7fL4.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-CKV1Bsxh.js" as="script"><link rel="prefetch" href="/assets/giscus-CpJ6lC06.js" as="script"><link rel="prefetch" href="/assets/SearchResult-rJO7RTLT.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="å¸¦æˆ‘å›å®¶"><img class="vp-nav-logo" src="/assets/avatar.jpg" alt><!----><span class="vp-site-name hide-in-pad">chanper</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="HOME"><!--[--><iconify-icon class="vp-icon" icon="solar:home-smile-angle-bold" sizing="height" height="1em"></iconify-icon><!--]-->HOME<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/coding/" aria-label="Coding"><!--[--><iconify-icon class="vp-icon" icon="streamline:code-monitor-1" sizing="height" height="1em"></iconify-icon><!--]-->Coding<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/life/" aria-label="Life"><!--[--><iconify-icon class="vp-icon" icon="icomoon-free:finder" sizing="height" height="1em"></iconify-icon><!--]-->Life<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">æœç´¢</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/coding/AQS.html" aria-label="AQS æºç è§£æ"><!---->AQS æºç è§£æ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/code-review.html" aria-label="Code Review"><!---->Code Review<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Elasticsearch.html" aria-label="Elasticsearch å­¦ä¹ "><!---->Elasticsearch å­¦ä¹ <!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Guava.html" aria-label="Guava ç¬”è®°"><!---->Guava ç¬”è®°<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Guide-RPC.html" aria-label="Guide-RPC ä»£ç é˜…è¯»"><!---->Guide-RPC ä»£ç é˜…è¯»<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Hive-SQL.html" aria-label="Hive SQL è¯­æ³•å¤§å…¨"><!---->Hive SQL è¯­æ³•å¤§å…¨<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/NIO.html" aria-label="Java NIO"><!---->Java NIO<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/java-stream.html" aria-label="Java Stream æµ"><!---->Java Stream æµ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/java-threadlocal.html" aria-label="Java ThreadLocal"><!---->Java ThreadLocal<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Java_base.html" aria-label="Java åŸºç¡€"><!---->Java åŸºç¡€<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JUC.html" aria-label="Java å¹¶å‘å­¦ä¹ "><!---->Java å¹¶å‘å­¦ä¹ <!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM-reference-type.html" aria-label="Java å¼•ç”¨ç±»å‹"><!---->Java å¼•ç”¨ç±»å‹<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Logging.html" aria-label="Java æ—¥å¿—æ¡†æ¶"><!---->Java æ—¥å¿—æ¡†æ¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM.html" aria-label="Java è™šæ‹Ÿæœºç¬”è®°"><!---->Java è™šæ‹Ÿæœºç¬”è®°<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM-GC.html" aria-label="JVM åƒåœ¾å›æ”¶"><!---->JVM åƒåœ¾å›æ”¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM-runtime-memory.html" aria-label="JVM è¿è¡Œæ—¶æ•°æ®åŒº"><!---->JVM è¿è¡Œæ—¶æ•°æ®åŒº<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/leetcode-bitcalc.html" aria-label="LeetCode-ä½è¿ç®—"><!---->LeetCode-ä½è¿ç®—<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/leetcode-permutation.html" aria-label="LeetCode-æ’åˆ—ç»„åˆ"><!---->LeetCode-æ’åˆ—ç»„åˆ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/linux-cmd.html" aria-label="Linux å‘½ä»¤å¤‡å¿˜å½•"><!---->Linux å‘½ä»¤å¤‡å¿˜å½•<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/LockSupport.html" aria-label="LockSupport æºç é˜…è¯»"><!---->LockSupport æºç é˜…è¯»<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/mock-test.html" aria-label="Mock æµ‹è¯•"><!---->Mock æµ‹è¯•<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MQ_Kafka.html" aria-label="MQ-Kafka"><!---->MQ-Kafka<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MyBatis.html" aria-label="MyBatis æ·±å…¥å­¦ä¹ "><!---->MyBatis æ·±å…¥å­¦ä¹ <!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MySQL-DDL.html" aria-label="MySQL DDL æ‰§è¡Œæ–¹å¼"><!---->MySQL DDL æ‰§è¡Œæ–¹å¼<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MySQL01.html" aria-label="MySQL åŸºç¡€"><!---->MySQL åŸºç¡€<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MySQL02.html" aria-label="MySQL æ·±å…¥åŸç†"><!---->MySQL æ·±å…¥åŸç†<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MySQL-Lock.html" aria-label="MySQL é”æœºåˆ¶"><!---->MySQL é”æœºåˆ¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Netty01.html" aria-label="Netty ç½‘ç»œæ¡†æ¶ 01"><!---->Netty ç½‘ç»œæ¡†æ¶ 01<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Netty02.html" aria-label="Netty ç½‘ç»œæ¡†æ¶ 02"><!---->Netty ç½‘ç»œæ¡†æ¶ 02<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/git-pro.html" aria-label="Pro Git é˜…è¯»ç¬”è®°"><!---->Pro Git é˜…è¯»ç¬”è®°<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis02.html" aria-label="Redis å•æœº"><!---->Redis å•æœº<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis03.html" aria-label="Redis å¤šæœº"><!---->Redis å¤šæœº<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis01.html" aria-label="Redis æ•°æ®ç»“æ„"><!---->Redis æ•°æ®ç»“æ„<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis04.html" aria-label="Redis ç‹¬ç«‹åŠŸèƒ½"><!---->Redis ç‹¬ç«‹åŠŸèƒ½<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/cache-migration.html" aria-label="Redis ç¼“å­˜è¿ç§»å®è·µ"><!---->Redis ç¼“å­˜è¿ç§»å®è·µ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Thrift.html" aria-label="RPC-Thrift"><!---->RPC-Thrift<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/SpringTransaction.html" aria-label="Spring äº‹åŠ¡"><!---->Spring äº‹åŠ¡<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Synchronized.html" aria-label="Synchronized é”æœºåˆ¶"><!---->Synchronized é”æœºåˆ¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Thread.html" aria-label="Thread æºç é˜…è¯»"><!---->Thread æºç é˜…è¯»<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/ThreadPoolExecutor.html" aria-label="ThreadPoolExecutor æºç åˆ†æ"><!---->ThreadPoolExecutor æºç åˆ†æ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Unsafe.html" aria-label="Unsafe æºç é˜…è¯»"><!---->Unsafe æºç é˜…è¯»<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Windows-WSL-MySQL.html" aria-label="Windows-WSL å®ç°MySQLä¸»ä»åŒæ­¥"><!---->Windows-WSL å®ç°MySQLä¸»ä»åŒæ­¥<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Zookeeper.html" aria-label="Zookeeper å­¦ä¹ ç¬”è®°"><!---->Zookeeper å­¦ä¹ ç¬”è®°<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/gateway.html" aria-label="å…³äºç½‘å…³"><!---->å…³äºç½‘å…³<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/distributed-transaction.html" aria-label="åˆ†å¸ƒå¼äº‹åŠ¡"><!---->åˆ†å¸ƒå¼äº‹åŠ¡<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/distributed-cache.html" aria-label="åˆ†å¸ƒå¼ç¼“å­˜"><!---->åˆ†å¸ƒå¼ç¼“å­˜<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/bigdata-hadoop.html" aria-label="å¤§æ•°æ® - Hadoop æ¦‚è¿°"><!---->å¤§æ•°æ® - Hadoop æ¦‚è¿°<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Shred_Algorithm.html" aria-label="æ‰‹æ’•ç®—æ³•"><!---->æ‰‹æ’•ç®—æ³•<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/SmallSpring.html" aria-label="æ‰‹æ’¸ Spring é¡¹ç›®"><!---->æ‰‹æ’¸ Spring é¡¹ç›®<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MQ_Abstract.html" aria-label="æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"><!---->æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Authorization.html" aria-label="è®¤è¯ç™»å½•"><!---->è®¤è¯ç™»å½•<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/coding/interview-java.html" aria-label="é¢è¯•å…«è‚¡"><!---->é¢è¯•å…«è‚¡<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/ddd.html" aria-label="é¢†åŸŸé©±åŠ¨è®¾è®¡"><!---->é¢†åŸŸé©±åŠ¨è®¾è®¡<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->é¢è¯•å…«è‚¡</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2023/3/10</span><meta property="datePublished" content="2023-03-10T00:00:00.000Z"></span><!----><!----><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color8 clickable" role="navigation">Java</span><!--]--><meta property="articleSection" content="Java"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color7 clickable" role="navigation">é¢è¯•</span><!--]--><meta property="keywords" content="é¢è¯•"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h2 id="å®ä¹ -ç›®çš„åœ°æœç´¢ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#å®ä¹ -ç›®çš„åœ°æœç´¢ä¼˜åŒ–"><span>å®ä¹  -- ç›®çš„åœ°æœç´¢ä¼˜åŒ–</span></a></h2><p>ä»¥å‰ç”¨æˆ·åœ¨æœç´¢æœºåœºæ•°æ®æ—¶ï¼Œåªä¼šå±•ç¤ºå¯¹åº”çš„åŸå¸‚æœºåœºä¿¡æ¯ï¼Œæ–°çš„éœ€æ±‚æ˜¯ç”¨æˆ·åœ¨æœç´¢æŸä¸ªæ™¯ç‚¹ä¿¡æ¯æ—¶ï¼Œå±•ç¤ºå¯¹åº”åŸå¸‚çš„æœºåœºä¿¡æ¯ã€‚å¦å¤–ä¼˜åŒ–äº†ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>é‚»è¿‘æœºåœºè·ç¦»ç”±æœºåœº-é‚»è¿‘åŸå¸‚ -&gt; æœºåœº-é‚»è¿‘æœºåœºï¼šå¢åŠ near_airport_distanceçš„jsonæ ¼å¼ä¸²</li><li>åŒéŸ³ä¸åŒå­—çš„åŸå¸‚æœºåœºæœç´¢ï¼šcityPinyin -&gt; æœºåœº çš„ Map åˆ‡æ¢ä¸º MultiMap</li></ul><h3 id="æ•°æ®åº“è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åº“è®¾è®¡"><span>æ•°æ®åº“è®¾è®¡</span></a></h3><h4 id="scenic-data" tabindex="-1"><a class="header-anchor" href="#scenic-data"><span>Scenic_Data</span></a></h4><p>4K å¤šæ¡æ•°æ®</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CREATE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> TABLE `scenic_data` (</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `id` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">bigint</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) unsigned </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> AUTO_INCREMENT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `scenic_id` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `scenic_name` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `city_code` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">char</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DEFAULT</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `city_name` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DEFAULT</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `scenic_longitude` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `scenic_latitude` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `deleted` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">11</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;0&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `operator` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `create_time` timestamp </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DEFAULT</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> CURRENT_TIMESTAMP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `update_time` timestamp </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DEFAULT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CURRENT_TIMESTAMP</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ON</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UPDATE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> CURRENT_TIMESTAMP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  PRIMARY</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> KEY</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (`id`)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  KEY `idx_city_code` (`city_code`)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  KEY `idx_scenic_id` (`scenic_id`)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  KEY `idx_deleted` (`deleted`)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) ENGINE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">InnoDB</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> AUTO_INCREMENT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">7762</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DEFAULT</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> CHARSET</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">utf8mb4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="scenic-near-airports" tabindex="-1"><a class="header-anchor" href="#scenic-near-airports"><span>Scenic_Near_Airports</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CREATE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> TABLE `scenic_near_airports` (</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `id` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">bigint</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) unsigned </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> AUTO_INCREMENT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `scenic_id` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `scenic_name` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `near_city_code` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">char</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `near_airport_code` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">char</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;[]&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `distance` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">11</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;0&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `deleted` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">11</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;0&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `operator` </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DEFAULT </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `create_time` timestamp </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DEFAULT</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> CURRENT_TIMESTAMP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  `update_time` timestamp </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NOT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NULL</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DEFAULT</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CURRENT_TIMESTAMP</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ON</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UPDATE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> CURRENT_TIMESTAMP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  PRIMARY</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> KEY</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (`id`)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  KEY `idx_scenic_near_airport` (`scenic_id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">`near_airport_code`)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  KEY `idx_deleted` (`deleted`)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) ENGINE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">InnoDB</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> AUTO_INCREMENT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">7589</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DEFAULT</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> CHARSET</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">utf8mb4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ ¸å¿ƒé€»è¾‘" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒé€»è¾‘"><span>æ ¸å¿ƒé€»è¾‘</span></a></h3><h4 id="æ™¯ç‚¹-é‚»è¿‘æœºåœºè½åº“" tabindex="-1"><a class="header-anchor" href="#æ™¯ç‚¹-é‚»è¿‘æœºåœºè½åº“"><span>æ™¯ç‚¹/é‚»è¿‘æœºåœºè½åº“</span></a></h4><p>ScenicDataPullJob#pullScenicPoiAndComputeNearAirport æ¯ 6H æ‰§è¡Œä¸€æ¬¡</p><ul><li>ä»æ™¯ç‚¹æœåŠ¡æ‹‰å–å…¨é‡æ™¯ç‚¹æ•°æ®</li><li>è¿‡æ»¤æœ‰æœºåœºçš„åŸå¸‚ã€å›½å†…æ™¯ç‚¹ç­‰ç­‰å„ç§è¿‡æ»¤</li><li>å’ŒDBé‡Œé¢ç°æœ‰çš„çš„æ™¯ç‚¹æ•°æ®åšdiffAndSave</li><li>è®¡ç®—æ™¯ç‚¹çš„é‚»è¿‘æœºåœºï¼Œé€‰å–0-300kmä»¥å†…ï¼Œä¸”è·ç¦»æœ€è¿‘çš„ä¸‰ä¸ªæœºåœº</li><li>è½åˆ°æ™¯ç‚¹é‚»è¿‘æœºåœºè¡¨é‡Œ</li></ul><h4 id="æœ¬åœ°ç¼“å­˜-æœç´¢æ ‘" tabindex="-1"><a class="header-anchor" href="#æœ¬åœ°ç¼“å­˜-æœç´¢æ ‘"><span>æœ¬åœ°ç¼“å­˜/æœç´¢æ ‘</span></a></h4><p>InitService#buildSuggestionEnv æœåŠ¡å¯åŠ¨æ—¶/æ¯å¤©å‡Œæ™¨æ‰§è¡Œ (æœ¬åœ°ç¼“å­˜1.5Gï¼Œæœºå™¨8Gï¼Œå½±å“ä¸å¤§)</p><ul><li>è¯»å–æ•°æ®åº“çš„æœ€æ–°æ•°æ®ï¼Œæ„å»º æ™¯ç‚¹id -&gt; é‚»è¿‘æœºåœº çš„mapé›†åˆ</li><li>æ ¹æ®æ‹¼éŸ³æ„å»ºå‰ç¼€æœç´¢æ ‘ Trie Treeï¼Œkey=æ™¯ç‚¹æ‹¼éŸ³ï¼Œvalue=æ™¯ç‚¹id <ul><li>æœåŠ¡é‡Œç¼“å­˜äº†å¾ˆå¤šå‰ç¼€æ ‘ï¼Œå¦‚åŸå¸‚æ‹¼éŸ³ã€åŸå¸‚æ‹¼éŸ³ç®€ç§°ã€æœºåœºã€é‚»è¿‘æœºåœºã€æ™¯ç‚¹ç­‰ç­‰ï¼Œå­˜å…¥ä¸€ä¸ª<code>Map&lt;TrieTreeTypeEnum, TrieTree&gt;</code>é‡Œ</li><li>TrieTreeå°è£…äº†ä¸€ä¸ªTreeNodeæ ¹ç»“ç‚¹ï¼Œæ¯ä¸ªTreeNodeèŠ‚ç‚¹é‡Œé¢æ˜¯ä¸€ä¸ªTreeNodeåˆ—è¡¨ï¼Œå’Œå½“å‰è¿™ä¸ªèŠ‚ç‚¹ä¿å­˜çš„å­—ç¬¦ï¼Œä»¥åŠæ˜¯å¦æ˜¯å¶å­ç»“ç‚¹çš„æ ‡å¿—ä½ï¼Œå¶å­ç»“ç‚¹è¿˜ä¼šæœ‰ä¸€ä¸ªå­˜å‚¨æ™¯ç‚¹Idçš„dataå­—æ®µ</li><li>æœç´¢çš„æ—¶å€™æŒ‰ç…§ç”¨æˆ·è¾“å…¥çš„å†…å®¹è½¬æ¢æˆæ‹¼éŸ³ï¼Œç„¶åä¸€ä¸ªä¸ªå­—ç¬¦åŒ¹é…ï¼Œè¾“å…¥å…¨éƒ¨åŒ¹é…å®Œæˆ–è€…åˆ°è¾¾å¶å­ç»“ç‚¹å³åŒ¹é…æˆåŠŸï¼ŒæŠŠå½“å‰è¿™å±‚åç»­çš„æ‰€æœ‰å¶å­ç»“ç‚¹é‡ŒdataåŸŸå­˜å‚¨çš„æ™¯ç‚¹Idè¿”å›å‡ºå»ï¼Œå¦‚æœä¸­é€”é‡åˆ°æŸä¸ªå­—ç¬¦ä¸åŒ¹é…ï¼Œé‚£ä¹ˆåŒ¹é…å¤±è´¥è¿”å›ä¸ªnullå‡ºå»</li></ul></li></ul><blockquote><p><code>TrieTree = TreeNode + å¯¹å¤–çš„æ–¹æ³•</code></p><p><code>TreeNode = List&lt;TreeNode&gt; + char + terminal + scenicId</code></p></blockquote><h4 id="æœç´¢é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#æœç´¢é€»è¾‘"><span>æœç´¢é€»è¾‘</span></a></h4><ul><li>ç”¨æˆ·è¾“å…¥è¿‡æ»¤éæ³•å­—ç¬¦ï¼Œè½¬æ¢æˆæ‹¼éŸ³</li><li>æ ¹æ®æ‹¼éŸ³æœç´¢å‰ç¼€æ ‘ï¼Œè·å¾—åŒ¹é…çš„æ™¯ç‚¹Id</li><li>ç„¶åæ„é€ å¯¹åº”çš„æ™¯ç‚¹ä¿¡æ¯</li><li>æ¥ç€ç”¨ä¸­æ–‡è¿‡æ»¤ä¸€éï¼Œé˜²æ­¢ä¸­æ–‡æœç´¢æ—¶åŒéŸ³ä¸åŒåçš„æ™¯ç‚¹ä¿¡æ¯ï¼ˆé»„é¹¤æ¥¼/é»„æ²³æ¥¼ï¼‰</li><li>ç„¶åå†è¿‡æ»¤æ²¡æœ‰æœºåœºä¿¡æ¯çš„æ™¯ç‚¹</li><li>å¦‚æœè¿‡æ»¤å®Œçš„ç»“æœä¸ºç©ºï¼Œä¼šæ ¹æ®ç”¨æˆ·è¾“å…¥å»æŸ¥é‚»è¿‘åŸå¸‚çš„æœºåœºåšä¸€ä¸ªå…œåº•</li><li>æœ€åæœ‰ä¸€äº›åç½®çš„å¤„ç†ï¼ŒåƒåŸå¸‚/æ™¯ç‚¹çš„æœç´¢çƒ­åº¦ç­‰ç­‰ã€‚æœ€åå°†æœç´¢ç»“æœè¿”å›</li></ul><h4 id="å¤šçº¿ç¨‹ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å¤šçº¿ç¨‹ä½¿ç”¨"><span>å¤šçº¿ç¨‹ä½¿ç”¨</span></a></h4><p>ä¸­è½¬avæ‰¹é‡æŸ¥è¯¢æ¥å£éœ€æ±‚ä¸­ï¼Œéœ€è¦æ ¹æ® ftd æ‰¹é‡æŸ¥è¯¢ä¸­è½¬è”ç¨‹çš„AVæƒ…å†µï¼Œä»¥å‰å·²ç»æœ‰äº†å•ä¸ªæŸ¥è¯¢è¯·æ±‚çš„æ¥å£ï¼Œè¿™æ¬¡éœ€è¦æ–°å¢æ‰¹é‡æŸ¥è¯¢æ¥å£ã€‚ç”±äºæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯ä¸€ä¸ªè€—æ—¶çš„RPCè°ƒç”¨ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹æé«˜æ•ˆç‡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CompletableFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Void</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> allFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">allOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">transferAvFlightReqs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(request </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CompletableFuture</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">supplyAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> queryTransferAv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((request)))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">thenAccept</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((res) </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                                String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> uniqueKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getTransferAvUniqueKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(request);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                                map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(uniqueKey, res);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            }))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toArray</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">::new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">allFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">BATCH_QUERY_TRANSFER_AV_TIMEOUT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MILLISECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸»è¦çš„è€ƒè™‘ç‚¹æ˜¯è¦ä¿è¯å•ä¸ªè¯·æ±‚çš„å¤±è´¥ä¸å½±å“å…¶å®ƒè¯·æ±‚ï¼ˆthenAcceptï¼‰ï¼Œå¹¶ä¸”åŸºäºå•æ¬¡æŸ¥è¯¢çš„è°ƒç”¨æ—¶é—´ï¼Œé€šè¿‡é…ç½®çš„æ–¹å¼é™åˆ¶æ‰¹é‡è¯·æ±‚çš„æ€»æ—¶é—´ã€‚</p><h2 id="é¡¹ç›®" tabindex="-1"><a class="header-anchor" href="#é¡¹ç›®"><span>é¡¹ç›®</span></a></h2><h3 id="é…·å®‰å¥½ç‰©" tabindex="-1"><a class="header-anchor" href="#é…·å®‰å¥½ç‰©"><span>é…·å®‰å¥½ç‰©</span></a></h3><p>é…·å®‰å¥½ç‰©æ˜¯ä¸€ä¸ªå¥½ç‰©æ¨èå’Œè´­ç‰©å•†åŸï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç½‘é¡µæµè§ˆå•†å“ä¿¡æ¯ã€æœç´¢å•†å“ã€ä¸‹å•ç­‰ï¼Œç®¡ç†å‘˜é€šè¿‡ç³»ç»Ÿåå°ç»´æŠ¤å•†å“<br>SPU/SKUã€è®¢å•ç®¡ç†ã€äººå‘˜ç®¡ç†ç­‰ã€‚</p><p>æŠ€æœ¯æ€»ä½“åŸºäº SpringBoot+SpringCloud+MyBatis+Redisã€‚ä¸»è¦<br>ä½¿ç”¨ SpringBoot æ¡†æ¶å®Œæˆåå°å•†å“ SPU/SKU çš„ä¸Šä¸‹æ¶ç®¡ç†<br>ä½¿ç”¨ MyBatisPlus å®Œæˆæ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥<br>å®ç° MySQL çš„ä¸»ä»åŒæ­¥<br>ä½¿ç”¨ Redisson å®ç°åˆ†å¸ƒå¼é”é¿å…ç¼“å­˜å‡»ç©¿<br>ä½¿ç”¨ é˜¿é‡Œäº‘OSS å®ç°å›¾ç‰‡çš„ä¸Šä¼ å­˜å‚¨<br>ä½¿ç”¨ Redis å¯¹è´­ç‰©è½¦æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦</p><h4 id="nginx-åå‘ä»£ç†" tabindex="-1"><a class="header-anchor" href="#nginx-åå‘ä»£ç†"><span>Nginx åå‘ä»£ç†</span></a></h4><p>æ­£å‘ä»£ç†ä»£ç†å®¢æˆ·ç«¯ï¼Œåå‘ä»£ç†ä»£ç†æœåŠ¡å™¨ã€‚</p><div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-properties"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">upstream gulimall{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  server 127.0.0.1:10086</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">server {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  listen       80</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  server_name gulimall  *.gulimall</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  location /static {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">      root   D:\Tools\nginx\html</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	# é…ç½®è¯·æ±‚è·¯ç”±</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  location / {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">      proxy_pass http://gulimall</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">      proxy_set_header Host $host</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # include D:\\Tools\\nginx\\conf\\conf.d\\*.conf;  # åŒ…å«äº†å“ªäº›é…ç½®æ–‡ä»¶</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æœ¬æœºè¯·æ±‚ gulimall -&gt; æœ¬åœ° Nginx æœåŠ¡å™¨ï¼Œå¦‚æœæ˜¯ /static è·¯å¾„çš„é™æ€èµ„æºç›´æ¥ä» Nginx ç›®å½•ä¸‹è¿”å›</li><li>å…¶å®ƒ gulimall åŸŸåä¸‹çš„è¯·æ±‚æ ¹æ® upstream è½¬å‘åˆ°ç½‘å…³</li></ul><h4 id="jvm-è°ƒä¼˜" tabindex="-1"><a class="header-anchor" href="#jvm-è°ƒä¼˜"><span>JVM è°ƒä¼˜</span></a></h4><p><strong>JMeter å‹æµ‹</strong></p><p>æ·»åŠ çº¿ç¨‹ç»„ -&gt; æŸ¥çœ‹ç»“æœæ ‘å’Œæ±‡æ€»æŠ¥å‘Š -&gt; åˆ†æå¼‚å¸¸æ¯”ä¾‹ã€ååé‡ã€å“åº”æ—¶é—´ç­‰ã€‚</p><p>å‘ç°ï¼šç›´æ¥è®¿é—®ä¸€ä¸ªæ§åˆ¶å™¨çš„ååé‡å¯è¾¾ 25000 QPSï¼›è€Œç»è¿‡ç½‘å…³å†è®¿é—®ååé‡è¿˜å‰© 5500 QPS å·¦å³ï¼Œå¼‚å¸¸æ•°é‡ä¹Ÿä¼šå¢åŠ ï¼›è€Œå¦‚æœç»è¿‡ Nginx ä»£ç†ååé‡ä»…å‰© 2200 QPS å·¦å³ã€‚</p><p>ä¼˜åŒ–ï¼š</p><ul><li>ä¸‰çº§ç›®å½•åŸæœ¬æ˜¯æ ¹æ®çˆ¶ç›®å½• id æŸ¥ä¸‰æ¬¡æ•°æ®åº“ï¼ŒæŸ¥è¯¢ DB é€Ÿåº¦å¾ˆæ…¢ã€‚å¯ä»¥ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ï¼Œä¸€æ¬¡æ€§å…¨éƒ¨æŸ¥å‡ºå†å°è£…æ ‘å½¢ç»“æ„ï¼ŒQPS ä» 2500 æé«˜åˆ°äº† 7000ã€‚</li><li>å•†å“ä¿¡æ¯å±•ç¤ºçš„ä¸šåŠ¡ï¼Œç½‘ç»œä¼ è¾“æ•°æ®é‡è¿‡å¤§ï¼Œå¯¼è‡´é¡µé¢åŠ è½½è¿‡æ…¢ï¼Œå¯ä»¥é€šè¿‡ TO ä¼ è¾“å¯¹è±¡ç²¾ç®€è¿”å›çš„æ•°æ®é‡ï¼ŒåŠ å¿«é¡µé¢çš„åŠ è½½</li></ul><p><strong>JConsole</strong></p><p>Java ç›‘è§†å’Œç®¡ç†æ§åˆ¶å°ï¼Œæ ¹æ® PID è¿æ¥æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹è™šæ‹Ÿæœºå†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬å †ç©ºé—´ã€Edenã€Survivorç­‰ï¼ŒåŒ…æ‹¬ Young GCã€Old GC æ—¶é—´ï¼Œä»¥åŠçº¿ç¨‹æ•°é‡ç­‰ä¿¡æ¯</p><p><strong>jmap</strong><br><code>jstack</code> æŸ¥çœ‹å †æ ˆä¿¡æ¯ï¼Œä»¥åŠæ’æŸ¥æ­»é”é—®é¢˜<br><code>jhsdb jmap --heap --pid 20536</code> æŸ¥çœ‹è¿›ç¨‹ä½¿ç”¨çš„GCç®—æ³•ã€å †é…ç½®ä¿¡æ¯å’Œå„å†…å­˜åŒºåŸŸå†…å­˜ä½¿ç”¨ä¿¡æ¯<br><code>jstat -gc -h3 31736 1000 10</code> æŸ¥çœ‹ GC æƒ…å†µï¼Œå„ä¸ªç©ºé—´çš„ä½¿ç”¨é‡<br><code>jmap -dump:format=b,file=dump.hprof 20536</code> ç”Ÿæˆå †è½¬å‚¨å¿«ç…§ heap profile -&gt; VisualVM/JProfile æŸ¥çœ‹å†…å­˜å ç”¨æƒ…å†µ -&gt; å®šä½å¤§å¯¹è±¡ -&gt; å®šä½ä»£ç ä¸­åˆ›å»ºçš„ä½ç½® -&gt; æ’æŸ¥ BUG</p><h4 id="ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜"><span>ç¼“å­˜</span></a></h4><p>å¼•å…¥ data-redis-starter -&gt; é…ç½® redis åœ°å€ã€è®¿é—® -&gt; ä½¿ç”¨ StringRedisTemplate æ“ä½œ Redis ï¼ˆredisTemplate æ˜¯ Spring å¯¹ Lettuce/Jedis çš„å°è£…ï¼‰</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Test</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> testRedis</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    ValueOperations</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stringStringValueOperations </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stringStringValueOperations</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(val </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Key &#39;Hello&#39; does not exist. Then set it...&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        stringStringValueOperations</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;World&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        val </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stringStringValueOperations</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello = &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> val);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è´­ç‰©è½¦ç¼“å­˜</strong></p><p>ä½¿ç”¨ Redis çš„åŸå› ï¼šå‡è½»æ•°æ®åº“å‹åŠ›ã€é€Ÿåº¦å¿«ã€å…±äº«ç¼“å­˜</p><p>å…·ä½“æ“ä½œï¼šå¯¼å…¥ Spring Cache å’Œ Redis ä¾èµ–åæ ‡ï¼Œttlè¿‡æœŸæ—¶é—´è®¾ä¸º30åˆ†é’Ÿï¼Œ<a href="/EnableCaching">@EnableCaching </a> å¼€å¯ç¼“å­˜ï¼Œåœ¨å¯¹åº”çš„æ§åˆ¶å™¨æ–¹æ³•ä¸Šæ ‡æ³¨ <a href="/Cacheable">@Cacheable </a> æ³¨è§£å¯¹ç»“æœç¼“å­˜ã€‚åœ¨ save å’Œ delete æ–¹æ³•ä¸Šæ ‡æ³¨ <a href="/CacheEvict">@CacheEvict </a> æ ‡æ³¨ï¼Œå¯¹æ•°æ®åº“åšä¿®æ”¹æ—¶åˆ é™¤ç¼“å­˜ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>æ•°æ®ç»“æ„ï¼š<code>Map&lt;String, Map&lt;String, CatItemInfo&gt;&gt; Cart:UID = {{SKU1 = Info1}, {SKU2 = Info2}}</code></p><ul><li>ä»¥ ä¸šåŠ¡å+ç”¨æˆ·ID ä½œä¸º key</li><li>ä»¥å•†å“ id ä½œä¸ºå€¼çš„ field</li><li>ä»¥å•†å“ç›¸å…³ä¿¡æ¯çš„ json æ•°æ®ä½œä¸ºå€¼çš„ value</li></ul><h4 id="å¤šçº¿ç¨‹ä½¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#å¤šçº¿ç¨‹ä½¿ç”¨-1"><span>å¤šçº¿ç¨‹ä½¿ç”¨</span></a></h4><p>è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå¹¶ä½¿ç”¨ CompletableFuture å¼‚æ­¥ç¼–æ’å®ç°æ ¹æ® skuId æ£€ç´¢å•†å“è¯¦ç»†ä¿¡æ¯ï¼ŒSKU åˆ†åŸºæœ¬ä¿¡æ¯ã€å›¾ç‰‡ä¿¡æ¯ã€é”€å”®å±æ€§ã€ä»‹ç»ã€è§„æ ¼å‚æ•°ã€‚å…¶ä¸­ï¼Œå›¾ç‰‡ä¿¡æ¯æ˜¯å¯ä»¥å’ŒåŸºæœ¬ä¿¡æ¯å¹¶å‘æ£€ç´¢çš„ï¼Œé€šè¿‡ runAsync å®ç°ï¼Œè€Œåé¢ä¸‰ä¸ªå±æ€§å¿…é¡»å…ˆè·å–åˆ° SKU çš„ spuId æ‰èƒ½æ£€ç´¢ï¼Œå› æ­¤é€šè¿‡ thenAcceptAsync å®ç°ã€‚æœ€åé€šè¿‡ CompletableFuture.allOf(...) ç­‰å¾…æ‰€æœ‰æ£€ç´¢å®Œæˆå†è¿”å›ã€‚</p><ul><li><code>CompletableFuture::supplyAsync(Supplierï¼Œ executor)</code> ç›¸æ¯”äº <code>CompletableFuture::runAsync(Runnableï¼Œ executor)</code> å¯ä»¥è·å–è¿”å›å€¼</li><li>å¦‚æœæ²¡æœ‰æŒ‡å®šçº¿ç¨‹æ± ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ ForkJoinPool.commonPool()</li><li>get() è·å–ç»“æœæ—¶ï¼Œå¦‚æœç»“æœéç©ºåˆ™ reportGet()ï¼Œå¦åˆ™ waitingGet()</li></ul><p><strong>çº¿ç¨‹æ± é…ç½®</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ThreadPoolExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 200</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> LinkedBlockingDeque</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10000</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Executors</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">defaultThreadFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				new</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ThreadPoolExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AbortPolicy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  * æŸ¥è¯¢é¡µé¢è¯¦ç»†å†…å®¹</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SkuItemVo</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> skuId) throws ExecutionException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> InterruptedException {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    SkuItemVo</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> skuItemVo </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> SkuItemVo</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 1. sku åŸºæœ¬ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    CompletableFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SkuInfoEntity</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> infoFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">supplyAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        SkuInfoEntity</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> info</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(skuId);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        skuItemVo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setInfo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(info);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> info;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }, executor);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 2. skuå›¾ç‰‡ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    CompletableFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Void</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> imageFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">runAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SkuImagesEntity</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">images</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> imagesService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getImagesBySkuId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(skuId);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        skuItemVo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setImages</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(images);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }, executor);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 3. è·å–spué”€å”®å±æ€§ç»„åˆ list (åœ¨ 1 ä¹‹å)</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    CompletableFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Void</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> saleAttrFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> infoFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">thenAcceptAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(res </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ItemSaleAttrVo</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">saleAttrVos</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> skuSaleAttrValueService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getSaleAttrsBuSpuId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">res</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getSpuId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        skuItemVo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setSaleAttr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(saleAttrVos);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }, executor);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ......</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // TODO 6. æŸ¥è¯¢å½“å‰ sku æ˜¯å¦å‚ä¸ç§’æ€ä¼˜æƒ </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆåœ¨è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">allOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(imageFuture, saleAttrFuture, descFuture, baseAttrFuture).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> skuItemVo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è®¢å•ã€åº“å­˜" tabindex="-1"><a class="header-anchor" href="#è®¢å•ã€åº“å­˜"><span>è®¢å•ã€åº“å­˜</span></a></h4><p>ä¸šåŠ¡é€»è¾‘ï¼šå½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œè®¢å•ç³»ç»Ÿç”Ÿæˆè®¢å•ï¼Œå•†å“ç³»ç»Ÿæ‰£å‡åº“å­˜ï¼Œä¿ƒé”€ç³»ç»Ÿæ‰£å‡ä¼˜æƒ åˆ¸ï¼Œæœ€åè®¢å•å…¥åº“ã€‚</p><p>å¯ä»¥é‡‡ç”¨ 2PCã€3PCã€TCC ç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼ˆé€‚åˆè¦æ±‚å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä¾‹å¦‚é‡‘èæ”¯ä»˜ï¼‰ï¼Œä½†æœ¬é¡¹ç›®é‡‡ç”¨ MQ ä¿è¯äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h5 id="è®¢å•ä¸šåŠ¡" tabindex="-1"><a class="header-anchor" href="#è®¢å•ä¸šåŠ¡"><span>è®¢å•ä¸šåŠ¡</span></a></h5><p>ç”¨æˆ·ä¸‹å•åï¼Œè®¢å•ç³»ç»Ÿéœ€è¦</p><ul><li>å‘é€è®¢å•åˆ›å»ºçš„æ¶ˆæ¯ç»™ MQï¼Œå¹¶è®¾ç½® TTLï¼Œç»è¿‡è®¾å®šçš„ TTL åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œç›‘å¬æ­»ä¿¡é˜Ÿåˆ—çš„æœåŠ¡æ ¹æ®è®¢å•çš„çŠ¶æ€ï¼ˆå·²æ”¯ä»˜/æœªæ”¯ä»˜ï¼‰è¿›è¡Œåç»­ä¸šåŠ¡å¤„ç†ï¼ˆäº¤ä»˜ä»“å‚¨ç‰©æµ/å…³å•åº“å­˜è§£é”ï¼‰ï¼Œå®ç°è‡ªåŠ¨å…³å•</li><li>ç„¶åè¿›å…¥åº“å­˜ç³»ç»Ÿé”å®šåº“å­˜</li></ul><h5 id="åº“å­˜é”å®š" tabindex="-1"><a class="header-anchor" href="#åº“å­˜é”å®š"><span>åº“å­˜é”å®š</span></a></h5><ul><li>ç”±äºè®¢å•å¯èƒ½å›æ»šï¼Œæ‰€ä»¥ä¸ºäº†èƒ½å¤Ÿå¾—åˆ°åº“å­˜é”å®šçš„ä¿¡æ¯ï¼Œåœ¨é”å®šæ—¶éœ€è¦è®°å½•åº“å­˜å·¥ä½œå•ï¼ˆè®¢å•ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€æ•°é‡ç­‰ï¼‰</li><li>åº“å­˜ä¿å­˜åœ¨ Redis ä¸­ï¼Œæ”¶åˆ°è¯·æ±‚ååˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œç„¶åå‡æ‰ Redis ä¸­çš„åº“å­˜ï¼ˆRedis ä¸­çš„åº“å­˜æ‰£å®Œå°±æ— æ³•ä¸‹å•äº†ï¼‰</li><li>é”å®šæˆåŠŸåå‘å»¶è¿Ÿé˜Ÿåˆ—å‘é€æ¶ˆæ¯(é”å®šçš„ç›¸å…³ä¿¡æ¯)ï¼Œå®ç°åº“å­˜è‡ªåŠ¨è§£é”ã€‚ç„¶åä¿®æ”¹å¯¹åº”çš„è®¢å•çŠ¶æ€ï¼Œè¿›å…¥æ”¯ä»˜æµç¨‹</li><li>æ”¯ä»˜æˆåŠŸåè®¢å•è¿›å…¥å‡ºåº“çŠ¶æ€ï¼Œæ­¤æ—¶æ‰£é™¤æ•°æ®åº“ä¸­çš„åº“å­˜ã€‚å¦‚æœä¸­é€”å¤±è´¥ï¼Œåˆ™å–æ¶ˆè®¢å•ï¼Œè§£é”åº“å­˜ç­‰</li></ul><p><strong>åº“å­˜è‡ªåŠ¨è§£é”</strong>ï¼šåº“å­˜é”å®š(Redis ä¸­)åï¼Œä¹Ÿä¼šæœ‰ä¸€ä¸ªæ¶ˆæ¯å‘é€åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œç»è¿‡ TTL åæ ¹æ®è®¢å•çŠ¶æ€å’Œå·¥ä½œå•çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦è¿›è¡Œåº“å­˜è§£é”ï¼Œåªæœ‰è®¢å•æ˜¯è¿‡æœŸçš„ï¼Œä¸”å·¥ä½œå•çš„åº“å­˜å¤„äºé”å®šçŠ¶æ€æ‰è¿›è¡Œåº“å­˜è§£é”ã€‚</p><p>è‡ªåŠ¨å…³å•å’Œè‡ªåŠ¨è§£é”åº“å­˜ä¸¤ä¸ªä¸šåŠ¡é€šè¿‡é‡æ–°æŸ¥è¯¢å½“å‰çš„çŠ¶æ€æ¥ä¿è¯å¹‚ç­‰æ€§ã€‚</p><h5 id="ä¼˜æƒ åˆ¸ä¸šåŠ¡" tabindex="-1"><a class="header-anchor" href="#ä¼˜æƒ åˆ¸ä¸šåŠ¡"><span>ä¼˜æƒ åˆ¸ä¸šåŠ¡</span></a></h5><ul><li>è®¢å•ç³»ç»Ÿä¸‹å•æ—¶ï¼Œå°†æ‰£å‡çš„ä¼˜æƒ åˆ¸äº‹ä»¶æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæœ€ç»ˆä¼˜æƒ åˆ¸ç³»ç»Ÿä¼šæ‰§è¡Œå¯¹åº”çš„ä¸šåŠ¡ï¼Œå®Œæˆåé€šè¿‡æ‰‹åŠ¨ç¡®è®¤çš„æ–¹å¼å‘é€åº”ç­”ï¼Œå‘Šè¯‰ MQ åˆ é™¤è¿™æ¡æ¶ˆæ¯ï¼Œé˜²æ­¢ä¸šåŠ¡å‡ºç°å¼‚å¸¸è€Œæ¶ˆæ¯å·²ç»è¢«åˆ é™¤çš„é—®é¢˜ã€‚</li><li>åŒæ—¶è®¢å•ç³»ç»Ÿéœ€è¦å°†å¯¹åº”çš„ä¼˜æƒ åˆ¸æ¶ˆæ¯å†™å…¥æ•°æ®åº“ï¼Œå¹¶æŠŠçŠ¶æ€è®¾ä¸ºæœªå®Œæˆï¼Œä¼˜æƒ åˆ¸ç³»ç»Ÿåœ¨æ¶ˆè´¹æˆåŠŸåï¼Œä¹Ÿå‘ MQ å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œé€šçŸ¥è®¢å•ç³»ç»Ÿå°†è¿™ä¸ªè®¢å•çš„ä¼˜æƒ åˆ¸ä¸šåŠ¡çŠ¶æ€è®¾ä¸ºå®Œæˆï¼Œè¿™æ ·ï¼Œå³ä½¿æ¶ˆæ¯ç§¯å‹å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œä¹Ÿèƒ½é€šè¿‡å®šæ—¶ä»»åŠ¡å°†æœªå®Œæˆçš„æ¶ˆæ¯é‡æ–°å‘é€ï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚</li></ul><h4 id="mq" tabindex="-1"><a class="header-anchor" href="#mq"><span>MQ</span></a></h4><p><strong>æ¶ˆæ¯ä¸¢å¤±</strong></p><p>MQ æœ¬èº«æœ‰æŒä¹…åŒ–æœºåˆ¶ï¼Œæ­¤å¤–è¿˜æœ‰ï¼š</p><ul><li>æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ <ul><li>ConfirmCallback</li><li>ReturnCallback</li><li>ConsumerAck</li></ul></li><li>æ¶ˆæ¯ç”Ÿäº§ç«¯ç»™æ¯ä¸ªæ¶ˆæ¯æ³¨å…¥ä¸€ä¸ªå”¯ä¸€ IDï¼Œæ¶ˆè´¹è€…åŸºäº ID è¿›è¡Œæ ¡éªŒï¼Œå®ç°æ¶ˆæ¯æ£€æµ‹ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±</li></ul><p>æ³¨ï¼šåˆ†å¸ƒå¼ ID çš„ç”Ÿæˆå¯ä»¥ä½¿ç”¨ è‡ªå¢ä¸»é”®ã€UUIDã€Redisã€é›ªèŠ±ç®—æ³•ç­‰</p><p><strong>é‡å¤æ¶ˆè´¹(å¹‚ç­‰æ€§)</strong></p><p>é˜²æ­¢æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹ï¼Œä¹Ÿå³è§£å†³æ¶ˆè´¹è€…ç«¯å¹‚ç­‰æ€§é—®é¢˜ã€‚å¯ä»¥é€šè¿‡å»ºç«‹æ¶ˆæ¯çš„æ—¥å¿—è¡¨ï¼ˆMySQL/Redisï¼‰ï¼Œè®°å½•æ¶ˆæ¯çš„ ID å’Œæ‰§è¡ŒçŠ¶æ€ï¼ˆæœªæ‰§è¡Œ/å·²å®Œæˆï¼‰ï¼Œç„¶åæ ¹æ®æ¶ˆæ¯çš„æ‰§è¡ŒçŠ¶æ€åšè¿›ä¸€æ­¥çš„åˆ¤æ–­å¤„ç†ã€‚</p><p><strong>æ¶ˆæ¯ç§¯å‹</strong></p><p>ä¸€èˆ¬æ˜¯æ¶ˆè´¹è€…ç«¯çš„æ€§èƒ½é—®é¢˜ã€‚</p><ul><li>æ‰©å®¹ï¼Œå¢åŠ æ¶ˆè´¹è€…çš„æ•°é‡</li><li>é™çº§ä¸€äº›éæ ¸å¿ƒä¸šåŠ¡ï¼Œå‡å°‘æœåŠ¡ç«¯çš„å‹åŠ›</li><li>é€šè¿‡ç›‘æ§ã€æ—¥å¿—ç­‰æ‰‹æ®µåˆ†æä¸šåŠ¡é€»è¾‘æ˜¯å¦å½±å“äº†æ€§èƒ½</li></ul><h4 id="ç§’æ€è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ç§’æ€è®¾è®¡"><span>ç§’æ€è®¾è®¡</span></a></h4><ul><li>æœåŠ¡å•ä¸€èŒè´£ + ç‹¬ç«‹éƒ¨ç½²ï¼šç§’æ€æœåŠ¡å³ä½¿è‡ªå·±æ‰›ä¸ä½æŒ‚æ‰ï¼Œä¹Ÿä¸å½±å“å…¶ä»–æœåŠ¡</li><li>ç§’æ€é“¾æ¥åŠ å¯†ï¼šé˜²æ­¢æ¶æ„æ”»å‡»ã€é“¾æ¥æš´éœ²</li><li>åº“å­˜é¢„çƒ­ + å¿«é€Ÿæ‰£å‡ï¼šç§’æ€è¯»å¤šå†™å°‘ï¼Œæ— éœ€æ¯æ¬¡å®æ—¶æ ¡éªŒåº“å­˜ï¼Œæå‰æ‰£å‡åº“å­˜æ”¾åˆ° Redis ä¸­ï¼Œå¹¶ç”¨ä¿¡å·é‡æ§åˆ¶è¿›æ¥çš„è¯·æ±‚æ•°</li><li>åŠ¨é™åˆ†ç¦»ï¼šnginx åšå¥½åŠ¨é™åˆ†ç¦»ï¼Œä¿è¯åŠ¨æ€è¯·æ±‚æ‰æ‰“åˆ°åç«¯çš„æœåŠ¡é›†ç¾¤ï¼Œå¹¶ä½¿ç”¨ CDN ç½‘ç»œåˆ†æ‹…é›†ç¾¤å‹åŠ›</li><li>æ¶æ„è¯·æ±‚æ‹¦æˆªï¼šç½‘å…³å±‚è¯†åˆ«éæ³•æ”»å‡»è¯·æ±‚å¹¶æ‹¦æˆª</li><li>æµé‡é”™å³°ï¼šåˆ©ç”¨éªŒè¯ç ã€åŠ å…¥è´­ç‰©è½¦ç­‰æ‰‹æ®µå‡æ‘Šæµé‡</li><li>é™æµã€ç†”æ–­ã€é™çº§ï¼šå‰åç«¯é™æµï¼Œé™åˆ¶æ¬¡æ•°ï¼Œå¿«é€Ÿå¤±è´¥é™çº§è¿è¡Œï¼Œç†”æ–­éš”ç¦»é˜²æ­¢é›ªå´©</li><li>é˜Ÿåˆ—å‰Šå³°ï¼šæ‰€æœ‰ç§’æ€æˆåŠŸçš„è¯·æ±‚è¿›å…¥é˜Ÿåˆ—ï¼Œæ…¢æ…¢å¤„ç†åç»­æµç¨‹</li></ul><h3 id="æ‰‹å†™spring" tabindex="-1"><a class="header-anchor" href="#æ‰‹å†™spring"><span>æ‰‹å†™Spring</span></a></h3><h4 id="ioc" tabindex="-1"><a class="header-anchor" href="#ioc"><span>IoC</span></a></h4><h5 id="beanfactory" tabindex="-1"><a class="header-anchor" href="#beanfactory"><span>BeanFactory</span></a></h5><p>æœ€åŸºæœ¬çš„å¯åˆå§‹åŒ–çš„å®¹å™¨ï¼šDefaultListableBeanFactory é€šè¿‡ä¸€å±‚å±‚çš„ç»§æ‰¿å…³ç³»ä¸»è¦å®ç°äº†ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li>BeanFactoryï¼š Map å­˜å‚¨ BeanName å’Œ BeanDefinitionï¼ˆå…¨é™å®šç±»å+å±æ€§é›†åˆï¼‰ çš„æ˜ å°„å…³ç³»</li><li>SingletonBeanRegistryï¼šMap å­˜å‚¨ BeanName å’Œå•ä¾‹ Bean çš„æ˜ å°„ï¼Œéœ€è¦æ—¶å€™é€šè¿‡ BeanName ä» map é‡Œè·å– Bean å¯¹è±¡ï¼Œå¦‚æœè·å–çš„æ—¶å€™ä¸å­˜åœ¨å¯¹åº”çš„Beanå¯¹è±¡ï¼Œå°±ä»BeanFactoryä¸­å–BeanDefinitionå®ä¾‹åŒ–ï¼ˆåå°„/Cglibï¼‰åæ”¾å…¥map</li></ul><p>æ³¨ï¼šå®ä¾‹åŒ–ä¸€èˆ¬å°±æ˜¯åå°„åˆ›å»ºå¯¹è±¡ï¼ŒåŒºåˆ«äºæ‹¦æˆªå™¨é€šè¿‡CglibåŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡</p><h5 id="applicationcontext" tabindex="-1"><a class="header-anchor" href="#applicationcontext"><span>ApplicationContext</span></a></h5><p>æ›´è¿›ä¸€æ­¥ï¼ŒApplicationContext ç»„åˆäº† BeanFactoryï¼ˆå…·æœ‰åŠ è½½ BeanDefinition å’Œ å­˜å‚¨ Bean çš„åŠŸèƒ½ï¼‰ï¼Œè¿˜æä¾›äº†å¾ˆå¤šé¢å¤–çš„æ‰©å±•ç‚¹ï¼Œä¾‹å¦‚è‡ªåŠ¨è£…è½½ã€åç½®å¤„ç†å™¨ã€Aware æ¥å£ã€ç›‘å¬å™¨ç­‰ç­‰ã€‚</p><p>æ³¨ï¼šBeanFactoryæ˜¯éœ€è¦æ‰‹åŠ¨æ³¨å†ŒBeançš„ï¼Œè·å–æ—¶è‡ªåŠ¨å®ä¾‹åŒ–ã€‚è€ŒContextåˆ›å»ºæ—¶æ ¹æ®é…ç½®è‡ªåŠ¨æ³¨å†ŒBeanã€‚</p><p>åˆ›å»º ApplicationContex æ—¶ï¼Œä¼ å…¥Beançš„é…ç½®æ–‡ä»¶ï¼Œç„¶åè¿›å…¥ refresh() æ–¹æ³•ï¼Œæ‰§è¡Œåº”ç”¨ä¸Šä¸‹æ–‡çš„åˆå§‹åŒ–ï¼š</p><ul><li>refreshBeanFactoryï¼šåˆ›å»º BeanFactory è£…è½½æ‰€æœ‰ BeanDefinitionï¼ˆåŒ…æ‹¬å„ç§å¤„ç†å™¨ã€ç›‘å¬å™¨ï¼‰</li><li>invokeBeanFactoryPostProcessorï¼šå®ä¾‹åŒ–æ‰€æœ‰ BeanFactoryPostProcessor å¹¶æ‰§è¡Œåç½®å¤„ç†</li><li>registerBeanPostProcessorï¼šå®ä¾‹åŒ–æ‰€æœ‰ BeanPostProcessor å¹¶æ‰§è¡Œåç½®å¤„ç†</li><li>InitApplicationEventMulticasterï¼šåˆå§‹åŒ–äº‹ä»¶å‘å¸ƒå™¨ï¼Œåˆ›å»ºæ‰€æœ‰ ApplicationListener çš„é›†åˆç”¨äºäº‹ä»¶å¤„ç†</li><li>registerListenersï¼šå®ä¾‹åŒ– ApplicationListener å¹¶æ”¾å…¥ç›‘å¬å™¨é›†åˆ</li><li>preInstantiateSingletonsï¼šå®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹ Bean</li><li>finishRefreshï¼šå‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶</li></ul><p>æ³¨ï¼šäº‹ä»¶å¤„ç† publishEvent -&gt; multicastEvent -&gt; getListenersForEvent -&gt; onApplicationEvent å…·ä½“çš„ç›‘å¬å™¨è´Ÿè´£å¯¹äº‹ä»¶æ˜¯å¦å“åº”ã€å¦‚ä½•å“åº”</p><h4 id="aop" tabindex="-1"><a class="header-anchor" href="#aop"><span>AOP</span></a></h4><p>DefaultAdvisorAutoProxyCreator æ˜¯é»˜è®¤çš„ä»£ç†åˆ›å»ºå™¨ï¼ŒåŸºäºå®¹å™¨ä¸­æ‰€æœ‰çš„ AspectJExpressionPointcutAdvisor å¯¹å½“å‰è¦åˆ›å»ºçš„ Bean ä½œåŒ¹é…ï¼Œç„¶åé€šè¿‡ ProxyFactory é€‰æ‹©åŸºäº JDK/CGLIB åˆ›å»ºå®é™…çš„ä»£ç†å¯¹è±¡ä½œä¸º Bean è¿”å›ï¼Œæœ€ç»ˆåŠ å…¥åˆ°å®¹å™¨ä¸­ã€‚ï¼ˆåŸºäºAspectJå®ç°çš„ï¼‰</p><p>AspectJExpressionPointcutAdvisor æ•´åˆäº†åˆ‡é¢ pointcutã€æ‹¦æˆªæ–¹æ³• adviceã€è¡¨è¾¾å¼ expressionï¼Œèƒ½å¤ŸåŸºäº expression åšåŒ¹é…ï¼Œæ„å»º AdvisedSupport(ä»£ç†ç›®æ ‡ã€æ‹¦æˆªå™¨)ã€‚</p><h4 id="bean-ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#bean-ç”Ÿå‘½å‘¨æœŸ"><span>Bean ç”Ÿå‘½å‘¨æœŸ</span></a></h4><p>è®©Beanå®ç°DisposableBeanï¼ˆdestroyï¼‰, InitializingBeanï¼ˆafterPropertiesSetï¼‰, Awareï¼ˆsettersï¼‰æ¥å£ï¼Œåœ¨å®¹å™¨çš„å„ä¸ªé˜¶æ®µæ‰§è¡Œç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚</p><h4 id="å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#å¾ªç¯ä¾èµ–"><span>å¾ªç¯ä¾èµ–</span></a></h4><p>Spring æ¡†æ¶è®¾è®¡è§£å†³å¾ªç¯ä¾èµ–éœ€è¦ç”¨åˆ°ä¸‰ä¸ªMapï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä¸€çº§ç¼“å­˜ï¼Œå­˜æ”¾æˆå“å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> singletonObjects </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ConcurrentHashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// äºŒçº§ç¼“å­˜ï¼Œå­˜æ”¾æœªå¡«å……å±æ€§çš„åŠæˆå“å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> earlySingletonObjects </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä¸‰çº§ç¼“å­˜ï¼Œå­˜æ”¾ä»£ç†å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ObjectFactory</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> singletonFactories </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ObjectFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·å–å•ä¾‹ Bean æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getSingleton</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> beanName) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> singletonObject </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> singletonObjects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (singletonObject </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ²¡æœ‰å°±åˆ°äºŒçº§ç¼“å­˜ä¸­å–</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        singletonObject </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> earlySingletonObjects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (singletonObject </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// äºŒçº§è¿˜æ²¡æœ‰å»ä¸‰çº§ç¼“å­˜æ‰¾ï¼Œåªæœ‰ä»£ç†å¯¹è±¡æ‰ä¼šæ”¾åˆ°ä¸‰çº§ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            ObjectFactory</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> singletonFactory </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> singletonFactories</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (singletonFactory </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                singletonObject </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> singletonFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                //æŠŠä¸‰çº§ç¼“å­˜ä¸­ä»£ç†å·¥å‚çš„çœŸå®å¯¹è±¡å–å‡ºæ¥æ”¾å…¥äºŒçº§ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                earlySingletonObjects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(beanName, singletonObject);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                singletonFactories</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> singletonObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å•ä¾‹ Bean åœ¨å®ä¾‹åŒ–åç«‹åˆ»æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼ˆéä»£ç† Bean æ˜¯ä¸€ä¸ªå‡å·¥å‚ç›´æ¥è¿”å›è¯¥å¯¹è±¡ï¼‰</li><li>å½“å…¶ä»– Bean ä¾èµ–æ­¤ Bean æ—¶ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ï¼Œå–å‡ºçœŸå®å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜æå‰æš´éœ²å‡ºæ¥ã€‚</li><li>å½“å¯¹è±¡å®Œå…¨åˆ›å»ºå®Œæˆåï¼Œè°ƒç”¨ registerSingleton æ”¾å…¥ä¸€çº§ç¼“å­˜ï¼ŒåŒæ—¶ç§»é™¤äºŒçº§å’Œä¸‰çº§ç¼“å­˜ä¸­çš„å¼•ç”¨ã€‚</li></ul><h4 id="äº‹åŠ¡ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡ç®¡ç†"><span>äº‹åŠ¡ç®¡ç†</span></a></h4><p>ç¼–ç¨‹å¼ï¼štransactionManagerã€TransactionTemplate</p><p>å£°æ˜å¼ï¼š@Transactionalï¼ˆåŸºäºTransactionInterceptorï¼‰</p><ul><li>TransactionDefinitionï¼šäº‹åŠ¡å®šä¹‰ä¿¡æ¯ <ul><li>äº‹åŠ¡éš”ç¦»çº§åˆ«</li><li>ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶</li><li>åªè¯»</li><li>å›æ»šè§„åˆ™</li></ul></li><li>TransactionStatusï¼šäº‹åŠ¡è¿è¡ŒçŠ¶æ€ <ul><li>æ˜¯å¦å›æ»š</li><li>æš‚åœçš„å¤–éƒ¨äº‹åŠ¡</li><li>å¹¶ä¸”å°è£…äº†ä¸€ä¸ªå®é™…çš„äº‹åŠ¡å¯¹è±¡ï¼ˆConnectionï¼‰</li></ul></li><li>TransactionManagerï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼ŒSpring äº‹åŠ¡ç­–ç•¥çš„æ ¸å¿ƒç®¡ç†å™¨ã€‚ <ul><li>getTransaction()</li><li>commit()</li><li>rollback()</li></ul></li><li>TransactionSynchronizationManagerï¼šåŸºäºThreadLocalç»‘å®šçº¿ç¨‹äº‹åŠ¡ï¼Œä»¥åŠæä¾›ä¸€äº›å›è°ƒ</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TransactionSynchronizationManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å½“å‰çº¿ç¨‹å¼€å¯çŠ¶æ€çš„æ‰€æœ‰æ•°æ®åº“è¿æ¥ Map</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // keyæ˜¯DataSourceæ•°æ®æºå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // valueæ˜¯æ•°æ®åº“è¿æ¥ConnectionHolder</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resources </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NamedThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Transactional resources&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // äº‹åŠ¡åŒæ­¥å™¨é›†åˆï¼Œå¯æ‰©å±•çš„æ¥å£ï¼Œå®šä¹‰äº†è‹¥å¹²ä¸åŒäº‹ç‰©é˜¶æ®µçš„å›è°ƒ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Set</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TransactionSynchronization</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> synchronizations </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NamedThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Transaction synchronizations&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„"><span>æ•°æ®ç»“æ„</span></a></h2><h4 id="æ’åºç®—æ³•" tabindex="-1"><a class="header-anchor" href="#æ’åºç®—æ³•"><span>æ’åºç®—æ³•</span></a></h4><p>å†’æ³¡ $O(n^2)$, é€‰æ‹© $O(n^2)$, æ’å…¥ $O(n^2)$, å½’å¹¶ $O(nlogn)$, å¿«æ’ $O(nlogn)$, å †æ’ $O(nlogn)$</p><h4 id="æŸ¥æ‰¾ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾ç®—æ³•"><span>æŸ¥æ‰¾ç®—æ³•</span></a></h4><p>é¡ºåºæŸ¥æ‰¾ã€äºŒåˆ†æŸ¥æ‰¾ã€å“ˆå¸ŒæŸ¥æ‰¾ã€æ ‘è¡¨æŸ¥æ‰¾ï¼ˆäºŒå‰æ’åºæ ‘ã€å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘ï¼‰</p><h4 id="æ»¡äºŒå‰æ ‘å’Œå®Œå…¨äºŒå‰æ ‘" tabindex="-1"><a class="header-anchor" href="#æ»¡äºŒå‰æ ‘å’Œå®Œå…¨äºŒå‰æ ‘"><span>æ»¡äºŒå‰æ ‘å’Œå®Œå…¨äºŒå‰æ ‘</span></a></h4><p>æ»¡äºŒå‰æ ‘:æ¯ä¸€å±‚çš„èŠ‚ç‚¹æ•°éƒ½è¾¾åˆ°æœ€å¤§å€¼ï¼Œå³$2<sup>{h-1}$ä¸ªï¼Œå…¶ä¸­hæ˜¯æ ‘çš„é«˜åº¦ã€‚æ»¡äºŒå‰æ ‘çš„æ€»èŠ‚ç‚¹æ•°æ˜¯$2</sup>h-1$ä¸ªã€‚<br>å®Œå…¨äºŒå‰æ ‘:é™¤äº†æœ€åä¸€å±‚å¤–ï¼Œå…¶ä»–å±‚çš„èŠ‚ç‚¹æ•°éƒ½è¾¾åˆ°æœ€å¤§å€¼ï¼Œä¸”æœ€åä¸€å±‚çš„èŠ‚ç‚¹éƒ½è¿ç»­é›†ä¸­åœ¨æœ€å·¦è¾¹ã€‚æ€»èŠ‚ç‚¹æ•°åœ¨$2<sup>{h-1}$åˆ°$2</sup>h-1$ä¹‹é—´ã€‚</p><p>æ»¡äºŒå‰æ ‘ä¸€å®šæ˜¯å®Œå…¨äºŒå‰æ ‘ï¼Œä½†å®Œå…¨äºŒå‰æ ‘ä¸ä¸€å®šæ˜¯æ»¡äºŒå‰æ ‘ã€‚</p><h4 id="å›¾" tabindex="-1"><a class="header-anchor" href="#å›¾"><span>å›¾</span></a></h4><p>ä¸€ä¸ªå›¾å°±æ˜¯ä¸€äº›é¡¶ç‚¹çš„é›†åˆï¼Œè¿™äº›é¡¶ç‚¹é€šè¿‡ä¸€ç³»åˆ—è¾¹ç»“å¯¹ï¼ˆè¿æ¥ï¼‰ã€‚</p><p>å­˜å‚¨ç»“æ„ï¼šé‚»æ¥è¡¨ã€åå­—é“¾è¡¨ã€é‚»æ¥å¤šé‡è¡¨<br>Primç®—æ³•ï¼šé€‰å·²è¿é€šé›†åˆåˆ°æœªè¿é€šé›†åˆæœ€å°æƒå€¼è¾¹çš„é¡¶ç‚¹<br>Kruscalç®—æ³•ï¼šé€‰æœ€å°æƒå€¼è¾¹ï¼Œç›´åˆ°æ„æˆä¸€ä¸ªè¿é€šå›¾</p><h4 id="å“ˆå¸Œå†²çª" tabindex="-1"><a class="header-anchor" href="#å“ˆå¸Œå†²çª"><span>å“ˆå¸Œå†²çª</span></a></h4><ul><li>å¼€æ”¾å®šå€æ³•ï¼šä»å‘ç”Ÿå†²çªçš„é‚£ä¸ªå•å…ƒèµ·ï¼ŒæŒ‰ç…§ä¸€å®šçš„æ¬¡åºï¼Œä»å“ˆå¸Œè¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„å•å…ƒã€‚çº¿è¡Œæ¢æŸ¥æ³•ã€å¹³æ–¹æ¢æŸ¥æ³•ã€åŒæ•£åˆ—å‡½æ•°æ¢æŸ¥æ³•ã€‚</li><li>é“¾åœ°å€æ³•ï¼šå°†å“ˆå¸Œå€¼ç›¸åŒçš„å…ƒç´ æ„æˆä¸€ä¸ªåŒä¹‰è¯çš„å•é“¾è¡¨</li><li>å†å“ˆå¸Œæ³•</li><li>å…¬å…±æº¢å‡ºåŒº</li></ul><h4 id="å¸ƒéš†è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#å¸ƒéš†è¿‡æ»¤å™¨"><span>å¸ƒéš†è¿‡æ»¤å™¨</span></a></h4><p>èƒ½å¤Ÿå¿«é€Ÿæ£€ç´¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ç»™å®šçš„å¤§é›†åˆä¸­ï¼Œä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ä¸­æœ‰å¤šä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°ï¼Œ</p><ul><li>åŠ å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå–å“ˆå¸Œï¼Œå¯¹åº”ä½æ•°ç»„ä¸‹æ ‡ç½® 1</li><li>åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè®¡ç®—å“ˆå¸Œåˆ¤æ–­å¯¹åº”ä½æ˜¯å¦ä¸º 1ã€‚éƒ½ä¸º 1 åˆ™å¯èƒ½å­˜åœ¨ï¼Œåªè¦æœ‰ä¸€ä½é 1ï¼Œåˆ™ä¸€å®šä¸å­˜åœ¨</li></ul><p>ä½¿ç”¨åœºæ™¯ï¼šå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦å­˜åœ¨äºå¤§æ•°æ®é‡çš„é›†åˆä¸­ã€é˜²æ­¢ç¼“å­˜ç©¿é€ã€é‚®ç®±çš„åƒåœ¾è¿‡æ»¤ã€é»‘åå•åŠŸèƒ½ã€å»é‡ç­‰ã€‚</p><h2 id="è®¡ç½‘" tabindex="-1"><a class="header-anchor" href="#è®¡ç½‘"><span>è®¡ç½‘</span></a></h2><h3 id="åŸºç¡€" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€"><span>åŸºç¡€</span></a></h3><h4 id="tcp-ip-ç½‘ç»œæ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#tcp-ip-ç½‘ç»œæ¨¡å‹"><span>TCP/IP ç½‘ç»œæ¨¡å‹</span></a></h4><p>ç‰©æ•°ç½‘ä¼ ä¼šè¡¨åº”ã€‚å…¶ä¸­åªæœ‰åº”ç”¨å±‚åœ¨ç”¨æˆ·ç©ºé—´ï¼Œå…¶å®ƒå±‚éƒ½åœ¨ OS å†…æ ¸ä¸­ã€‚</p><ol><li><strong>åº”ç”¨å±‚</strong>ï¼šç½‘ç»œåº”ç”¨ç¨‹åºå’Œç½‘ç»œä¹‹é—´çš„æ¥å£</li><li><strong>è¡¨ç¤ºå±‚</strong>ï¼šè´Ÿè´£æŠŠæ•°æ®è½¬æ¢æˆå…¼å®¹å¦ä¸€ä¸ªç³»ç»Ÿèƒ½è¯†åˆ«çš„æ ¼å¼</li><li><strong>ä¼šè¯å±‚</strong>ï¼šè´Ÿè´£å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¡¨ç¤ºå±‚å®ä½“ä¹‹é—´çš„é€šä¿¡ä¼šè¯</li><li><strong>ä¼ è¾“å±‚</strong>ï¼šè´Ÿè´£ç«¯åˆ°ç«¯çš„æ•°æ®ä¼ è¾“</li><li><strong>ç½‘ç»œå±‚</strong>ï¼šè´Ÿè´£æ•°æ®çš„è·¯ç”±ã€è½¬å‘ã€åˆ†ç‰‡</li><li><strong>æ•°æ®é“¾è·¯å±‚</strong>ï¼šè´Ÿè´£æ•°æ®çš„å°å¸§å’Œå·®é”™æ£€æµ‹ï¼Œä»¥åŠ MAC å¯»å€ï¼›</li><li><strong>ç‰©ç†å±‚</strong>ï¼šè´Ÿè´£åœ¨ç‰©ç†ç½‘ç»œä¸­ä¼ è¾“æ•°æ®å¸§</li></ol><h4 id="é”®å…¥ç½‘å€åˆ°ç½‘é¡µæ˜¾ç¤º" tabindex="-1"><a class="header-anchor" href="#é”®å…¥ç½‘å€åˆ°ç½‘é¡µæ˜¾ç¤º"><span>é”®å…¥ç½‘å€åˆ°ç½‘é¡µæ˜¾ç¤º</span></a></h4><ol><li>å¯¹ URL ç½‘å€è¿›è¡Œè§£æï¼Œç”Ÿæˆ HTTP è¯·æ±‚æ¶ˆæ¯</li><li>è¿›è¡Œ DNS æŸ¥è¯¢ï¼šåŸŸå -&gt; IPåœ°å€</li><li>å’Œç›®æ ‡æœåŠ¡å™¨é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹ TCP è¿æ¥ã€‚è¿æ¥å»ºç«‹åï¼Œå°è£… TCP æŠ¥æ–‡ï¼Œäº¤ä»˜ç½‘ç»œå±‚</li><li>ç½‘ç»œå±‚å°è£…IPæ•°æ®åŒ…ï¼Œå†™å…¥æº IP åœ°å€ã€ç›®æ ‡ IP åœ°å€ã€åè®®ç­‰ä¿¡æ¯ï¼Œç„¶åäº¤ä»˜ç½‘ç»œæ¥å£å±‚</li><li>ç½‘ç»œæ¥å£å±‚é€šè¿‡ ARP åè®®è·å¾—ä¸‹ä¸€è·³ MAC åœ°å€ï¼Œå°è£…æ•°æ®å¸§å‘é€å‡ºå»ã€‚</li><li>æ•°æ®åŒ…ç»è¿‡è‹¥å¹²ä¸ªäº¤æ¢æœº/è·¯ç”±å™¨çš„è½¬å‘ï¼Œæ¥åˆ°ç›®æ ‡ IP æ‰€åœ¨çš„å­ç½‘ï¼Œå†äº¤ç»™ç›®æ ‡ IP å¯¹åº”çš„çš„æœåŠ¡å™¨</li><li>æœåŠ¡å™¨ä¸€å±‚å±‚è§£ææ•°æ®åŒ…ï¼Œæ ¹æ®ç«¯å£äº¤ä»˜ç»™å¯¹åº”çš„è¿›ç¨‹ã€‚</li><li>è¿›ç¨‹å°†å“åº”æ•°æ®å°è£…æˆ HTTP å“åº”æŠ¥æ–‡ï¼Œç„¶åä¹Ÿä¸€å±‚å±‚å°è£…ï¼Œå‘å›ç»™å®¢æˆ·ç«¯è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨ã€‚</li><li>å®¢æˆ·ç«¯çš„æµè§ˆå™¨å¯¹æ¥æ”¶åˆ°çš„æ•°æ®åŒ…è§£æï¼Œç„¶åæ¸²æŸ“æ•´ä¸ªç½‘é¡µçš„æ˜¾ç¤ºã€‚</li><li>æœ€åï¼Œå¦‚æœæ²¡æœ‰åˆ«çš„æ•°æ®è¯·æ±‚äº†ï¼ŒåŒæ–¹å°±è¿›è¡Œ TCP å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥</li></ol><h4 id="å†…æ ¸æ”¶å‘æ•°æ®åŒ…" tabindex="-1"><a class="header-anchor" href="#å†…æ ¸æ”¶å‘æ•°æ®åŒ…"><span>å†…æ ¸æ”¶å‘æ•°æ®åŒ…</span></a></h4><p>åº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œè·Ÿ Socket å±‚è¿›è¡Œæ•°æ®äº¤äº’ï¼Œç»è¿‡ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€ç½‘ç»œæ¥å£å±‚ï¼Œæœ€åç”±ç½‘å¡è´Ÿè´£æ¥æ”¶å’Œå‘é€ç½‘ç»œåŒ…ã€‚</p><p><strong>æ¥æ”¶</strong></p><ul><li>ç½‘å¡æ¥æ”¶åˆ°ä¸€ä¸ªç½‘ç»œåŒ…åï¼Œé€šè¿‡ DMA å†™å…¥ RingBuffer ç¯å½¢ç¼“å†²åŒº</li><li>æ¥ç€ç½‘å¡å‘ CPU å‘èµ·ç¡¬ä»¶ä¸­æ–­ï¼ˆå±è”½ä¸­æ–­ -&gt; è½¯ä¸­æ–­ -&gt; å–æ¶ˆå±è”½ï¼‰ï¼Œå”¤é†’æ•°æ®æ¥æ”¶æœåŠ¡ç¨‹åº</li><li>å†…æ ¸ä¸­çš„<code>ksoftirqd</code>çº¿ç¨‹è´Ÿè´£å¤„ç†è½¯ä¸­æ–­ï¼Œé€šè¿‡ poll æ–¹æ³•è½®è¯¢å¤„ç†æ•°æ®ï¼ˆä» RingBuffer å– sk_buff å¸§äº¤ç”±åè®®æ ˆï¼Œæ”¾å…¥ Socket æ¥æ”¶ç¼“å†²åŒºï¼‰</li><li>åº”ç”¨å±‚ç¨‹åºè°ƒç”¨ Socket æ¥å£ï¼Œå°†æ¥æ”¶ç¼“å†²åŒºæ•°æ®æ‹·è´åˆ°åº”ç”¨å±‚ç¼“å†²åŒºï¼Œç„¶åå”¤é†’ç”¨æˆ·è¿›ç¨‹</li></ul><p><strong>å‘é€</strong></p><ul><li>ç¨‹åºè°ƒç”¨ socket å‘é€æ•°æ®æ—¶ï¼Œå†…æ ¸ç”³è¯·ä¸€ä¸ªå†…æ ¸æ€çš„ sk_buff å†…å­˜ï¼Œå°†å¾…å‘é€æ•°æ®æ‹·è´åˆ° sk_buff ä¸­ï¼Œå¹¶åŠ å…¥å‘é€ç¼“å†²åŒº</li><li>ç½‘ç»œåè®®æ ˆä»å‘é€ç¼“å†²åŒºä¸­å–å‡º sk_buffï¼Œå‘ä¸‹é€å±‚å¤„ç†ï¼ˆå¯¹äº TCPï¼Œä¼šæ‹·è´ä¸€ä»½ sk_buff å‰¯æœ¬ä»¥æ”¯æŒé‡ä¼ ï¼‰</li><li>ç½‘å¡é©±åŠ¨ç¨‹åºä»å‘é€é˜Ÿåˆ—ä¸­è¯»å– sk_buffï¼ŒæŒ‚åˆ° RingBuffer ä¸­ï¼Œå¹¶å°†æ•°æ®æ˜ å°„åˆ° DMA å†…å­˜åŒºåŸŸï¼Œè§¦å‘çœŸå®å‘é€</li><li>å‘é€å®Œæˆåï¼Œç½‘å¡è§¦å‘ç¡¬ä¸­æ–­é‡Šæ”¾å†…å­˜ï¼ˆsk_buff å’Œ RingBufferï¼Œæ”¶åˆ° ACK åé‡Šæ”¾ TCP æ•°æ®åŒ…å¯¹åº”çš„åŸå§‹ sk_buffï¼‰</li></ul><p><strong>æœŸé—´å…±å‘ç”Ÿäº†ä¸‰æ¬¡å†…å­˜æ‹·è´ï¼š</strong><br>ç”¨æˆ·æ•°æ® -&gt; å†…æ ¸ sk_buff -&gt; TCP æ‹·è´ -&gt; sk_buff å¤§äº MTU æ—¶æ‹·è´æˆå¤šä»½å° sk_buff</p><h4 id="ç½‘ç»œåˆ†æ" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œåˆ†æ"><span>ç½‘ç»œåˆ†æ</span></a></h4><p>ä¸€èˆ¬ä½¿ç”¨ tcpdump åœ¨ Linux ä¸‹æŠ“å–æ•°æ®åŒ…å­˜å…¥ pcap æ–‡ä»¶ï¼Œç„¶ååˆ° Wireshark ä¸­è¿›è¡Œåˆ†æ</p><p><code>tcpdump -i &lt;eth0&gt; &lt;protocol&gt; and host &lt;ip&gt; -nn</code></p><ul><li>æ•°æ®æ ¼å¼ï¼š<code>æ—¶é—´æˆ³ åè®® æºåœ°å€.æºç«¯å£ &gt; ç›®çš„åœ°å€.ç›®çš„ç«¯å£ ç½‘ç»œåŒ…è¯¦æƒ…</code></li><li>æ•°æ®é“¾è·¯å±‚å¯ä»¥å¾—åˆ° æº MAC åœ°å€ã€ç›®æ ‡ MAC åœ°å€ã€ç±»å‹ç­‰</li><li>IP å±‚å¯ä»¥å¾—åˆ° æº IPã€ç›®çš„ IPã€TTLã€IP åŒ…é•¿åº¦ã€åè®®ç­‰å­—æ®µ</li></ul><h3 id="http" tabindex="-1"><a class="header-anchor" href="#http"><span>HTTP</span></a></h3><h4 id="http-åè®®" tabindex="-1"><a class="header-anchor" href="#http-åè®®"><span>HTTP åè®®</span></a></h4><p>è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œè¶…æ–‡æœ¬æŒ‡æ–‡å­—ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ç­‰ä¿¡æ¯ï¼Œä¼ è¾“æŒ‡åœ¨å¤šä¸ªè®¾å¤‡ä¹‹é—´ï¼Œåè®®æŒ‡è§„å®šäº†é€šä¿¡çš„æ–¹å¼ã€‚</p><p><strong>çŠ¶æ€ç </strong></p><ul><li>1xx æç¤ºä¿¡æ¯</li><li>2xx æˆåŠŸã€‚å¦‚ 200 OKï¼›204 No Content</li><li>3xx é‡å®šå‘ã€‚å¦‚ 301 æ°¸ä¹…é‡å®šå‘ï¼›304 èµ„æºæœªä¿®æ”¹</li><li>4xx å‘é€æŠ¥æ–‡æœ‰è¯¯ã€‚å¦‚ 400 è¯·æ±‚é”™è¯¯ï¼›404 èµ„æºä¸å­˜åœ¨</li><li>5xx æœåŠ¡å™¨å¤„ç†å‡ºé”™ã€‚å¦‚ 500 æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼›503 æœåŠ¡å™¨å¿™</li></ul><p><strong>å­—æ®µ</strong></p><ul><li>Host: æœåŠ¡å™¨åŸŸå</li><li>Content-Length: æœ¬æ¬¡å›åº”çš„æ•°æ®é•¿åº¦</li><li>Connection: æ˜¯å¦ä½¿ç”¨é•¿è¿æ¥ Keep-Aliveã€‚åªè¦ä»»æ„ä¸€ç«¯æ²¡æœ‰æå‡ºæ–­å¼€ï¼Œå°±ä¿æŒTCPè¿æ¥çŠ¶æ€</li><li>Content-Type: æœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯æœ¬æ¬¡æ•°æ®çš„æ ¼å¼ <code>Content-Type: text/html; Charset=utf-8</code></li><li>Accept: å®¢æˆ·ç«¯å£°æ˜è‡ªå·±æ¥æ”¶çš„æ•°æ®æ ¼å¼ï¼Œ<code>Accept: */*</code>è¡¨ç¤ºä»»æ„</li><li>Content-Encoding / Accept-Encoding: å‘é€ / å¯æ¥å—çš„å‹ç¼©æ ¼å¼</li></ul><h4 id="http-ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#http-ç¼“å­˜"><span>HTTP ç¼“å­˜</span></a></h4><ol><li>å¼ºåˆ¶ç¼“å­˜ï¼šæ ¹æ®å“åº”ä¸­çš„ Cache-Control (ç›¸å¯¹æ—¶é—´) å’Œ Expires (ç»å¯¹æ—¶é—´) åˆ¤æ–­è¯·æ±‚æ˜¯å¦è¿‡æœŸï¼Œæ²¡è¿‡æœŸç›´æ¥ä»ç¼“å­˜ä¸­å–å“åº”ç»“æœ</li><li>åå•†ç¼“å­˜ï¼šå¼ºåˆ¶ç¼“å­˜æ²¡æœ‰å‘½ä¸­æ—¶ï¼Œå¯ä»¥ä¸æœåŠ¡ç«¯åå•†ä¹‹åï¼Œé€šè¿‡åå•†ç»“æœæ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œä¸€èˆ¬å“åº” 304 å‘ŠçŸ¥ä½¿ç”¨ç¼“å­˜ã€‚ä¸¤ç§å¤´éƒ¨å®ç° <ul><li>Last-Modified å’Œ If-Modified-Since æ ¹æ®æ—¶é—´åˆ¤æ–­æ˜¯å¦æœ‰æ›´æ–°</li><li>Etag å’Œ If-None-Match æ ¹æ®å”¯ä¸€æ ‡è¯†åˆ¤æ–­ ï¼ˆç±»ä¼¼CASï¼‰</li></ul></li></ol><h4 id="http-ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#http-ä¼˜åŒ–"><span>HTTP ä¼˜åŒ–</span></a></h4><p><strong>å°½é‡é¿å…å‘é€ HTTP è¯·æ±‚</strong></p><p>å¯¹äºé‡å¤æ€§çš„ HTTP è¯·æ±‚ï¼Œé€šè¿‡ç¼“å­˜æŠ€æœ¯ï¼Œé¿å…å‘é€è¯·æ±‚ã€‚å…·ä½“çš„ï¼š</p><ul><li>å®¢æˆ·ç«¯æŠŠç¬¬ä¸€æ¬¡è¯·æ±‚ä»¥åŠå“åº”çš„æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜ä¸Šï¼Œkey æ˜¯ URLï¼Œvalue æ˜¯å“åº”</li><li>å“åº”è¿‡æœŸåï¼Œå†æ¬¡å‘é€è¯·æ±‚ä¼šåœ¨ Etag å¤´éƒ¨å¸¦ä¸Šå”¯ä¸€æ ‡è¯†å“åº”çš„æ‘˜è¦ï¼ŒæœåŠ¡å™¨å°†æ‘˜è¦å’Œæœ¬åœ°èµ„æºä½œæ¯”è¾ƒ</li><li>å¦‚æœä¸€è‡´ï¼Œå“åº” 304 Not Modifiedï¼Œæ— éœ€æºå¸¦æ•°æ®</li></ul><p><strong>å‡å°‘è¯·æ±‚æ¬¡æ•°</strong></p><ul><li>å‡å°‘é‡å®šå‘è¯·æ±‚æ¬¡æ•°ï¼š<br>å¦‚æœèµ„æºè½¬ç§»äº†ï¼Œä¸”ç”±ä»£ç†æœåŠ¡å™¨è½¬å‘ï¼Œå¯èƒ½äº§ç”Ÿå¤šæ¬¡é‡å®šå‘ã€‚è€Œå¦‚æœé‡å®šå‘çš„å·¥ä½œäº¤ç”±ä»£ç†æœåŠ¡å™¨å®Œæˆï¼Œå°±èƒ½å‡å°‘ HTTP è¯·æ±‚æ¬¡æ•°äº†</li><li>åˆå¹¶è¯·æ±‚ï¼š <ul><li>æŠŠå¤šä¸ªè®¿é—®å°æ–‡ä»¶çš„è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªå¤§çš„è¯·æ±‚ï¼Œå‡å°‘é‡å¤å‘é€çš„ HTTP å¤´éƒ¨</li><li>ä¾‹å¦‚å¯¹äºå¾ˆå¤šå°å›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ CSS Image Sprites åˆæˆä¸€ä¸ªå¤§å›¾ç‰‡ï¼›æœåŠ¡ç«¯ Webpack å·¥å…·æ‰“åŒ… js/css èµ„æºï¼›å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®ç”¨ Base64 ç¼–ç è·Ÿéš HTML ä¸€èµ·å‘é€</li><li>ä½†å¯èƒ½ä¸€ä¸ªå°èµ„æºå˜åŒ–åï¼Œå¿…é¡»é‡æ–°ä¸‹è½½æ•´ä¸ªå¤§èµ„æº</li></ul></li><li>å»¶è¿Ÿå‘é€è¯·æ±‚ï¼š <ul><li>æŒ‰éœ€ä¸‹è½½ï¼Œç”¨æˆ·æ»‘åŠ¨åˆ°æŸä¸ªå…ƒç´ æ‰åŠ è½½</li></ul></li></ul><p><strong>å‡å°‘å“åº”æ•°æ®çš„å¤§å°</strong></p><ul><li>æ— æŸå‹ç¼©ï¼šä¾‹å¦‚éœå¤«æ›¼ç¼–ç ã€gzipï¼Œé€‚ç”¨äºæ–‡æœ¬ã€ä»£ç ã€å¯æ‰§è¡Œæ–‡ä»¶ç­‰</li><li>æœ‰æŸå‹ç¼©ï¼šWebP/PNGã€H264/H265...ï¼Œé€‚ç”¨äºéŸ³é¢‘ã€è§†é¢‘ã€å›¾ç‰‡ç­‰</li></ul><h4 id="https-åè®®" tabindex="-1"><a class="header-anchor" href="#https-åè®®"><span>HTTPS åè®®</span></a></h4><p>HTTP é»˜è®¤ç«¯å£ 80ï¼ŒHTTPS é»˜è®¤ç«¯å£ 443ã€‚HTTPS åœ¨ TCP å’Œ HTTP ç½‘ç»œå±‚ä¹‹é—´åŠ å…¥äº† SSL/TLS å®‰å…¨åè®®ï¼Œä½¿å¾—æŠ¥æ–‡èƒ½å¤ŸåŠ å¯†ä¼ è¾“ã€‚</p><ul><li>æ··åˆåŠ å¯†ï¼šé€šä¿¡å»ºç«‹å‰åŸºäºéå¯¹ç§°åŠ å¯†çš„æ•°å­—è¯ä¹¦äº¤æ¢<code>ä¼šè¯ç§˜é’¥</code>ï¼Œé€šä¿¡è¿‡ç¨‹ä¸­åŸºäºå¯¹ç§°åŠ å¯†ç”¨<code>ä¼šè¯ç§˜é’¥</code>æ¥åŠ å¯†æ˜æ–‡æ•°æ®</li><li>æ‘˜è¦ç®—æ³•ï¼šé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—ä¼ è¾“å†…å®¹çš„æŒ‡çº¹ï¼Œä¿è¯æ¶ˆæ¯å®Œæ•´æ€§ã€‚</li><li>æ•°å­—è¯ä¹¦ï¼šå°†æœåŠ¡å™¨å…¬é’¥æ”¾åœ¨ CA æœºæ„çš„æ•°å­—è¯ä¹¦ä¸­ï¼Œåªè¦è¯ä¹¦æ˜¯å¯ä¿¡çš„ï¼Œå…¬é’¥å°±æ˜¯å¯ä¿¡çš„</li></ul><p>éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼šRSAã€DSAã€ECDHE...<br>å¯¹ç§°åŠ å¯†ç®—æ³•ï¼šDESã€AESã€RC5...<br>æ•£åˆ—æ‘˜è¦ç®—æ³•ï¼šSHA1ã€SHA256ã€MD5...</p><h5 id="tls-æ¡æ‰‹" tabindex="-1"><a class="header-anchor" href="#tls-æ¡æ‰‹"><span>TLS æ¡æ‰‹</span></a></h5><p><strong>RSA å¯†é’¥åå•†ç®—æ³•</strong></p><p>HTTP å®Œæˆ TCP è¿æ¥å»ºç«‹éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œ HTTPS è¿˜è¦è¿›è¡Œ SSL/TLS å››æ¬¡æ¡æ‰‹ï¼ˆ2ä¸ªRTTï¼‰ã€‚æ—§ç‰ˆ TLS ä½¿ç”¨ RSA ç®—æ³•å®ç°ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ - å®¢æˆ·ç«¯ï¼š<code>Client Hello</code> åŒ…æ‹¬ TLSç‰ˆæœ¬ + client_random + æ”¯æŒçš„å¯†ç å¥—ä»¶</li><li>ç¬¬äºŒæ¬¡ - æœåŠ¡ç«¯ï¼š<code>Server Hello</code> åŒ…æ‹¬ ç¡®è®¤ TLS ç‰ˆæœ¬ + server_random + é€‰æ‹©çš„å¯†ç å¥—ä»¶ï¼Œä»¥åŠ <code>Server Certificate</code> å†…å«æ•°å­—è¯ä¹¦ã€</li><li>ç¬¬ä¸‰æ¬¡ - å®¢æˆ·ç«¯ï¼š <ul><li><code>Client Key Exchange</code> å†…å«ç”¨æœåŠ¡ç«¯ RSA å…¬é’¥åŠ å¯†çš„æ–°éšæœºæ•° <code>pre-master</code></li><li>ç„¶ååŒæ–¹åŸºäºä¸‰ä¸ªéšæœºæ•°ç”ŸæˆåŸºäºå¯¹ç§°åŠ å¯†çš„ä¼šè¯å¯†é’¥ã€‚</li><li>æ¥ç€å‘é€ <code>Change Cipher Spec</code> å‘Šè¯‰æœåŠ¡ç«¯å¼€å§‹ä½¿ç”¨åŠ å¯†æ–¹å¼å‘é€æ¶ˆæ¯</li><li>æœ€åå‘é€ <code>Encrypted Hashshake Message (Finished)</code>ï¼Œå¯¹ä¹‹å‰çš„æ•°æ®åšä¸ªæ‘˜è¦å¹¶ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ï¼Œè®©æœåŠ¡å™¨åšéªŒè¯ï¼Œç¡®ä¿åŠ å¯†é€šä¿¡å®‰å…¨å¯ç”¨</li></ul></li><li>ç¬¬å››æ¬¡ - æœåŠ¡ç«¯ï¼šä¹Ÿå‘é€ <code>Change Cipher Spec</code> å’Œ <code>Encrypted Hashshake Message</code>ï¼ŒéªŒè¯åŠ å¯†é€šä¿¡å®‰å…¨å¯ç”¨</li></ul><p>RSA ç®—æ³•ç¼ºé™·ï¼šä¸æ”¯æŒå‰å‘ä¿å¯†ï¼Œä¸€æ—¦æœåŠ¡ç«¯ç§é’¥æ³„éœ²ï¼Œè¿‡å»æ‰€æœ‰è¢«æˆªè·çš„ TLS é€šä¿¡å¯†æ–‡éƒ½ä¼šè¢«ç ´è§£ã€‚å› æ­¤äº§ç”Ÿäº† ECDHE å¯†é’¥ç®—æ³•ã€‚</p><p><strong>æ”¹è¿›ï¼šECDHE å¯†é’¥åå•†ç®—æ³•</strong></p><ul><li>åŸºäºç¦»æ•£å¯¹æ•°ã€ECC æ¤­åœ†æ›²çº¿è®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥</li><li>æ”¯æŒå‰å‘ä¿å¯†</li></ul><h5 id="æ•°å­—è¯ä¹¦" tabindex="-1"><a class="header-anchor" href="#æ•°å­—è¯ä¹¦"><span>æ•°å­—è¯ä¹¦</span></a></h5><p>ç”¨æ¥è®¤è¯å…¬é’¥æŒæœ‰è€…çš„èº«ä»½ï¼Œé˜²æ­¢ç¬¬ä¸‰æ–¹è¿›è¡Œå†’å……ã€‚</p><ul><li>æ•°å­—è¯ä¹¦ = å…¬é’¥ + æŒæœ‰è€…ä¿¡æ¯ + CA æœºæ„ä¿¡æ¯ + CA å¯¹è¿™ä»½æ–‡ä»¶çš„æ•°å­—ç­¾åã€ç®—æ³•ã€æœ‰æ•ˆæœŸç­‰</li><li>å…¶ä¸­æ•°å­—ç­¾åç”± CA å¯¹æŒæœ‰è€…çš„ç›¸å…³ä¿¡æ¯ Hash åç”¨ CA ç§é’¥åŠ å¯†è€Œå¾—</li><li>å®¢æˆ·ç«¯ä»æœåŠ¡ç«¯æ‹¿åˆ°æ•°å­—è¯ä¹¦åï¼Œç”¨ CA å…¬é’¥è§£å¯†æ•°å­—ç­¾åï¼Œä¸æœåŠ¡ç«¯ä¿¡æ¯åšå¯¹æ¯”ï¼Œä¸€è‡´åˆ™æ˜¯å¯ä¿¡èµ–çš„</li></ul><h4 id="http-æ¼”è¿›" tabindex="-1"><a class="header-anchor" href="#http-æ¼”è¿›"><span>HTTP æ¼”è¿›</span></a></h4><p><img src="/img/HTTP%E6%BC%94%E8%BF%9B.webp#id=D7LAB&amp;originHeight=366&amp;originWidth=782&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>HTTP/1.1</strong></p><p>ä¼˜ç‚¹ï¼šç®€å•ã€çµæ´»ã€æ˜“äºæ‰©å±•ã€åº”ç”¨å¹¿æ³›ã€è·¨å¹³å°ã€‚ç›¸æ¯”äº1.0ï¼ŒHTTP/1.1 ä½¿ç”¨é•¿è¿æ¥å‡å°‘è¿æ¥å»ºç«‹é‡Šæ”¾çš„å¼€é”€ï¼Œæ”¯æŒç®¡é“åŒ–ä¼ è¾“ï¼Œå¯ä»¥ä¸€æ¬¡å‘èµ·å¤šä¸ªè¯·æ±‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— çŠ¶æ€ï¼Œå¾—ç”¨Cookieè§£å†³</li><li>ä¸å®‰å…¨ï¼šæ˜æ–‡ä¼ è¾“</li><li>æ€§èƒ½ä¸€èˆ¬ï¼šå­˜åœ¨å“åº”çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼ˆHTTP å®Œæˆä¸€ä¸ªè¯·æ±‚+å“åº”æ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªï¼‰</li></ul><p><strong>HTTP/2</strong></p><ul><li>åŸºäºHTTPSï¼Œå®‰å…¨æ€§å¾—åˆ°ä¿è¯</li><li>å¤´éƒ¨å‹ç¼©ï¼šHPack ç®—æ³•å‹ç¼© Header éƒ¨åˆ†å›ºå®šé‡å¤çš„å­—æ®µ</li><li>äºŒè¿›åˆ¶å¸§ï¼šåˆ†æ•°æ®å¸§å’Œæ§åˆ¶å¸§ä¸¤ç±»</li><li>å¤šè·¯å¤ç”¨ï¼šä¸€ä¸ª TCP è¿æ¥åŒ…å«å¤šä¸ª Streamï¼Œä¸åŒçš„ HTTP è¯·æ±‚é€šè¿‡ Stream ID åŒºåˆ†</li><li>æ”¯æŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼ˆå¶æ•°å· Streamï¼‰</li><li>ç¼ºé™·ï¼šç”±äºåŸºäºTCPï¼Œä»ç„¶å­˜åœ¨ TCP å±‚é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼ˆåªæœ‰å‰ä¸€ä¸ªå­—èŠ‚æ•°æ®åˆ°è¾¾ï¼Œåé¢çš„å­—èŠ‚æ•°æ®æ‰èƒ½ä»å†…æ ¸ç¼“å†²åŒºä¸­å–å‡ºï¼‰</li></ul><p><strong>HTTP/3</strong></p><p>ä½¿ç”¨åŸºäº UDP çš„ QUIC åè®®ï¼ˆä¸€ä¸ªåœ¨ UDP ä¹‹ä¸Šçš„ä¼ª TCP + TLS + HTTP/2 çš„å¤šè·¯å¤ç”¨åè®®ï¼‰ã€‚ç‰¹ç‚¹ï¼š</p><ul><li>å•å‘é€’å¢çš„ Packet Numberï¼Œé…åˆ StreamID å’Œ Offset å­—æ®µï¼Œæ”¯æŒä¹±åºç¡®è®¤è€Œä¸å½±å“æ•°æ®åŒ…çš„æ­£ç¡®ç»„è£…</li><li>æ— é˜Ÿå¤´é˜»å¡ï¼šå¤šä¸ª Stream ä¹‹é—´ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ã€‚æŸä¸ªæµå‘ç”Ÿä¸¢åŒ…ä»…å½±å“è¯¥æµ</li><li>æ›´å¿«çš„è¿æ¥å»ºç«‹ï¼šQUIC æœ¬èº«åŒ…å« TLS 1.3ï¼Œä¸€ä¸ª RTT å†…å°±å¯ä»¥å®Œæˆè¿æ¥å»ºç«‹å’Œå¯†é’¥åå•†</li><li>æ”¯æŒè¿æ¥è¿ç§»ï¼šé€šè¿‡<code>è¿æ¥ID</code>æ ‡è®°é€šä¿¡çš„ä¸¤ä¸ªç«¯ç‚¹ï¼Œé¿å…ç½‘ç»œåˆ‡æ¢åçš„æ¡æ‰‹ã€æ…¢å¯åŠ¨é€ æˆç½‘ç»œå¡é¡¿</li><li>ä¼˜åŒ– HTTP å±‚ï¼šç®€åŒ–å¸§ç»“æ„ã€QPack å‹ç¼©ç®—æ³•</li></ul><h4 id="get-å’Œ-post" tabindex="-1"><a class="header-anchor" href="#get-å’Œ-post"><span>Get å’Œ Post</span></a></h4><ul><li>Get çš„è¯­ä¹‰æ˜¯ä»æœåŠ¡å™¨è·å–æŒ‡å®šçš„èµ„æºï¼Œè¯·æ±‚çš„å‚æ•°ä¸€èˆ¬æ˜¯ä»¥ KV å½¢å¼å†™åœ¨ URL ä¸­ï¼ˆæµè§ˆå™¨ä¼šå¯¹ URL çš„é•¿åº¦æœ‰é™åˆ¶ï¼Œ HTTPåè®®æ²¡æœ‰ï¼‰</li><li>POST çš„è¯­ä¹‰æ˜¯æ ¹æ®è¯·æ±‚ä½“å¯¹æŒ‡å®šçš„èµ„æºåšå‡ºå¤„ç†ï¼Œè¯·æ±‚æºå¸¦çš„æ•°æ®ä¸€èˆ¬æ˜¯åœ¨æŠ¥æ–‡ body ä¸­ï¼Œæ ¼å¼ä»»æ„ï¼Œå¤§å°ä¸é™</li><li>Get æ–¹æ³•æ˜¯å®‰å…¨ä¸”å¹‚ç­‰çš„ï¼Œä¸ä¼šç ´åæœåŠ¡å™¨ä¸Šçš„èµ„æºï¼Œä¸”å¤šæ¬¡æ‰§è¡Œçš„ç»“æœç›¸åŒï¼ˆå› æ­¤ GET è¯·æ±‚çš„æ•°æ®å¯ä»¥ç¼“å­˜ï¼ŒPOST éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼‰ã€‚</li><li>Post æ–¹æ³•ä¸æ˜¯å®‰å…¨ï¼Œä¹Ÿä¸æ˜¯å¹‚ç­‰çš„ã€‚</li></ul><p>HTTP è¯·æ±‚éƒ½æ˜¯æ˜æ–‡ï¼Œå› æ­¤GET/POSTéƒ½ä¸å®‰å…¨ï¼Œæ­¤å¤–GETæ²¡æœ‰è§„å®šä¸èƒ½æºå¸¦è¯·æ±‚ä½“ï¼ŒPOSTè¯·æ±‚URLä¹Ÿå¯ä»¥æœ‰å‚æ•°ã€‚</p><h4 id="å¯¹æ¯”-rpc" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”-rpc"><span>å¯¹æ¯” RPC</span></a></h4><p>çº¯è£¸ TCP å¯ä»¥æ”¶å‘æ•°æ®ï¼Œä½†å®ƒæ˜¯ä¸ªæ— è¾¹ç•Œçš„æ•°æ®æµï¼Œä¸Šå±‚éœ€è¦å®šä¹‰æ¶ˆæ¯æ ¼å¼ç”¨äºå®šä¹‰æ¶ˆæ¯è¾¹ç•Œã€‚äºæ˜¯å°±æœ‰äº†å„ç§åè®®ï¼ŒHTTP å’Œå„ç±» RPC åè®®å°±æ˜¯åœ¨ TCP ä¹‹ä¸Šå®šä¹‰çš„åº”ç”¨å±‚åè®®ã€‚RPCæœ¬è´¨ä¸Šæ˜¯ä¸€ç§è°ƒç”¨æ–¹å¼ï¼Œå…·ä½“çš„å®ç° gRPC/Thrift æ‰æ˜¯åè®®ï¼Œç›®çš„æ˜¯å¸Œæœ›ç¨‹åºå‘˜èƒ½åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•é‚£æ ·å»è°ƒç”¨è¿œç«¯çš„æœåŠ¡æ–¹æ³•ã€‚å½“ç„¶ RPC ä¹Ÿä¸ä¸€å®šéå¾—åŸºäº TCPã€‚</p><p>åŒºåˆ«ï¼š</p><ul><li>æœåŠ¡å‘ç°ï¼šRPCä¸€èˆ¬æœ‰ä¸“é—¨çš„ä¸­é—´æœåŠ¡ï¼Œå¦‚ Zookeeper æ¥ä¿å­˜æœåŠ¡åå’ŒIPä¿¡æ¯ï¼ˆHTTPå½“ç„¶ä¹Ÿèƒ½å®ç°ï¼‰</li><li>åº•å±‚è¿æ¥å½¢å¼ï¼šRPCä½¿ç”¨è¿æ¥æ± </li><li>ä¼ è¾“å†…å®¹ï¼šHTTPæŠ¥æ–‡éå¸¸å†—ä½™ï¼Œè€ŒRPCå®šåˆ¶åŒ–ç¨‹åº¦é«˜ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ã€‚å› æ­¤å†…ç½‘æœåŠ¡ä¹‹é—´é€šå¸¸ä½¿ç”¨ RPCã€‚</li></ul><p>ä¸è¿‡ï¼ŒHTTP/2 é€šè¿‡å‹ç¼©åšäº†å¾ˆå¤šæ”¹è¿›ï¼Œæ€§èƒ½ç”šè‡³ä¼˜äºRPCï¼Œä¾‹å¦‚ gRPC åŸºäº HTTP/2 å®ç°ã€‚ä½†ç”±äºå†å²åŸå› ï¼ŒRPCä»åœ¨ä½¿ç”¨ã€‚</p><h3 id="tcp" tabindex="-1"><a class="header-anchor" href="#tcp"><span>TCP</span></a></h3><h4 id="tcp-udp-åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#tcp-udp-åŒºåˆ«"><span>TCP/UDP åŒºåˆ«</span></a></h4><ul><li>TCPæ˜¯æœ‰è¿æ¥çš„ã€é¢å‘å­—èŠ‚æµçš„å¯é ä¼ è¾“åè®®ã€‚</li><li>UDPæ˜¯æ— è¿æ¥çš„ï¼Œé¢å‘æ•°æ®æŠ¥çš„åè®®ï¼Œå°½æœ€å¤§åŠªåŠ›äº¤ä»˜ï¼Œä¸ä¿è¯å¯é ä¼ è¾“ã€‚</li><li>TCPæä¾›æµé‡æ§åˆ¶ï¼Œå³æºç«¯é€šè¿‡æ»‘åŠ¨çª—å£æ¥å‘Šè¯‰å¯¹ç«¯è‡ªå·±çš„å‘é€çª—å£å¤§å°ï¼Œä»è€Œæ§åˆ¶å¯¹ç«¯å‘é€æ•°æ®çš„é€Ÿåº¦ï¼›UDPæ²¡æœ‰æµé‡æ§åˆ¶ã€‚</li><li>TCPæä¾›æ‹¥å¡æ§åˆ¶ï¼Œå³å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼ŒTCPä¼šé™ä½è‡ªå·±çš„å‘é€é€Ÿåº¦ï¼Œä»è€Œé¿å…ç½‘ç»œæ‹¥å¡çš„æ¶æ€§å¾ªç¯ï¼›UDPæ²¡æœ‰æ‹¥å¡æ§åˆ¶ã€‚</li><li>TCPå¼€é”€å¤§ï¼Œå¤´éƒ¨è‡³å°‘20ä¸ªå­—èŠ‚ï¼Œè€ŒUDPå¤´éƒ¨å›ºå®šåªæœ‰8ä¸ªå­—èŠ‚ã€‚</li></ul><h4 id="ä¸‰æ¬¡æ¡æ‰‹" tabindex="-1"><a class="header-anchor" href="#ä¸‰æ¬¡æ¡æ‰‹"><span>ä¸‰æ¬¡æ¡æ‰‹</span></a></h4><p><img src="/img/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png#id=N9ti5&amp;originHeight=1081&amp;originWidth=1296&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>è¿‡ç¨‹ï¼š</strong></p><ul><li>é¦–å…ˆæœåŠ¡ç«¯ä¸»åŠ¨ç›‘å¬æŸä¸ªç«¯å£ï¼Œå¤„äº Listen çŠ¶æ€</li><li>å®¢æˆ·ç«¯éšæœºä¸€ä¸ªåºåˆ—å·ï¼Œå¹¶å‘é€ SYN æŠ¥æ–‡ç»™æœåŠ¡ç«¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯å¤„äº SYN-SENT çŠ¶æ€</li><li>æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ SYN æŠ¥æ–‡åï¼Œä¹Ÿéšæœºä¸€ä¸ªåºåˆ—å·ï¼Œç„¶åå‘é€ SYN+ACK æŠ¥æ–‡ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”ç¡®è®¤å®¢æˆ·ç«¯æŠ¥æ–‡çš„åºåˆ—å·ã€‚æ­¤æ—¶æœåŠ¡ç«¯å¤„äº SYN-RCVD çŠ¶æ€</li><li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯æŠ¥æ–‡åï¼Œåºåˆ—å·+1ï¼Œå†æ¬¡å‘æœåŠ¡ç«¯å›åº”ä¸€ä¸ª ACK æŠ¥æ–‡ï¼ŒåŒæ—¶ç¡®è®¤æœåŠ¡ç«¯æŠ¥æ–‡çš„åºåˆ—å·ã€‚æ­¤æ¬¡æŠ¥æ–‡å·²ç»å¯ä»¥æºå¸¦æ•°æ®äº†ã€‚ä¹‹åå®¢æˆ·ç«¯å¤„äº ESTABLISHED çŠ¶æ€</li><li>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯åº”ç­”æŠ¥æ–‡åï¼Œä¹Ÿè¿›å…¥ Established çŠ¶æ€ã€‚ä¸‰æ¬¡æ¡æ‰‹å®Œæˆã€‚</li></ul><p>TCP é€šè¿‡ (æºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£) è¿™æ ·çš„å››å…ƒç»„æ¥å”¯ä¸€ç¡®å®šä¸€æ¡è¿æ¥ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼š</strong></p><ul><li>é¦–è¦åŸå› æ˜¯é˜²æ­¢æ—§çš„ï¼ˆé˜»å¡åœ¨ç½‘ç»œä¸­ï¼‰é‡å¤è¿æ¥åˆå§‹åŒ–é€ æˆæ··ä¹±ã€‚å¦‚æœåªæœ‰ä¸¤æ¬¡æ¡æ‰‹ï¼ŒæœåŠ¡ç«¯æ²¡æœ‰ä¸­é—´çŠ¶æ€ç»™å®¢æˆ·ç«¯æ¥é˜»æ­¢æ—§è¿æ¥ï¼Œå¯¼è‡´è¿æ¥é‡Šæ”¾åæœåŠ¡ç«¯åˆå»ºç«‹ä¸€ä¸ªæ—§è¿æ¥ï¼Œé€ æˆèµ„æºæµªè´¹ã€‚</li><li>åŒæ­¥åŒæ–¹çš„åˆå§‹åºåˆ—å·ï¼Œä¸¤æ¬¡æ¡æ‰‹åªèƒ½ä¿è¯æœåŠ¡ç«¯ç¡®è®¤äº†å®¢æˆ·ç«¯çš„åºåˆ—å·ï¼Œä¸èƒ½ä¿è¯å®¢æˆ·ç«¯ç¡®è®¤äº†æœåŠ¡ç«¯çš„åºåˆ—å·ã€‚</li></ul><p><strong>æ¡æ‰‹ä¸¢å¤±</strong></p><ul><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ SYN ä¸¢å¤±: è§¦å‘è¶…æ—¶é‡ä¼ ï¼ŒLinux ä¼šé‡ä¼  5 æ¬¡ï¼Œä¸”è¶…æ—¶æ—¶é—´ RTO å‘ˆæŒ‡æ•°ä¸Šæ¶¨ï¼ˆç¿»å€ 1 -&gt; 3 -&gt; 7 -&gt; 15 -&gt; 31ï¼‰</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹ SYN + ACK ä¸¢å¤±ï¼šå®¢æˆ·ç«¯é‡ä¼  SYNï¼ŒæœåŠ¡ç«¯é‡ä¼  SYN + ACKï¼Œä¸€ç›´é‡ä¼ è‡³æœ€å¤§æ¬¡æ•°</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ ACK ä¸¢å¤±ï¼šæœåŠ¡ç«¯å¤„äº SYN_RECV çŠ¶æ€ï¼Œä¸€ç›´é‡ä¼  SYN + ACK ç›´è‡³æœ€å¤§æ¬¡æ•°åæ–­å¼€è¿æ¥ã€‚å®¢æˆ·ç«¯å¤„äº Established çŠ¶æ€ï¼Œç”±äº TCP ä¿æ´»æœºåˆ¶ï¼Œå¯èƒ½æŒç»­ 2 å°æ—¶æ‰ä¼šå‘ç°è¯¥è¿æ¥å·²å¤±æ•ˆï¼Œè€Œå¦‚æœå®¢æˆ·ç«¯å·²ç»å‘é€æ•°æ®äº†ï¼Œä¼šä¸€ç›´é‡ä¼ æ•°æ®åŒ…ç›´è‡³æœ€å¤§æ¬¡æ•°ï¼ˆé»˜è®¤ 15 æ¬¡ï¼‰</li></ul><p>æ³¨ï¼š</p><ul><li>æ‰€æœ‰é‡ä¼ æ¬¡æ•°éƒ½æœ‰<code>/proc/sys/net/ipv4/</code>ä¸‹çš„å†…æ ¸å‚æ•°é™å®š</li><li>ç½‘ç»œåŒ…è¿›ä¸»æœºé¡ºåºï¼šWire -&gt; NIC -&gt; tcpdump -&gt; netfilter/iptablesï¼ˆé˜²ç«å¢™ï¼‰</li><li>ç½‘ç»œåŒ…å‡ºä¸»æœºé¡ºåºï¼šiptables -&gt; tcpdump -&gt; NIC -&gt; Wire</li></ul><h4 id="å››æ¬¡æŒ¥æ‰‹" tabindex="-1"><a class="header-anchor" href="#å››æ¬¡æŒ¥æ‰‹"><span>å››æ¬¡æŒ¥æ‰‹</span></a></h4><p><img src="/img/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png#id=kVjem&amp;originHeight=794&amp;originWidth=753&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>è¿‡ç¨‹ï¼š</strong></p><ul><li>å®¢æˆ·ç«¯æ‰“ç®—å…³é—­è¿æ¥æ—¶ï¼Œä¼šå‘é€ä¸€ä¸ª FIN æŠ¥æ–‡ï¼Œä¹‹åå®¢æˆ·ç«¯è¿›å…¥ FIN_WAIT_1 çŠ¶æ€ã€‚</li><li>æœåŠ¡ç«¯æ”¶åˆ°è¯¥æŠ¥æ–‡åï¼Œå›å¤ä¸€ä¸ª ACK åº”ç­”ï¼Œè¿›å…¥ CLOSE_WAIT çŠ¶æ€ã€‚</li><li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ ACK åº”ç­”åï¼Œè¿›å…¥ FIN_WAIT_2 çŠ¶æ€ã€‚</li><li>ç­‰æœåŠ¡ç«¯å¤„ç†å®Œæ•°æ®åï¼Œä¹Ÿå‘å®¢æˆ·ç«¯å‘é€ FIN æŠ¥æ–‡ï¼Œä¹‹åæœåŠ¡ç«¯è¿›å…¥ LAST_ACK çŠ¶æ€ã€‚</li><li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ FIN æŠ¥æ–‡åï¼Œä¹Ÿå›å¤ä¸€ä¸ª ACK åº”ç­”ï¼Œä¹‹åè¿›å…¥ TIME_WAIT çŠ¶æ€</li><li>æœåŠ¡ç«¯æ”¶åˆ°äº† ACK åº”ç­”æŠ¥æ–‡åï¼Œå°±è¿›å…¥äº† CLOSE çŠ¶æ€ï¼Œè‡³æ­¤æœåŠ¡ç«¯å·²ç»å®Œæˆè¿æ¥çš„å…³é—­ã€‚</li><li>å®¢æˆ·ç«¯åœ¨ç»è¿‡ 2MSLï¼ˆæœ€å¤§æŠ¥æ–‡ç”Ÿå­˜æ—¶é—´ï¼ŒLinuxä¸­ä¸º30sï¼‰ æ—¶é—´åï¼Œè‡ªåŠ¨è¿›å…¥ CLOSE çŠ¶æ€ï¼Œè‡³æ­¤å®¢æˆ·ç«¯ä¹Ÿå®Œæˆè¿æ¥çš„å…³é—­ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿ</strong></p><ul><li>å…³é—­è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ FIN æ—¶ï¼Œä»…ä»…è¡¨ç¤ºå®¢æˆ·ç«¯ä¸å†å‘é€æ•°æ®äº†ä½†æ˜¯è¿˜èƒ½æ¥æ”¶æ•°æ®ã€‚</li><li>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ FIN æŠ¥æ–‡æ—¶ï¼Œå…ˆå›ä¸€ä¸ª ACK åº”ç­”æŠ¥æ–‡ï¼Œè€ŒæœåŠ¡ç«¯å¯èƒ½è¿˜æœ‰æ•°æ®éœ€è¦å¤„ç†å’Œå‘é€ï¼Œç­‰æœåŠ¡ç«¯æŠŠè¿™äº›æ•°æ®éƒ½å¤„ç†å‘é€å®Œï¼Œæ‰å‘é€ FIN æŠ¥æ–‡ç»™å®¢æˆ·ç«¯æ¥è¡¨ç¤ºç°åœ¨åŒæ„å…³é—­è¿æ¥ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯è¦ç­‰å¾…æœåŠ¡ç«¯æŠŠæ‰‹ä¸Šçš„æ•°æ®å¤„ç†å‘é€å®Œå†å…³é—­ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ TIME_WAIT çŠ¶æ€ï¼Ÿ</strong></p><ul><li>ç­‰å¾… 2MSL è®©ä¸¤ä¸ªæ–¹å‘ä¸Šç°æœ‰çš„æ•°æ®åŒ…éƒ½è¢«ä¸¢å¼ƒï¼Œä½¿å¾—æ—§è¿æ¥çš„æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­éƒ½è‡ªç„¶æ¶ˆå¤±ï¼Œé˜²æ­¢è¢«åé¢ç›¸åŒå››å…ƒç»„çš„æ–°è¿æ¥é”™è¯¯çš„æ¥æ”¶</li><li>ç­‰å¾…è¶³å¤Ÿçš„æ—¶é—´ä»¥ç¡®ä¿ç¬¬å››æ¬¡æŒ¥æ‰‹çš„ ACK èƒ½è®©æœåŠ¡ç«¯æ¥æ”¶ï¼Œä»è€Œå¸®åŠ©å…¶æ­£å¸¸å…³é—­</li></ul><p>TIME_WAIT ä¼šå ç”¨ç³»ç»Ÿèµ„æºï¼Œå› æ­¤åœ¨é«˜å¹¶å‘ä¸‹å¯ä»¥é€‚å½“è°ƒæ•´è¯¥æ—¶é—´ï¼Œé¿å…èµ„æºæµªè´¹å’Œè¿æ¥å»¶è¿Ÿã€‚ä¾‹å¦‚å¼€å¯ tcp_tw_reuse é‡ç”¨å¤„äº TIME_WAIT çŠ¶æ€çš„è¿æ¥ï¼Œå¹¶å¼€å¯ PAWS é˜²å›ç»•æ—¶é—´æˆ³ï¼ˆåŒæ–¹ç»´æŠ¤æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°æ•°æ®åŒ…çš„æ—¶é—´æˆ³ï¼‰</p><p><strong>ä¸‰æ¬¡æŒ¥æ‰‹</strong></p><p>å¦‚æœç¬¬ä¸€æ¬¡æŒ¥æ‰‹åï¼Œå¦‚æœè¢«åŠ¨å…³é—­æ–¹æ¥æ”¶åˆ° FIN ä¸”æ²¡æœ‰æ•°æ®è¦ç»§ç»­å‘é€ï¼ŒåŒæ—¶å¼€å¯äº† TCP å»¶è¿Ÿç¡®è®¤æœºåˆ¶ï¼Œé‚£ä¹ˆç¬¬äºŒã€ä¸‰æ¬¡æŒ¥æ‰‹ ACK+FIN å¯ä»¥åˆå¹¶ä¼ è¾“ï¼Œå®ç°ä¸‰æ¬¡æŒ¥æ‰‹ã€‚</p><p>TCP å»¶è¿Ÿç¡®è®¤ï¼šæ²¡æœ‰å“åº”æ•°æ®è¦å‘é€æ—¶ï¼ŒACK å°†å»¶è¿Ÿä¸€æ®µæ—¶é—´éšæ•°æ®ä¸€å—å‘é€ï¼Œä»¥æé«˜ç½‘ç»œæ•ˆç‡ã€‚</p><h4 id="é‡ä¼ æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é‡ä¼ æœºåˆ¶"><span>é‡ä¼ æœºåˆ¶</span></a></h4><p><strong>è¶…æ—¶é‡ä¼ ï¼š</strong><br>åœ¨å‘é€æ•°æ®æ—¶ï¼Œè®¾å®šä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“è¶…è¿‡æŒ‡å®šçš„æ—¶é—´åï¼Œæ²¡æœ‰æ”¶åˆ°å¯¹æ–¹çš„ ACK ç¡®è®¤åº”ç­”æŠ¥æ–‡ï¼ˆæ•°æ®åŒ…ä¸¢å¤±/ç¡®è®¤åº”ç­”ä¸¢å¤±ï¼‰ï¼Œå°±ä¼šé‡å‘è¯¥æ•°æ®ã€‚</p><p>é—®é¢˜ï¼šè¶…æ—¶é‡ä¼ æ—¶é—´ RTO çš„è®¾å®šï¼Œç†è®ºä¸Šåº”ç•¥å¤§äº RTTã€‚ä½†RTTæ— æ³•å‡†ç¡®è®¡ç®—ï¼ŒLinuxé‡‡ç”¨åŠ æƒç§»åŠ¨å¹³å‡ï¼Œé‡‡æ ·ä¼°è®¡ã€‚</p><p><strong>å¿«é€Ÿé‡ä¼ ï¼š</strong><br>å½“æ”¶åˆ°ä¸‰ä¸ªç›¸åŒçš„ ACK æŠ¥æ–‡æ—¶ï¼Œä¼šåœ¨å®šæ—¶å™¨è¿‡æœŸä¹‹å‰ï¼Œé‡ä¼ ä¸¢å¤±çš„æŠ¥æ–‡æ®µã€‚</p><p>é—®é¢˜ï¼šé‡ä¼ æ—¶æ˜¯é‡ä¼ ä¸€ä¸ªè¿˜æ˜¯é‡ä¼ æ‰€æœ‰å·²ç»å‘å‡ºå»çš„æ•°æ®åŒ…ï¼Œåªé‡ä¼ ä¸€ä¸ªå¯èƒ½é€ æˆå»¶è¿Ÿé‡ä¼ ï¼Œé‡ä¼ æ‰€æœ‰å¯èƒ½æµªè´¹ç½‘ç»œèµ„æº</p><p><strong>SACK: Selective ACK</strong><br>åœ¨ TCP å¤´éƒ¨ã€Œé€‰é¡¹ã€å­—æ®µé‡ŒåŠ ä¸€ä¸ª SACKï¼Œå°†å·²æ”¶åˆ°çš„æ•°æ®ä¿¡æ¯å‘ç»™ã€Œå‘é€æ–¹ã€ï¼Œè¿™æ ·å‘é€æ–¹å°±å¯ä»¥åªé‡ä¼ ä¸¢å¤±çš„æ•°æ®ã€‚</p><p><strong>Duplicate SACKï¼š</strong><br>ä½¿ç”¨ SACK æ¥å‘Šè¯‰ã€Œå‘é€æ–¹ã€æœ‰å“ªäº›æ•°æ®è¢«é‡å¤æ¥æ”¶äº†ï¼Œè¿™æ ·ã€Œå‘é€æ–¹ã€å°±çŸ¥é“æ•°æ®æ²¡æœ‰ä¸¢ï¼Œæ˜¯ã€Œæ¥æ”¶æ–¹ã€çš„ ACK ç¡®è®¤æŠ¥æ–‡ä¸¢äº†ã€‚</p><h4 id="æµé‡æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#æµé‡æ§åˆ¶"><span>æµé‡æ§åˆ¶</span></a></h4><p>æµé‡æ§åˆ¶æ˜¯ä¸ºäº†é¿å…ã€Œå‘é€æ–¹ã€çš„æ•°æ®å¡«æ»¡ã€Œæ¥æ”¶æ–¹ã€çš„ç¼“å­˜ï¼Œå¹¶ä¸æ¶‰åŠæ•´ä½“ç½‘ç»œä¸­çš„æµé‡ã€‚</p><p><strong>æ»‘åŠ¨çª—å£ï¼š</strong></p><p>ä¸ºäº†æé«˜ç½‘ç»œçš„ä¼ è¾“æ•ˆç‡ï¼Œå¼•å…¥æ»‘åŠ¨çª—å£ï¼ŒåŒæ–¹å„è‡ªç»´æŠ¤å‘é€çª—å£å’Œæ¥æ”¶çª—å£ã€‚åœ¨å‘é€çª—å£èŒƒå›´å†…çš„æ•°æ®éƒ½å¯ä»¥å‘é€å‡ºå»ï¼Œçª—å£åå»¶ä¹‹å¤–çš„æ•°æ®éƒ½æ˜¯æš‚æ—¶ä¸èƒ½å‘é€çš„æ•°æ®ã€‚éšç€æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œçª—å£ä¼šå‘åç§»åŠ¨ã€‚</p><p>ä¸€èˆ¬ç”±æ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥ç”¨äºæ¥æ”¶æ•°æ®ï¼Œå‘é€æ–¹æ ¹æ®æ¥æ”¶æ–¹çš„å¤„ç†èƒ½åŠ›è°ƒæ•´çª—å£å¤§å°ã€‚ä½†åŒæ–¹çª—å£åªæ˜¯è¿‘ä¼¼ç›¸ç­‰ï¼Œä¼ è¾“è¿‡ç¨‹å­˜åœ¨å»¶è¿Ÿï¼Œçª—å£ä¹Ÿæ—¶åˆ»åœ¨å˜åŒ–ã€‚å‘é€çª—å£ = min(æ‹¥å¡çª—å£ï¼Œæ¥æ”¶çª—å£)</p><p><strong>ä¼˜åŒ–ç‚¹</strong></p><ol><li>ä¸ºäº†é˜²æ­¢èµ„æºç´§å¼ æ—¶ï¼Œæ“ä½œç³»ç»Ÿå‡å°ç¼“å­˜ï¼ŒåŒæ—¶æ”¶ç¼©çª—å£ï¼Œå¯¼è‡´ä¸¢åŒ…å’Œçª—å£å˜è´Ÿå€¼çš„æƒ…å†µï¼ŒTCPè§„å®šå¿…é¡»å…ˆæ”¶ç¼©çª—å£ï¼Œå†å‡å°‘ç¼“å­˜ã€‚çª—å£ç¼©å‡ä¸º0åï¼Œéœ€è¦å®šæ—¶å‘é€çª—å£æ¢æµ‹æŠ¥æ–‡ï¼Œç¡®è®¤å½“å‰çª—å£å¤§å°ï¼Œé¿å…åŒæ–¹æŒä¹…ç­‰å¾…ã€‚</li><li>ç³Šæ¶‚çª—å£ç»¼åˆå¾ï¼šå‘é€æ–¹ä¸ºäº†å¡«æ»¡æ¥æ”¶æ–¹å‡ ä¸ªå­—èŠ‚çš„çª—å£ï¼Œå‘é€ä¸€æ•´ä¸ª TCP æŠ¥æ–‡ï¼Œè€Œ TCP + IP é¦–éƒ¨å°±æœ‰40å­—èŠ‚ï¼Œä¼šé€ æˆæå¤§èµ„æºæµªè´¹ã€‚</li></ol><ul><li>æ¥æ”¶æ–¹åœ¨çª—å£å°äº min(MSS, 0.5*cache) æ—¶ï¼Œå°±å‘é€0çª—å£é€šå‘Š</li><li>Nagle å»¶è¿Ÿå¤„ç†ç®—æ³•ï¼šå¿…é¡»ç­‰çª—å£ &gt;=MSS ä¸”æ•°æ®å¤§å° &gt;= MSSï¼Œæˆ–è€…æ”¶åˆ°ä¹‹å‰å‘é€æ•°æ®çš„ ACKï¼Œæ‰ä¼šç»§ç»­å‘é€ï¼›å¦åˆ™ä¸€ç›´å›¤ç§¯æ•°æ®ã€‚</li><li>æ¥æ”¶æ–¹ä¸é€šå‘Šå°çª—å£ + å‘é€æ–¹å¼€å¯ Nagle ç®—æ³•ï¼Œæ‰èƒ½é¿å…ç³Šæ¶‚çª—å£ç»¼åˆç—‡ã€‚</li></ul><h4 id="æ‹¥å¡æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#æ‹¥å¡æ§åˆ¶"><span>æ‹¥å¡æ§åˆ¶</span></a></h4><p>æ‹¥å¡æ§åˆ¶æ˜¯ä¸ºäº†é¿å…ã€Œå‘é€æ–¹ã€çš„æ•°æ®å¡«æ»¡æ•´ä¸ªç½‘ç»œï¼Œç”±å‘é€æ–¹ç»´æŠ¤ï¼Œæ ¹æ®ç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦åŠ¨æ€å˜åŒ–ã€‚ï¼ˆä»¥ä¸‹çª—å£å¤§å°çš„å•ä½éƒ½æ˜¯ MSSï¼Œè€Œä¸æ˜¯ä¸ªï¼‰</p><p><strong>æ…¢å¯åŠ¨</strong></p><p>æŒ‡åœ¨åˆšåˆšåŠ å…¥ç½‘ç»œçš„è¿æ¥ä¸­ï¼Œä¸€ç‚¹ä¸€ç‚¹åœ°æé€Ÿï¼Œä¸è¦ä¸€ä¸Šæ¥å°±æŠŠé“¾è·¯å æ»¡ã€‚å¼€å§‹å…ˆåˆå§‹åŒ–cwnd = 1ï¼Œè¡¨æ˜å¯ä»¥ä¼ ä¸€ä¸ªMSSå¤§å°çš„æ•°æ®ã€‚æ¯å½“æ”¶åˆ°ä¸€ä¸ªACKï¼Œcwnd+1ï¼›ä¹Ÿå°±æ˜¯è¯´æ¯ç»è¿‡ä¸€ä¸ªRTTï¼Œcwnd = cwnd*2ï¼Œå‘ˆæŒ‡æ•°ä¸Šå‡ã€‚é˜ˆå€¼ssthreshï¼ˆslow start thresholdï¼‰æ…¢å¯åŠ¨é—¨é™æ˜¯ä¸€ä¸ªä¸Šé™ï¼Œå½“cwnd &gt;= ssthreshæ—¶ï¼Œå°±ä¼šè¿›å…¥æ‹¥å¡é¿å…ç®—æ³•ã€‚</p><p><strong>æ‹¥å¡é¿å…</strong></p><p>cwndè¶…è¿‡æ…¢å¯åŠ¨é—¨é™åï¼Œæ¯æ”¶åˆ°ä¸€ä¸ªACKï¼Œcwnd = cwnd + 1/cwndï¼›ä¹Ÿå°±æ˜¯è¯´æ¯ç»è¿‡ä¸€ä¸ªRTTï¼Œcwnd = cwnd + 1ã€‚æ­¤æ—¶å‘åŒ…æ•°å‘ˆçº¿æ€§å¢é•¿ï¼Œé¿å…å¢é•¿è¿‡å¿«å¯¼è‡´ç½‘ç»œæ‹¥å¡ã€‚</p><p><strong>æ‹¥å¡å‘ç”Ÿ</strong></p><p>ä¸€æ—¦å‘ç”Ÿä¸¢åŒ…ã€å»¶æ—¶å¯¼è‡´é‡ä¼ ï¼Œè¿›å…¥æ‹¥å¡å‘ç”Ÿé˜¶æ®µï¼šssthresh = 0.5 * cwndï¼Œcwndé‡ç½®ä¸º1 ï¼ˆLinuxåˆå§‹å€¼ä¸º10ï¼‰</p><p><strong>å¿«é‡ä¼ </strong></p><p>å½“æ¥æ”¶æ–¹å‘ç°ä¸€ä¸ªä¹±åºåˆ°è¾¾çš„æŠ¥æ–‡æ®µï¼Œå°±ä¼šå‘é€ä¸‰æ¬¡å‰ä¸€ä¸ªåŒ…çš„ ACKã€‚å‘é€ç«¯æ¥æ”¶åˆ°ä¸‰ä¸ªç›¸åŒçš„ACKæŠ¥æ–‡ï¼Œå°±ä¼šè¿›è¡Œå¿«é€Ÿé‡ä¼ ï¼Œä¸å¿…ç­‰åˆ°è¶…æ—¶å†é‡ä¼ ã€‚è¿™æ—¶è®¾ç½® cwnd /= 2ï¼Œssthresh = cwndï¼Œè¿›å…¥å¿«æ¢å¤ã€‚</p><p><strong>å¿«æ¢å¤</strong></p><p>å¿«é€Ÿæ¢å¤ç®—æ³•æ˜¯è®¤ä¸ºï¼Œå¦‚æœè¿˜èƒ½æ”¶åˆ° 3 ä¸ªé‡å¤çš„ ACK è¯´æ˜ç½‘ç»œä¹Ÿæ²¡é‚£ä¹ˆç³Ÿç³•ï¼Œå› æ­¤æ²¡å¿…è¦åƒ RTO è¶…æ—¶é‚£ä¹ˆå¼ºçƒˆã€‚æ­¤æ—¶å‘é€æ–¹æŠŠ ssthresh è®¾ä¸ºå½“å‰ cwnd çš„ä¸€åŠ</p><h4 id="åŠ-å…¨è¿æ¥é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#åŠ-å…¨è¿æ¥é˜Ÿåˆ—"><span>åŠ/å…¨è¿æ¥é˜Ÿåˆ—</span></a></h4><p>TCP ä¸‰æ¬¡æ¡æ‰‹æ—¶ï¼ŒLinux ä¼šç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p><ul><li>åŠè¿æ¥é˜Ÿåˆ—ï¼Œä¹Ÿç§° SYN é˜Ÿåˆ—ï¼Œåº•å±‚æ˜¯å“ˆå¸Œè¡¨ <ul><li>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ SYN åï¼Œå†…æ ¸ä¼šæŠŠè¯¥è¿æ¥å­˜å‚¨åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶å“åº” SYN + ACK</li><li>SYN æ´ªæ³›æ”»å‡»ã€DDos éƒ½æ˜¯åŠè¿æ¥é˜Ÿåˆ—æº¢å‡º</li></ul></li><li>å…¨è¿æ¥é˜Ÿåˆ—ï¼Œä¹Ÿç§° accept é˜Ÿåˆ—ï¼Œåº•å±‚æ˜¯é“¾è¡¨ <ul><li>æœåŠ¡ç«¯æ”¶åˆ°ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ ACK åï¼Œå†…æ ¸ä¼šæŠŠè¿æ¥ä»åŠè¿æ¥é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œç„¶ååˆ›å»ºæ–°çš„å®Œå…¨è¿æ¥åŠ å…¥å…¨è¿æ¥é˜Ÿåˆ—ï¼Œç­‰å¾…è¿›ç¨‹è°ƒç”¨ accept æŠŠè¿æ¥å–å‡º</li></ul></li></ul><p>ä¸ç®¡æ˜¯åŠè¿æ¥ï¼Œè¿˜æ˜¯å…¨è¿æ¥é˜Ÿåˆ—ï¼Œéƒ½æœ‰æœ€å¤§é•¿åº¦é™åˆ¶ï¼Œè¶…è¿‡åä¼šç›´æ¥ä¸¢å¼ƒæˆ–è¿”å› RST åŒ…ã€‚éœ€è¦æ³¨æ„ï¼ŒTCP ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨ accept è°ƒç”¨ä¹‹å‰çš„ã€‚</p><h4 id="tcp-ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#tcp-ä¼˜åŒ–"><span>TCP ä¼˜åŒ–</span></a></h4><p><strong>ä¸‰æ¬¡æ¡æ‰‹</strong></p><ul><li>å®¢æˆ·ç«¯ï¼šå¯ä»¥æ ¹æ®ç½‘ç»œç¨³å®šæ€§ã€ç›®æ ‡æœåŠ¡å™¨ç¹å¿™ç¨‹åº¦ä¿®æ”¹ SYN é‡ä¼ æ¬¡æ•°ï¼Œè°ƒæ•´æ¡æ‰‹æ—¶é—´ä¸Šé™ã€‚ä¾‹å¦‚åœ¨å†…ç½‘ä¸­é™ä½é‡è¯•æ¬¡æ•°ï¼Œå°½å¿«æŠŠé”™è¯¯æš´éœ²ç»™åº”ç”¨ç¨‹åº</li><li>æœåŠ¡ç«¯ï¼šè°ƒæ•´åŠ/å…¨è¿æ¥é˜Ÿåˆ—é•¿åº¦ã€SYN+ACK æŠ¥æ–‡é‡ä¼ æ¬¡æ•°</li><li>ç»•è¿‡ä¸‰æ¬¡æ¡æ‰‹ï¼štcp_fastopen å‡å°‘ä¸€ä¸ª RTT</li></ul><p><strong>å››æ¬¡æŒ¥æ‰‹</strong></p><ul><li>ä¸»åŠ¨æ–¹ï¼šè°ƒæ•´ FIN æŠ¥æ–‡é‡ä¼ æ¬¡æ•°ã€FIN_WAIT2 çŠ¶æ€æ—¶é—´ã€å­¤å„¿è¿æ¥ä¸Šé™</li></ul><h4 id="åˆ†ç‰‡é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#åˆ†ç‰‡é—®é¢˜"><span>åˆ†ç‰‡é—®é¢˜</span></a></h4><p>å¦‚æœTCPå±‚ä¸è¿›è¡Œåˆ†ç‰‡ï¼Œä»…åœ¨IPå±‚åˆ†ç‰‡ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªTCPæŠ¥æ–‡æ®µçš„æŸä¸ªIPåˆ†ç‰‡ä¸¢å¤±ï¼Œæ¥æ”¶æ–¹çš„IPå±‚æ— æ³•ç»„è£…æˆä¸€ä¸ªå®Œæ•´çš„TCPæŠ¥æ–‡ï¼Œä¹Ÿå°±ä¸ä¼šå“åº”ACKç»™å‘é€æ–¹ã€‚äºæ˜¯å‘é€æ–¹å°±ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…æ—¶é‡ä¼ ï¼Œå› æ­¤ç”±IPå±‚è¿›è¡Œåˆ†ç‰‡ä¼ è¾“æ•ˆç‡å¾ˆä½ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†è¾¾åˆ°æœ€ä½³çš„ä¼ è¾“æ•ˆèƒ½ TCP åè®®åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™é€šå¸¸è¦åå•†åŒæ–¹çš„ MSS å€¼ï¼Œä½¿å¾—IPåŒ…é•¿åº¦ä¸ä¼šå¤§äºMTUï¼Œä¹Ÿå°±ä¸ç”¨IPåˆ†ç‰‡äº†ã€‚è¿™æ ·å³ä½¿ä¸€ä¸ªIPåˆ†ç‰‡ä¸¢å¤±ï¼Œè¿›è¡Œé‡å‘æ—¶ä¹Ÿæ˜¯ä»¥ MSS ä¸ºå•ä½ã€‚</p><h4 id="ç²˜åŒ…é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ç²˜åŒ…é—®é¢˜"><span>ç²˜åŒ…é—®é¢˜</span></a></h4><p>å¯¹äºUDPï¼ŒOSä¸ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œæ‹†åˆ†ï¼Œæ¯ä¸ªUDPæŠ¥æ–‡å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯ã€‚<br>è€Œå¯¹äºTCPï¼Œæ¶ˆæ¯å¯èƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿåˆ†ç»„æˆå¤šä¸ª TCP æŠ¥æ–‡ï¼Œå› æ­¤æ¥æ”¶æ–¹çš„ç¨‹åºå¦‚æœä¸çŸ¥é“å‘é€æ–¹å‘é€çš„æ¶ˆæ¯é•¿åº¦/è¾¹ç•Œï¼Œå°±æ— æ³•è¯»å‡ºä¸€ä¸ªæœ‰æ•ˆçš„ç”¨æˆ·æ¶ˆæ¯ã€‚å› æ­¤æˆ‘ä»¬è¯´ TCP æ˜¯é¢å‘å­—èŠ‚æµçš„åè®®ã€‚</p><p>å½“ä¸¤ä¸ªæ¶ˆæ¯å„è‡ªçš„éƒ¨åˆ†å†…å®¹è¢«åˆ†åˆ°åŒä¸€ä¸ª TCP æŠ¥æ–‡æ—¶ï¼Œå³äº§ç”Ÿ TCP ç²˜åŒ…é—®é¢˜ï¼Œè¿™æ—¶æ¥æ”¶æ–¹å¦‚æœä¸çŸ¥é“æ¶ˆæ¯è¾¹ç•Œçš„è¯ï¼Œæ— æ³•è¯»å‡ºæœ‰æ•ˆçš„ä¿¡æ¯ã€‚</p><p><strong>è§£å†³æ–¹æ³•</strong></p><ul><li>å›ºå®šé•¿åº¦çš„æ¶ˆæ¯ï¼šä¸çµæ´»</li><li>ç‰¹æ®Šå­—ç¬¦ä½œä¸ºè¾¹ç•Œï¼šä¸¤ä¸ªç”¨æˆ·æ¶ˆæ¯ä¹‹é—´æ’å…¥ç‰¹æ®Šå­—ç¬¦ï¼Œä¾‹å¦‚ HTTP åè®®é€šè¿‡å›è½¦ç¬¦+æ¢è¡Œç¬¦ä½œä¸ºæŠ¥æ–‡çš„è¾¹ç•Œï¼ˆæ³¨æ„è½¬ä¹‰ï¼‰</li><li>è‡ªå®šä¹‰æ¶ˆæ¯ç»“æ„ï¼šåˆ†åŒ…å¤´å’Œæ•°æ®ï¼Œåœ¨åŒ…å¤´é‡Œè®°å½•æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ï¼Œæ¥æ”¶æ–¹é€šè¿‡è§£æåŒ…å¤´å°±å¯ä»¥çŸ¥é“æ¶ˆæ¯çš„è¾¹ç•Œäº†ã€‚</li></ul><h4 id="åºåˆ—å·å’Œç¡®è®¤å·" tabindex="-1"><a class="header-anchor" href="#åºåˆ—å·å’Œç¡®è®¤å·"><span>åºåˆ—å·å’Œç¡®è®¤å·</span></a></h4><p><strong>åºåˆ—å·</strong></p><ul><li>åˆå§‹åºåˆ—å·ï¼šTCP å»ºç«‹è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŸºäºæ—¶é’Ÿã€æº/ç›®çš„ IP/ç«¯å£ ç”Ÿæˆçš„éšæœºæ•°</li><li>åºåˆ—å·ï¼šTCP å¤´éƒ¨çš„ä¸€ä¸ª 32ä½ æ— ç¬¦å·æ•°å­—æ®µï¼Œåˆ°è¾¾ 4G åå½’é›¶ã€‚æ ‡è¯†äº† TCP å‘é€ç«¯åˆ° TCP æ¥æ”¶ç«¯çš„æ•°æ®æµçš„ä¸€ä¸ªå­—èŠ‚ï¼Œç”¨äºä¼ è¾“ç¡®è®¤ã€ä¸¢å¤±é‡ä¼ ã€æœ‰åºæ¥æ”¶ã€‚ <ul><li>åºåˆ—å· = ä¸Šä¸€æ¬¡å‘é€çš„åºåˆ—å· + æ•°æ®é•¿åº¦ã€‚å¦‚æœä¸Šä¸€æ¬¡æ˜¯ SYN/FINï¼Œåˆ™æ”¹ä¸ºä¸Šä¸€æ¬¡åºåˆ—å· +1</li></ul></li></ul><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éšæœºç”Ÿæˆåˆå§‹åºåˆ—å·ï¼Œä»¥é¿å…å†å²æŠ¥æ–‡è¢«ä¸‹ä¸€ä¸ªç›¸åŒå››å…ƒç»„çš„è¿æ¥æ¥æ”¶ã€‚ä½†ä¹Ÿæ— æ³•å®Œå…¨é¿å…ï¼Œå¯ä»¥å¼€å¯ TCP æ—¶é—´æˆ³æœºåˆ¶ï¼Œé˜²æ­¢åºåˆ—å·å›ç»•ã€‚</p><ul><li>åˆæ³•çš„åºåˆ—å·ï¼šæŠ¥æ–‡çš„åºåˆ—å·æ¯”<code>æœŸæœ›ä¸‹ä¸€ä¸ªæ”¶åˆ°çš„åºåˆ—å·</code>è¦å¤§</li><li>åˆæ³•çš„æ—¶é—´æˆ³ï¼šæŠ¥æ–‡çš„æ—¶é—´æˆ³æ¯”<code>æœ€åæ”¶åˆ°çš„æŠ¥æ–‡æ—¶é—´æˆ³</code>è¦å¤§</li></ul><p><strong>ç¡®è®¤å·</strong></p><p>æŒ‡ä¸‹ä¸€æ¬¡ã€ŒæœŸæœ›ã€æ”¶åˆ°çš„æ•°æ®çš„åºåˆ—å·ï¼Œå‘é€ç«¯æ”¶åˆ°æ¥æ”¶æ–¹å‘æ¥çš„ ACK ç¡®è®¤æŠ¥æ–‡ä»¥åï¼Œå°±å¯ä»¥è®¤ä¸ºåœ¨è¿™ä¸ªåºå·ä»¥å‰çš„æ•°æ®éƒ½å·²ç»è¢«æ­£å¸¸æ¥æ”¶ã€‚ç”¨æ¥è§£å†³ä¸¢åŒ…çš„é—®é¢˜ã€‚</p><ul><li>ç¡®è®¤å· = ä¸Šä¸€æ¬¡æ”¶åˆ°çš„æŠ¥æ–‡åºåˆ—å· + æ•°æ®é•¿åº¦ã€‚å¦‚æœæ”¶åˆ°çš„æ˜¯ SYN/FINï¼Œåˆ™æ”¹ä¸ºä¸Šä¸€æ¬¡åºåˆ—å· +1</li></ul><h4 id="ä¿æ´»æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#ä¿æ´»æœºåˆ¶"><span>ä¿æ´»æœºåˆ¶</span></a></h4><p>å¦‚æœä¸¤ç«¯çš„ TCP è¿æ¥ä¸€ç›´æ²¡æœ‰æ•°æ®äº¤äº’ï¼Œè¾¾åˆ°äº†è§¦å‘ TCP ä¿æ´»æœºåˆ¶çš„æ¡ä»¶ï¼Œå¹¶ä¸”å¼€å¯äº† TCP-keepalive æœºåˆ¶ï¼Œé‚£ä¹ˆå†…æ ¸é‡Œçš„ TCP åè®®æ ˆå°±ä¼šå‘é€æ¢æµ‹æŠ¥æ–‡ã€‚</p><ul><li>å¦‚æœå¯¹ç«¯æ­£å¸¸å“åº”ï¼Œé‚£ä¹ˆ TCP ä¿æ´»æ—¶é—´é‡ç½®ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ä¿æ´»æ—¶æœºåˆ°æ¥</li><li>å¦‚æœå¯¹ç«¯è¿ç»­å‡ æ¬¡æ²¡æœ‰å“åº”ï¼Œè¾¾åˆ°ä¿æ´»æ¢æµ‹æ¬¡æ•°åï¼ŒTCP ä¼šæŠ¥å‘Šè¯¥ TCP è¿æ¥å·²æ­»äº¡</li></ul><p>å¦‚æœæ²¡æœ‰å¼€å¯ TCP-keepaliveï¼Œå¹¶ä¸”åŒæ–¹éƒ½æ²¡æœ‰è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ TCP è¿æ¥å°†ä¼šä¸€ç›´ä¿æŒå­˜åœ¨ã€‚</p><h4 id="å…³é—­è¿æ¥" tabindex="-1"><a class="header-anchor" href="#å…³é—­è¿æ¥"><span>å…³é—­è¿æ¥</span></a></h4><p>å…³é—­ socket æœ‰ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li>close() åŒæ—¶å…³é—­ socket å‘é€æ–¹å‘å’Œè¯»å–æ–¹å‘ï¼Œä½¿å¾— socket ä¸å†æœ‰å‘é€å’Œæ¥æ”¶æ•°æ®çš„èƒ½åŠ›ã€‚ä½†å¦‚æœå¤šçº¿ç¨‹å…±äº«è¯¥ socketï¼Œåˆ™ close() ä¼šè®©å¼•ç”¨è®¡æ•° -1ï¼Œåªè¦å¼•ç”¨è®¡æ•°é0ï¼Œå…¶å®ƒçº¿ç¨‹è¿˜å¯ä»¥æ­£å¸¸è¯»å†™è¯¥ socket</li><li>shutdown() å¯ä»¥æŒ‡å®šä»…å…³é—­ socket å‘é€æ–¹å‘/è¯»å–æ–¹å‘ã€‚å¦‚æœå¤šçº¿ç¨‹å…±äº«è¯¥ socketï¼Œåˆ™å…¶å®ƒçº¿ç¨‹å°†å—åˆ°å½±å“</li></ul><p>å› æ­¤ï¼Œclose() æ˜¯ä¸€ç§ç²—æš´çš„å…³é—­æ–¹å¼ï¼Œä¸ä¼šç»å†å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹ï¼Œç­‰åˆ°å¯¹ç«¯å‘é€æ•°æ®æ¢å¤ RST æ‰èƒ½æ­£ç¡®å…³é—­è¿æ¥ã€‚</p><p>ç²—æš´çš„å…³é—­è¿›ç¨‹å¯ä»¥å…³é—­ TCP è¿æ¥ï¼Œä½†ä¸ä¼˜é›…ã€‚å¯ä»¥é€šè¿‡ä¼ªé€  RST æŠ¥æ–‡æ¥å…³é—­è¿æ¥ï¼Œä½†è¦åŒæ—¶æ»¡è¶³<strong>å››å…ƒç»„ç›¸åŒ</strong>ã€<strong>åºåˆ—å·æ˜¯å¯¹æ–¹æœŸæœ›çš„</strong>ä¸¤ä¸ªæ¡ä»¶ã€‚</p><ul><li><code>killcx</code> å·¥å…·ï¼š <ul><li>ä¸»åŠ¨å‘å¤„äº Established çŠ¶æ€çš„æœåŠ¡ç«¯å‘é€ SYNï¼Œæ¥æ”¶ Challenge ACKï¼Œè·å¾—æœåŠ¡å™¨æœŸæœ›çš„åºåˆ—å·å’Œç¡®è®¤å·</li><li>åˆ©ç”¨ Challenge ACK ä¿¡æ¯ä¼ªé€ ä¸¤ä¸ª RST æŠ¥æ–‡å‘é€ç»™å®¢æˆ·ç«¯(åºåˆ—å·)å’ŒæœåŠ¡ç«¯(ç¡®è®¤å·)ï¼Œè®©å®ƒä»¬ä¼˜é›…åœ°é‡Šæ”¾è¿æ¥</li></ul></li><li><code>tcpkill</code> å·¥å…·ï¼š <ul><li>åœ¨åŒæ–¹è¿›è¡Œ TCP é€šä¿¡æ—¶ï¼Œæ‹¿åˆ°å¯¹æ–¹ä¸‹ä¸€æ¬¡æœŸæœ›çš„åºåˆ—å·ï¼Œç„¶åä¼ªé€  RST æŠ¥æ–‡æ¥å…³é—­è¿æ¥</li><li>ä»…é€‚ç”¨äºæ´»è·ƒçš„ TCP è¿æ¥</li></ul></li></ul><p>å¦‚æœè¿›ç¨‹å´©æºƒï¼ŒOS å†…æ ¸ä¼šè‡ªåŠ¨å‘é€ FIN å®Œæˆ TCP å››æ¬¡æŒ¥æ‰‹å…³é—­è¿æ¥ï¼›è€Œå¦‚æœä¸»æœºå®•æœºï¼Œå¯¹ç«¯æ˜¯æ— æ³•æ„ŸçŸ¥çš„ï¼Œéœ€è¦ TCP ä¿æ´»æœºåˆ¶æ¥æ¢æµ‹ä¸»æœºæ˜¯å¦æ­£å¸¸ã€‚åœ¨ Linux ä¸­ï¼Œéœ€è¦è‡³å°‘ 2H 11min 15s æ‰èƒ½å‘ç°ä¸€ä¸ªæ­»äº¡è¿æ¥ã€‚</p><h3 id="ip" tabindex="-1"><a class="header-anchor" href="#ip"><span>IP</span></a></h3><h4 id="ip-åœ°å€" tabindex="-1"><a class="header-anchor" href="#ip-åœ°å€"><span>IP åœ°å€</span></a></h4><ul><li>ABCDE åœ°å€ -&gt; CIDR æ— åˆ†ç±»åœ°å€</li><li>IP åœ°å€ &amp; å­ç½‘æ©ç  = ç½‘ç»œå·</li><li>IPv4 åœ°å€ 32 ä½ï¼Œè€Œ IPv6 åœ°å€ 128 ä½ï¼Œä¸”æ”¯æŒè‡ªåŠ¨åˆ†é… IP åœ°å€ï¼Œç®€åŒ–åŒ…å¤´ï¼Œæé«˜ä¼ è¾“æ€§èƒ½ï¼Œæå‡äº†å®‰å…¨æ€§</li><li>localhost æ˜¯ä¸€ä¸ªåŸŸåï¼Œä¸è¿‡ä¼šè§£ææˆ 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€</li><li><code>ping 127.0.0.1/æœ¬åœ°IP</code>æœ€åéƒ½ä¼šèµ° æœ¬åœ°å›ç¯æ¥å£ï¼ˆå‡ç½‘å¡ï¼‰ï¼Œç„¶åæ’å…¥<code>input_pkt_queue</code>é“¾è¡¨åï¼Œé€šè¿‡è½¯ä¸­æ–­é€šçŸ¥<code>ksoftirqd</code>æ¥æ”¶æ•°æ®ï¼Œå› æ­¤æ–­ç½‘ä¹Ÿèƒ½ Ping é€š</li><li>å¦‚æœæœåŠ¡å™¨ listen çš„æ˜¯ 0.0.0.0ï¼Œè¡¨ç¤ºç›‘å¬æœ¬æœºçš„æ‰€æœ‰ IPv4 åœ°å€</li></ul><h4 id="ip-å’Œ-mac-åœ°å€" tabindex="-1"><a class="header-anchor" href="#ip-å’Œ-mac-åœ°å€"><span>IP å’Œ MAC åœ°å€</span></a></h4><ol><li>MAC åœ°å€çš„ä½œç”¨æ˜¯å®ç°ã€Œç›´è¿ã€çš„ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´é€šä¿¡ï¼Œåœ¨ç½‘ç»œä¼ è¾“å¯»å€è¿‡ç¨‹ä¸­æ˜¯ä¸€ç›´å˜åŒ–çš„ã€‚</li><li>è€Œ IP åˆ™è´Ÿè´£åœ¨ã€Œæ²¡æœ‰ç›´è¿ã€çš„ä¸¤ä¸ªç½‘ç»œä¹‹é—´è¿›è¡Œé€šä¿¡ä¼ è¾“ï¼ŒæºIPåœ°å€å’Œç›®æ ‡IPåœ°å€åœ¨æ•´ä¸ªä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼ˆé™¤é NATï¼‰</li><li>å¦‚æœåªç”¨ MAC åœ°å€ï¼Œè·¯ç”±å™¨å°±éœ€è¦è®°ä½æ¯ä¸ªMACåœ°å€æ‰€åœ¨çš„å­ç½‘ï¼Œè€Œ MAC åœ°å€æœ‰48ä½ï¼Œè·¯ç”±å™¨æ— æ³•å­˜å‚¨è¿™ä¹ˆå¤šå­ç½‘ä¿¡æ¯</li><li>IP åœ°å€æ˜¯è®¾å¤‡ä¸Šçº¿ä»¥åï¼Œæ‰èƒ½æ ¹æ®è¿›å…¥å“ªä¸ªå­ç½‘æ¥åˆ†é…çš„ï¼Œåœ¨è®¾å¤‡è¿˜æ²¡æœ‰ IP çš„æ—¶å€™éœ€è¦ç”¨ MAC åœ°å€æ¥åŒºåˆ†ä¸åŒçš„è®¾å¤‡</li></ol><p>IP åœ°å€ç±»ä¼¼ä½å€é—¨ç‰Œå·ï¼Œä½åœ¨ä¸åŒåœ°æ–¹å°±æœ‰ä¸åŒé—¨ç‰Œå·ï¼Œå¿«é€’æ ¹æ®é—¨ç‰Œå·æ‰¾åˆ°æ‰€åœ¨ä½ç½®ã€‚è€Œ MAC åœ°å€ç±»ä¼¼èº«ä»½è¯å·ï¼Œè®¾å¤‡å‡ºå‚å°±å›ºå®šå†™æ­»äº†ï¼Œä½†æ˜¯çŸ¥é“èº«ä»½è¯å·æ˜¯æ²¡æ³•æ‰¾åˆ°äººçš„ï¼Œèº«ä»½è¯å·å’Œåœ°ç†ä½ç½®æ— å…³ã€‚</p><h4 id="dns" tabindex="-1"><a class="header-anchor" href="#dns"><span>DNS</span></a></h4><p>åŸŸåè§£æåè®®ï¼ŒåŸŸå -&gt; IPåœ°å€</p><p>æŸ¥è¯¢é¡ºåºï¼š</p><ul><li>æµè§ˆå™¨ç¼“å­˜ -&gt; OSç¼“å­˜ -&gt; æœ¬åœ°DNS Â ï¼ˆä¸»æœºå’Œæœ¬åœ°DNSæœåŠ¡å™¨ä¹‹é—´é€’å½’æŸ¥è¯¢ï¼‰</li><li>è¿˜æ²¡æœ‰å°±ç”±æœ¬åœ°DNSå‘å‡ºæŸ¥è¯¢ï¼šæ ¹DNS -&gt; é¡¶çº§DNS -&gt; æƒå¨DNS Â ï¼ˆDNSæœåŠ¡å™¨ä¹‹é—´è¿­ä»£æŸ¥è¯¢ï¼‰</li></ul><p><img src="/img/DNS%E6%9F%A5%E8%AF%A2.webp#id=l92M7&amp;originHeight=1095&amp;originWidth=1505&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><h4 id="arp" tabindex="-1"><a class="header-anchor" href="#arp"><span>ARP</span></a></h4><p>åœ°å€è§£æè§£æï¼ŒIP -&gt; MAC</p><p>åŸç†ï¼šå¹¿æ’­ ARP è¯·æ±‚ -&gt; è§£åŒ…åŒ¹é… -&gt; å•æ’­ ARP å“åº” -&gt; æœ‰é™ç¼“å­˜</p><p>RARPï¼šMAC -&gt; IPï¼Œç”¨äºæ‰“å°æœºæœåŠ¡å™¨ç­‰å°å‹åµŒå…¥å¼è®¾å¤‡æ¥å…¥ç½‘ç»œ</p><h4 id="dhcp" tabindex="-1"><a class="header-anchor" href="#dhcp"><span>DHCP</span></a></h4><p>åŠ¨æ€ä¸»æœºé…ç½®åè®®ï¼ŒåŠ¨æ€è·å–IPåœ°å€</p><p>åŸç†ï¼ˆå…¨ç¨‹ UDPå¹¿æ’­ï¼‰ï¼š</p><ul><li>å®¢æˆ·ç«¯ï¼ˆ0.0.0.0:68ï¼‰ä½¿ç”¨ UDP å¹¿æ’­ï¼ˆ255.255.255.255:67ï¼‰ï¼Œå‘èµ· DHCP DISCOVER</li><li>DHCP æœåŠ¡å™¨å“åº” DHCP OFFERï¼Œæºå¸¦å¯ç§Ÿçº¦çš„ IP åœ°å€ã€å­ç½‘æ©ç ã€é»˜è®¤ç½‘å…³ã€DNS æœåŠ¡å™¨ä»¥åŠ IP åœ°å€ç§Ÿç”¨æœŸç­‰ä¿¡æ¯</li><li>å®¢æˆ·ç«¯æ”¶åˆ°ä¸€ä¸ª DHCP OFFER åï¼Œå›å¤ DHCP REQUESTï¼Œå›æ˜¾é…ç½®çš„å‚æ•°</li><li>DHCP æœåŠ¡å™¨å“åº” DHCP ACK ç¡®è®¤é…ç½®ä¿¡æ¯</li></ul><h4 id="icmp" tabindex="-1"><a class="header-anchor" href="#icmp"><span>ICMP</span></a></h4><p>äº’è”ç½‘æ§åˆ¶æŠ¥æ–‡åè®®ï¼Œç”¨äºç¡®è®¤ IP åŒ…æ˜¯å¦æˆåŠŸé€è¾¾ç›®æ ‡åœ°å€ã€æŠ¥å‘Šå‘é€è¿‡ç¨‹ä¸­ IP åŒ…è¢«åºŸå¼ƒçš„åŸå› å’Œæ”¹å–„ç½‘ç»œè®¾ç½®ç­‰ã€‚</p><p>åˆ†ç±»ï¼š</p><ul><li>ç”¨äºè¯Šæ–­çš„æŸ¥è¯¢æŠ¥æ–‡ <ul><li>å¦‚ Ping å‘½ä»¤åˆ©ç”¨ ICMP-å›é€è¯·æ±‚ã€ICMP-å›é€åº”ç­” ä¸¤ç±»æŠ¥æ–‡</li></ul></li><li>ç”¨äºé€šçŸ¥å‡ºé”™åŸå› çš„å·®é”™æŠ¥æ–‡ <ul><li>å¦‚ Traceroute å‘½ä»¤åˆ©ç”¨ ICMP-è¶…æ—¶æ¶ˆæ¯ æŠ¥æ–‡ï¼Œé€šè¿‡è®¾ç½®ç‰¹æ®Šçš„ TTL è¿½è¸ªæ²¿é€”è·¯ç”±ï¼Œä»¥åŠä¸€ä¸ªä¸å¯èƒ½çš„ç«¯å£å·ï¼ˆICMP-ç«¯å£ä¸å¯è¾¾ï¼‰æ ‡è®°å·²åˆ°è¾¾ç›®çš„ä¸»æœº</li><li>å¦‚ Traceroute å‘½ä»¤åˆ©ç”¨ ICMP-ç¦æ­¢åˆ†ç‰‡ æŠ¥æ–‡ï¼Œé€šè¿‡è®¾ç½®ä¸åˆ†ç‰‡ç¡®å®šè·¯å¾„ä¸Šåˆé€‚çš„ MTU å¤§å°</li></ul></li></ul><h4 id="nat" tabindex="-1"><a class="header-anchor" href="#nat"><span>NAT</span></a></h4><p>ç½‘ç»œåœ°å€è½¬æ¢åè®®ã€‚åŸºäºè½¬æ¢è¡¨å°† ç§æœ‰IP -&gt; å…¬æœ‰IPï¼ˆé€šå¸¸ç”¨ NAPTï¼šç½‘ç»œåœ°å€å’Œç«¯å£è½¬åŒ–åè®®ï¼Œç§æœ‰IP + ç«¯å£ -&gt; å…±æœ‰IP + ç«¯å£ï¼‰</p><p>ç¼ºç‚¹ï¼šå¤–ç½‘æ— æ³•ä¸»åŠ¨è¿æ¥ã€æ€§èƒ½å¼€é”€å¤§ã€é‡å¯è¿æ¥æ–­å¼€<br>è§£å†³ï¼šIPv6ã€NATç©¿é€ï¼ˆåº”ç”¨ç¨‹åºä¸»åŠ¨å»ºç«‹ç«¯å£æ˜ å°„ï¼‰</p><h4 id="igmp" tabindex="-1"><a class="header-anchor" href="#igmp"><span>IGMP</span></a></h4><p>å› ç‰¹ç½‘ç»„ç®¡ç†åè®®ã€‚ç”¨äºç»´æŠ¤ IGMP è·¯ç”±è¡¨ï¼Œç®¡ç†åŠ å…¥ã€ç¦»å¼€ç»„æ’­ç»„çš„ä¸»æœº</p><h2 id="æ“ä½œç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#æ“ä½œç³»ç»Ÿ"><span>æ“ä½œç³»ç»Ÿ</span></a></h2><h3 id="ç¡¬ä»¶ç»“æ„" tabindex="-1"><a class="header-anchor" href="#ç¡¬ä»¶ç»“æ„"><span>ç¡¬ä»¶ç»“æ„</span></a></h3><h4 id="å†¯è¯ºä¾æ›¼ç»“æ„" tabindex="-1"><a class="header-anchor" href="#å†¯è¯ºä¾æ›¼ç»“æ„"><span>å†¯è¯ºä¾æ›¼ç»“æ„</span></a></h4><p>è¿ç®—å™¨ã€æ§åˆ¶å™¨ã€å­˜å‚¨å™¨ã€è¾“å…¥è®¾å¤‡ã€è¾“å‡ºè®¾å¤‡</p><p><img src="/img/%E5%86%AF%E8%AF%BA%E4%BE%9D%E6%9B%BC%E6%A8%A1%E5%9E%8B.webp#id=Rdt00&amp;originHeight=271&amp;originWidth=613&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><ul><li>CPU = æ§åˆ¶å•å…ƒ + é€»è¾‘è¿ç®—å•å…ƒ + å¯„å­˜å™¨</li><li>å¯„å­˜å™¨åˆ† é€šç”¨å¯„å­˜å™¨ã€æŒ‡ä»¤å¯„å­˜å™¨ã€ç¨‹åºè®¡æ•°å™¨</li><li>æ€»çº¿åˆ† åœ°å€æ€»çº¿ï¼ˆæŒ‡å®šå†…å­˜åœ°å€ï¼‰ã€æ§åˆ¶æ€»çº¿ï¼ˆæŒ‡å®šè¯»/å†™ï¼‰ã€æ•°æ®æ€»çº¿ï¼ˆä¼ è¾“æ•°æ®ï¼‰</li></ul><h4 id="æŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#æŒ‡ä»¤"><span>æŒ‡ä»¤</span></a></h4><p>æŒ‡ä»¤å‘¨æœŸçš„å››çº§æµæ°´çº¿ï¼šFetch -&gt; Decode -&gt; Execute -&gt; Store</p><p>ç¡¬ä»¶32/64ä½æŒ‡CPUä½å®½ï¼Œè½¯ä»¶32/64ä½æŒ‡æŒ‡ä»¤çš„ä½å®½ã€‚</p><p>64ä½ç›¸æ¯”32ä½çš„ä¼˜åŠ¿ï¼š</p><ol><li>64ä½CPUå¯ä»¥ä¸€æ¬¡è®¡ç®—è¶…è¿‡32ä½çš„æ•°å­—ï¼Œä½†å¾ˆå°‘æœ‰ç¨‹åºè®¡ç®—è¿™ä¹ˆå¤§çš„æ•°å­—ï¼Œåªæœ‰è®¡ç®—å¤§æ•°å­—æ‰èƒ½ä½“ç°è¶…è¿‡32ä½CPUçš„æ€§èƒ½</li><li>64ä½CPUå¯ä»¥å¯»å€æ›´å¤§çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œ32ä½æœ€é«˜å¯»å€4G</li></ol><h4 id="å¤šçº§å­˜å‚¨å™¨" tabindex="-1"><a class="header-anchor" href="#å¤šçº§å­˜å‚¨å™¨"><span>å¤šçº§å­˜å‚¨å™¨</span></a></h4><ul><li>å¯„å­˜å™¨: ä¸€èˆ¬åœ¨åŠä¸ªCPUå‘¨æœŸå†…å®Œæˆè¯»å†™</li><li>CPU Cacheï¼šRAM é™æ€éšæœºå­˜å‚¨å™¨ï¼Œæ–­ç”µä¸¢å¤±ã€‚ <ul><li>L1ï¼š2-4ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå‡ åKBã€‚åˆ†æ•°æ®ç¼“å­˜ã€æŒ‡ä»¤ç¼“å­˜</li><li>L2ï¼š10-20ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå‡ ç™¾KB</li><li>L3: 20-60ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå‡ åMBã€‚å¤šæ ¸å…±äº«</li></ul></li><li>å†…å­˜ï¼šDRAM åŠ¨æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼Œç”µå®¹éœ€è¦å®šæ—¶åˆ·æ–°ã€‚200-300ä¸ªæ—¶é’Ÿå‘¨æœŸ</li><li>SSD/HDD ç¡¬ç›˜ï¼šæ–­ç”µåæ•°æ®ä¸ä¸¢å¤±ï¼ŒSSDæ¯”å†…å­˜æ…¢ 10-1000 å€ï¼ŒHDDæ¯”å†…å­˜æ…¢ 10W å€</li></ul><p>æ¯ä¸ªå­˜å‚¨å™¨åªå’Œç›¸é‚»çš„ä¸€å±‚å­˜å‚¨å™¨è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œå½¢æˆç¼“å­˜ä½“ç³»ã€‚</p><p><img src="/img/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.webp#id=puypr&amp;originHeight=854&amp;originWidth=962&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><h4 id="cpu-cache" tabindex="-1"><a class="header-anchor" href="#cpu-cache"><span>CPU Cache</span></a></h4><p>CPU Cache æ˜¯ç”±å¾ˆå¤šä¸ª <code>Cache Line</code> ç»„æˆçš„ï¼Œ<code>Cache Line</code> æ˜¯ CPU ä»å†…å­˜è¯»å–æ•°æ®çš„åŸºæœ¬å•ä½ï¼ˆä¾‹å¦‚ä¸€æ¬¡è½½å…¥ 64Byteï¼‰ï¼Œç”±å„ç§æ ‡å¿—ï¼ˆTagï¼‰+ æ•°æ®å—ï¼ˆData Blockï¼‰ç»„æˆã€‚</p><p><strong>ç›´æ¥æ˜ å°„</strong></p><ul><li>é€šè¿‡å–æ¨¡è¿ç®—ï¼Œè®¡ç®—å†…å­˜å—å¯¹åº”çš„ Cache Line åœ°å€</li><li>ç»„æ ‡è®° Tagï¼š è®°å½•æ˜¯å¦æ˜¯å¯¹åº”çš„å†…å­˜å—ï¼ˆå› ä¸ºå¤šä¸ªå†…å­˜å—ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ª Cache Lineï¼‰</li><li>æœ‰æ•ˆä½ Valid Bitï¼šæ ‡è®°æ•°æ®æ˜¯å¦è¿˜æœ‰æ•ˆ</li><li>åç§»é‡ Offsetï¼šå®šä½ CPU è¯»å– Cache Line ä¸­å“ªä¸ª Word å­—</li></ul><p>å› æ­¤ï¼Œä¸€ä¸ªå†…å­˜çš„è®¿é—®åœ°å€ç”± ç»„æ ‡è®°ã€Cache Line ç´¢å¼•ã€åç§»é‡ ä¸‰è€…å…±åŒå®šä½ã€‚å…¶å®ƒæ˜ å°„ä¾‹å¦‚å…¨ç›¸è”ã€ç»„ç›¸è”ç­‰ç±»ä¼¼ã€‚</p><p><strong>æå‡ç¼“å­˜å‘½ä¸­ç‡</strong></p><p>æå‡ç¼“å­˜å‘½ä¸­ç‡ï¼Œä¹Ÿå°±å¯ä»¥æå‡ç¨‹åºæ‰§è¡Œé€Ÿåº¦ï¼Œä¼˜åŒ–æ–¹æ³•ä¾‹å¦‚ï¼š</p><ul><li>æŒ‰å†…å­˜å¸ƒå±€é¡ºåºè®¿é—®</li><li>æœ‰è§„å¾‹çš„æ¡ä»¶åˆ†æ”¯è¯­å¥å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„åˆ†æ”¯é¢„æµ‹å™¨</li><li>å½“æœ‰å¤šä¸ªåŒæ—¶æ‰§è¡Œçš„ã€Œè®¡ç®—å¯†é›†å‹ã€çº¿ç¨‹ï¼Œå¯ä»¥æŠŠçº¿ç¨‹ç»‘å®šåœ¨æŸä¸€ä¸ª CPU æ ¸å¿ƒä¸Šï¼Œé¿å…çº¿ç¨‹åœ¨ä¸åŒæ ¸å¿ƒæ¥å›åˆ‡æ¢ï¼Œå½±å“ç¼“å­˜å‘½ä¸­ç‡ã€‚</li></ul><p><strong>å†™å…¥æ•°æ®</strong></p><ol><li>å†™ç›´è¾¾ Write Throughï¼šæŠŠæ•°æ®åŒæ—¶å†™å…¥å†…å­˜å’ŒCacheã€‚æ¯æ¬¡å†™æ“ä½œéƒ½ä¼šå†™å›å†…å­˜ï¼Œæ¶ˆè€—æ€§èƒ½</li><li>å†™å› Write Backï¼šå°†æ–°æ•°æ®å†™å…¥ Cache Block é‡Œï¼Œåªæœ‰å½“ä¿®æ”¹è¿‡çš„ Cache Blockã€Œè¢«æ›¿æ¢ã€æ—¶æ‰éœ€è¦å†™åˆ°å†…å­˜ä¸­ã€‚</li></ol><p><strong>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</strong></p><p>ç”±äº L1/L2 Cache æ˜¯å¤šä¸ªæ ¸å¿ƒå„è‡ªç‹¬æœ‰çš„ï¼Œå› æ­¤å¯èƒ½å¸¦æ¥å¤šæ ¸å¿ƒçš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚å› æ­¤éœ€è¦ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œèƒ½å¤Ÿå®ç°ï¼š</p><ol><li>å†™ä¼ æ’­ï¼šæŸä¸ª CPU æ ¸å¿ƒé‡Œçš„ Cache æ•°æ®æ›´æ–°æ—¶ï¼Œå¿…é¡»è¦ä¼ æ’­åˆ°å…¶ä»–æ ¸å¿ƒçš„ Cacheã€‚ <ul><li>å®ç°æ–¹æ³•ï¼šæ€»çº¿å—…æ¢ï¼Œæ¯ä¸ª CPU æ ¸å¿ƒç›‘å¬æ€»çº¿ä¸Šçš„å¹¿æ’­äº‹ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„æ•°æ®åœ¨è‡ªå·±çš„ L1 Cache é‡Œï¼Œå¦‚æœæœ‰äº‹ä»¶å°±æ›´æ–°ã€‚ä¼šåŠ é‡æ€»çº¿è´Ÿè½½ï¼Œä¸”ä¸èƒ½ä¿è¯äº‹åŠ¡ä¸²è¡ŒåŒ–</li></ul></li><li>äº‹åŠ¡ä¸²è¡ŒåŒ–ï¼šæŸä¸ª CPU æ ¸å¿ƒé‡Œå¯¹æ•°æ®çš„æ“ä½œé¡ºåºï¼Œå¿…é¡»åœ¨å…¶ä»–æ ¸å¿ƒçœ‹èµ·æ¥é¡ºåºæ˜¯ä¸€æ ·çš„ <ul><li>å®ç°æ–¹æ³•ï¼šMESIåè®®ï¼Œæ ‡è®° Cache Line çš„å››ç§ä¸åŒçŠ¶æ€</li><li><code>Modified</code>ï¼šå·²ä¿®æ”¹ã€‚Cache æ•°æ®å’Œå†…å­˜ä¸­æ•°æ®ä¸ä¸€è‡´ï¼Œå¯ä»¥è‡ªç”±å†™å…¥ï¼Œè¢«æ›¿æ¢æ—¶éœ€è¦å†™å›å†…å­˜ã€‚</li><li><code>Exclusive</code>ï¼šç‹¬å ã€‚ä»…ä¸€ä¸ªæ ¸å¿ƒå­˜å‚¨è¯¥ Cache Lineï¼Œå¯ä»¥è‡ªç”±å†™å…¥ï¼Œä¸éœ€è¦é€šçŸ¥å…¶å®ƒæ ¸å¿ƒã€‚å¦‚æœå…¶å®ƒæ ¸å¿ƒä»å†…å­˜è¯»å–äº†è¯¥ Cache Lineï¼Œé‚£ä¹ˆå°†è½¬ä¸ºå…±äº«çŠ¶æ€</li><li><code>Shared</code>ï¼šå…±äº«ã€‚ä¿®æ”¹æ—¶éœ€è¦å‘æ‰€æœ‰å…¶å®ƒæ ¸å¿ƒå¹¿æ’­è¯·æ±‚ï¼Œè¦æ±‚æŠŠè¯¥ Cache Line æ ‡è®°ä¸ºæ— æ•ˆï¼Œç„¶åå†æ›´æ–°</li><li><code>Invalidated</code>ï¼šå·²å¤±æ•ˆã€‚æ•°æ®ä¸ä¸€è‡´ï¼Œä¸å¯ä»¥è¯»å–è¯¥çŠ¶æ€æ•°æ®ã€‚</li></ul></li></ol><p><strong>ä¼ªå…±äº«</strong></p><p>ç”±äºå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™åŒä¸€ä¸ª Cache Line çš„ä¸åŒå˜é‡ï¼Œè€Œå¯¼è‡´ CPU Cache å¤±æ•ˆçš„ç°è±¡ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>Cache Line å¤§å°å­—èŠ‚å¯¹é½ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰</li><li>å­—èŠ‚å¡«å……ï¼Œä¾‹å¦‚ Disruptor ä¸­çš„ RingBuffer ç±»æ•°æ®å‰åå¡«å…… longï¼Œä½¿å¾—æ— è®ºæ€ä¹ˆåŠ è½½ Cache Lineï¼Œè¿™æ•´ä¸ª Cache Line é‡Œéƒ½æ²¡æœ‰ä¼šå‘ç”Ÿæ›´æ–°æ“ä½œçš„æ•°æ®</li></ul><h4 id="cpu-è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#cpu-è°ƒåº¦"><span>CPU è°ƒåº¦</span></a></h4><p>Linux å†…æ ¸ä¸­ï¼Œæ— è®ºæ˜¯è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œè°ƒåº¦çš„éƒ½æ˜¯ <code>task_struct</code> ç»“æ„ä½“ï¼ŒåŒºåˆ«åœ¨äºçº¿ç¨‹çš„<code>task_struct</code>éƒ¨åˆ†èµ„æºæ˜¯å…±äº«äº†è¿›ç¨‹å·²åˆ›å»ºçš„èµ„æºï¼Œå¦‚å†…å­˜åœ°å€ç©ºé—´ã€ä»£ç æ®µã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚</p><p><strong>è°ƒåº¦å™¨</strong></p><ul><li>Deadlineï¼šå¯¹åº” dl_rq è¿è¡Œé˜Ÿåˆ—</li><li>Realtimeï¼šå¯¹åº” rt_rqã€‚</li><li>Fair: å¯¹åº” cfs_rqã€‚å®Œå…¨å…¬å¹³è°ƒåº¦ï¼Œä¼˜å…ˆé€‰æ‹© vruntime å°‘çš„ä»»åŠ¡ï¼Œç”¨äºæ™®é€šä»»åŠ¡ï¼Œå†…éƒ¨ç»„ç»‡æˆçº¢é»‘æ ‘ç»“æ„</li></ul><p>è°ƒåº¦ä¼˜å…ˆçº§ä»ä¸Šåˆ°ä¸‹ï¼Œdl_rq -&gt; rt_rq -&gt; cfs_rqï¼Œä¹Ÿå³å®æ—¶ä»»åŠ¡æ€»æ˜¯å…ˆäºæ™®é€šä»»åŠ¡è¢«æ‰§è¡Œã€‚</p><p>è¿›ç¨‹ä¼˜å…ˆçº§å¯ä»¥é€šè¿‡ <code>nice | renice</code> è®¾ç½®/æ›´æ”¹ï¼ŒèŒƒå›´ -20~19ï¼Œæ˜¯ä¸€ä¸ªä¿®æ­£å€¼ï¼Œnice å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><h4 id="ä¸­æ–­" tabindex="-1"><a class="header-anchor" href="#ä¸­æ–­"><span>ä¸­æ–­</span></a></h4><p>ä¸­æ–­æ˜¯ç³»ç»Ÿç”¨æ¥å“åº”ç¡¬ä»¶è®¾å¤‡è¯·æ±‚çš„ä¸€ç§æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿæ”¶åˆ°ç¡¬ä»¶çš„ä¸­æ–­è¯·æ±‚ï¼Œä¼šæ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ï¼Œç„¶åè°ƒç”¨å†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†ç¨‹åºæ¥å“åº”è¯·æ±‚ã€‚ä¸­æ–­æ˜¯ä¸€ç§å¼‚æ­¥çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</p><p>Linux ä¸ºäº†è§£å†³ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œè¿‡é•¿å’Œä¸­æ–­ä¸¢å¤±çš„é—®é¢˜ï¼Œå°†ä¸­æ–­å¤„ç†ç¨‹åºåˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li>ä¸ŠåŠéƒ¨ï¼šç›´æ¥å¤„ç†ç¡¬ä»¶è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ç¡¬ä¸­æ–­ã€‚ <ul><li>è´Ÿè´£è€—æ—¶çŸ­çš„å·¥ä½œï¼Œç‰¹ç‚¹æ˜¯å¿«é€Ÿæ‰§è¡Œï¼Œä¸€èˆ¬ä¼šæš‚æ—¶å…³é—­ä¸­æ–­è¯·æ±‚ã€‚ä¾‹å¦‚å¤„ç†è·Ÿç¡¬ä»¶ç›¸å…³æˆ–æ—¶é—´æ•æ„Ÿçš„äº‹æƒ…ã€‚</li></ul></li><li>ä¸‹åŠéƒ¨ï¼šç”±å†…æ ¸è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è½¯ä¸­æ–­ã€‚ <ul><li>è´Ÿè´£ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œï¼Œç‰¹ç‚¹æ˜¯å»¶è¿Ÿæ‰§è¡Œï¼Œé€šå¸¸è€—æ—¶è¾ƒé•¿ã€‚</li></ul></li></ul><p>å¦å¤–ï¼Œç¡¬ä¸­æ–­ä¼šæ‰“æ–­ CPU æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åç«‹å³æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºã€‚æ¯ä¸ª CPU éƒ½å¯¹åº”ä¸€ä¸ªè½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹ï¼Œåä¸º<code>ksoftirqd/CPU.no</code></p><p><code>watch -d cat /proc/softirqs</code> å¯ä»¥ç›‘æ§è½¯ä¸­æ–­å˜åŒ–ï¼Œ[]å†…çš„æ˜¯å†…æ ¸çº¿ç¨‹</p><h4 id="æ•°å€¼å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#æ•°å€¼å­˜å‚¨"><span>æ•°å€¼å­˜å‚¨</span></a></h4><p>è´Ÿæ•°ç”¨è¡¥ç è¡¨ç¤ºï¼šç»Ÿä¸€å’Œæ­£æ•°çš„åŠ å‡æ³•æ“ä½œ<br>åè¿›åˆ¶è½¬äºŒè¿›åˆ¶ï¼šæ•´æ•°é™¤ 2 å–ä½™å¹¶åè½¬ï¼Œå°æ•°ä¹˜ 2 å–æ•´</p><p>æµ®ç‚¹æ•°å­˜å‚¨ï¼š</p><p>$(-1)^\text{ç¬¦å·ä½} * (1 + \text{å°¾æ•°}) * 2^{\text{æŒ‡æ•°} - 127}$</p><ul><li>å°¾æ•°ä½å†³å®šäº†æµ®ç‚¹æ•°çš„ç²¾åº¦</li><li>æŒ‡æ•°ä½å†³å®šäº†æµ®ç‚¹æ•°çš„è¡¨ç¤ºèŒƒå›´</li></ul><p>ç”±äºè®¡ç®—æœºå­˜å‚¨æµ®ç‚¹æ•°æœ‰ä½æ•°é™åˆ¶ï¼Œæœ‰çš„å°æ•°æ— æ³•ç”¨ã€Œå®Œæ•´ã€çš„äºŒè¿›åˆ¶æ¥è¡¨ç¤ºï¼Œæ‰€ä»¥åªèƒ½ä»¥è¿‘ä¼¼å€¼ä¿å­˜ã€‚è¿›è€Œï¼Œä¸¤ä¸ªè¿‘ä¼¼æ•°ç›¸åŠ ï¼Œå¾—åˆ°çš„å¿…ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªè¿‘ä¼¼æ•°ã€‚</p><h3 id="os-ç»“æ„" tabindex="-1"><a class="header-anchor" href="#os-ç»“æ„"><span>OS ç»“æ„</span></a></h3><h4 id="å†…æ ¸æ€å’Œç”¨æˆ·æ€" tabindex="-1"><a class="header-anchor" href="#å†…æ ¸æ€å’Œç”¨æˆ·æ€"><span>å†…æ ¸æ€å’Œç”¨æˆ·æ€</span></a></h4><p>å†…æ ¸å…·æœ‰å¾ˆé«˜çš„æƒé™ï¼Œå¯ä»¥æ§åˆ¶ cpuã€å†…å­˜ã€ç¡¬ç›˜ç­‰ç¡¬ä»¶ï¼Œè€Œåº”ç”¨ç¨‹åºå…·æœ‰çš„æƒé™å¾ˆå°ï¼Œå› æ­¤ OS æŠŠå†…å­˜åˆ†æˆäº†ä¸¤ä¸ªåŒºåŸŸï¼š</p><ul><li>å†…æ ¸ç©ºé—´ï¼šè¿™ä¸ªå†…å­˜ç©ºé—´åªæœ‰å†…æ ¸ç¨‹åºå¯ä»¥è®¿é—®</li><li>ç”¨æˆ·ç©ºé—´ï¼šè¿™ä¸ªå†…å­˜ç©ºé—´ä¸“é—¨ç»™åº”ç”¨ç¨‹åºä½¿ç”¨</li></ul><p>ç”¨æˆ·ç©ºé—´çš„ä»£ç åªèƒ½è®¿é—®ä¸€ä¸ªå±€éƒ¨çš„å†…å­˜ç©ºé—´ï¼Œè€Œå†…æ ¸ç©ºé—´çš„ä»£ç å¯ä»¥è®¿é—®æ‰€æœ‰å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œç¨‹åºä½¿ç”¨ç”¨æˆ·ç©ºé—´å³è¯¥ç¨‹åºåœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼Œç¨‹åºä½¿ç”¨å†…æ ¸ç©ºé—´å³ç¨‹åºåœ¨å†…æ ¸æ€æ‰§è¡Œã€‚åº”ç”¨å¦‚æœéœ€è¦è¿›å…¥å†…æ ¸æ€ï¼Œéœ€è¦é€šè¿‡ä¸­æ–­å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸å¤„ç†å®Œåå†è§¦å‘ä¸­æ–­å›åˆ°ç”¨æˆ·æ€ã€‚</p><h4 id="å†…æ ¸è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#å†…æ ¸è®¾è®¡"><span>å†…æ ¸è®¾è®¡</span></a></h4><ul><li>Linux æ˜¯å®å†…æ ¸è®¾è®¡ï¼ŒåŒ…å«å¤šä¸ªæ¨¡å—ï¼Œæ•´ä¸ªå†…æ ¸åƒä¸€ä¸ªå®Œæ•´çš„ç¨‹åºï¼Œä¸”æ‹¥æœ‰æœ€é«˜çš„æƒé™</li><li>Windows æ˜¯æ··åˆå‹å†…æ ¸ï¼Œå¾®å†…æ ¸ï¼ˆå†…æ ¸åªä¿ç•™åŸºæœ¬èƒ½åŠ›ï¼‰åŸºç¡€ä¸Šæ­å»ºå…¶å®ƒæ¨¡å—</li></ul><h3 id="å†…å­˜ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#å†…å­˜ç®¡ç†"><span>å†…å­˜ç®¡ç†</span></a></h3><h4 id="è™šæ‹Ÿå†…å­˜" tabindex="-1"><a class="header-anchor" href="#è™šæ‹Ÿå†…å­˜"><span>è™šæ‹Ÿå†…å­˜</span></a></h4><p>ä¸ºäº†åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿å¾—è¿›ç¨‹ä¹‹é—´çš„å†…å­˜åœ°å€ä¸å—å½±å“ï¼Œç›¸äº’éš”ç¦»ï¼Œäºæ˜¯ OS æä¾›ä¸€ç§æœºåˆ¶ï¼Œå°†ä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€å’Œå†…å­˜çš„ç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ã€‚ç¨‹åºä»…è®¿é—®è™šæ‹Ÿåœ°å€ï¼Œç”± OS è½¬æ¢æˆä¸åŒçš„ç‰©ç†åœ°å€ã€‚</p><ul><li>ç¨‹åºä¸­ä½¿ç”¨çš„åœ°å€å«è™šæ‹Ÿå†…å­˜åœ°å€</li><li>ç¡¬ä»¶é‡Œçš„ç©ºé—´åœ°å€å«ç‰©ç†å†…å­˜åœ°å€</li></ul><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œæ‰€ä»¥æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´å°±æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚è¿›ç¨‹ä¹Ÿæ²¡æœ‰åŠæ³•è®¿é—®å…¶ä»–è¿›ç¨‹çš„é¡µè¡¨ï¼Œæ‰€ä»¥è¿™äº›é¡µè¡¨æ˜¯ç§æœ‰çš„ï¼Œè¿™å°±è§£å†³äº†å¤šè¿›ç¨‹ä¹‹é—´åœ°å€å†²çªçš„é—®é¢˜ã€‚</p><p><strong>å†…å­˜åˆ†æ®µ</strong><br>ç¨‹åºç”±è‹¥å¹²ä¸ªé€»è¾‘æ®µç»„æˆï¼Œä¾‹å¦‚ä»£ç åˆ†æ®µã€æ•°æ®åˆ†æ®µã€æ ˆæ®µã€å †æ®µã€‚ä¸åŒçš„æ®µæœ‰ä¸åŒçš„å±æ€§ï¼Œäºæ˜¯ç”¨åˆ†æ®µçš„å½¢å¼æŠŠè¿™äº›æ®µåˆ†ç¦»å‡ºæ¥ã€‚</p><p><img src="/img/%E5%86%85%E5%AD%98%E5%88%86%E6%AE%B5.webp#id=Ed6yQ&amp;originHeight=1004&amp;originWidth=1382&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>åˆ†æ®µæœºåˆ¶ä¸‹çš„è™šæ‹Ÿåœ°å€ç”±ä¸¤éƒ¨åˆ†ç»„æˆ:</p><ul><li>æ®µé€‰æ‹©å› å­: ä¿å­˜åœ¨æ®µå¯„å­˜å™¨é‡Œï¼ŒåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š <ul><li>æ®µå·ï¼šæ®µè¡¨çš„ç´¢å¼•ï¼Œæ®µè¡¨ = æ®µåŸºåœ°å€ + æ®µç•Œé™ + ç‰¹æƒç­‰çº§</li><li>ç‰¹æƒæ ‡å¿—ä½</li></ul></li><li>æ®µå†…åç§»é‡ï¼šæ®µåŸºåœ°å€ + æ®µå†…åç§»é‡ -&gt; ç‰©ç†å†…å­˜åœ°å€</li></ul><p>ç¼ºé™·ï¼š</p><ul><li>å†…å­˜ç¢ç‰‡ï¼šä¸»è¦æ˜¯å¤–éƒ¨å†…å­˜ç¢ç‰‡ï¼Œä¸è¿ç»­å†…å­˜ç©ºé—´å¯¼è‡´æ— æ³•åŠ è½½ä¸€ä¸ªæ–°è¿›ç¨‹ã€‚å¯ä»¥é€šè¿‡å†…å­˜äº¤æ¢è§£å†³ï¼ˆä¹Ÿå°±æ˜¯Swapåˆ†åŒºï¼‰</li><li>å†…å­˜äº¤æ¢æ•ˆç‡ä½ï¼šå†…å­˜äº¤æ¢éœ€è¦åœ¨ç¡¬ç›˜å’Œå†…å­˜é—´äº¤æ¢æ•°æ®ï¼Œç¡¬ç›˜é€Ÿåº¦å¤ªæ…¢ï¼Œå¦‚æœäº¤æ¢ä¸€ä¸ªå¾ˆå¤§çš„ç©ºé—´ï¼Œå°†é€ æˆå¡é¡¿</li></ul><p><strong>å†…å­˜åˆ†é¡µ</strong></p><p>ä¸ºäº†è§£å†³å†…å­˜åˆ†æ®µçš„ã€Œå¤–éƒ¨å†…å­˜ç¢ç‰‡å’Œå†…å­˜äº¤æ¢æ•ˆç‡ä½ã€çš„é—®é¢˜ï¼Œå°±å‡ºç°äº†å†…å­˜åˆ†é¡µã€‚åˆ†é¡µæ˜¯æŠŠæ•´ä¸ªè™šæ‹Ÿå’Œç‰©ç†å†…å­˜ç©ºé—´åˆ‡æˆä¸€æ®µæ®µå›ºå®šå°ºå¯¸çš„å¤§å°ï¼Œè¿™æ ·çš„ä¸€ä¸ªè¿ç»­ä¸”å°ºå¯¸å›ºå®šçš„å†…å­˜ç©ºé—´å«é¡µï¼ˆLinuxä¸‹ä¸€é¡µ4KBï¼‰ã€‚</p><p><img src="/img/%E5%86%85%E5%AD%98%E5%88%86%E9%A1%B5.webp#id=zADBN&amp;originHeight=561&amp;originWidth=935&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>åˆ†é¡µæœºåˆ¶ä¸‹çš„è™šæ‹Ÿåœ°å€ç”±ä¸¤éƒ¨åˆ†ç»„æˆ:</p><ul><li>é¡µå·ï¼šä½œä¸ºé¡µè¡¨çš„ç´¢å¼•ï¼Œé¡µè¡¨åŒ…å«ç‰©ç†é¡µæ‰€åœ¨ç‰©ç†å†…å­˜çš„åŸºåœ°å€</li><li>é¡µå†…åç§»ï¼šé¡µåŸºåœ°å€ + é¡µå†…åç§»é‡ -&gt; ç‰©ç†åœ°å†…å­˜å€</li></ul><p>ä¼˜ç‚¹ï¼š</p><ul><li>ç”±äºæ¯ä¸ªé¡µçš„å¤§å°å›ºå®šï¼Œå› æ­¤å­˜åœ¨å†…éƒ¨ç¢ç‰‡é—®é¢˜ã€‚ä½†ç¢ç‰‡å¾ˆå°</li><li>å†…å­˜ä¸è¶³æ—¶ï¼ŒOS æ¢å‡ºæœ€è¿‘æœªä½¿ç”¨çš„é¡µé¢ï¼Œéœ€è¦æ—¶å†æ¢å…¥ã€‚æ¯æ¬¡äº¤æ¢ä»…å‡ ä¸ªé¡µé¢ï¼Œå› æ­¤æ•ˆç‡è¾ƒé«˜</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ¯ä¸ªç¨‹åºéƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå› æ­¤é¡µè¡¨å ç”¨ç©ºé—´å¤§</li></ul><p>è§£å†³åŠæ³•ï¼šå¤šçº§é¡µè¡¨ã€‚å……åˆ†åˆ©ç”¨ç¨‹åºçš„å±€éƒ¨æ€§åŸç†ï¼Œä¸€çº§é¡µè¡¨éœ€è¦è¦†ç›–æ‰€æœ‰è™šæ‹Ÿåœ°å€ï¼Œè€ŒäºŒçº§é¡µè¡¨æŒ‰éœ€åˆ›å»ºã€‚å¯¹äº 64 ä½ç³»ç»Ÿï¼Œéœ€è¦å››çº§ç›®å½•ã€‚</p><p>ä¼˜åŒ–ï¼šTLB å¿«è¡¨ã€‚åˆ©ç”¨å±€éƒ¨æ€§åŸç†ï¼ŒæŠŠé¡µè¡¨é¡¹ç¼“å­˜åœ¨ CPU çš„ä¸€ä¸ªä¸“é—¨èŠ¯ç‰‡ TLB ï¼ˆTranslation Lookaside Buffer è½¬å€æ—è·¯ç¼“å­˜ï¼‰ä¸­ã€‚</p><p><strong>æ®µé¡µå¼å†…å­˜ç®¡ç†</strong></p><p>æ®µé¡µç»“åˆï¼Œè™½ç„¶å¢åŠ äº†ç¡¬ä»¶æˆæœ¬å’Œç³»ç»Ÿå¼€é”€ï¼Œä½†æé«˜äº†å†…å­˜çš„åˆ©ç”¨ç‡ã€‚</p><ul><li>å…ˆå°†ç¨‹åºåˆ’åˆ†ä¸ºå¤šä¸ªæœ‰é€»è¾‘æ„ä¹‰çš„æ®µï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„åˆ†æ®µæœºåˆ¶ï¼›</li><li>æ¥ç€å†æŠŠæ¯ä¸ªæ®µåˆ’åˆ†ä¸ºå¤šä¸ªé¡µï¼Œä¹Ÿå°±æ˜¯å¯¹åˆ†æ®µåˆ’åˆ†å‡ºæ¥çš„è¿ç»­ç©ºé—´ï¼Œå†åˆ’åˆ†å›ºå®šå¤§å°çš„é¡µï¼›</li></ul><p><img src="/img/%E6%AE%B5%E9%A1%B5%E5%BC%8F%E5%86%85%E5%AD%98.webp#id=pGugH&amp;originHeight=699&amp;originWidth=1452&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>å› æ­¤ï¼Œè®¿é—®å†…å­˜åœ°å€æ—¶ï¼š</p><ol><li>åˆ°æ®µè¡¨ä¸­æ ¹æ®æ®µå·æŸ¥è¯¢é¡µè¡¨åœ°å€</li><li>åˆ°é¡µè¡¨ä¸­æŸ¥è¯¢ç‰©ç†é¡µå·</li><li>ç‰©ç†é¡µåŸºåœ°å€ + é¡µå†…åç§»é‡ å¾—åˆ°ç‰©ç†å†…å­˜åœ°å€</li></ol><p><strong>è™šæ‹Ÿå†…å­˜ä¼˜ç‚¹</strong></p><ol><li>è™šæ‹Ÿå†…å­˜å¯ä»¥ä½¿å¾—è¿›ç¨‹å¯¹è¿è¡Œå†…å­˜è¶…è¿‡ç‰©ç†å†…å­˜å¤§å°ï¼Œå› ä¸ºç¨‹åºè¿è¡Œç¬¦åˆå±€éƒ¨æ€§åŸç†ï¼ŒCPU è®¿é—®å†…å­˜ä¼šæœ‰å¾ˆæ˜æ˜¾çš„é‡å¤è®¿é—®çš„å€¾å‘æ€§ï¼Œå¯¹äºé‚£äº›æ²¡æœ‰è¢«ç»å¸¸ä½¿ç”¨åˆ°çš„å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ¢å‡ºåˆ°ç‰©ç†å†…å­˜ä¹‹å¤–ï¼Œæ¯”å¦‚ç¡¬ç›˜ä¸Šçš„ swap åŒºåŸŸã€‚</li><li>ç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œæ‰€ä»¥æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´å°±æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚è¿›ç¨‹ä¹Ÿæ²¡æœ‰åŠæ³•è®¿é—®å…¶ä»–è¿›ç¨‹çš„é¡µè¡¨ï¼Œæ‰€ä»¥è¿™äº›é¡µè¡¨æ˜¯ç§æœ‰çš„ï¼Œè¿™å°±è§£å†³äº†å¤šè¿›ç¨‹ä¹‹é—´åœ°å€å†²çªçš„é—®é¢˜ã€‚</li><li>é¡µè¡¨é‡Œçš„é¡µè¡¨é¡¹ä¸­é™¤äº†ç‰©ç†åœ°å€ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ ‡è®°å±æ€§çš„æ¯”ç‰¹ï¼Œæ¯”å¦‚æ§åˆ¶ä¸€ä¸ªé¡µçš„è¯»å†™æƒé™ï¼Œæ ‡è®°è¯¥é¡µæ˜¯å¦å­˜åœ¨ç­‰ã€‚åœ¨å†…å­˜è®¿é—®æ–¹é¢ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†æ›´å¥½çš„å®‰å…¨æ€§ã€‚</li></ol><h4 id="linux-å†…å­˜ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#linux-å†…å­˜ç®¡ç†"><span>Linux å†…å­˜ç®¡ç†</span></a></h4><p>ç”±äº Intel CPU å†å²åŸå› ï¼ŒLinux ä¸å¾—ä¸ä½¿ç”¨è™šæ‹Ÿçš„æ®µå¼å†…å­˜ï¼Œåªç”¨äºè®¿é—®æ§åˆ¶å’Œå†…å­˜ä¿æŠ¤ï¼Œä¸»è¦è¿˜æ˜¯é¡µå¼å†…å­˜ç®¡ç†ã€‚æ•´ä¸ªå†…å­˜ç©ºé—´åˆ†ä¸ºäº†å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€çš„å†…æ ¸éƒ¨åˆ†éƒ½å…³è”ç›¸åŒçš„ç‰©ç†å†…å­˜ï¼Œè¿™æ ·è¿›ç¨‹åˆ‡æ¢åˆ°å†…æ ¸æ€åå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®¿é—®å†…æ ¸ç©ºé—´å†…å­˜ã€‚</p><p>è€Œç”¨æˆ·ç©ºé—´å†…å­˜åˆ†ä¸ºï¼š</p><ul><li>ä»£ç æ®µ: åŒ…æ‹¬äºŒè¿›åˆ¶å¯æ‰§è¡Œä»£ç ï¼›</li><li>æ•°æ®æ®µ: åŒ…æ‹¬å·²åˆå§‹åŒ–çš„é™æ€å¸¸é‡å’Œå…¨å±€å˜é‡ï¼›</li><li>BSS æ®µ: åŒ…æ‹¬æœªåˆå§‹åŒ–çš„é™æ€å˜é‡å’Œå…¨å±€å˜é‡ï¼›</li><li>å †æ®µ: åŒ…æ‹¬åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œä»ä½åœ°å€å¼€å§‹å‘ä¸Šå¢é•¿ï¼›</li><li>æ–‡ä»¶æ˜ å°„æ®µ: åŒ…æ‹¬åŠ¨æ€åº“ã€å…±äº«å†…å­˜ç­‰ï¼Œä»ä½åœ°å€å¼€å§‹å‘ä¸Šå¢é•¿</li><li>æ ˆæ®µ: åŒ…æ‹¬å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ç­‰ã€‚æ ˆçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸€èˆ¬æ˜¯ 8 MBã€‚å½“ç„¶ç³»ç»Ÿä¹Ÿæä¾›äº†å‚æ•°ï¼Œä»¥ä¾¿æˆ‘ä»¬è‡ªå®šä¹‰å¤§å°ï¼›</li></ul><p><img src="/img/32%E4%BD%8D%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.webp#id=cOAL8&amp;originHeight=976&amp;originWidth=1210&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>å¯¹äº 32ä½ OSï¼Œå†…æ ¸ç©ºé—´å  1Gï¼Œç”¨æˆ·ç©ºé—´ 3Gï¼Œå³ç†è®ºä¸Šå¯ä»¥ç”³è¯·æœ€å¤§ 3G è™šæ‹Ÿå†…å­˜ï¼›<br>å¯¹äº 64ä½ç³»ç»Ÿï¼Œå†…æ ¸ç©ºé—´ 128Tï¼Œç”¨æˆ·ç©ºé—´ 128Tï¼Œä¸­é—´æ˜¯æœªå®šä¹‰ï¼Œå³ç†è®ºä¸Šå¯ä»¥ç”³è¯·æœ€å¤§ 128G è™šæ‹Ÿå†…å­˜ã€‚</p><h4 id="å†…å­˜åˆ†é…" tabindex="-1"><a class="header-anchor" href="#å†…å­˜åˆ†é…"><span>å†…å­˜åˆ†é…</span></a></h4><ul><li>malloc() ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯ C çš„åº“å‡½æ•°ï¼Œç”¨äºåŠ¨æ€åˆ†é…å†…å­˜ã€‚</li><li>malloc() åˆ†é…çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œåªæœ‰åœ¨åˆæ¬¡è®¿é—®æ—¶ç”± OS è§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œå»ºç«‹å®é™…çš„æ˜ å°„å…³ç³»ã€‚ï¼ˆå› æ­¤ç”³è¯·æ—¶å¯ä»¥è¶…å‡ºç‰©ç†å†…å­˜é™åˆ¶ï¼‰</li><li>åˆ†é…ç©ºé—´æ—¶ï¼Œmalloc() ä¼šé¢„åˆ†é…ä¸€å®šçš„ç©ºé—´ä½œä¸ºå†…å­˜æ± ï¼Œä¾‹å¦‚ malloc(1) ä¼šç›´æ¥åˆ†é… 132KBã€‚</li><li>æ¯æ¬¡åˆ†é…çš„å†…å­˜å—å‰æœ‰ 16Byte å¤´ä¿¡æ¯ï¼Œå› æ­¤ free() åªéœ€è¦çŸ¥é“èµ·å§‹åœ°å€å°±çŸ¥é“è¯¥é‡Šæ”¾å¤šå¤§çš„å†…å­˜ç©ºé—´ã€‚</li></ul><p>ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>é€šè¿‡ brk() ç³»ç»Ÿè°ƒç”¨ä»å †åˆ†é…å†…å­˜ï¼Œå †é¡¶æŒ‡é’ˆä¸Šç§»ã€‚</li></ol><ul><li>ç”¨äºå°äº 128KB çš„å†…å­˜ç”³è¯·ã€‚</li><li>free() æ—¶ä¼šå…ˆæ”¾è¿› malloc å†…å­˜æ± ä¸­ä»¥å¤ç”¨ï¼Œç­‰è¿›ç¨‹é€€å‡ºåå†å½’è¿˜ OS</li></ul><ol start="2"><li>é€šè¿‡ mmap() ç³»ç»Ÿè°ƒç”¨åœ¨æ–‡ä»¶æ˜ å°„åŒºåŸŸåˆ†é…å†…å­˜ã€‚</li></ol><ul><li>ç”¨äºå¤§äº 128KB çš„å†…å­˜ç”³è¯·ã€‚</li><li>free() åç›´æ¥å½’è¿˜ OS</li></ul><p>å› æ­¤ï¼Œmmap() æ–¹å¼ä¼šé¢‘ç¹å‘ç”Ÿè¿è¡Œæ€çš„åˆ‡æ¢å’Œç¼ºé¡µä¸­æ–­ï¼Œè€Œ brk() é€šè¿‡å†…å­˜æ± å‡å°‘äº†ç³»ç»Ÿè°ƒç”¨å’Œç¼ºé¡µä¸­æ–­ã€‚ä½†æ˜¯ brk() ä¸æ–­åˆ†é…å°ç©ºé—´ï¼Œå›æ”¶åå¯èƒ½æ— æ³•ç”¨äºå¤§å†…å­˜çš„åˆ†é…ï¼Œè¿›è€Œäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>å†…å­˜æ³„éœ²ï¼šç¨‹åºä¸­å·²åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœã€‚<br>å†…å­˜æº¢å‡ºï¼šOOMï¼ŒæŒ‡åº”ç”¨ç³»ç»Ÿä¸­å­˜åœ¨æ— æ³•å›æ”¶çš„å†…å­˜æˆ–ä½¿ç”¨çš„å†…å­˜è¿‡å¤šï¼Œæœ€ç»ˆä½¿å¾—ç¨‹åºè¿è¡Œè¦ç”¨åˆ°çš„å†…å­˜å¤§äºèƒ½æä¾›çš„æœ€å¤§å†…å­˜ã€‚æ­¤æ—¶ç¨‹åºå°±è¿è¡Œä¸äº†ï¼Œç³»ç»Ÿä¼šæç¤ºå†…å­˜æº¢å‡ºã€‚</p><h4 id="å†…å­˜å›æ”¶" tabindex="-1"><a class="header-anchor" href="#å†…å­˜å›æ”¶"><span>å†…å­˜å›æ”¶</span></a></h4><p>malloc() åˆ†é…è™šæ‹Ÿå†…å­˜åï¼Œç¨‹åºåˆæ¬¡è®¿é—®æ—¶ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œè¿›è€Œä¸­æ–­å¤„ç†ç¨‹åºä¼šåˆ¤æ–­ç‰©ç†å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œä¸è¶³æ—¶å°†è¿›è¡Œå†…å­˜å›æ”¶ã€‚</p><p>å›æ”¶æµç¨‹ï¼škswapd -&gt; direct reclaim -&gt; OOM Killer</p><ul><li>åå°å†…å­˜å›æ”¶ kswapdï¼šåœ¨ç‰©ç†å†…å­˜ç´§å¼ çš„æ—¶å€™ï¼Œä¼šå”¤é†’ kswapd å†…æ ¸çº¿ç¨‹æ¥å›æ”¶å†…å­˜ï¼Œå¼‚æ­¥éé˜»å¡</li><li>ç›´æ¥å†…å­˜å›æ”¶ direct reclaimï¼šå¦‚æœåå°å¼‚æ­¥å›æ”¶è·Ÿä¸ä¸Šè¿›ç¨‹å†…å­˜ç”³è¯·çš„é€Ÿåº¦ï¼Œå°±ä¼šå¼€å§‹ç›´æ¥å›æ”¶ï¼ŒåŒæ­¥é˜»å¡</li><li>OOM: å¦‚æœç›´æ¥å›æ”¶ä»ç„¶æ— æ³•æ»¡è¶³ç¨‹åºçš„ç”³è¯·ï¼Œå†…æ ¸å°†è§¦å‘ OOMï¼Œç”± OOM Killer æ ¹æ®æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µå’Œ <code>oom_score_adj</code> å€¼è¿›è¡Œæ‰“åˆ†ï¼Œå¾—åˆ†æœ€é«˜çš„è¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Œç›´åˆ°é‡Šæ”¾è¶³å¤Ÿçš„å†…å­˜ï¼ˆå¯é€šè¿‡<code>/proc/[pid]/oom_score_adj</code>è°ƒæ•´è¢«æ€æ‰çš„æ¦‚ç‡ï¼‰ã€‚</li></ul><p><strong>å¯å›æ”¶å†…å­˜</strong></p><p>OS é€šè¿‡é¡µé¢ç½®æ¢ç®—æ³•å¾—åˆ°ä»¥ä¸‹ä¸¤ç±»å¯å›æ”¶çš„å†…å­˜ï¼š</p><ul><li>æ–‡ä»¶é¡µ File-backed Pageï¼šå†…æ ¸ç¼“å­˜çš„ç£ç›˜æ•°æ®ï¼ˆBufferï¼‰å’Œå†…æ ¸ç¼“å­˜çš„æ–‡ä»¶æ•°æ®ï¼ˆCacheï¼‰ <ul><li>å¯ä»¥ç›´æ¥é‡Šæ”¾ï¼Œéœ€è¦æ—¶é‡æ–°ä»ç£ç›˜è¯»å–</li><li>è„é¡µéœ€è¦å…ˆå†™å›</li></ul></li><li>åŒ¿åé¡µ Anonymous Pageï¼šåƒ å †ã€æ ˆ è¿™æ ·çš„æ²¡æœ‰å®é™…è½½ä½“çš„æ•°æ® <ul><li>é€šè¿‡ Linux çš„ Swap æœºåˆ¶ï¼ŒæŠŠä¸å¸¸ç”¨çš„å†…å­˜å†™å…¥ç£ç›˜ï¼Œéœ€è¦æ—¶é‡æ–°è½½å…¥</li></ul></li></ul><p>æ–‡ä»¶é¡µã€åŒ¿åé¡µçš„å›æ”¶éƒ½åŸºäº LRU ç®—æ³•ï¼Œåˆ†åˆ«å¯¹åº” activeã€inactive ä¸¤ä¸ªåŒå‘é“¾è¡¨ï¼ˆå…±å››ä¸ªé“¾è¡¨ï¼‰ï¼Œä¼˜å…ˆå›æ”¶ä¸å¸¸è®¿é—®çš„å†…å­˜ã€‚</p><p><strong>æ€§èƒ½ä¼˜åŒ–</strong></p><p>ç›´æ¥å†…å­˜å›æ”¶ä¼šé˜»å¡çº¿ç¨‹ï¼Œæ–‡ä»¶é¡µã€åŒ¿åé¡µéƒ½éœ€è¦ç£ç›˜ IOï¼Œå› æ­¤é¢‘ç¹çš„å†…å­˜å›æ”¶ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚ä¼˜åŒ–æªæ–½ï¼š</p><ol><li>å‡å° <code>/proc/sys/vm/swappiness</code>ï¼Œä½¿å…¶å€¾å‘äºå›æ”¶æ–‡ä»¶é¡µï¼ˆå¹²å‡€é¡µå¯ä»¥ç›´æ¥å›æ”¶ï¼Œå¥½äº Swap æ¢å…¥æ¢å‡ºï¼‰ã€‚èŒƒå›´0-100</li><li>å¢å¤§ <code>/proc/sys/vm/min_free_kbytes</code> ï¼Œè°ƒæ•´é¡µé˜ˆå€¼ï¼ŒåŠæ—©è§¦å‘åå°å›æ”¶ï¼Œé¿å…è¿›å…¥ç›´æ¥å†…å­˜å›æ”¶é˜»å¡è¿›ç¨‹</li></ol><ul><li>å†…æ ¸å®šä¹‰äº†ä¸‰ä¸ªå†…å­˜é˜ˆå€¼ï¼špages_min, pages_low, pages_highã€‚åä¸¤è€…åŸºäº pages_min è®¡ç®—è€Œå¾—</li><li>å†…å­˜å¤„åœ¨ pages_min å’Œ pages_low ä¹‹é—´æ—¶ä¼šè§¦å‘åå°å›æ”¶ kswapd</li></ul><ol><li>å¯¹äº NUMA æ¶æ„çš„ CPUï¼Œå¯ä»¥ç½® <code>/proc/sys/vm/zone_reclaim_mode</code> ä¸º 0ï¼Œä»¥æ”¯æŒè®¿é—®è¿œç«¯ Node å†…å­˜</li></ol><ul><li>SMPï¼šä¹Ÿç§° UMAï¼ˆUniform Memory Accessï¼‰ï¼Œæ¯ä¸ª CPU åœ°ä½å¹³ç­‰ï¼Œå…±äº«ç‰©ç†èµ„æºï¼Œå› æ­¤è®¿é—®å†…å­˜æ—¶é—´éƒ½ç›¸åŒã€‚ä½†æ€»çº¿å‹åŠ›å¤§ï¼Œå¯ç”¨å¸¦å®½å°</li><li>NUMAï¼šé UMAï¼Œå¯¹ CPU åˆ†ç»„ï¼Œæ¯ç»„ Node æœ‰ç‹¬ç«‹çš„ç‰©ç†èµ„æºï¼Œé€šè¿‡æ€»çº¿è®¿é—®å…¶å®ƒ Node å†…å­˜ï¼Œä½†è€—æ—¶ç¨é•¿ï¼ˆä½†æ”¶ç›Šé«˜äºå†…å­˜å›æ”¶ï¼‰</li></ul><h4 id="swap-æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#swap-æœºåˆ¶"><span>Swap æœºåˆ¶</span></a></h4><p>ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨æ—¶ï¼Œéœ€è¦å°†å†…å­˜æ•°æ®æ¢å‡ºåˆ°ç£ç›˜ï¼Œéœ€è¦æ—¶å†ä»ç£ç›˜æ¢å…¥å†…å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± Swap æœºåˆ¶æ§åˆ¶ã€‚ä¸€èˆ¬å›æ”¶åƒ å †ã€æ ˆ è¿™æ ·çš„æ²¡æœ‰å®é™…è½½ä½“çš„åŒ¿åé¡µæ•°æ®</p><p><strong>è§¦å‘åœºæ™¯</strong></p><ol><li>å†…å­˜ä¸è¶³ï¼šç³»ç»Ÿæ‰€éœ€å†…å­˜è¶…è¿‡å¯ç”¨ç‰©ç†å†…å­˜ï¼Œå†…æ ¸ä¼šè¿›è¡Œç›´æ¥å†…å­˜å›æ”¶ï¼Œä¿è¯æ­£åœ¨æ‰§è¡Œè¿›ç¨‹çš„å¯ç”¨æ€§ã€‚åŒæ­¥ã€‚</li><li>å†…å­˜é—²ç½®ï¼šé€šè¿‡åå°å®ˆæŠ¤è¿›ç¨‹ kSwapd å°†ä¸å†ä½¿ç”¨çš„å†…å­˜å›æ”¶ã€‚å¼‚æ­¥ã€‚</li></ol><p><strong>å¼€å¯æ–¹æ³•</strong></p><ol><li>Swap åˆ†åŒºï¼šç¡¬ç›˜ä¸Šçš„ç‹¬ç«‹åŒºåŸŸï¼Œä»…ç”¨äºäº¤æ¢åˆ†åŒº</li><li>Swap æ–‡ä»¶ï¼šæ–‡ä»¶ç³»ç»Ÿä¸­çš„ç‰¹æ®Šæ–‡ä»¶</li></ol><h4 id="ç¼“å­˜å‘½ä¸­ç‡" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜å‘½ä¸­ç‡"><span>ç¼“å­˜å‘½ä¸­ç‡</span></a></h4><p><strong>é¢„è¯»å¤±æ•ˆ</strong></p><p>Linux/MySQL ä¸ºè¯»ç¼“å­˜æä¾›äº†é¢„è¯»æœºåˆ¶ï¼Œé€šè¿‡ä¸€æ¬¡ç£ç›˜é¡ºåºè¯»å°†å¤šä¸ª Page (4KB)è£…å…¥ Page Cache (16KB)ï¼Œå‡å°‘ç£ç›˜IOï¼Œæé«˜ååé‡ã€‚è€Œå¦‚æœé¢„è¯»çš„æ•°æ®æ²¡æœ‰è¢«è®¿é—®ï¼Œå°±æ˜¯é¢„è¯»å¤±æ•ˆï¼Œå ç”¨äº† LRU é“¾è¡¨å‰æ’çš„ä½ç½®ï¼Œå¤§å¤§é™ä½äº†ç¼“å­˜å‘½ä¸­ç‡ã€‚</p><p>æ”¹è¿›æ–¹æ³•ï¼šè®©é¢„è¯»é¡µåœç•™åœ¨å†…å­˜é‡Œçš„æ—¶é—´è¦å°½å¯èƒ½çŸ­ï¼Œå› æ­¤å¯ä»¥åˆ’åˆ†å†·æ•°æ®å’Œçƒ­æ•°æ®ã€‚</p><ul><li>Linuxï¼šä¸¤ä¸ª LRU é“¾è¡¨ï¼Œæ´»è·ƒ LRU é“¾è¡¨ active_listï¼Œéæ´»è·ƒ LRU é“¾è¡¨ inactive_list <ul><li>é¢„è¯»é¡µå…ˆåŠ å…¥ inactive_list å¤´éƒ¨ï¼Œå¾…çœŸæ­£è¢«è®¿é—®æ—¶æ‰æ’å…¥ active_list å¤´éƒ¨</li><li>active_list æ·˜æ±°çš„é¡µé¢é™çº§åˆ° inactive_list å¤´éƒ¨</li></ul></li><li>MySQLï¼šLRU é“¾è¡¨åˆ’åˆ†å‰åŠéƒ¨åˆ† young åŒºåŸŸå’ŒååŠéƒ¨åˆ† old åŒºåŸŸ <ul><li>é¢„è¯»é¡µå…ˆåŠ å…¥ old åŒºåŸŸå¤´éƒ¨ï¼Œå¾…çœŸæ­£è¢«è®¿é—®æ—¶æ‰æ’å…¥ young åŒºåŸŸå¤´éƒ¨</li><li>young åŒºåŸŸæ·˜æ±°çš„é¡µé¢é™çº§åˆ° old åŒºåŸŸå¤´éƒ¨</li></ul></li></ul><p><strong>ç¼“å­˜æ±¡æŸ“</strong></p><p>æ‰¹é‡è¯»å–æ•°æ®æ—¶ï¼ˆä¾‹å¦‚ SQL å…¨è¡¨æ‰«æï¼‰ï¼Œç”±äºæ•°æ®ä»…è¢«è®¿é—®ä¸€æ¬¡ï¼Œè¿™äº›å¤§é‡æ•°æ®éƒ½ä¼šè¢«åŠ å…¥åˆ°ã€Œæ´»è·ƒ LRU é“¾è¡¨ã€é‡Œï¼Œç„¶åä¹‹å‰ç¼“å­˜åœ¨æ´»è·ƒ LRU é“¾è¡¨ï¼ˆæˆ–è€… young åŒºåŸŸï¼‰é‡Œçš„çƒ­ç‚¹æ•°æ®å…¨éƒ¨éƒ½è¢«æ·˜æ±°äº†ï¼Œå¦‚æœè¿™äº›å¤§é‡çš„æ•°æ®åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½ä¸ä¼šè¢«è®¿é—®çš„è¯ï¼Œé‚£ä¹ˆæ•´ä¸ªæ´»è·ƒ LRU é“¾è¡¨ï¼ˆæˆ–è€… young åŒºåŸŸï¼‰å°±è¢«æ±¡æŸ“äº†ã€‚</p><p>æ”¹è¿›æ–¹æ³•ï¼šæé«˜è¿›å…¥æ´»è·ƒ LRU é“¾è¡¨ï¼ˆæˆ–è€… young åŒºåŸŸï¼‰çš„é—¨æ§›ï¼Œé¿å…çƒ­ç‚¹æ•°æ®ä¸ä¼šè¢«è½»æ˜“æ›¿æ¢æ‰ã€‚</p><ul><li>Linuxï¼šå†…å­˜é¡µç¬¬äºŒæ¬¡è®¿é—®æ—¶æ‰è¿›è¡Œå‡çº§</li><li>MySQLï¼šå†…å­˜é¡µç¬¬äºŒæ¬¡è¢«è®¿é—®æ—¶ï¼Œåˆ¤æ–­å®ƒåœç•™åœ¨ old åŒºåŸŸçš„æ—¶é—´ï¼Œè¶…è¿‡ 1s å°±å‡çº§åˆ° young åŒºåŸŸï¼Œå¦åˆ™åœç•™åœ¨ old åŒºåŸŸ</li></ul><h3 id="è¿›ç¨‹ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹ç®¡ç†"><span>è¿›ç¨‹ç®¡ç†</span></a></h3><h4 id="è¿›ç¨‹" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹"><span>è¿›ç¨‹</span></a></h4><p>è¿è¡Œä¸­çš„ç¨‹åºï¼Œå°±è¢«ç§°ä¸ºã€Œè¿›ç¨‹ã€ï¼ˆProcessï¼‰ã€‚</p><ul><li>è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰ï¼šè¯¥æ—¶åˆ»è¿›ç¨‹å ç”¨ CPU</li><li>å°±ç»ªçŠ¶æ€ï¼ˆReadyï¼‰ï¼šå¯è¿è¡Œï¼Œç”±äºå…¶ä»–è¿›ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€è€Œæš‚æ—¶åœæ­¢è¿è¡Œ</li><li>é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰ï¼šè¯¥è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸€äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚ç­‰å¾…è¾“å…¥/è¾“å‡ºæ“ä½œçš„å®Œæˆï¼‰è€Œæš‚æ—¶åœæ­¢è¿è¡Œï¼Œè¿™æ—¶ï¼Œå³ä½¿ç»™å®ƒCPUæ§åˆ¶æƒï¼Œå®ƒä¹Ÿæ— æ³•è¿è¡Œ</li><li>åˆ›å»ºçŠ¶æ€ï¼ˆnewï¼‰ï¼šè¿›ç¨‹æ­£åœ¨è¢«åˆ›å»ºæ—¶çš„çŠ¶æ€</li><li>ç»“æŸçŠ¶æ€ï¼ˆExitï¼‰ï¼šè¿›ç¨‹æ­£åœ¨ä»ç³»ç»Ÿä¸­æ¶ˆå¤±æ—¶çš„çŠ¶æ€</li></ul><p><img src="/img/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81.webp#id=gi9T3&amp;originHeight=722&amp;originWidth=1166&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>å¦å¤–è¿˜æœ‰æŒ‚èµ·çŠ¶æ€ï¼Œæè¿°è¿›ç¨‹æš‚æ—¶è¢«æ·˜æ±°å‡ºå†…å­˜çš„çŠ¶æ€ï¼ˆsleep/æ¢å‡ºç­‰ï¼‰ï¼š</p><ul><li>é˜»å¡æŒ‚èµ·çŠ¶æ€ï¼šè¿›ç¨‹åœ¨å¤–å­˜ï¼ˆç¡¬ç›˜ï¼‰å¹¶ç­‰å¾…æŸä¸ªäº‹ä»¶çš„å‡ºç°ï¼›</li><li>å°±ç»ªæŒ‚èµ·çŠ¶æ€ï¼šè¿›ç¨‹åœ¨å¤–å­˜ï¼ˆç¡¬ç›˜ï¼‰ï¼Œä½†åªè¦è¿›å…¥å†…å­˜ï¼Œç«‹åˆ»è¿è¡Œï¼›</li></ul><p>æ ¹æ®è¿›ç¨‹æ‰€å¤„çš„ä¸åŒçŠ¶æ€ï¼Œå°†è¿›ç¨‹å¯¹åº”çš„è¿›ç¨‹æ§åˆ¶å— PCB é€šè¿‡é“¾è¡¨ç»„ç»‡èµ·æ¥ï¼Œä¾‹å¦‚å°±ç»ªé˜Ÿåˆ—ã€é˜»å¡é˜Ÿåˆ—ç­‰</p><h4 id="çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹"><span>çº¿ç¨‹</span></a></h4><p>çº¿ç¨‹æ˜¯è¿›ç¨‹å½“ä¸­çš„ä¸€æ¡æ‰§è¡Œæµç¨‹ã€‚åŒä¸€ä¸ªè¿›ç¨‹å†…å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«ä»£ç æ®µã€æ•°æ®æ®µã€æ‰“å¼€çš„æ–‡ä»¶ç­‰èµ„æºï¼Œä½†æ¯ä¸ªçº¿ç¨‹å„è‡ªéƒ½æœ‰ä¸€å¥—ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œæ ˆï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿çº¿ç¨‹çš„æ§åˆ¶æµæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼›</li><li>å„ä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å¹¶å‘æ‰§è¡Œï¼›</li><li>å„ä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«åœ°å€ç©ºé—´å’Œæ–‡ä»¶ç­‰èµ„æºï¼›</li></ul><p><strong>ç¼ºç‚¹</strong><br>å½“è¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ—¶ï¼Œä¼šå¯¼è‡´å…¶æ‰€å±è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹å´©æºƒã€‚ï¼ˆé’ˆå¯¹C/C++ï¼‰</p><p><strong>å®ç°</strong></p><ul><li>ç”¨æˆ·çº¿ç¨‹ï¼šåœ¨ç”¨æˆ·ç©ºé—´å®ç°çš„çº¿ç¨‹ï¼Œä¸æ˜¯ç”±å†…æ ¸ç®¡ç†çš„çº¿ç¨‹ï¼Œæ˜¯ç”±ç”¨æˆ·æ€çš„çº¿ç¨‹åº“æ¥å®Œæˆçº¿ç¨‹çš„ç®¡ç†</li><li>å†…æ ¸çº¿ç¨‹ï¼šåœ¨å†…æ ¸ä¸­å®ç°çš„çº¿ç¨‹ï¼Œæ˜¯ç”±å†…æ ¸ç®¡ç†çš„çº¿ç¨‹</li><li>è½»é‡çº§è¿›ç¨‹ï¼šåœ¨å†…æ ¸ä¸­æ¥æ”¯æŒç”¨æˆ·çº¿ç¨‹</li></ul><h4 id="è¿›ç¨‹å’Œçº¿ç¨‹å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹å’Œçº¿ç¨‹å¯¹æ¯”"><span>è¿›ç¨‹å’Œçº¿ç¨‹å¯¹æ¯”</span></a></h4><ul><li>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯å¤„ç†å™¨è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚</li><li>è¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œå› æ­¤ä¸ä¼šç›¸äº’å½±å“ï¼›è€Œçº¿ç¨‹å…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼ŒåŒ…æ‹¬å†…å­˜å’Œèµ„æºã€‚</li><li>çº¿ç¨‹æ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼Œç”±äºæ¶‰åŠèµ„æºå°‘ï¼Œè€Œä¸”ç›¸åŒçš„åœ°å€ç©ºé—´ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨ï¼Œçº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯ä»¥åŠåˆ‡æ¢æ‰€éœ€çš„å¼€é”€éƒ½æ¯”è¿›ç¨‹å°ã€‚</li></ul><h4 id="çº¿ç¨‹å’Œåç¨‹å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹å’Œåç¨‹å¯¹æ¯”"><span>çº¿ç¨‹å’Œåç¨‹å¯¹æ¯”</span></a></h4><p>åç¨‹æ˜¯ä¸€ç§è¿è¡Œåœ¨çº¿ç¨‹ä¹‹ä¸Šçš„ç”¨æˆ·æ€æ¨¡å‹ï¼Œä¹Ÿç§°çº¤ç¨‹ï¼Œåœ¨çº¿ç¨‹çš„åŸºç¡€ä¸Šé€šè¿‡æ—¶åˆ†å¤ç”¨çš„æ–¹å¼è¿è¡Œå¤šä¸ªåç¨‹ã€‚</p><ul><li>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªåç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¯ä»¥å•ç‹¬æ‹¥æœ‰å¤šä¸ªåç¨‹</li><li>çº¿ç¨‹è¿›ç¨‹éƒ½æ˜¯åŒæ­¥æœºåˆ¶ï¼Œè€Œåç¨‹åˆ™æ˜¯å¼‚æ­¥</li><li>åç¨‹åˆ‡æ¢ä¸éœ€è¦å†…æ ¸æ€/ç”¨æˆ·æ€çš„è½¬æ¢ï¼Œå¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€åˆ‡æ¢ä¸Šä¸‹æ–‡</li><li>åç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€</li></ul><h4 id="ä¸Šä¸‹æ–‡åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#ä¸Šä¸‹æ–‡åˆ‡æ¢"><span>ä¸Šä¸‹æ–‡åˆ‡æ¢</span></a></h4><p>CPU ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå…ˆæŠŠå‰ä¸€ä¸ªä»»åŠ¡çš„ CPU ä¸Šä¸‹æ–‡ï¼ˆCPU å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼‰ä¿å­˜èµ·æ¥ï¼Œç„¶ååŠ è½½æ–°ä»»åŠ¡çš„ä¸Šä¸‹æ–‡åˆ°è¿™äº›å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼Œæœ€åå†è·³è½¬åˆ°ç¨‹åºè®¡æ•°å™¨æ‰€æŒ‡çš„æ–°ä½ç½®ï¼Œè¿è¡Œæ–°ä»»åŠ¡ã€‚</p><p>æ ¹æ®ä»»åŠ¡çš„ä¸åŒï¼Œåˆ†ä¸‰ç§ï¼š</p><p><strong>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><ul><li>åœ¨å†…æ ¸æ€å®Œæˆï¼Œäº¤æ¢ä¿¡æ¯å­˜å‚¨åœ¨ PCB ä¸­</li><li>ä¸ä»…åŒ…å«äº†è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œè¿˜åŒ…æ‹¬å†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„èµ„æºã€‚</li></ul><p><strong>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><ul><li>å½“ä¸¤ä¸ªçº¿ç¨‹ä¸æ˜¯å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ™åˆ‡æ¢çš„è¿‡ç¨‹å°±è·Ÿè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸€æ ·ï¼›</li><li>å½“ä¸¤ä¸ªçº¿ç¨‹æ˜¯å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œå› ä¸ºè™šæ‹Ÿå†…å­˜æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥åœ¨åˆ‡æ¢æ—¶ï¼Œè™šæ‹Ÿå†…å­˜è¿™äº›èµ„æºå°±ä¿æŒä¸åŠ¨ï¼Œåªéœ€è¦åˆ‡æ¢çº¿ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€å’Œæ ˆæ•°æ®</li><li>æ¶‰åŠèµ„æºå°‘ï¼Œå¼€é”€æ¯”è¿›ç¨‹ä½å¾—å¤š</li></ul><p><strong>ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><ul><li>å“åº”ç¡¬ä»¶ä¸­æ–­æ—¶å‘ç”Ÿ</li><li>æ¯”è¿›ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ›´å¿«ï¼Œå› ä¸ºé€šå¸¸æ¶‰åŠæå°‘çš„çš„çŠ¶æ€ä¿¡æ¯</li></ul><h4 id="è¿›ç¨‹é—´é€šä¿¡" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹é—´é€šä¿¡"><span>è¿›ç¨‹é—´é€šä¿¡</span></a></h4><p>æ¯ä¸ªè¿›ç¨‹çš„ç”¨æˆ·åœ°å€ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸èƒ½äº’ç›¸è®¿é—®ï¼Œä½†å†…æ ¸ç©ºé—´æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ï¼Œå› æ­¤è¿›ç¨‹ä¹‹é—´è¦é€šä¿¡å¿…é¡»é€šè¿‡å†…æ ¸ã€‚</p><h5 id="ç®¡é“-pipe" tabindex="-1"><a class="header-anchor" href="#ç®¡é“-pipe"><span>ç®¡é“ï¼ˆPipeï¼‰</span></a></h5><ul><li>ç‰¹ç‚¹ï¼šä¸€ç§ç”¨äºçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„å•å‘é€šä¿¡æ–¹å¼ï¼Œé€šè¿‡<code>pipe</code>åˆ›å»ºï¼Œä»…å­˜åœ¨äºå†…å­˜ã€‚</li><li>ä¼˜ç‚¹ï¼šç®€å•ã€è½»é‡çº§ã€é€‚ç”¨äºä¸€å¯¹ä¸€é€šä¿¡ã€‚</li><li>ç¼ºç‚¹ï¼šå•å‘é€šä¿¡ï¼Œä¸é€‚ç”¨äºæ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</li></ul><h5 id="å‘½åç®¡é“-named-pipe" tabindex="-1"><a class="header-anchor" href="#å‘½åç®¡é“-named-pipe"><span>å‘½åç®¡é“ï¼ˆNamed Pipeï¼‰</span></a></h5><ul><li>ç‰¹ç‚¹ï¼šä¸€ç§å…è®¸æ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ä¹‹é—´è¿›è¡ŒåŒå‘é€šä¿¡çš„æ–¹å¼ã€‚é€šè¿‡<code>mkfifo</code>åˆ›å»ºã€‚</li><li>ä¼˜ç‚¹ï¼šæ”¯æŒåŒå‘é€šä¿¡ï¼Œé€‚ç”¨äºå¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</li><li>ç¼ºç‚¹ï¼šéœ€è¦æ˜¾å¼åˆ›å»ºå’Œå‘½åï¼Œæ•ˆç‡ä½ï¼Œä¸é€‚åˆè¿›ç¨‹é—´é¢‘ç¹äº¤æ¢æ•°æ®</li></ul><h5 id="æ¶ˆæ¯é˜Ÿåˆ—-message-queue" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—-message-queue"><span>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰</span></a></h5><p>æ¶ˆæ¯é˜Ÿåˆ—è§£å†³äº†ç®¡é“é€šä¿¡æ•ˆç‡ä½çš„é—®é¢˜ã€‚</p><ul><li>ç‰¹ç‚¹ï¼šå…è®¸ä¸åŒè¿›ç¨‹ä¹‹é—´è¿›è¡Œå¼‚æ­¥é€šä¿¡ï¼Œé€šè¿‡æ¶ˆæ¯ä¼ é€’æ•°æ®ã€‚</li><li>ä¼˜ç‚¹ï¼šæ”¯æŒå¤šå¯¹å¤šé€šä¿¡ã€å¼‚æ­¥é€šä¿¡ï¼Œæ¶ˆæ¯å…·æœ‰æ ¼å¼åŒ–ç»“æ„ã€‚</li><li>ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„ç¼–ç¨‹å·¥ä½œæ¥ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯æ‹·è´å¼€é”€å¤§ï¼Œä¸é€‚åˆå¤§æ•°æ®çš„ä¼ è¾“</li></ul><h5 id="å…±äº«å†…å­˜-shared-memory" tabindex="-1"><a class="header-anchor" href="#å…±äº«å†…å­˜-shared-memory"><span>å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰</span></a></h5><p>å…±äº«å†…å­˜è§£å†³äº† MQ çš„æ¶ˆæ¯æ‹·è´å¯¼è‡´é¢å¤–å¼€é”€çš„é—®é¢˜ï¼Œæ˜¯<strong>é€Ÿåº¦æœ€å¿«</strong>çš„ IPC æ–¹å¼ï¼Œå› ä¸ºä¸éœ€è¦åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å¤åˆ¶æ•°æ®ã€‚å‰ææ˜¯å¤„ç†å¥½å¤šè¿›ç¨‹å¹¶å‘è®¿é—®çš„é—®é¢˜ã€‚</p><ul><li>ç‰¹ç‚¹ï¼šå…è®¸å¤šä¸ªè¿›ç¨‹è®¿é—®åŒä¸€å—å†…å­˜åŒºåŸŸï¼Œå®ç°é«˜æ•ˆçš„æ•°æ®å…±äº«ã€‚</li><li>ä¼˜ç‚¹ï¼šé«˜æ•ˆã€å¿«é€Ÿï¼Œé€‚ç”¨äºå¤§é‡æ•°æ®å…±äº«ã€‚</li><li>ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„åŒæ­¥æœºåˆ¶æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå¯¹å†…å­˜ç®¡ç†è¦æ±‚è¾ƒé«˜ã€‚</li></ul><h5 id="ä¿¡å·é‡-semaphore" tabindex="-1"><a class="header-anchor" href="#ä¿¡å·é‡-semaphore"><span>ä¿¡å·é‡ï¼ˆSemaphoreï¼‰</span></a></h5><p>ä¿¡å·é‡æœºåˆ¶é˜²æ­¢äº†å¤šè¿›ç¨‹ç«äº‰å…±äº«èµ„æºè€Œé€ æˆæ•°æ®é”™ä¹±çš„é—®é¢˜ã€‚</p><ul><li>ç‰¹ç‚¹ï¼šç”¨äºæ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºè®¿é—®çš„æ–¹å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•´å‹çš„è®¡æ•°å™¨ï¼Œå¯ç”¨äºåŒæ­¥å’Œäº’æ–¥ã€‚ <ul><li>åŸå­ P æ“ä½œï¼šç”¨äºè¿›å…¥å…±äº«èµ„æºå‰ï¼Œä¿¡å·é‡å‡ 1ï¼Œç„¶åå¦‚æœä¿¡å·é‡ &lt; 0ï¼Œåˆ™è¡¨æ˜èµ„æºå·²è¢«å ç”¨ï¼Œè¿›ç¨‹éœ€é˜»å¡ç­‰å¾…ï¼›å¦åˆ™è¡¨æ˜è¿˜æœ‰èµ„æºå¯ä½¿ç”¨ï¼Œè¿›ç¨‹ç»§ç»­æ­£å¸¸æ‰§è¡Œ</li><li>åŸå­ V æ“ä½œï¼šç”¨äºç¦»å¼€å…±äº«èµ„æºåï¼Œä¿¡å·é‡åŠ  1ï¼Œç„¶åå¦‚æœä¿¡å·é‡ &lt;= 0ï¼Œåˆ™è¡¨æ˜å½“å‰æœ‰é˜»å¡ä¸­çš„è¿›ç¨‹ï¼Œä¼šå°†è¯¥è¿›ç¨‹å”¤é†’è¿è¡Œï¼›å¦åˆ™è¡¨æ˜å½“å‰æ²¡æœ‰é˜»å¡ä¸­çš„è¿›ç¨‹</li><li>Pã€Vå¿…é¡»æˆå¯¹å‡ºç°ã€‚</li><li>å¦‚æœä¿¡å·é‡åˆå§‹å€¼ä¸º1ï¼Œå³äº’æ–¥ä¿¡å·é‡ï¼Œä»»ä½•æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªè¿›ç¨‹è®¿é—®ï¼Œå¾ˆå¥½çš„ä¿æŠ¤äº†å…±äº«å†…å­˜ã€‚</li><li>å¦‚æœä¿¡å·é‡åˆå§‹å€¼ä¸º0ï¼Œå³åŒæ­¥ä¿¡å·é‡ï¼Œä¿è¯è¿›ç¨‹æ‰§è¡Œçš„å…ˆåï¼Œä¾‹å¦‚ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</li></ul></li><li>ä¼˜ç‚¹ï¼šæ”¯æŒè¿›ç¨‹åŒæ­¥å’Œäº’æ–¥ï¼Œå¯ç”¨äºå¤šç§é€šä¿¡åœºæ™¯ã€‚</li><li>ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚æ€§è¾ƒé«˜ï¼Œå®¹æ˜“å¼•å…¥æ­»é”ç­‰é—®é¢˜ã€‚</li></ul><h5 id="å¥—æ¥å­—-socket" tabindex="-1"><a class="header-anchor" href="#å¥—æ¥å­—-socket"><span>å¥—æ¥å­—ï¼ˆSocketï¼‰</span></a></h5><ul><li>ç‰¹ç‚¹ï¼šåŸºäºç½‘ç»œåè®®çš„IPCæ–¹å¼ï¼Œç”¨äºä¸åŒä¸»æœºä¸Šçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚ <ul><li><code>int socket(int domain, int type, int protocal)</code><ul><li>domain: åè®®æ—ï¼Œå¦‚ UPv4 å¯¹åº” AF_INET, IPv6 å¯¹åº” AF_INET6ï¼Œ æœ¬åœ°é€šä¿¡ AF_LOCAL/AF_UNIX</li><li>typeï¼šç±»å‹ï¼Œå¦‚ TCP å¯¹åº” SOCKET_STREAM, UDP å¯¹åº” SOCKET_DGRAM, SOCK_RAW</li><li>protocolï¼šåè®®ï¼ŒåŸºæœ¬åºŸå¼ƒï¼Œå¡«0</li></ul></li><li>å¯¹äº TCPï¼Œéœ€è¦ bind, listen, accept, write, read... æœåŠ¡ç«¯ç›‘å¬å’Œä¼ é€æ•°æ®ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ªsocketï¼ˆé—¨å«å’Œå‘˜å·¥ï¼‰</li><li>å¯¹äº UDPï¼Œåªè¦ bind, sendto, recvfrom</li></ul></li><li>ä¼˜ç‚¹ï¼šæ”¯æŒè·¨ç½‘ç»œé€šä¿¡ï¼Œå¯ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿã€‚</li><li>ç¼ºç‚¹ï¼šç›¸å¯¹å¤æ‚ï¼Œéœ€è¦ç½‘ç»œåè®®æ”¯æŒã€‚</li></ul><h5 id="ä¿¡å·-signal" tabindex="-1"><a class="header-anchor" href="#ä¿¡å·-signal"><span>ä¿¡å·ï¼ˆSignalï¼‰</span></a></h5><p>å¯¹äºå¼‚å¸¸æƒ…å†µä¸‹çš„å·¥ä½œæ¨¡å¼ï¼Œéœ€è¦ç”¨ã€Œä¿¡å·ã€çš„æ–¹å¼æ¥é€šçŸ¥è¿›ç¨‹ã€‚ä¾‹å¦‚ Ctrl+Z äº§ç”Ÿ SigSTP ä¿¡å·ï¼ŒCtrl+C äº§ç”Ÿ SigINT ä¿¡å·</p><ul><li>ç‰¹ç‚¹ï¼šç”¨äºé€šçŸ¥è¿›ç¨‹å‘ç”Ÿäº‹ä»¶ï¼ˆæ¥è‡ªè½¯ä»¶/ç¡¬ä»¶ï¼‰çš„è½»é‡çº§æ–¹å¼ï¼Œé€šå¸¸ç”¨äºå¤„ç†å¼‚æ­¥äº‹ä»¶ã€‚</li><li>ä¼˜ç‚¹ï¼šç®€å•ã€å¿«é€Ÿï¼Œç”¨äºå¤„ç†å¼‚æ­¥äº‹ä»¶ã€‚</li><li>ç¼ºç‚¹ï¼šåªèƒ½ä¼ é€’ç®€å•çš„ä¿¡æ¯ï¼Œä¸é€‚åˆå¤§é‡æ•°æ®äº¤æ¢ã€‚</li></ul><h4 id="çº¿ç¨‹é—´é€šä¿¡" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹é—´é€šä¿¡"><span>çº¿ç¨‹é—´é€šä¿¡</span></a></h4><p>ä¸´ç•ŒåŒºï¼šè®¿é—®å…±äº«èµ„æºçš„ä»£ç ç‰‡æ®µï¼Œäº§ç”Ÿæ¥è‡ªå¤šçº¿ç¨‹é—´çš„ç«äº‰æ¡ä»¶å¯¼è‡´ç¨‹åºè¿è¡Œçš„ä¸ç¡®å®šæ€§ã€‚<br>äº’æ–¥ï¼šä¿è¯ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹åœ¨ä¸´ç•ŒåŒºæ‰§è¡Œæ—¶ï¼Œå…¶ä»–è¿›ç¨‹/çº¿ç¨‹åº”è¯¥è¢«é˜»æ­¢è¿›å…¥ä¸´ç•ŒåŒº<br>åŒæ­¥ï¼šå¹¶å‘è¿›ç¨‹/çº¿ç¨‹åœ¨ä¸€äº›å…³é”®ç‚¹ä¸Šå¯èƒ½éœ€è¦äº’ç›¸ç­‰å¾…ä¸äº’é€šæ¶ˆæ¯ï¼Œè¿™ç§ç›¸äº’åˆ¶çº¦çš„ç­‰å¾…ä¸äº’é€šä¿¡æ¯ç§°ä¸ºè¿›ç¨‹/çº¿ç¨‹åŒæ­¥</p><p>é€šå¸¸ä½¿ç”¨ é”/ä¿¡å·é‡ å®ç°è¿›ç¨‹/çº¿ç¨‹äº’æ–¥ï¼Œä¿¡å·é‡åŠŸèƒ½æ›´å¼ºå¤§ï¼Œè¿˜èƒ½å®ç°åŒæ­¥ã€‚</p><ol><li>äº’æ–¥é”ï¼ˆMutexï¼‰ï¼šç”¨äºæ§åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œä¿è¯å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶çš„äº’æ–¥æ€§ã€‚åº•å±‚å¯ä»¥åŸºäº<code>æµ‹è¯•å¹¶è®¾ç½®</code>/<code>ç­‰å¾…é˜Ÿåˆ—</code></li><li>ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼šä¸€ç§åŒæ­¥å·¥å…·ï¼Œç”¨äºä¿è¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„é¡ºåºæ€§å’Œäº’æ–¥æ€§ã€‚Pæ“ä½œå‡1ï¼Œå°äº0é˜»å¡ï¼›VåŠ 1ï¼Œå°äºç­‰äº0å”¤é†’çº¿ç¨‹ã€‚åˆå§‹ç½® 1 å³äº’æ–¥ï¼Œç½® 0 å³åŒæ­¥ã€‚</li><li>æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰ï¼šç”¨äºçº¿ç¨‹é—´çš„ç­‰å¾…å’Œå”¤é†’ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç­‰å¾…æŸä¸ªæ¡ä»¶å˜é‡æ»¡è¶³åè¢«å”¤é†’ã€‚</li><li>å±éšœï¼ˆBarrierï¼‰ï¼šç”¨äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œå½“æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­æ“ä½œã€‚</li><li>è‡ªæ—‹é”ï¼ˆSpinlockï¼‰ï¼šä¸€ç§å¿™ç­‰å¾…çš„åŒæ­¥å·¥å…·ï¼Œå®ƒä¼šä¸æ–­åœ°æ£€æµ‹å…±äº«èµ„æºæ˜¯å¦å¯ç”¨ï¼Œç›´åˆ°èµ„æºå¯ç”¨åæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­æ“ä½œã€‚</li></ol><h4 id="çº¿ç¨‹åˆ›å»ºæ•°é‡" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹åˆ›å»ºæ•°é‡"><span>çº¿ç¨‹åˆ›å»ºæ•°é‡</span></a></h4><p>å—é™äºè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸Šé™å’Œç³»ç»Ÿå‚æ•°é™åˆ¶</p><ul><li>æ¯åˆ†é…ä¸€ä¸ªçº¿ç¨‹éœ€è¦åˆ†é…ä¸€å®šçš„è™šæ‹Ÿå†…å­˜ï¼Œä¾‹å¦‚å¯¹äº 32ä½ ç³»ç»Ÿï¼Œç”¨æˆ·ç©ºé—´3Gï¼Œæ¯ä¸ªçº¿ç¨‹å  10M è™šæ‹Ÿå†…å­˜ï¼Œåˆ™èƒ½åˆ›å»ºçº¦ 300 ä¸ªçº¿ç¨‹</li><li>/proc/sys/kernel/threads-max è¡¨ç¤ºç³»ç»Ÿæ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œé»˜è®¤ 14553</li><li>/proc/sys/kernel/pid_max è¡¨ç¤ºç³»ç»Ÿå…¨å±€çš„è¿›ç¨‹/çº¿ç¨‹ PID å·æ•°å€¼çš„é™åˆ¶ï¼Œé»˜è®¤ 32768</li><li>/proc/sys/vm/max_map_count è¡¨ç¤ºé™åˆ¶ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰çš„VMA(è™šæ‹Ÿå†…å­˜åŒºåŸŸ)çš„æ•°é‡ï¼Œé»˜è®¤ 65530</li></ul><h4 id="å…³é—­è¿›ç¨‹" tabindex="-1"><a class="header-anchor" href="#å…³é—­è¿›ç¨‹"><span>å…³é—­è¿›ç¨‹</span></a></h4><p><strong>çº¿ç¨‹å´©æºƒ</strong></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœçº¿ç¨‹å› ä¸ºéæ³•è®¿é—®å†…å­˜å¼•èµ·å´©æºƒï¼Œé‚£ä¹ˆè¿›ç¨‹ä¹Ÿä¼šå´©æºƒã€‚å› ä¸ºå„ä¸ªçº¿ç¨‹çš„åœ°å€ç©ºé—´æ˜¯å…±äº«çš„ï¼Œéæ³•è®¿é—®ä¼šå¯¼è‡´å†…å­˜çš„ä¸ç¡®å®šæ€§ã€‚</p><p><strong>è¿›ç¨‹å´©æºƒ</strong></p><p>è¿›ç¨‹ç»“æŸæ˜¯ç”±äº OSå†…æ ¸ å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‘è¿›ç¨‹å‘é€ä¿¡å·ï¼Œä¾‹å¦‚ SIGKILLï¼Œç„¶åæ‰§è¡Œè‡ªå®šä¹‰/é»˜è®¤çš„ä¿¡å·å¤„ç†å‡½æ•°(é™¤SIGKILL)ï¼Œæ‰§è¡Œå®Œæ¯•åç»“æŸè¿›ç¨‹ã€‚</p><p>å› æ­¤ï¼Œå¯¹äº JVM è¿™ç§è‡ªå·±å®šä¹‰äº†ä¿¡å·å¤„ç†å‡½æ•°çš„è¿›ç¨‹ï¼Œå¯ä»¥å‘é€ SIGTERMï¼ˆkill çš„é»˜è®¤ä¿¡å·ï¼‰å‘½ä»¤ï¼Œæ‰§è¡Œä¸€äº›èµ„æºæ¸…ç†åå† exit ä¼˜é›…åœ°é€€å‡ºã€‚è€Œåƒ StackOverFlowErrorã€NPE ç­‰éæ³•è®¿é—®å†…å­˜ï¼ŒJVM è‡ªå®šäº† SIGSEGV ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå†…éƒ¨é€šè¿‡æ ˆå›æº¯æ¢å¤çº¿ç¨‹æ‰§è¡Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚è€Œå…¶å®ƒçš„ SIGSEGV ä¿¡å· JVM ä¸åšç‰¹æ®Šå¤„ç†ï¼Œç”Ÿæˆå´©æºƒæ—¥å¿—å¹¶é€€å‡ºã€‚</p><h4 id="æ­»é”" tabindex="-1"><a class="header-anchor" href="#æ­»é”"><span>æ­»é”</span></a></h4><p>æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹æ–¹æ‰€éœ€è¦çš„èµ„æºï¼Œå¹¶ä¸”éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œå¯¼è‡´è¿™äº›çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œè¿›è€Œé™·å…¥äº†ä¸€ç§åƒµå±€çš„çŠ¶æ€ã€‚Java ç¨‹åºå¯ä»¥ä½¿ç”¨ jstack å·¥å…·æ£€æŸ¥æ­»é”ã€‚</p><p><strong>æ­»é”æ¡ä»¶</strong></p><ol><li>äº’æ–¥ï¼šå¤šä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªèµ„æºã€‚</li><li>è¯·æ±‚ä¸ä¿æŒï¼šçº¿ç¨‹æŒæœ‰èµ„æºåä¸ä¼šä¸»åŠ¨é‡Šæ”¾å·²ç»æŒæœ‰çš„èµ„æº</li><li>ä¸å¯æŠ¢å ï¼šçº¿ç¨‹å·²ç»æŒæœ‰çš„èµ„æºä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹å‰¥å¤º</li><li>å¾ªç¯ç­‰å¾…ï¼šä¸¤ä¸ªçº¿ç¨‹è·å–èµ„æºçš„é¡ºåºæ„æˆäº†ç¯å½¢é“¾</li></ol><p><strong>é¢„é˜²æ­»é”</strong></p><ol><li>ç ´ç¯äº’æ–¥ï¼šèµ„æºéç‹¬å ï¼Œå³å¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ä¸€ä¸ªèµ„æº</li><li>ç ´ç¯è¯·æ±‚ä¸ä¿æŒï¼šå¯ä»¥ä¸€æ¬¡æ€§è¯·æ±‚æ‰€æœ‰æ‰€éœ€çš„èµ„æºï¼Œæˆ–è¿è¡Œè¿‡ç¨‹ä¸­é€æ­¥é‡Šæ”¾æ‰å·²ä½¿ç”¨å®Œæ¯•çš„èµ„æº</li><li>ç ´åä¸å¯æŠ¢å ï¼šå·²æŒæœ‰èµ„æºçš„è¿›ç¨‹åœ¨æå‡ºæ–°çš„èµ„æºè¯·æ±‚æ²¡æœ‰å¾—åˆ°æ»¡è¶³æ—¶ï¼Œå®ƒå¿…é¡»é‡Šæ”¾å·²ç»ä¿æŒçš„æ‰€æœ‰èµ„æº</li><li>ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šé€šè¿‡å¯¹èµ„æºè¿›è¡Œæ’åºï¼ŒæŒ‰ç¼–å·é¡ºåºç”³è¯·ï¼Œä¿è¯èµ„æºç”³è¯·ä¸å½¢æˆç¯è·¯ï¼ˆæœ€å¸¸ç”¨ï¼Œå°†ç¨€ç¼ºèµ„æºè®¾ç½®è¾ƒå¤§çš„ç¼–å·ï¼ŒæŒ‰ä»å°åˆ°å¤§çš„åºå·ç”³è¯·ï¼‰</li></ol><p><strong>é¿å…æ­»é”</strong><br>é“¶è¡Œå®¶ç®—æ³•ï¼šåœ¨åˆ†é…èµ„æºæ—¶åˆ¤æ–­æ˜¯å¦ä¼šå‡ºç°æ­»é”ï¼Œåªåœ¨ä¸ä¼šå‡ºç°æ­»é”çš„æƒ…å†µä¸‹æ‰åˆ†é…èµ„æºã€‚ä½†æ˜¯è¿›ç¨‹å¿…é¡»äº‹å…ˆå£°æ˜æ¯ä¸ªè¿›ç¨‹è¯·æ±‚å¾—æœ€å¤§èµ„æºæ•°ã€‚</p><ul><li>Availableï¼šå¯åˆ©ç”¨èµ„æºå‘é‡</li><li>Maxï¼šæœ€å¤§éœ€æ±‚çŸ©é˜µ</li><li>Allocation: å·²åˆ†é…çŸ©é˜µ</li><li>Needï¼šéœ€æ±‚çŸ©é˜µ</li></ul><h4 id="ç»å…¸åŒæ­¥é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ç»å…¸åŒæ­¥é—®é¢˜"><span>ç»å…¸åŒæ­¥é—®é¢˜</span></a></h4><p><strong>å“²å­¦å®¶è¿›é¤é—®é¢˜</strong></p><ul><li>æ‹¿ç­·å­å‰åŠ ä¸Šäº’æ–¥ä¿¡å·é‡</li><li>å¶æ•°ç¼–å·å“²å­¦å®¶å…ˆæ‹¿å·¦è¾¹ç­·å­ï¼Œåæ‹¿å³è¾¹ç­·å­ï¼›å¥‡ä¹¦ç¼–å·å“²å­¦å®¶å…ˆæ‹¿å³è¾¹ç­·å­ï¼Œåæ‹¿å·¦è¾¹ç­·å­</li><li>state æ•°ç»„è®°å½•æ¯ä½å“²å­¦å®¶çš„ è¿›é¤/æ€è€ƒ/é¥¥é¥¿ çŠ¶æ€</li></ul><p><strong>è¯»è€…/å†™è€…é—®é¢˜</strong></p><ul><li>è¯»è€…æœ‰é™ï¼šwMutex å†™äº’æ–¥ï¼ŒrCount è¯»ä¸ªæ•°ï¼ŒrCountMutex å¯¹rCountçš„äº’æ–¥</li><li>å†™è€…ä¼˜å…ˆï¼šrMutex è¯»äº’æ–¥ï¼ŒwDataMutex å†™äº’æ–¥ï¼ŒwCount å†™æ•°é‡ï¼ŒwCountMutext å¯¹wCountçš„äº’æ–¥</li><li>å…¬å¹³ç­–ç•¥ï¼šè¯»å†™äº’æ–¥ã€ä¼˜å…ˆçº§ç›¸åŒã€ä¸€ä¸ªå†™è€…è®¿é—®ä¸´ç•ŒåŒºã€å¤šä¸ªè¯»è€…åŒæ—¶è®¿é—®ä¸´ç•ŒåŒº</li></ul><h4 id="é”æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é”æœºåˆ¶"><span>é”æœºåˆ¶</span></a></h4><p>ä¸ºäº†é¿å…èµ„æºç«äº‰è€Œå¯¼è‡´æ•°æ®é”™ä¹±ï¼Œå…±äº«èµ„æºè®¿é—®å‰éœ€è¦åŠ é”ï¼Œ</p><ul><li>äº’æ–¥é”ï¼š <ul><li>åŠ é”å¤±è´¥åï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾ CPUï¼Œå¹¶è¢«å†…æ ¸ç½®ä¸ºç¡çœ çŠ¶æ€</li><li>ç­‰åˆ°é”è¢«é‡Šæ”¾åï¼Œå†…æ ¸åœ¨åˆé€‚çš„æ—¶æœºå”¤é†’çº¿ç¨‹</li><li>åŠ é”å¤±è´¥/å”¤é†’çº¿ç¨‹ä¼šè¿›è¡Œç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå­˜åœ¨æ€§èƒ½å¼€é”€ã€‚å› æ­¤å¦‚æœè¢«é”ä½çš„ä»£ç æ‰§è¡Œæ—¶é—´å¾ˆçŸ­åº”é€‰æ‹©è‡ªæ—‹é”</li></ul></li><li>è‡ªæ—‹é”ï¼š <ul><li>åŠ é”å¤±è´¥åï¼Œçº¿ç¨‹ä¼šå¿™ç­‰å¾…ï¼Œç›´åˆ°å®ƒæ‹¿åˆ°é”</li><li>åº•å±‚åŸºäº CASï¼Œåœ¨ç”¨æˆ·æ€å®ŒæˆåŠ é”å’Œè§£é”ï¼Œå¼€é”€è¾ƒå°ã€‚å¿™ç­‰é€šè¿‡ whileå¾ªç¯/PAUSEæŒ‡ä»¤ æ¥å®ç°ï¼Œæ¨èPAUSEï¼ŒåŠ é”å¤±è´¥æ—¶cpuç¡çœ  30 clock é™ä½äº†è¯»é¢‘ç‡</li><li>å¯¹äºå•æ ¸CPUï¼Œéœ€è¦é…åˆæŠ¢å å¼çš„è°ƒåº¦å™¨ï¼Œå¦åˆ™è‡ªæ—‹çš„çº¿ç¨‹æ°¸è¿œä¸ä¼šæ”¾å¼ƒ CPU</li></ul></li></ul><p><strong>åŠ é”å¤±è´¥æ—¶ï¼Œäº’æ–¥é”è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œè‡ªæ—‹é”åˆ™å¿™ç­‰</strong></p><ul><li>è¯»å†™é”ï¼š <ul><li>è¯»å–å…±äº«èµ„æºç”¨è¯»é”ï¼Œä¿®æ”¹å…±äº«èµ„æºç”¨å†™é”ã€‚å¯ä»¥åŸºäºäº’æ–¥é”/è‡ªæ—‹é”</li><li>æ ¹æ®å®ç°è¿˜åˆ†ä¸ºè¯»ä¼˜å…ˆé”å’Œå†™ä¼˜å…ˆé”ï¼Œä½†å­˜åœ¨é¥¥é¥¿é—®é¢˜ï¼Œä»¥åŠå…¬å¹³è¯»å†™é”</li><li>é€‚ç”¨äºèƒ½æ˜ç¡®åŒºåˆ† read/writeï¼Œä¸”è¯»å¤šå†™å°‘çš„åœºæ™¯</li></ul></li></ul><p>ä»¥ä¸Šä¸‰ç§é”éƒ½æ˜¯æ‚²è§‚é”ï¼Œå³è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒé«˜ï¼Œäºæ˜¯å¾ˆå®¹æ˜“å‡ºç°å†²çªï¼Œæ‰€ä»¥è®¿é—®å…±äº«èµ„æºå‰ï¼Œå…ˆè¦ä¸Šé”ã€‚</p><p>è€Œä¹è§‚é”ï¼Œä¹Ÿå«æ— é”ç¼–ç¨‹ï¼Œå‡å®šå†²çªçš„æ¦‚ç‡å¾ˆä½ï¼Œå…ˆä¿®æ”¹å®Œå…±äº«èµ„æºï¼Œå†éªŒè¯è¿™æ®µæ—¶é—´å†…æœ‰æ²¡æœ‰å‘ç”Ÿå†²çªï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆæ“ä½œå®Œæˆï¼Œå¦åˆ™æ”¾å¼ƒæœ¬æ¬¡æ“ä½œï¼Œå¹¶è¿›è¡Œé‡è¯•æ¥è§£å†³å†²çªã€‚ä¹è§‚é”é€‚ç”¨äºå†²çªæ¦‚ç‡å¾ˆä½ï¼Œä¸”åŠ é”æˆæœ¬éå¸¸é«˜çš„åœºæ™¯ã€‚</p><h3 id="è°ƒåº¦ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦ç®—æ³•"><span>è°ƒåº¦ç®—æ³•</span></a></h3><h4 id="è¿›ç¨‹è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹è°ƒåº¦"><span>è¿›ç¨‹è°ƒåº¦</span></a></h4><p>ä¹Ÿå³çº¿ç¨‹è°ƒåº¦ã€‚æ ¹æ®å¦‚ä½•å¤„ç†æ—¶é’Ÿä¸­æ–­ ï¼ŒæŠŠè°ƒåº¦ç®—æ³•åˆ†æŠ¢å å¼å’ŒéæŠ¢å å¼ã€‚</p><p><strong>è°ƒåº¦åŸåˆ™</strong></p><ol><li>CPU åˆ©ç”¨ç‡ï¼šè°ƒåº¦ç¨‹åºåº”ç¡®ä¿ CPU æ˜¯å§‹ç»ˆåŒ†å¿™çš„çŠ¶æ€ï¼Œè¿™å¯æé«˜ CPU çš„åˆ©ç”¨ç‡ï¼›</li><li>ç³»ç»Ÿååé‡ï¼šååé‡è¡¨ç¤ºçš„æ˜¯å•ä½æ—¶é—´å†… CPU å®Œæˆè¿›ç¨‹çš„æ•°é‡ï¼Œé•¿ä½œä¸šçš„è¿›ç¨‹ä¼šå ç”¨è¾ƒé•¿çš„ CPU èµ„æºï¼Œå› æ­¤ä¼šé™ä½ååé‡ï¼Œç›¸åï¼ŒçŸ­ä½œä¸šçš„è¿›ç¨‹ä¼šæå‡ç³»ç»Ÿååé‡ï¼›</li><li>å‘¨è½¬æ—¶é—´ï¼šå‘¨è½¬æ—¶é—´æ˜¯è¿›ç¨‹è¿è¡Œ+é˜»å¡æ—¶é—´+ç­‰å¾…æ—¶é—´çš„æ€»å’Œï¼Œä¸€ä¸ªè¿›ç¨‹çš„å‘¨è½¬æ—¶é—´è¶Šå°è¶Šå¥½ï¼›</li><li>ç­‰å¾…æ—¶é—´ï¼šè¿™ä¸ªç­‰å¾…æ—¶é—´ä¸æ˜¯é˜»å¡çŠ¶æ€çš„æ—¶é—´ï¼Œè€Œæ˜¯è¿›ç¨‹å¤„äºå°±ç»ªé˜Ÿåˆ—çš„æ—¶é—´ï¼Œç­‰å¾…çš„æ—¶é—´è¶Šé•¿ï¼Œç”¨æˆ·è¶Šä¸æ»¡æ„ï¼›</li><li>å“åº”æ—¶é—´ï¼šç”¨æˆ·æäº¤è¯·æ±‚åˆ°ç³»ç»Ÿç¬¬ä¸€æ¬¡äº§ç”Ÿå“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œåœ¨äº¤äº’å¼ç³»ç»Ÿä¸­ï¼Œå“åº”æ—¶é—´æ˜¯è¡¡é‡è°ƒåº¦ç®—æ³•å¥½åçš„ä¸»è¦æ ‡å‡†ã€‚</li></ol><p><strong>è°ƒåº¦ç®—æ³•</strong></p><ul><li>å…ˆæ¥å…ˆæœåŠ¡ FCFSï¼šéæŠ¢å å¼ï¼Œå…ˆæ¥çš„è¿›ç¨‹ä¸€ç›´è¿è¡Œåˆ°é€€å‡ºæˆ–é˜»å¡ã€‚ä¸åˆ©äºçŸ­ä½œä¸šï¼Œé€‚ç”¨äº CPU ç¹å¿™å‹ä½œä¸šï¼Œä¸é€‚åˆ I/O ç¹å¿™å‹ä½œä¸šçš„ç³»ç»Ÿ</li><li>æœ€çŸ­ä½œä¸šä¼˜å…ˆ SJFï¼šä¼˜å…ˆé€‰æ‹©è¿è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹ã€‚ä¸åˆ©äºé•¿ä½œä¸šï¼Œç”šè‡³é¥¥é¥¿</li><li>é«˜å“åº”æ¯”ä¼˜å…ˆ HRRNï¼šå“åº”æ¯” = (ç­‰å¾…æ—¶é—´ + è¦æ±‚æœåŠ¡æ—¶é—´) / è¦æ±‚æœåŠ¡æ—¶é—´ã€‚æƒè¡¡äº†çŸ­ä½œä¸šå’Œé•¿ä½œä¸šï¼Œä½†è¦æ±‚æœåŠ¡æ—¶é—´æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œå› æ­¤åªæ˜¯ç†æƒ³ç®—æ³•</li><li>æ—¶é—´ç‰‡è½®è½¬ RRï¼šRound-Robinï¼Œå…³é”®åœ¨äºæ—¶é—´ç‰‡çš„è®¾å®šï¼Œè¿‡çŸ­å¯¼è‡´æ€•é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿‡é•¿ä¼šå¼•èµ·çŸ­ä½œä¸šè¿›ç¨‹çš„å“åº”æ—¶é—´å˜é•¿</li><li>æœ€é«˜ä¼˜å…ˆçº§ HPFï¼šåˆ†æŠ¢å å¼å’ŒéæŠ¢å å¼ï¼Œè¿˜åˆ†é™æ€ä¼˜å…ˆçº§å’ŒåŠ¨æ€ä¼˜å…ˆçº§ï¼ˆè¿è¡Œæ—¶é—´å¢åŠ é™ä½ä¼˜å…ˆçº§ï¼Œç­‰å¾…æ—¶é—´å¢åŠ æé«˜ä¼˜å…ˆçº§ï¼‰ã€‚å¯èƒ½å¯¼è‡´ä½ä¼˜å…ˆçº§é¥¥é¥¿</li><li>å¤šçº§åé¦ˆé˜Ÿåˆ— MFQï¼š <ul><li>å¤šçº§ï¼šå¤šä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§è¶Šé«˜æ—¶é—´ç‰‡è¶ŠçŸ­</li><li>åé¦ˆï¼šå¦‚æœæœ‰æ–°è¿›ç¨‹åŠ å…¥ä¼˜å…ˆçº§é«˜çš„é˜Ÿåˆ—ï¼Œç«‹åˆ»åœæ­¢å½“å‰è¿è¡Œè¿›ç¨‹ï¼Œè½¬è€Œå»è¿è¡Œä¼˜å…ˆçº§é«˜çš„é˜Ÿåˆ—ï¼›</li><li>æ–°è¿›ç¨‹æ”¾å…¥ç¬¬ä¸€çº§é˜Ÿåˆ—ï¼Œæ—¶é—´ç‰‡ç”¨å®Œæ”¾å…¥ä¸‹ä¸€çº§é˜Ÿåˆ—ï¼Œè¢«å¼ºå åˆ™æ”¾å…¥åŸé˜Ÿåˆ—æœ«å°¾</li><li>å…¼é¡¾äº†é•¿çŸ­ä½œä¸šï¼ŒåŒæ—¶æœ‰è¾ƒå¥½çš„å“åº”æ—¶é—´</li></ul></li></ul><h4 id="é¡µé¢è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#é¡µé¢è°ƒåº¦"><span>é¡µé¢è°ƒåº¦</span></a></h4><p>ç¼ºé¡µä¸­æ–­å’Œä¸€èˆ¬ä¸­æ–­çš„åŒºåˆ«ï¼š</p><ul><li>ç¼ºé¡µä¸­æ–­åœ¨æŒ‡ä»¤æ‰§è¡Œã€ŒæœŸé—´ã€äº§ç”Ÿå’Œå¤„ç†ä¸­æ–­ä¿¡å·ï¼Œè€Œä¸€èˆ¬ä¸­æ–­åœ¨ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œã€Œå®Œæˆã€åæ£€æŸ¥å’Œå¤„ç†ä¸­æ–­ä¿¡å·ã€‚</li><li>ç¼ºé¡µä¸­æ–­è¿”å›åˆ°è¯¥æŒ‡ä»¤çš„å¼€å§‹é‡æ–°æ‰§è¡Œã€Œè¯¥æŒ‡ä»¤ã€ï¼Œè€Œä¸€èˆ¬ä¸­æ–­è¿”å›åˆ°è¯¥æŒ‡ä»¤çš„ã€Œä¸‹ä¸€ä¸ªæŒ‡ä»¤ã€æ‰§è¡Œã€‚</li></ul><p>å½“å‡ºç°ç¼ºé¡µå¼‚å¸¸ï¼Œéœ€è°ƒå…¥æ–°é¡µé¢è€Œå†…å­˜å·²æ»¡æ—¶ï¼Œé€‰æ‹©è¢«ç½®æ¢çš„ç‰©ç†é¡µé¢ï¼š</p><ul><li>æœ€ä½³é¡µé¢ç½®æ¢ï¼šç†æƒ³ç®—æ³•ï¼Œç½®æ¢æœªæ¥æœ€é•¿æ—¶é—´ä¸è®¿é—®çš„é¡µé¢</li><li>å…ˆè¿›å…ˆå‡ºç½®æ¢ï¼šæ¢å‡ºé©»ç•™æ—¶é—´æœ€é•¿çš„é¡µé¢</li><li>æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ LRUï¼šæ¢å‡ºæœ€é•¿æ—¶é—´æœªè¢«è®¿é—®çš„é¡µé¢ã€‚å®ç°å¼€é”€ä¼šæ¯”è¾ƒå¤§</li><li>æ—¶é’Ÿé¡µé¢ç½®æ¢ï¼šæ‰€æœ‰é¡µé¢ä¿å­˜åœ¨ä¸€ä¸ªç¯å½¢é“¾è¡¨ä¸­ï¼Œç»´æŠ¤æŒ‡å‘æœ€è€çš„é¡µé¢ã€‚å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œé¡ºæ—¶é’ˆæ‰¾åˆ°ä¸€ä¸ªè®¿é—®ä½ä¸º 0 çš„é¡µé¢ç½®æ¢</li><li>æœ€ä¸å¸¸ç”¨ç½®æ¢ LFUï¼šæ¢å‡ºè®¿é—®æ¬¡æ•°æœ€å°‘çš„é¡µé¢ã€‚ä½†æ²¡æœ‰è€ƒè™‘æ—¶é—´é—®é¢˜ï¼Œå¯ä»¥å®šæœŸå‡å°‘å·²è®¿é—®æ¬¡æ•°ã€‚</li></ul><h4 id="ç£ç›˜è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#ç£ç›˜è°ƒåº¦"><span>ç£ç›˜è°ƒåº¦</span></a></h4><ul><li>å…ˆæ¥å…ˆæœï¼šç®€å•ç²—æš´ï¼Œç£é“åˆ†æ•£ï¼Œæ€§èƒ½ä½</li><li>æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼šä¼˜å…ˆé€‰æ‹©ä»å½“å‰ç£å¤´ä½ç½®æ‰€éœ€å¯»é“æ—¶é—´æœ€çŸ­çš„è¯·æ±‚ï¼Œå­˜åœ¨é¥¥é¥¿</li><li>Scanï¼šç£å¤´åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šç§»åŠ¨ï¼Œè®¿é—®æ‰€æœ‰æœªå®Œæˆçš„è¯·æ±‚ï¼Œç›´åˆ°ç£å¤´åˆ°è¾¾è¯¥æ–¹å‘ä¸Šçš„æœ€åçš„ç£é“ï¼Œæ‰è°ƒæ¢æ–¹å‘ã€‚ä¸­é—´ç£é“è®¿é—®é¢‘ç‡é«˜</li><li>CScanï¼šç£å¤´æœä¸€ä¸ªæ–¹å‘ç§»åŠ¨æ—¶å¤„ç†è¯·æ±‚ï¼Œè¿”å›æ—¶ç›´æ¥å¤ä½ä¸å¤„ç†è¯·æ±‚ã€‚å¯¹å„ä¸ªä½ç½®ç£é“å“åº”é¢‘ç‡æ¯”è¾ƒå¹³å‡</li><li>LOOKï¼šç±»ä¼¼ Scanï¼Œä½†ç£å¤´åœ¨ç§»åŠ¨åˆ°æœ€è¿œçš„è¯·æ±‚ä½ç½®æ—¶å°±ç«‹å³åå‘ç§»åŠ¨ã€‚</li><li>C-LOOKï¼šç±»ä¼¼ CScanï¼Œä¹Ÿæ˜¯æœ€è¿œè¯·æ±‚æ—¶å°±è¿”å›ï¼Œä¸”è¿”å›é€”ä¸­ä¸å¤„ç†è¯·æ±‚</li></ul><h3 id="æ–‡ä»¶ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶ç³»ç»Ÿ"><span>æ–‡ä»¶ç³»ç»Ÿ</span></a></h3><p>Linux ä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ™®é€šæ–‡ä»¶ã€ç›®å½•ã€å—è®¾å¤‡ã€ç®¡é“ã€Socket ç­‰ç­‰</p><h4 id="åŸºæœ¬ç»„æˆ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ç»„æˆ"><span>åŸºæœ¬ç»„æˆ</span></a></h4><p>Linux ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ†é…ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š</p><ul><li>inodeï¼šç´¢å¼•èŠ‚ç‚¹ï¼Œæ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œè®°å½•æ–‡ä»¶å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚ inode ç¼–å·ã€æ–‡ä»¶å¤§å°ã€è®¿é—®æƒé™ã€åˆ›å»º/ä¿®æ”¹æ—¶é—´ã€ç£ç›˜ä½ç½®ç­‰</li><li>dentryï¼šç›®å½•é¡¹ï¼Œå¤šä¸ªç›®å½•é¡¹å…³è”èµ·æ¥å½¢æˆç›®å½•ç»“æ„ã€‚è®°å½•æ–‡ä»¶çš„åå­—ã€inode æŒ‡é’ˆã€å…¶ä»–ç›®å½•é¡¹å±‚çº§å…³è”ç­‰ã€‚æœ¬è´¨æ˜¯å†…æ ¸åœ¨å†…å­˜ä¸­ç»´æŠ¤çš„æ•°æ®ç»“æ„ï¼Œä¸å­˜æ”¾äºç£ç›˜ã€‚</li></ul><p><img src="/img/%E7%9B%AE%E5%BD%95%E9%A1%B9%E5%92%8C%E7%B4%A2%E5%BC%95%E5%85%B3%E7%B3%BB%E5%9B%BE.webp#id=mkdtI&amp;originHeight=842&amp;originWidth=1172&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>ç£ç›˜æ ¼å¼åŒ–æ—¶ä¼šè¢«åˆ†æˆä¸‰ä¸ªå­˜å‚¨åŒºåŸŸï¼š</p><ul><li>è¶…çº§å—ï¼šç”¨æ¥å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿçš„å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚å—ä¸ªæ•°ã€å—å¤§å°ã€ç©ºé—²å—ç­‰ç­‰ã€‚æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶è¿›å…¥å†…å­˜</li><li>ç´¢å¼•èŠ‚ç‚¹åŒºï¼šç”¨æ¥å­˜å‚¨ç´¢å¼•èŠ‚ç‚¹ã€‚å½“æ–‡ä»¶è¢«è®¿é—®æ—¶è¿›å…¥å†…å­˜</li><li>æ•°æ®å—åŒºï¼šç”¨æ¥å­˜å‚¨æ–‡ä»¶æˆ–ç›®å½•æ•°æ®ã€‚å½“æ–‡ä»¶è¢«è®¿é—®æ—¶è¿›å…¥å†…å­˜</li></ul><p><strong>ç›®å½•</strong></p><p>ç›®å½•é¡¹è®°å½•ç€æ–‡ä»¶åï¼Œå’Œç´¢å¼•èŠ‚ç‚¹æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œå³æ–‡ä»¶å¯ä»¥æœ‰åˆ«åï¼Œä¾‹å¦‚ç¡¬é“¾æ¥çš„å®ç°ã€‚è€Œç›®å½•ä¹Ÿæ˜¯ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œè®°å½•å­ç›®å½•å’Œæ–‡ä»¶ã€‚ç›®å½•é¡¹æ—¢å¯ä»¥è¡¨ç¤ºæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºç›®å½•é¡¹ã€‚</p><p><strong>å­˜å‚¨</strong></p><p>ç£ç›˜è¯»å†™çš„æœ€å°å•ä½æ˜¯æ‰‡åŒºï¼Œé»˜è®¤ 512Bï¼Œè€Œæ–‡ä»¶ç³»ç»ŸæŠŠå¤šä¸ªæ‰‡åŒºæ„æˆä¸€ä¸ªé€»è¾‘å—ï¼Œé»˜è®¤ 4KBï¼Œä»¥é€»è¾‘å—ä¸ºå•ä½è¯»å†™ç£ç›˜ã€‚</p><p><strong>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</strong></p><p>VFS ä½äºç”¨æˆ·å±‚å’Œæ–‡ä»¶ç³»ç»Ÿä¸­é—´ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚æ ¹æ®å­˜å‚¨ä½ç½®çš„ä¸åŒï¼Œåˆ†ä¸ºç£ç›˜æ–‡ä»¶ç³»ç»Ÿï¼ˆExt2/3/4ï¼‰ã€å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼ˆ/proc, /sysï¼‰ã€ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ(NFS, SMB)</p><p><img src="/img/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.webp#id=N5wFA&amp;originHeight=1262&amp;originWidth=962&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>ç¡¬/è½¯é“¾æ¥</strong></p><ul><li>ç¡¬é“¾æ¥ï¼šå¤šä¸ªç›®å½•é¡¹ä¸­çš„ç´¢å¼•èŠ‚ç‚¹æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶ <ul><li>ä¸å¯ç”¨äºè·¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ‰å„è‡ªçš„ inode ç»“æ„å’Œåˆ—è¡¨</li><li>åªæœ‰åˆ é™¤æ–‡ä»¶çš„æ‰€æœ‰ç¡¬é“¾æ¥ä»¥åŠæºæ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šåˆ é™¤è¯¥æ–‡ä»¶</li></ul></li><li>è½¯é“¾æ¥ï¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæœ‰ç‹¬ç«‹ inode çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ <ul><li>å¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿ</li><li>å³ä½¿ç›®æ ‡æ–‡ä»¶åˆ é™¤äº†ï¼Œè½¯é“¾æ¥ä»åœ¨ï¼Œåªä¸è¿‡æ‰¾ä¸åˆ°ç›®æ ‡æ–‡ä»¶</li></ul></li></ul><h4 id="æ–‡ä»¶ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶ä½¿ç”¨"><span>æ–‡ä»¶ä½¿ç”¨</span></a></h4><p>open -&gt; write/read -&gt; close</p><ul><li>æ‰“å¼€æ–‡ä»¶åï¼ŒOS ä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶è¡¨ï¼Œæ¯ä¸€é¡¹ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ FDï¼ŒåŒ…æ‹¬ï¼š <ul><li>æ–‡ä»¶æŒ‡é’ˆï¼šè·Ÿè¸ªè¯»å†™ä½ç½®</li><li>æ‰“å¼€è®¡æ•°å™¨ï¼šæ‰“å¼€è¯¥æ–‡ä»¶çš„è¿›ç¨‹æ•°ï¼Œè®¡æ•°å™¨ä¸º0æ—¶æ‰å…³é—­æ–‡ä»¶ï¼Œåˆ é™¤è¯¥æ¡ç›®</li><li>æ–‡ä»¶ç£ç›˜ä½ç½®</li><li>è®¿é—®æƒé™</li></ul></li></ul><h4 id="æ–‡ä»¶å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶å­˜å‚¨"><span>æ–‡ä»¶å­˜å‚¨</span></a></h4><p><strong>è¿ç»­å­˜æ”¾</strong></p><ul><li>æ–‡ä»¶å­˜æ”¾åœ¨ç£ç›˜è¿ç»­çš„ç‰©ç†ç©ºé—´ä¸­</li><li>æ–‡ä»¶æ•°æ®ç´§å¯†ç›¸è¿ï¼Œè¯»å†™æ•ˆç‡é«˜ï¼ˆä¸€æ¬¡ç£ç›˜å¯»é“å°±å¯ä»¥è¯»å‡ºæ•´ä¸ªæ–‡ä»¶ï¼‰</li><li>ä½†ä¼šäº§ç”Ÿç£ç›˜ç¢ç‰‡ã€æ–‡ä»¶é•¿åº¦ä¸æ˜“æ‰©å±•çš„é—®é¢˜</li></ul><p><strong>éè¿ç»­å­˜æ”¾</strong></p><ul><li>é“¾è¡¨æ–¹å¼ï¼š <ul><li>æ•°æ®ç¦»æ•£ä¸è¿ç»­ï¼Œåˆ†éšå¼é“¾è¡¨ï¼ˆæŒ‡é’ˆç›¸è¿ï¼‰ã€æ˜¾å¼é“¾æ¥ï¼ˆé“¾æ¥è¡¨å­˜å‚¨å—åœ°å€ï¼‰</li><li>å¯ä»¥æ¶ˆé™¤ç£ç›˜ç¢ç‰‡ï¼Œæ–‡ä»¶é•¿åº¦ä¹Ÿå¯ä»¥åŠ¨æ€æ‰©å±•</li><li>ä½†éšå¼é“¾è¡¨æ— æ³•ç›´æ¥è®¿é—®æ•°æ®å—ï¼Œåªèƒ½é€šè¿‡æŒ‡é’ˆé¡ºåºè®¿é—®ï¼Œè€Œä¸”æŒ‡é’ˆè¿˜æ¶ˆè€—é¢å¤–å­˜å‚¨ç©ºé—´</li><li>è€Œæ˜¾å¼é“¾æ¥é€šè¿‡æ–‡ä»¶åˆ†é…è¡¨ï¼Œæé«˜äº†æ£€ç´¢é€Ÿåº¦ï¼Œå‡å°‘ç£ç›˜è®¿é—®æ¬¡æ•°ï¼Œä½†ä¸é€‚ç”¨äºå¤§ç£ç›˜</li></ul></li><li>ç´¢å¼•æ–¹å¼ <ul><li>ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªç´¢å¼•æ•°æ®å—ï¼Œå­˜æ”¾æŒ‡å‘æ–‡ä»¶æ•°æ®å—çš„æŒ‡é’ˆåˆ—è¡¨ã€‚æ–‡ä»¶å¤´ä¸­ä¿å­˜ç´¢å¼•æ•°æ®å—çš„æŒ‡é’ˆ</li><li>æ–‡ä»¶çš„åˆ›å»ºã€å¢å¤§ã€ç¼©å°éƒ½å¾ˆæ–¹ä¾¿ï¼Œæ²¡æœ‰ç¢ç‰‡é—®é¢˜ï¼Œæ”¯æŒé¡ºåºè¯»å†™å’Œéšæœºè¯»å†™</li><li>ä½†å­˜å‚¨ç´¢å¼•å ç”¨é¢å¤–ç©ºé—´ã€‚å¯¹äºå¤§æ–‡ä»¶ï¼Œéœ€è¦é“¾å¼ç´¢å¼•å—/å¤šçº§ç´¢å¼•å—</li></ul></li></ul><p>Unix ç³»ç»Ÿå¯¹äºä¸åŒå¤§å°çš„æ–‡ä»¶ï¼Œé‡‡å–é“¾è¡¨ã€ä¸€çº§ç´¢å¼•ã€äºŒçº§ç´¢å¼•ã€ä¸‰çº§ç´¢å¼•ç­‰æ–¹å¼ã€‚</p><h4 id="ç©ºé—²ç©ºé—´ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#ç©ºé—²ç©ºé—´ç®¡ç†"><span>ç©ºé—²ç©ºé—´ç®¡ç†</span></a></h4><p><strong>ç©ºé—²è¡¨</strong></p><ul><li>ç»´æŠ¤ä¸€å¼ è¡¨ï¼ŒåŒ…æ‹¬ç©ºé—²åŒºçš„ç¬¬ä¸€ä¸ªå—å·å’Œç©ºé—²å—ä¸ªæ•°</li><li>é€‚ç”¨äºå°‘é‡ç©ºé—²åŒºåœºæ™¯ï¼Œå¦åˆ™è¡¨é¡¹å¤ªå¤šæŸ¥è¯¢æ•ˆç‡ä½</li></ul><p><strong>ç©ºé—²é“¾è¡¨</strong></p><ul><li>ç©ºé—²å—æ„æˆé“¾è¡¨</li><li>ç®€å•ï¼Œä½†ä¸èƒ½éšæœºè®¿é—®ï¼ŒIO å¤šæ•ˆç‡ä½ï¼ŒæŒ‡é’ˆæ¶ˆè€—äº†å—çš„å­˜å‚¨ç©ºé—´</li></ul><p><strong>ä½å›¾æ³•</strong></p><ul><li>Linux æ–‡ä»¶ç³»ç»Ÿé‡‡ç”¨äº†ä½å›¾æ³•ï¼Œç”¨äºŒè¿›åˆ¶çš„ä¸€ä½æ¥è¡¨ç¤ºç£ç›˜ä¸­ä¸€ä¸ªå—çš„ä½¿ç”¨æƒ…å†µ</li><li>inode ç©ºé—²å—ä¹Ÿæ˜¯ä½å›¾æ³•ç®¡ç†</li></ul><h4 id="æ–‡ä»¶-io" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶-io"><span>æ–‡ä»¶ IO</span></a></h4><p><strong>ç¼“å†²/éç¼“å†² IO</strong></p><p>æ ¹æ®æ˜¯å¦åˆ©ç”¨æ ‡å‡†åº“ç¼“å†²ï¼Œåˆ†ï¼š</p><ul><li>ç¼“å†² IOï¼šåˆ©ç”¨æ ‡å‡†åº“çš„ç¼“å­˜å®ç°æ–‡ä»¶çš„åŠ é€Ÿè®¿é—®ï¼Œè€Œæ ‡å‡†åº“å†é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶</li><li>éç¼“å†² IOï¼šç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶ï¼Œä¸ç»è¿‡æ ‡å‡†åº“ç¼“å­˜</li></ul><p><strong>ç›´æ¥/éç›´æ¥ IO</strong></p><p>æ ¹æ®æ˜¯å¦åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ï¼Œåˆ†ï¼š</p><ul><li>ç›´æ¥ IOï¼šä¸ä¼šå‘ç”Ÿå†…æ ¸ç¼“å­˜å’Œç”¨æˆ·ç¨‹åºä¹‹é—´æ•°æ®å¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥ç»è¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®ç£ç›˜</li><li>éç›´æ¥ IOï¼šè¯»æ“ä½œæ—¶ï¼Œæ•°æ®ä»å†…æ ¸ç¼“å­˜ä¸­æ‹·è´ç»™ç”¨æˆ·ç¨‹åºï¼Œå†™æ“ä½œæ—¶ï¼Œæ•°æ®ä»ç”¨æˆ·ç¨‹åºæ‹·è´ç»™å†…æ ¸ç¼“å­˜ï¼Œå†ç”±å†…æ ¸å†³å®šä»€ä¹ˆæ—¶å€™å†™å…¥æ•°æ®åˆ°ç£ç›˜</li></ul><p>è§¦å‘å†™å›çš„åœºæ™¯æœ‰ï¼š</p><ul><li>åœ¨è°ƒç”¨ write çš„æœ€åï¼Œå½“å‘ç°å†…æ ¸ç¼“å­˜çš„æ•°æ®å¤ªå¤šçš„æ—¶å€™ï¼Œå†…æ ¸ä¼šæŠŠæ•°æ®å†™åˆ°ç£ç›˜ä¸Šï¼›</li><li>ç”¨æˆ·ä¸»åŠ¨è°ƒç”¨ syncï¼Œå†…æ ¸ç¼“å­˜ä¼šåˆ·åˆ°ç£ç›˜ä¸Šï¼›</li><li>å½“å†…å­˜ååˆ†ç´§å¼ ï¼Œæ— æ³•å†åˆ†é…é¡µé¢æ—¶ï¼Œä¹Ÿä¼šæŠŠå†…æ ¸ç¼“å­˜çš„æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šï¼›</li><li>å†…æ ¸ç¼“å­˜çš„æ•°æ®çš„ç¼“å­˜æ—¶é—´è¶…è¿‡æŸä¸ªæ—¶é—´æ—¶ï¼Œä¹Ÿä¼šæŠŠæ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šï¼›</li></ul><p><strong>é˜»å¡/éé˜»å¡ å’Œ åŒæ­¥/å¼‚æ­¥ IO</strong>ã€</p><ul><li>é˜»å¡ IOï¼šç¨‹åºæ‰§è¡Œ read æ—¶çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œä¸€ç›´ç­‰åˆ°å†…æ ¸æ•°æ®å‡†å¤‡å¥½ï¼Œå¹¶æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºä¸­ï¼Œæ‹·è´è¿‡ç¨‹å®Œæˆ read æ‰ä¼šè¿”å›</li><li>éé˜»å¡ IOï¼šread è¯·æ±‚åœ¨æ•°æ®æœªå‡†å¤‡å¥½çš„æƒ…å†µä¸‹ç«‹å³è¿”å›ï¼Œç¨‹åºå¯ä»¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ä½†åº”ç”¨ç¨‹åºä¼šä¸æ–­è½®è¯¢å†…æ ¸ï¼Œç›´åˆ°å†…æ ¸å°†æ•°æ®å‡†å¤‡å¥½å¹¶å°†æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œread è°ƒç”¨æ‰å¯ä»¥è·å–åˆ°ç»“æœï¼ˆé’ˆå¯¹è½®è¯¢çš„ä¼˜åŒ–ï¼šIO å¤šè·¯å¤ç”¨ select/poll/epollï¼‰</li></ul><p>æ— è®ºæ˜¯é˜»å¡ I/Oã€éé˜»å¡ I/Oï¼Œè¿˜æ˜¯åŸºäºéé˜»å¡ I/O çš„å¤šè·¯å¤ç”¨éƒ½æ˜¯åŒæ­¥è°ƒç”¨ï¼Œå› ä¸ºå®ƒä»¬åœ¨ read è°ƒç”¨æ—¶ï¼Œå†…æ ¸å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°åº”ç”¨ç¨‹åºç©ºé—´çš„è¿‡ç¨‹éƒ½æ˜¯éœ€è¦ç­‰å¾…çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ã€‚</p><p>è€ŒçœŸæ­£çš„å¼‚æ­¥ I/O æ˜¯ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€è¿™ä¸¤ä¸ªè¿‡ç¨‹éƒ½ä¸ç”¨ç­‰å¾…ï¼Œä¾‹å¦‚ aio_read()</p><h4 id="page-cache" tabindex="-1"><a class="header-anchor" href="#page-cache"><span>Page Cache</span></a></h4><p>Page Cache æœ¬è´¨ä¸Šæ˜¯ç”± Linux å†…æ ¸ç®¡ç†çš„å†…å­˜åŒºåŸŸï¼Œé€šè¿‡ mmap/buffered IO å°†æ–‡ä»¶è¯»å–åˆ°å†…å­˜ç©ºé—´å®é™…ä¸Šéƒ½æ˜¯è¯»å–åˆ° Page Cache ä¸­ã€‚</p><ul><li>ç”±å¤šä¸ª Page(4KB) æ„æˆï¼Œä½†ä¸æ˜¯æ‰€æœ‰ Page éƒ½æ„æˆ Page Cacheï¼Œä¾‹å¦‚åŒ¿åé¡µ</li><li>Page Cache ç”¨äºç¼“å­˜æ–‡ä»¶çš„é¡µæ•°æ®ï¼Œbuffer cache ç”¨äºç¼“å­˜å—è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼‰çš„å—æ•°æ®ã€‚</li><li>å¯ä»¥åŠ å¿«æ•°æ®è®¿é—®ï¼ŒåŒæ—¶åŸºäºé¢„è¯»ï¼Œå¯ä»¥å‡å°‘IOï¼Œæé«˜ç£ç›˜ååé‡</li><li>ä½†éœ€è¦å ç”¨é¢å¤–ç‰©ç†å†…å­˜ç©ºé—´ï¼Œç‰©ç†å†…å­˜ç´§å¼ æ—¶å¯èƒ½å¯¼è‡´é¢‘ç¹çš„ swap</li></ul><p><strong>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</strong></p><p>ä¸¤æ–¹é¢ï¼šæ•°æ®ä¸€è‡´ + å…ƒæ•°æ®ä¸€è‡´</p><ul><li>fsync(fd)ï¼šå°†æ–‡ä»¶çš„è„æ•°æ®å’Œè„å…ƒæ•°æ®å…¨éƒ¨åˆ·æ–°è‡³ç£ç›˜</li><li>fdatasync(fd)ï¼šå°†æ–‡ä»¶è„æ•°æ®åˆ·æ–°è‡³ç£ç›˜ï¼ŒåŒæ—¶åªåˆ·æ–°å¿…è¦çš„å…ƒæ•°æ®ï¼Œå¦‚æ–‡ä»¶å¤§å°</li><li>sync()ï¼šåˆ·æ–°å›è„çš„æ–‡ä»¶å…ƒæ•°æ®</li></ul><p><strong>å¯¹æ¯” Direct IO</strong></p><ul><li>Page Cache åœ¨å†…æ ¸ç©ºé—´å¼€è¾Ÿç¼“å†²åŒº</li><li>mmapï¼šç”¨æˆ·ç©ºé—´åšå†…å­˜æ˜ å°„ï¼ŒæŒ‡å‘ Page Cache</li><li>Direct IOï¼šå»æ‰ Page Cacheï¼Œäº¤ç”± DMAï¼Œç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´å¼€è¾Ÿç¼“å†²åŒº</li></ul><h3 id="è®¾å¤‡ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#è®¾å¤‡ç®¡ç†"><span>è®¾å¤‡ç®¡ç†</span></a></h3><p>IO è®¾å¤‡åˆ†ä¸¤å¤§ç±»ï¼š</p><ul><li>å—è®¾å¤‡ï¼šæ•°æ®å­˜å‚¨åœ¨å›ºå®šå¤§å°çš„å—ä¸­ï¼Œæ¯ä¸ªå—æœ‰è‡ªå·±çš„åœ°å€ã€‚å¦‚ç¡¬ç›˜ã€USBç­‰</li><li>å­—ç¬¦è®¾å¤‡ï¼šä»¥å­—ç¬¦ä¸ºå•ä½æ”¶å‘æ•°æ®ï¼Œä¸å¯å¯»å€ã€‚ä¾‹å¦‚é¼ æ ‡ã€é”®ç›˜ç­‰</li></ul><h4 id="è®¾å¤‡æ§åˆ¶å™¨" tabindex="-1"><a class="header-anchor" href="#è®¾å¤‡æ§åˆ¶å™¨"><span>è®¾å¤‡æ§åˆ¶å™¨</span></a></h4><p>æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªè®¾å¤‡æ§åˆ¶å™¨ï¼Œæ¥å±è”½è®¾å¤‡ä¹‹é—´çš„å·®å¼‚ã€‚å®ƒåŒ…æ‹¬ï¼š</p><ul><li>èŠ¯ç‰‡ï¼šæ‰§è¡Œé€»è¾‘</li><li>å¯„å­˜å™¨ï¼š <ul><li>çŠ¶æ€å¯„å­˜å™¨ï¼šå‘Šè¯‰ CPU å·¥ä½œæ˜¯å¦å·²ç»å®Œæˆ</li><li>å‘½ä»¤å¯„å­˜å™¨ï¼šä¿å­˜è¦æ‰§è¡Œçš„å‘½ä»¤</li><li>æ•°æ®å¯„å­˜å™¨ï¼šä¿å­˜éœ€è¦ä¼ è¾“çš„æ•°æ®</li></ul></li></ul><p>å—æ•°æ®é€šå¸¸ä¼ è¾“çš„æ•°æ®é‡å¤§ï¼Œå› æ­¤è®¾å¤‡æ§åˆ¶å™¨è®¾ç«‹äº†å¯è¯»å†™çš„æ•°æ®ç¼“å†²åŒºã€‚</p><p>è®¾å¤‡æ§åˆ¶å™¨å’Œ CPU çš„é€šä¿¡æ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li>ç«¯å£ IOï¼šæ¯ä¸ªæ§åˆ¶å¯„å­˜å™¨åˆ†é…ä¸€ä¸ª I/O ç«¯å£ï¼Œé€šè¿‡ç‰¹æ®Šæ±‡ç¼–æŒ‡ä»¤æ“ä½œ</li><li>å†…å­˜æ˜ å°„ IOï¼šå°†æ‰€æœ‰æ§åˆ¶å¯„å­˜å™¨æ˜ å°„åˆ°å†…å­˜ç©ºé—´ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥åƒè¯»å†™å†…å­˜ä¸€æ ·è¯»å†™æ•°æ®ç¼“å†²åŒº</li></ul><p><strong>IO æ§åˆ¶æ–¹å¼</strong></p><ul><li>è½®è¯¢ï¼šå‚»ç“œå¼ï¼Œå ç”¨CPU</li><li>ä¸­æ–­ï¼šè½¯ä¸­æ–­/ç¡¬ä¸­æ–­ï¼ŒCPU ç»å¸¸è¢«æ‰“æ–­å ç”¨</li><li>DMAï¼šç›´æ¥å†…å­˜è®¿é—®ï¼Œç”±ç¡¬ä»¶å®Œæˆæ•°æ®è¯»å†™å†…å­˜ï¼ŒCPU ä»…åœ¨ä¼ è¾“å¼€å§‹å’Œç»“æŸæ—¶å¹²é¢„</li></ul><h4 id="è®¾å¤‡é©±åŠ¨ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#è®¾å¤‡é©±åŠ¨ç¨‹åº"><span>è®¾å¤‡é©±åŠ¨ç¨‹åº</span></a></h4><p>è®¾å¤‡æ§åˆ¶å™¨å±äºç¡¬ä»¶ï¼Œè€Œè®¾å¤‡é©±åŠ¨ç¨‹åºå±äº OSã€‚æä¾› OS -&gt; è®¾å¤‡é©±åŠ¨ç¨‹åº -&gt; è®¾å¤‡æ§åˆ¶å™¨çš„ä¸­é—´å±‚æ¥å£ï¼Œåˆå§‹åŒ–æ—¶éœ€è¦æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p><p>IO å®Œæˆ -&gt; æ§åˆ¶å™¨å‘èµ·ä¸­æ–­ -&gt; ä¿æŠ¤è¢«ä¸­æ–­è¿›ç¨‹çš„ CPU ä¸Šä¸‹æ–‡ -&gt; æ‰§è¡Œä¸­æ–­å¤„ç†å‡½æ•° -&gt; æ¢å¤ä¸­æ–­è¿›ç¨‹ä¸Šä¸‹æ–‡</p><h4 id="é€šç”¨å—å±‚" tabindex="-1"><a class="header-anchor" href="#é€šç”¨å—å±‚"><span>é€šç”¨å—å±‚</span></a></h4><p>é’ˆå¯¹å—è®¾å¤‡ï¼ŒLinux é€šè¿‡é€šç”¨å—å±‚ç®¡ç†ä¸åŒçš„å—è®¾å¤‡ï¼Œæä¾›æ–‡ä»¶ç³»ç»Ÿå’Œé©±åŠ¨ç¨‹åºä¹‹é—´çš„æŠ½è±¡æ¥å£ï¼š</p><ul><li>å‘ä¸Šä¸ºæ–‡ä»¶ç³»ç»Ÿ/åº”ç”¨ç¨‹åºæä¾›è®¿é—®å—è®¾å¤‡çš„æ ‡å‡†æ¥å£</li><li>å‘ä¸‹æŠŠå„ç§ç£ç›˜è®¾å¤‡æŠ½è±¡ä¸ºç»Ÿä¸€çš„å—è®¾å¤‡</li><li>å¹¶ä¸”è¿›è¡Œ IOè¯·æ±‚ çš„è°ƒåº¦ï¼Œä»¥æé«˜è¯»å†™æ•ˆç‡</li></ul><p><strong>è°ƒåº¦ç®—æ³•</strong></p><ul><li>æ— è°ƒåº¦ï¼šä¸åšä»»ä½•å¤„ç†ã€‚é€šå¸¸ç”¨äºè™šæ‹Ÿæœºï¼Œå°† IO äº¤ç”±ç‰©ç†æœºè´Ÿè´£</li><li>å…ˆå…¥å…ˆå‡º</li><li>å®Œå…¨å…¬å¹³ï¼šæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ª IO è°ƒåº¦é˜Ÿåˆ—ï¼ŒæŒ‰æ—¶é—´ç‰‡å‡åŒ€åˆ†å¸ƒæ¯ä¸ªè¿›ç¨‹çš„ IOè¯·æ±‚</li><li>ä¼˜å…ˆçº§è°ƒåº¦ï¼šé€‚åˆå¤§é‡è¿›ç¨‹çš„ç³»ç»Ÿï¼Œå¦‚æ¡Œé¢ç¯å¢ƒã€å¤šåª’ä½“åº”ç”¨ç­‰</li><li>æœ€ç»ˆæœŸé™è°ƒåº¦ï¼šåˆ†è¯»ã€å†™IOé˜Ÿåˆ—ï¼Œå¹¶ç¡®ä¿è¾¾åˆ°æœ€ç»ˆæœŸé™çš„è¯·æ±‚è¢«ä¼˜å…ˆå¤„ç†ã€‚é€‚ç”¨äº IOå‹åŠ›å¤§çš„åœºæ™¯ã€‚å¦‚ DB</li></ul><h4 id="linux-io-åˆ†å±‚" tabindex="-1"><a class="header-anchor" href="#linux-io-åˆ†å±‚"><span>Linux IO åˆ†å±‚</span></a></h4><p><img src="/img/I_O%E8%BD%AF%E4%BB%B6%E5%88%86%E5%B1%82.webp#id=aTZtk&amp;originHeight=842&amp;originWidth=500&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><ul><li>æ–‡ä»¶ç³»ç»Ÿï¼šè™šæ‹Ÿæ–‡ä»¶/å…¶å®ƒæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“å®ç°ï¼Œå‘ä¸Šæä¾›ç»Ÿä¸€çš„æ–‡ä»¶è®¿é—®æ¥å£ï¼Œå‘ä¸‹é€šè¿‡é€šç”¨å—å±‚è®¿é—®è®¾å¤‡</li><li>é€šç”¨å—å±‚ï¼šåŒ…æ‹¬å—è®¾å¤‡çš„ I/O é˜Ÿåˆ—å’Œ I/O è°ƒåº¦å™¨ï¼Œé€‰æ‹© IOè¯·æ±‚ å‘ç»™è®¾å¤‡å±‚</li><li>è®¾å¤‡å±‚ï¼šåŒ…æ‹¬ç¡¬ä»¶è®¾å¤‡ã€è®¾å¤‡æ§åˆ¶å™¨å’Œé©±åŠ¨ç¨‹åºï¼Œè´Ÿè´£æœ€ç»ˆç‰©ç†è®¾å¤‡çš„ I/O æ“ä½œ</li></ul><p>Linux æä¾›äº†é¡µç¼“å­˜ã€ç´¢å¼•èŠ‚ç‚¹ç¼“å­˜ã€ç›®å½•é¡¹ç¼“å­˜ã€ç¼“å†²åŒºç­‰æ¥æé«˜ IOæ•ˆç‡ã€‚</p><h3 id="ç½‘ç»œç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œç³»ç»Ÿ"><span>ç½‘ç»œç³»ç»Ÿ</span></a></h3><h4 id="é›¶æ‹·è´" tabindex="-1"><a class="header-anchor" href="#é›¶æ‹·è´"><span>é›¶æ‹·è´</span></a></h4><p>DMAï¼šDirect Memory Access ç›´æ¥å†…å­˜è®¿é—®ï¼Œåœ¨è¿›è¡Œ I/O è®¾å¤‡å’Œå†…å­˜çš„æ•°æ®ä¼ è¾“çš„æ—¶å€™ï¼Œæ•°æ®æ¬è¿çš„å·¥ä½œå…¨éƒ¨äº¤ç»™ DMA æ§åˆ¶å™¨ï¼ŒCPU ä¸å†å‚ä¸ä»»ä½•ä¸æ•°æ®æ¬è¿ç›¸å…³çš„äº‹æƒ…ï¼Œä»è€Œå¤„ç†åˆ«çš„äº‹åŠ¡ã€‚å¦‚ä»Šæ¯ä¸ª I/O è®¾å¤‡é‡Œéƒ½æœ‰è‡ªå·±çš„ DMA æ§åˆ¶å™¨ã€‚</p><p>ä»¥æ–‡ä»¶ä¼ è¾“çš„åœºæ™¯ä¸ºä¾‹ï¼Œæ•°æ®ä»ç£ç›˜ -&gt; å†…æ ¸ç¼“å†²åŒºï¼ˆç£ç›˜é«˜é€Ÿç¼“å­˜ PageCacheï¼‰-&gt; ç”¨æˆ·ç©ºé—´ -&gt; Socket ç¼“å†²åŒº -&gt; ç½‘å¡ã€‚<br>æ•´ä¸ªè¿‡ç¨‹éœ€è¦äº§ç”Ÿ4æ¬¡å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆread/write 2æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œä»¥åŠ4æ¬¡æ•°æ®æ‹·è´ï¼ˆCPU å’Œ DMA å„è´Ÿè´£2æ¬¡ï¼‰ï¼Œæ•ˆç‡å¾ˆä½ã€‚å¯ä»¥é€šè¿‡é›¶æ‹·è´æŠ€æœ¯å‡å°‘è¿™ä¸¤ä¸ªå¼€é”€ï¼Œå®ç°æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ul><li>mmap + writeï¼š<code>mmap()</code>ç³»ç»Ÿè°ƒç”¨ç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´</li><li>sendfileï¼šç”¨ä¸€æ¬¡<code>sendfile()</code>ç³»ç»Ÿè°ƒç”¨æ›¿ä»£<code>read() + write()</code>ï¼Œå¹¶ä¸”ç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºæ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œå‡å°‘äº†2æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œ1æ¬¡æ•°æ®æ‹·è´</li><li>Zero-Copy: å¦‚æœç½‘å¡æ”¯æŒ SG-DMA æŠ€æœ¯ï¼Œç½‘å¡å¯ä»¥ç›´æ¥ä»å†…æ ¸ç¼“å†²ä¸­æ‹·è´æ•°æ®ï¼Œå…¨ç¨‹ä¸éœ€è¦ CPU æ‹·è´ï¼Œå‡å°‘äº†2æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œ2æ¬¡æ•°æ®æ‹·è´</li></ul><p>ä¹Ÿå› æ­¤ï¼Œé›¶æ‹·è´æŠ€æœ¯ä¸å…è®¸å¯¹æ•°æ®å†…å®¹åšè¿›ä¸€æ­¥çš„åŠ å·¥ã€‚</p><p><strong>PageCache</strong><br>PageCache çš„ä¼˜åŒ–åŒ…æ‹¬</p><ul><li>ç¼“å­˜æœ€è¿‘è¢«è®¿é—®çš„æ•°æ®</li><li>é¢„è¯»åŠŸèƒ½</li></ul><p>ä½†å¯¹äºå¤§æ–‡ä»¶ï¼ŒPageCache ä¼šè¢«å¤§æ–‡ä»¶å æ»¡ï¼Œä¼˜åŒ–å¤±æ•ˆå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚å› æ­¤é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé’ˆå¯¹å¤§æ–‡ä»¶çš„ä¼ è¾“ï¼Œå°½é‡ä½¿ç”¨å¼‚æ­¥IOï¼Œç»•å¼€ PageCacheï¼ˆä¹Ÿç§°ç›´æ¥ IOï¼Œè€Œä½¿ç”¨ PageCache çš„å«åš ç¼“å­˜IOï¼‰ã€‚å¦å¤–ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå·²ç»å®ç°äº†ç£ç›˜ç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨ ç›´æ¥IOï¼Œå‡å°‘é¢å¤–æ€§èƒ½æŸè€—ã€‚</p><h4 id="i-o-å¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#i-o-å¤šè·¯å¤ç”¨"><span>I/O å¤šè·¯å¤ç”¨</span></a></h4><p><strong>åŸºæœ¬ Socket æ¨¡å‹</strong></p><p>é€šè¿‡ Socket å»ºç«‹ TCP è¿æ¥æ—¶ï¼Œç›‘å¬å’Œä¼ è¾“æ•°æ®çš„æ˜¯ä¸¤ä¸ª Socketï¼ŒOS å†…æ ¸ä¸ºæ¯ä¸ª Socket ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p><ul><li>TCP åŠè¿æ¥é˜Ÿåˆ—ï¼šä¿å­˜è¿˜æ²¡æœ‰å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¤„äº syn_rcvd çš„çŠ¶æ€ï¼›</li><li>TCP å…¨è¿æ¥é˜Ÿåˆ—ï¼šä¿å­˜å®Œæˆäº†ä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¤„äº established çŠ¶æ€ï¼›</li></ul><p>è¿™ç§æ¨¡å¼åŸºäºåŒæ­¥é˜»å¡ï¼Œåªèƒ½ä¸€å¯¹ä¸€é€šä¿¡</p><p><strong>å¤šè¿›ç¨‹æ¨¡å‹</strong></p><p>æœåŠ¡å™¨çš„ä¸»è¿›ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·çš„è¿æ¥ï¼Œä¸€æ—¦ä¸å®¢æˆ·ç«¯è¿æ¥å®Œæˆï¼Œé€šè¿‡ fork åˆ›å»ºå­è¿›ç¨‹æœåŠ¡å®¢æˆ·ã€‚ä½†æ˜¯ï¼Œå­è¿›ç¨‹é€€å‡ºåå¯èƒ½ä¿ç•™ä¸€äº›ä¿¡æ¯æˆä¸ºåƒµå°¸è¿›ç¨‹æ¶ˆè€—èµ„æºï¼Œéœ€è¦ä¸»è¿›ç¨‹é€šè¿‡ wait/waitpid å›æ”¶èµ„æºã€‚</p><p>ç”±äºè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼ˆè™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´èµ„æºï¼Œä»¥åŠå†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´èµ„æºï¼‰å¾ˆå¤§ï¼Œå› æ­¤è¿™ç§æ¨¡å¼å¹¶å‘é‡ä¸èƒ½å¾ˆé«˜ã€‚</p><p><strong>å¤šçº¿ç¨‹æ¨¡å‹</strong></p><p>å½“æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ TCP å®Œæˆè¿æ¥åï¼Œé€šè¿‡ pthread_create() å‡½æ•°åˆ›å»ºçº¿ç¨‹ï¼Œç„¶åå°†ã€Œå·²è¿æ¥ Socketã€çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™çº¿ç¨‹å‡½æ•°ï¼Œæ¥ç€åœ¨çº¿ç¨‹é‡Œå’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œä»è€Œè¾¾åˆ°å¹¶å‘å¤„ç†çš„ç›®çš„ã€‚ä½†æ˜¯é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œç³»ç»Ÿå¼€é”€ä¹Ÿæ˜¯ä¸å°çš„ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹æ± è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯æ³¨æ„éœ€è¦å¯¹å­˜æ”¾ Socket çš„é˜Ÿåˆ—åŒæ­¥åŠ é”ã€‚</p><p>æ— è®ºåŸºäºè¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œå¯¹äºä¸€å°æœºå™¨æƒ³è¦è¾¾åˆ° C10K çš„å¹¶å‘é‡è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</p><p><strong>I/O å¤šè·¯å¤ç”¨</strong></p><p>ä¸€ä¸ªè¿›ç¨‹å¤„ç†æ¯ä¸ªè¯·æ±‚å¦‚æœä»…éœ€ 1msï¼Œé‚£ä¹ˆå¤šä¸ªè¯·æ±‚å¤ç”¨ä¸€ä¸ªè¿›ç¨‹å°±å¯ä»¥å®ç°é«˜å¹¶å‘ï¼Œä¹Ÿå«æ—¶åˆ†å¤šè·¯å¤ç”¨ã€‚<code>select/poll/epoll</code>æ˜¯å†…æ ¸æä¾›ç»™ç”¨æˆ·æ€çš„å¤šè·¯å¤ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡è¿™äº›ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä»å†…æ ¸ä¸­è·å–å¤šä¸ªäº‹ä»¶ã€‚</p><ol><li>select</li></ol><ul><li>å°†å·²è¿æ¥çš„ Socket æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œç„¶åè°ƒç”¨ select å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´åˆ°å†…æ ¸é‡Œï¼Œç”±å†…æ ¸éå†åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶ï¼Œæ ‡è®°å¯è¯»/å¯å†™</li><li>æ¥ç€å†æŠŠæ•´ä¸ªæè¿°ç¬¦é›†åˆæ‹·è´å›ç”¨æˆ·æ€ï¼Œç”¨æˆ·æ€å†éå†ä¸€æ¬¡æ‰¾åˆ°å¯è¯»/å¯å†™çš„ Socketï¼Œå–å‡ºè¿›è¡Œå¤„ç†</li><li>éœ€è¦ 2 æ¬¡éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œç”¨å›ºå®šé•¿åº¦çš„ BitsMap è¡¨ç¤ºæè¿°ç¬¦é›†åˆï¼Œä¸ªæ•°å—é™</li></ul><ol start="2"><li>poll</li></ol><ul><li>ä»¥é“¾è¡¨å½¢å¼ç»„ç»‡ä¸€ä¸ªåŠ¨æ€æ•°ç»„è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå’Œ select ä¸€æ ·ä¹Ÿè¦åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€å„éå† 1 æ¬¡</li></ul><ol start="3"><li>epoll</li></ol><ul><li>å…ˆç”¨ epoll_create åˆ›å»ºä¸€ä¸ª epoll æ–‡ä»¶æè¿°ç¬¦ epfdï¼Œé€šè¿‡ epoll_ctl å°†éœ€è¦ç›‘è§†çš„ socket æ·»åŠ åˆ° epfd ä¸­ï¼Œæœ€åè°ƒç”¨ epoll_wait ç­‰å¾…æ•°æ®</li><li>å†…æ ¸ä¸­ä½¿ç”¨çº¢é»‘æ ‘æ¥è·Ÿè¸ªè¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒCRUD æ•ˆç‡å¾ˆé«˜</li><li>ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸ä¸­ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡å›è°ƒå‡½æ•°ï¼Œå†…æ ¸ä¼šå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ã€‚ç”¨æˆ·è°ƒç”¨ epoll_wait å¾—åˆ°æœ‰äº‹ä»¶å‘ç”Ÿçš„æè¿°ç¬¦ä¸ªæ•°ã€‚åªå°†æœ‰äº‹ä»¶å‘ç”Ÿçš„ Socket é›†åˆä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼Œå› æ­¤åªåœ¨ epoll_wait æœŸé—´å‘ç”Ÿäº†ä¸€æ¬¡å†…å­˜æ‹·è´ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡</li></ul><p>ä¸¤ç§äº‹ä»¶è§¦å‘æ¨¡å¼ï¼š</p><ul><li>è¾¹ç¼˜è§¦å‘ï¼š <ul><li>å½“è¢«ç›‘æ§çš„ Socket æè¿°ç¬¦ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ç«¯åªä¼šä» epoll_wait ä¸­è‹é†’ä¸€æ¬¡</li><li>å› æ­¤ç¨‹åºè¦ä¿è¯ä¸€æ¬¡æ€§å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®è¯»å–å®Œï¼›</li><li>ä¸€èˆ¬å’Œéé˜»å¡ I/O æ­é…ä½¿ç”¨ï¼Œæ•ˆç‡è¦é«˜äºæ°´å¹³è§¦å‘</li></ul></li><li>æ°´å¹³è§¦å‘ï¼š <ul><li>å½“è¢«ç›‘æ§çš„ Socket ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä» epoll_wait ä¸­è‹é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ•°æ®è¢« read å‡½æ•°è¯»å®Œæ‰ç»“æŸ</li><li>select/poll ä»…æœ‰æ°´å¹³è§¦å‘ï¼Œepoll é»˜è®¤æ˜¯æ°´å¹³è§¦å‘</li></ul></li></ul><h4 id="ç½‘ç»œæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œæ¨¡å¼"><span>ç½‘ç»œæ¨¡å¼</span></a></h4><p><strong>Reactor æ¨¡å¼</strong></p><p>ä¸€ç§éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å¼ï¼Œå¯¹äº‹ä»¶ååº”ï¼Œæ¥äº†ä¸€ä¸ªäº‹ä»¶ï¼ŒReactor å°±æœ‰ç›¸å¯¹åº”çš„ååº”/å“åº”ã€‚æ ¸å¿ƒéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼š</p><ul><li>Reactorï¼šè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹åŒ…å«è¿æ¥äº‹ä»¶ã€è¯»å†™äº‹ä»¶ï¼›</li><li>å¤„ç†èµ„æºæ± ï¼šè´Ÿè´£å¤„ç†äº‹ä»¶ï¼Œå¦‚ read -&gt; ä¸šåŠ¡é€»è¾‘ -&gt; sendï¼›</li></ul><p><strong>å• Reactor å•è¿›ç¨‹/çº¿ç¨‹</strong></p><p><img src="/img/%E5%8D%95Reactor%E5%8D%95%E8%BF%9B%E7%A8%8B.webp#id=Xhd2m&amp;originHeight=834&amp;originWidth=1427&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>Reactor å¯¹è±¡é€šè¿‡ selectï¼ˆIO å¤šè·¯å¤ç”¨æ¥å£ï¼‰ç›‘å¬äº‹ä»¶ï¼Œå°†äº‹ä»¶é€šè¿‡ dispatch åˆ†å‘ç»™ Acceptor / Handlerã€‚Acceptor è´Ÿè´£å»ºç«‹è¿æ¥ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡æ¥å¤„ç†åç»­çš„å“åº”äº‹ä»¶ã€‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU æ€§èƒ½</li><li>Handler å¤„ç†ä¸šåŠ¡æ—¶æ— æ³•å¤„ç†å…¶å®ƒäº‹ä»¶</li></ul><p>å®ç°ç®€å•ï¼Œä½†ä»…é€‚ç”¨äºä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿçš„åœºæ™¯ï¼Œä¸é€‚ç”¨è®¡ç®—æœºå¯†é›†å‹çš„åœºæ™¯ã€‚ä¾‹å¦‚ Redis 6.0 ä¹‹å‰çš„ç‰ˆæœ¬å°±æ˜¯ å• Reactor å•è¿›ç¨‹ã€‚</p><p>**<em>å• Reactor å¤šè¿›ç¨‹/çº¿ç¨‹</em></p><p><img src="/img/%E5%8D%95Reactor%E5%A4%9A%E7%BA%BF%E7%A8%8B.webp#id=cxi30&amp;originHeight=1277&amp;originWidth=1514&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>Handler å¯¹è±¡ä¸å†ç›´æ¥è´Ÿè´£ä¸šåŠ¡å¤„ç†ï¼Œåªè´Ÿè´£æ•°æ®æ¥æ”¶å’Œå‘é€ï¼Œread è¯»å–åˆ°æ•°æ®åäº¤ç»™å­çº¿ç¨‹é‡Œçš„ Processor è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¤„ç†å®Œåå†å‘å› Handlerã€‚</p><p>ç¼ºç‚¹ï¼šåªæœ‰ä¸€ä¸ª Reactor æ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„èˆ°è‰‡å’Œå“åº”ï¼Œä¸”åªåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œåœ¨é¢å¯¹ç¬é—´é«˜å¹¶å‘çš„åœºæ™¯æ—¶ï¼Œå®¹æ˜“æˆä¸ºæ€§èƒ½çš„ç“¶é¢ˆçš„åœ°æ–¹ã€‚</p><p><strong>å¤š Reactor å¤šè¿›ç¨‹/çº¿ç¨‹</strong></p><p><img src="/img/%E4%B8%BB%E4%BB%8EReactor%E5%A4%9A%E7%BA%BF%E7%A8%8B.webp#id=ZGkWX&amp;originHeight=1262&amp;originWidth=1772&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>MainReactor æ”¶åˆ°äº‹ä»¶åå°†æ–°è¿æ¥åˆ†é…ç»™ SubReactor ç»§ç»­ç›‘å¬ï¼Œå†æ¬¡å‘ç”Ÿäº‹ä»¶æ—¶ç”± SubReactor è°ƒç”¨ç›¸åº”çš„ Handler å“åº”ã€‚<br>ä¸»çº¿ç¨‹åªè´Ÿè´£æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹è´Ÿè´£å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ï¼Œä¸”æ— é¡»è¿”å›æ•°æ®ã€‚</p><p>ä¾‹å¦‚è‘—åçš„ Nettyã€Memcache éƒ½æ˜¯å¤š Reactor å¤šçº¿ç¨‹ï¼ŒNginx æ˜¯å¤š Reactor å¤šè¿›ç¨‹ã€‚</p><p><strong>Proactor</strong></p><p><img src="/img/Proactor.webp#id=sbg1q&amp;originHeight=654&amp;originWidth=1427&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>Proactor æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å¼ï¼Œä¸ç”¨ç­‰å¾… æ•°æ®å‡†å¤‡ å’Œ æ•°æ®æ‹·è´ ä¸¤ä¸ªè¿‡ç¨‹ï¼Œå®Œå…¨ç”±å†…æ ¸å®Œæˆå¹¶é€šçŸ¥ã€‚</p><p>Reacto å’Œ Proactor éƒ½æ˜¯ä¸€ç§åŸºäº<code>äº‹ä»¶åˆ†å‘</code>çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼ï¼ŒåŒºåˆ«åœ¨äº Reactor æ„ŸçŸ¥çš„æ˜¯å°±ç»ªå¯è¯»å†™ï¼ˆå¾…å®Œæˆï¼‰äº‹ä»¶ï¼ŒProactor æ„ŸçŸ¥çš„æ˜¯å·²å®Œæˆçš„è¯»å†™äº‹ä»¶ã€‚</p><p>ç„¶è€Œï¼ŒLinux ä¸‹çš„ AIO ç³»åˆ—å‡½æ•°éƒ½æ˜¯ç”¨æˆ·ç©ºé—´æ¨¡æ‹Ÿçš„å¼‚æ­¥ï¼Œä¸”ä»…æ”¯æŒæœ¬åœ°æ–‡ä»¶ AIOï¼Œä¸æ”¯æŒç½‘ç»œ Socketï¼Œå› æ­¤åŸºäº Linux çš„é«˜æ€§èƒ½ç½‘ç»œç¨‹åºéƒ½æ˜¯ Reactor æ–¹æ¡ˆã€‚</p><h4 id="ä¸€è‡´æ€§å“ˆå¸Œ" tabindex="-1"><a class="header-anchor" href="#ä¸€è‡´æ€§å“ˆå¸Œ"><span>ä¸€è‡´æ€§å“ˆå¸Œ</span></a></h4><p>ä¸åŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•é€‚ç”¨çš„ä¸šåŠ¡åœºæ™¯ä¹Ÿä¸åŒçš„ï¼Œä¾‹å¦‚è½®è¯¢ç­–ç•¥åªé€‚ç”¨äºæ¯ä¸ªèŠ‚ç‚¹æ•°æ®ä¸€è‡´çš„åœºæ™¯ï¼Œä½†æ˜¯ä¸é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¯èƒ½è®¿é—®ä¸åˆ°éœ€è¦çš„æ•°æ®ã€‚</p><p>å“ˆå¸Œç®—æ³•å¯ä»¥å»ºç«‹æ•°æ®å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œä½†èŠ‚ç‚¹å˜åŒ–æ—¶ï¼Œæ‰€æœ‰æ•°æ®éœ€è¦è¿›è¡Œè¿ç§»ï¼Œå¼€é”€è¿‡å¤§ã€‚</p><p><strong>ä¸€è‡´æ€§å“ˆå¸Œ</strong></p><p>å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Šï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚</p><p><img src="/img/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C.webp#id=oVxf2&amp;originHeight=560&amp;originWidth=587&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>è™šæ‹ŸèŠ‚ç‚¹</strong></p><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½ä¿è¯åˆ†å¸ƒå‡åŒ€ï¼Œå¯èƒ½å¤§é‡è¯·æ±‚é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>å› æ­¤å¯ä»¥å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹ä¹Ÿæ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šã€‚ä»¥æ­¤æé«˜èŠ‚ç‚¹çš„å‡è¡¡åº¦å’Œç¨³å®šæ€§ã€‚å¸¦è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§å“ˆå¸Œé€‚åˆç¡¬ä»¶é…ç½®ä¸åŒçš„èŠ‚ç‚¹çš„åœºæ™¯ï¼Œä»¥åŠèŠ‚ç‚¹è§„æ¨¡ä¼šå‘ç”Ÿå˜åŒ–çš„åœºæ™¯ã€‚</p><h4 id="ç½‘ç»œæ€§èƒ½" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œæ€§èƒ½"><span>ç½‘ç»œæ€§èƒ½</span></a></h4><p><strong>æŒ‡æ ‡</strong></p><ul><li>å¸¦å®½ï¼šé“¾è·¯çš„æœ€å¤§ä¼ è¾“é€Ÿç‡</li><li>å»¶æ—¶ï¼šè¯·æ±‚æ•°æ®åŒ…å‘é€åï¼Œæ”¶åˆ°å¯¹ç«¯å“åº”ï¼Œæ‰€éœ€è¦çš„æ—¶é—´å»¶è¿Ÿ</li><li>ååé‡ï¼šå•ä½æ—¶é—´å†…æˆåŠŸä¼ è¾“çš„æ•°æ®é‡</li><li>PPSï¼šPacket Per Second å‘åŒ…é€Ÿç‡</li><li>ç½‘ç»œå¯ç”¨æ€§ã€å¹¶å‘è¿æ¥æ•°ã€ä¸¢åŒ…ç‡ã€é‡ä¼ ç‡</li></ul><p><strong>æŸ¥çœ‹ç½‘ç»œä¿¡æ¯</strong></p><ul><li>ifconfig/ip æŸ¥çœ‹ç½‘ç»œé…åˆå’Œæ”¶å‘æ•°æ®åŒ…çš„ç»Ÿè®¡ä¿¡æ¯</li><li>ss/netstat æŸ¥çœ‹ socketã€ç½‘ç»œåè®®æ ˆã€ç½‘å£ã€è·¯ç”±è¡¨ä¿¡æ¯</li><li>sar æŸ¥çœ‹å½“å‰ç½‘ç»œçš„ååç‡å’Œ PPS</li></ul><h2 id="java" tabindex="-1"><a class="header-anchor" href="#java"><span>Java</span></a></h2><h3 id="é›†åˆ" tabindex="-1"><a class="header-anchor" href="#é›†åˆ"><span>é›†åˆ</span></a></h3><h4 id="arraylist" tabindex="-1"><a class="header-anchor" href="#arraylist"><span>ArrayList</span></a></h4><ul><li>ArrayListåº•å±‚æ˜¯å¯ä»¥åŠ¨æ€æ‰©å±•çš„ Object æ•°ç»„ï¼Œé»˜è®¤åˆå§‹å®¹é‡æ˜¯10ã€‚</li><li>å½“æ·»åŠ å…ƒç´ è¶…è¿‡å½“å‰çš„ capacity æ—¶ï¼Œå°±ä¼šè§¦å‘æ‰©å®¹æœºåˆ¶ï¼Œæ‰©å®¹æœºåˆ¶ä¸»è¦ç”±å†…éƒ¨çš„ grow() æ–¹æ³•å®ç°ã€‚ <ul><li>é¦–å…ˆä¼šæ ¹æ®é»˜è®¤å®¹é‡å’Œå­˜å‚¨æ‰€éœ€å®¹é‡çš„è¾ƒå¤§è€…ç¡®å®šä¸€ä¸ªæœ€å°æ‰©å®¹å®¹é‡<code>minCapacity</code></li><li>ç„¶åå°†ç°åœ¨çš„å®¹é‡æ‰©å¤§1.5å€å·¦å³ï¼Œç¡®å®šä¸€ä¸ªæ–°å®¹é‡</li><li>æ¥ç€å¼€è¾Ÿä¸€ä¸ªæ–°æ•°ç»„ï¼Œå®¹é‡ä¸ºä¸Šé¢ä¸¤ä¸ªå®¹é‡çš„è¾ƒå¤§è€…ï¼Œå°†æ‰€æœ‰å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­å®Œæˆæ‰©å®¹</li></ul></li><li>æœ€åæŠŠæ–°æ·»åŠ å…ƒç´ æ”¾åˆ°æ‰©å®¹åçš„æ•°ç»„æœ«å°¾</li></ul><h4 id="hashmap" tabindex="-1"><a class="header-anchor" href="#hashmap"><span>HashMap</span></a></h4><ul><li>JDK 1.8 ä¹‹å‰ HashMap ç”± æ•°ç»„+é“¾è¡¨ ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯ HashMap çš„ä¸»ä½“ï¼Œé“¾è¡¨æ˜¯ä¸ºäº†ç”¨æ‹‰é“¾æ³•è§£å†³å“ˆå¸Œå†²çªã€‚</li><li>JDK 1.8 ä¹‹å HashMap åœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦å¤§äº8ï¼Œå¹¶ä¸”æ•°ç»„é•¿åº¦è¶…è¿‡64ï¼Œå°±ä¼šæŠŠé“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚</li><li>å¦‚æœ HashMap å­˜å‚¨å…ƒç´ è¶…è¿‡ä¸€ä¸ªé˜ˆå€¼ï¼Œé˜ˆå€¼ç­‰äºå½“å‰å®¹é‡ * 0.75ï¼ˆè´Ÿè½½å› å­ï¼‰ï¼Œå°±ä¼šå°†æ•°ç»„æ‰©å®¹è‡³å½“å‰çš„2å€ï¼Œç„¶åè¿›è¡Œrehashï¼ŒæŠŠæ•°æ®æ”¾åˆ°æ–°çš„ä½ç½®ã€‚</li></ul><p>é»˜è®¤å¤§å°æ˜¯ 16ï¼Œè´Ÿè½½å› å­ 0.75 æ˜¯ç»Ÿè®¡å­¦ä¸Š Hash åéµå¾ªæ³Šæ¾åˆ†å¸ƒçš„ç»“æœã€‚æ‰©å®¹ $2^n$æ˜¯ä¸ºäº†åœ¨ç¡®å®šç´¢å¼•æ—¶<code>index = hashcode % capacity</code>å¯ä»¥åˆ©ç”¨ä½è¿ç®—ã€‚</p><h4 id="hashtable-treemap" tabindex="-1"><a class="header-anchor" href="#hashtable-treemap"><span>HashTable/TreeMap</span></a></h4><p>HashTable ä¹Ÿå®ç°äº† Map æ¥å£ï¼ŒåŸºäºé”æœºåˆ¶å®ç°äº†çº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤æ•ˆç‡ä½ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ¨èä½¿ç”¨ ConcurrentHashMapã€‚</p><p>TreeMap æ˜¯åŸºäºçº¢é»‘æ ‘å®ç°çš„æœ‰åºé”®å€¼å¯¹é›†åˆã€‚</p><h4 id="set" tabindex="-1"><a class="header-anchor" href="#set"><span>Set</span></a></h4><ul><li>HashSet åº•å±‚åŸºäº HashMapï¼Œä½¿ç”¨å“ˆå¸Œè¡¨å­˜å‚¨å…ƒç´ ï¼Œå…·æœ‰å¿«é€Ÿçš„æŸ¥æ‰¾æ€§èƒ½ï¼Œä½†ä¸ä¿è¯å…ƒç´ çš„é¡ºåºã€‚</li><li>LinkedHashSet åº•å±‚ä½¿ç”¨å“ˆå¸Œè¡¨å­˜å‚¨å…ƒç´ ï¼Œå¹¶é€šè¿‡é“¾è¡¨ç»´æŠ¤å…ƒç´ çš„æ’å…¥é¡ºåºã€‚</li><li>TreeSet åº•å±‚å®ç°æ˜¯åŸºäºçº¢é»‘æ ‘ï¼ˆTreeMapï¼‰ï¼Œæ”¯æŒå…ƒç´ è‡ªåŠ¨æ’åº</li></ul><h4 id="concurrenthashmap" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap"><span>ConcurrentHashMap</span></a></h4><p>JDK 7 ä»¥å‰çš„ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”ï¼Œæ¯ä¸ªsegmentä¸ŠåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œã€‚JDK 8åç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸ªtableå…ƒç´ éƒ½å¯ä»¥å¹¶å‘ï¼š</p><ul><li>ç»“æ„ä¸Šæ˜¯æ•°ç»„+é“¾è¡¨/çº¢é»‘æ ‘ï¼Œå½“å†²çªé“¾è¡¨è¾¾åˆ°ä¸€å®šé•¿åº¦æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æ¢æˆçº¢é»‘æ ‘ã€‚</li><li>ConcurrentHashMap é€šè¿‡ CAS å’Œ Synchronized å®ç°å¹¶å‘å®‰å…¨</li><li>putæ”¾å…¥å…ƒç´ çš„æ—¶å€™ <ul><li>é¦–å…ˆæ ¹æ® key è®¡ç®—å“ˆå¸Œå®šä½ Nodeï¼Œå¦‚æœå¯¹åº”ä½ç½®çš„ Node ä¸º nullï¼Œå°è¯• CAS å†™å…¥ï¼Œå¤±è´¥å°±è¿›å…¥ä¸‹æ¬¡å¾ªç¯é‡è¯•(æœ€å¤–å±‚æ˜¯ä¸ªæ— é™å¾ªç¯)</li><li>å¦‚æœè¦æ”¾çš„ä½ç½®ä¸º MOVEDï¼ˆ-1ï¼‰ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹æ­£åœ¨æ‰©å®¹ï¼Œå‚ä¸ä¸€èµ·æ‰©å®¹ã€‚</li><li>å¦åˆ™çš„è¯ï¼Œé€šè¿‡ Synchronized å¯¹ Node åŠ é”ï¼Œåˆ¤æ–­æ˜¯é“¾è¡¨è¿˜æ˜¯çº¢é»‘æ ‘ï¼Œå†™å…¥æ•°æ®ï¼Œå®ç°å¹¶å‘å®‰å…¨</li><li>æœ€åè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ˜¯é“¾è¡¨ï¼Œä¸”é•¿åº¦è¶…è¿‡é˜ˆå€¼ 8ï¼Œå°±æ‰©å®¹æ•°ç»„/è½¬æ¢æˆçº¢é»‘æ ‘ï¼ˆæ•°ç»„è¶…è¿‡64ï¼‰</li></ul></li><li>getè·å–å…ƒç´ çš„æ—¶å€™ <ul><li>ç›´æ¥æ ¹æ®å“ˆå¸Œå€¼ï¼Œæ‰¾å¯¹æŒ‡å®šä½ç½®ï¼Œå¦‚æœå¤´èŠ‚ç‚¹å°±æ˜¯è¦æ‰¾çš„ç›´æ¥è¿”å›</li><li>å¦åˆ™æŒ‰é“¾è¡¨/çº¢é»‘æ ‘æŸ¥æ‰¾æ‰€è¦çš„å…ƒç´ </li><li>get æ“ä½œä¸éœ€è¦åŠ é”ï¼Œå› ä¸º Node çš„å…ƒç´  val å’ŒæŒ‡é’ˆ next éƒ½æ˜¯ volatile ä¿®é¥°çš„ï¼Œå¯ä»¥ä¿è¯å¤šçº¿ç¨‹ä¸‹å¹¶å‘çš„å¯è§æ€§ã€‚</li></ul></li><li>æ‰©å®¹çš„æ—¶å€™ï¼š <ul><li>å…ˆæ ¹æ®è¿ç®—å¾—åˆ°éœ€è¦éå†çš„æ¬¡æ•°iï¼Œç„¶ååˆ©ç”¨tabAtæ–¹æ³•è·å¾—iä½ç½®çš„å…ƒç´ fï¼Œåˆå§‹åŒ–ä¸€ä¸ªforwardNodeå®ä¾‹fwd</li><li>å¦‚æœf == nullï¼Œåˆ™åœ¨tableä¸­çš„iä½ç½®æ”¾å…¥fwdï¼Œå¦åˆ™é‡‡ç”¨å¤´æ’æ³•çš„æ–¹å¼æŠŠå½“å‰æ—§tableæ•°ç»„çš„æŒ‡å®šä»»åŠ¡èŒƒå›´çš„æ•°æ®ç»™è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚ç„¶åç»™æ—§tableåŸä½ç½®èµ‹å€¼fwdã€‚</li><li>ç›´åˆ°éå†è¿‡æ‰€æœ‰çš„èŠ‚ç‚¹ä»¥åå°±å®Œæˆäº†å¤åˆ¶å·¥ä½œï¼ŒæŠŠtableæŒ‡å‘nextTableï¼Œå¹¶æ›´æ–°sizeCtlä¸ºæ–°æ•°ç»„å¤§å°çš„0.75å€ï¼Œæ‰©å®¹å®Œæˆã€‚</li><li>åœ¨æ­¤æœŸé—´å¦‚æœå…¶ä»–çº¿ç¨‹çš„æœ‰è¯»å†™æ“ä½œéƒ½ä¼šåˆ¤æ–­headèŠ‚ç‚¹æ˜¯å¦ä¸ºforwardNodeèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å°±å¸®åŠ©æ‰©å®¹ã€‚</li></ul></li></ul><h4 id="copyonwritearraylist" tabindex="-1"><a class="header-anchor" href="#copyonwritearraylist"><span>CopyOnWriteArrayList</span></a></h4><p>åœ¨è¯»å†™é”ï¼ˆä»…å†™æ“ä½œæ’ä»–ï¼‰çš„åŸºç¡€ä¸Šï¼Œæ›´è¿›ä¸€æ­¥ï¼Œè¯»å–å®Œå…¨ä¸ç”¨åŠ é”ï¼Œä»…å†™å†™äº’æ–¥éœ€è¦åŒæ­¥ã€‚</p><ul><li>CopyOnWriteArrayList ç±»çš„æ‰€æœ‰å¯å˜æ“ä½œï¼Œå¦‚addã€setç­‰ï¼Œéƒ½æ˜¯åˆ›å»ºåº•å±‚æ•°ç»„çš„å‰¯æœ¬ï¼Œä¿®æ”¹å®Œåå†æ›¿æ¢åŸæœ‰æ•°æ®å®ç°çš„</li><li>å¯¹äºè¯»æ“ä½œï¼Œå†…éƒ¨arrayä¸ä¼šå‘ç”Ÿä¿®æ”¹ï¼Œåªä¼šè¢«æ›¿æ¢ï¼Œå› æ­¤æ— éœ€ä»»ä½•åŒæ­¥æ§åˆ¶å°±å¯ä»¥ä¿è¯æ•°æ®å®‰å…¨</li><li>å¯¹äºå†™æ“ä½œï¼ŒåŠ é”ä¿è¯åŒæ­¥ï¼Œé¿å…å¤šçº¿ç¨‹å†™çš„æ—¶å€™æ‹·è´å¤šä»½å‰¯æœ¬</li></ul><h4 id="å¹¶å‘å®‰å…¨çš„-queue" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘å®‰å…¨çš„-queue"><span>å¹¶å‘å®‰å…¨çš„ Queue</span></a></h4><p>Java æä¾›çš„çº¿ç¨‹å®‰å…¨çš„ Queue åˆ†ä¸ºé˜»å¡é˜Ÿåˆ—ã€éé˜»å¡é˜Ÿåˆ—ã€‚</p><p><strong>éé˜»å¡é˜Ÿåˆ— - ConcurrentLinkedQueue</strong></p><ul><li>é€šè¿‡ CAS å®ç°çº¿ç¨‹å®‰å…¨</li><li>åº•å±‚ä½¿ç”¨é“¾è¡¨ï¼Œåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹æ€§èƒ½éå¸¸å¥½</li></ul><p><strong>é˜»å¡é˜Ÿåˆ— - BlockingQueue</strong></p><ul><li>é€šè¿‡åŠ é”å®ç°çº¿ç¨‹å®‰å…¨</li><li>å¹¿æ³›ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œé˜Ÿåˆ—å®¹å™¨å·²æ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹é˜»å¡ï¼Œé˜Ÿåˆ—å®¹å™¨ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹é˜»å¡ï¼Œç›´è‡³é˜Ÿåˆ—éç©º</li><li>ç»§æ‰¿è‡ª Queueï¼Œå®ç°ç±»æœ‰ï¼š <ul><li>ArrayBlockingQueueï¼šæ•°ç»„å®ç°çš„æœ‰ç•Œé˜Ÿåˆ—ï¼Œåˆ›å»ºæ—¶æŒ‡å®šå®¹é‡ã€‚é‡‡ç”¨ ReentrantLock æ§åˆ¶å¹¶å‘ï¼Œé»˜è®¤éå…¬å¹³</li><li>LinkedBlockingQueueï¼šåŸºäºå•å‘é“¾è¡¨çš„æ— ç•Œ/æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¯æŒ‡å®šå¤§å°.é‡‡ç”¨ ReentrantLock æ§åˆ¶å¹¶å‘</li><li>PriorityBlockingQueueï¼šåŸºäºå †çš„æ— ç•Œé˜Ÿåˆ—ï¼Œæ”¯æŒä¼˜å…ˆçº§ï¼Œå†…éƒ¨è‡ªåŠ¨æ‰©å®¹ã€‚é‡‡ç”¨ ReentrantLock æ§åˆ¶å¹¶å‘</li><li>SynchronousQueueï¼šå®¹é‡å›ºå®šä¸º 1 çš„åŒæ­¥é˜Ÿåˆ—ï¼Œå†…éƒ¨æ²¡æœ‰ä½¿ç”¨ AQSï¼Œè€Œæ˜¯é€šè¿‡ CAS æ§åˆ¶å¹¶å‘ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹å¿…é¡»ä¸€ä¸€é…å¯¹</li><li>DelayedWorkQueueï¼šåŸºäºå †çš„ä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—</li></ul></li></ul><h4 id="concurrentskiplistmap" tabindex="-1"><a class="header-anchor" href="#concurrentskiplistmap"><span>ConcurrentSkipListMap</span></a></h4><p>åˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³ï¼Œé€šè¿‡ç»´æŠ¤å¤šå±‚é“¾è¡¨å®ç°çš„ Mapï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ O(logN)ã€‚å†…éƒ¨é€šè¿‡ CAS å®ç°å¹¶å‘å®‰å…¨ã€‚</p><h3 id="io" tabindex="-1"><a class="header-anchor" href="#io"><span>IO</span></a></h3><h4 id="java-io-ä½“ç³»" tabindex="-1"><a class="header-anchor" href="#java-io-ä½“ç³»"><span>Java IO ä½“ç³»</span></a></h4><p>é¡¶å±‚ä¸¤å¤§ç±»å››ä¸ªæ¥å£ï¼š</p><ul><li><strong>InputStream/OutputStreamï¼šå­—èŠ‚è¾“å…¥è¾“å‡ºæµ</strong><ul><li>FileInputStream/FileOutputStream: æ–‡ä»¶è¾“å…¥è¾“å‡ºæµ</li><li>BufferedInputStream/BufferedOutputStream: ç¼“å†²è¾“å…¥è¾“å‡ºæµï¼Œæ¯æ¬¡æ‰¹é‡è¯»/å†™å­—èŠ‚åˆ°ç¼“å†²åŒºï¼Œå‡å°‘IOï¼Œæé«˜é‡å¤å•å­—èŠ‚è¯»å†™åœºæ™¯çš„æ•ˆç‡</li><li>ObjectInputStream/ObjectOutputStream: å¯¹è±¡åºåˆ—åŒ–/ååºåˆ—åŒ–æµ</li><li>PrintStreamï¼šå­—èŠ‚æ‰“å°æµ</li></ul></li><li><strong>Reader/Writerï¼šå­—ç¬¦è¾“å…¥è¾“å‡ºæµ</strong><ul><li>InputStreamReader/OutputStreamWriter: å­—èŠ‚ -&gt; å­—ç¬¦çš„è½¬æ¢æµ</li><li>FileReader/FileWriter: æ–‡ä»¶å­—ç¬¦è¾“å…¥è¾“å‡ºæµ</li><li>BufferedReader/BufferedWriterï¼šç¼“å†²å­—ç¬¦å­—ç¬¦è¾“å…¥è¾“å‡ºæµ</li><li>PrintWriter: å­—ç¬¦æ‰“å°æµ</li></ul></li></ul><h4 id="io-ä¸­çš„è®¾è®¡æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#io-ä¸­çš„è®¾è®¡æ¨¡å¼"><span>IO ä¸­çš„è®¾è®¡æ¨¡å¼</span></a></h4><ol><li>è£…é¥°å™¨æ¨¡å¼<br><code>BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(fileName), &quot;UTF-8&quot;));</code><br>é€šè¿‡ç»„åˆæ›¿ä»£ç»§æ‰¿ï¼Œåœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹æ‰©å±•åŸå§‹ç±»çš„åŠŸèƒ½ã€‚</li><li>é€‚é…å™¨æ¨¡å¼<br><code>InputStreamReader</code> å¯¹å­—èŠ‚è§£ç ï¼Œå°†å­—èŠ‚æµè½¬åŒ–ä¸ºå­—ç¬¦æµï¼Œ<code>OutputStreamWriter</code> å¯¹å­—ç¬¦ç¼–ç ï¼Œå°†å­—ç¬¦æµè½¬æ¢ä¸ºå­—èŠ‚æµ<br>ä¸åŒåŒºè£…é¥°å™¨ä¾§é‡äºåŠ¨æ€å¢å¼ºåŸå§‹ç±»çš„åŠŸèƒ½ï¼Œé€‚é…å™¨ä¸“æ³¨è§£å†³æ¥å£ä¸å…¼å®¹ï¼Œä¸èƒ½äº¤äº’çš„ç±»ï¼Œè®©å®ƒä»¬èƒ½å¤Ÿä¸€èµ·å·¥ä½œã€‚</li><li>å·¥å‚æ¨¡å¼<br>å¦‚<code>Files::newInputStream</code>åˆ›å»ºInputStreamå¯¹è±¡ï¼Œ<code>Paths::get</code>åˆ›å»ºPathå¯¹è±¡...</li><li>è§‚å¯Ÿè€…æ¨¡å¼<br>NIOä¸­çš„æ–‡ä»¶ç›®å½•ç›‘å¬æœåŠ¡åŸºäº<code>WatchService</code>æ¥å£ã€<code>Watchable</code>æ¥å£ï¼Œå†…éƒ¨é€šè¿‡ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹å®šæœŸè½®è¯¢æ£€æµ‹æ–‡ä»¶å˜åŒ–å®ç°ã€‚</li></ol><h4 id="io-æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#io-æ¨¡å‹"><span>IO æ¨¡å‹</span></a></h4><p>Unixä¸­çš„äº”ç§IOæ¨¡å‹ï¼šåŒæ­¥é˜»å¡ I/Oã€åŒæ­¥éé˜»å¡ I/Oã€I/O å¤šè·¯å¤ç”¨ã€ä¿¡å·é©±åŠ¨ I/O å’Œå¼‚æ­¥ I/O</p><p>Javaä¸­çš„ä¸‰ç§å¸¸è§IOæ¨¡å‹ï¼š</p><ul><li>BIOï¼šåŒæ­¥é˜»å¡IOï¼Œç”¨ç¨‹åºå‘èµ· read è°ƒç”¨åï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li><li>NIOï¼ŒåŒæ­¥éé˜»å¡IOï¼Œå‡†å¤‡æ•°æ®é˜¶æ®µä¸é˜»å¡ï¼Œåªæœ‰æ‹·è´é˜¶æ®µæ‰é˜»å¡ï¼Œåº”ç”¨ç¨‹åºè¦ä¸æ–­è½®è¯¢æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ã€‚è€ŒIOå¤šè·¯å¤ç”¨é€šè¿‡ select/epoll ç­‰ç³»ç»Ÿè°ƒç”¨å‡å°‘CPUä½¿ç”¨ã€‚Javaä½¿ç”¨Selectorã€Channelã€Bufferç­‰æŠ½è±¡å®ç°ã€‚</li><li>AIOï¼šå¼‚æ­¥IOï¼ŒåŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶</li></ul><h3 id="å¹¶å‘" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘"><span>å¹¶å‘</span></a></h3><h4 id="çº¿ç¨‹å®‰å…¨çš„ä¸‰å¤§ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹å®‰å…¨çš„ä¸‰å¤§ç‰¹æ€§"><span>çº¿ç¨‹å®‰å…¨çš„ä¸‰å¤§ç‰¹æ€§</span></a></h4><ul><li>åŸå­æ€§ï¼šè‹¥å¹²ä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ</li><li>å¯è§æ€§ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹åˆ°è¿™ä¸ªä¿®æ”¹ã€‚ï¼ˆåŸå› åœ¨äº Java çš„å…±äº«å†…å­˜æ¨¡å‹ï¼Œçº¿ç¨‹ç›´æ¥æ“ä½œçš„éƒ½æ˜¯ç¼“å­˜ï¼‰</li><li>æœ‰åºæ€§ï¼šç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸ä»£ç çš„é¡ºåºç›¸åŒï¼ˆåŸå› åœ¨äºæŒ‡ä»¤é‡æ’åºï¼‰</li></ul><p>Synchronized ä¿è¯äº†åŸå­æ€§å’Œå¯è§æ€§ï¼šåŠ äº’æ–¥é” -&gt; æ¸…ç©ºå·¥ä½œå†…å­˜ -&gt; æ‹·è´æœ€æ–°æ•°æ®åˆ°å·¥ä½œå†…å­˜ -&gt; æ‰§è¡Œä»£ç  -&gt; åˆ·æ–°å·¥ä½œå†…å­˜åˆ°ä¸»å†…å­˜ -&gt; é‡Šæ”¾äº’æ–¥é”</p><p>Volatile ä¿è¯äº†å¯è§æ€§å’Œæœ‰åºæ€§ï¼šé€šè¿‡ store/load æŒ‡ä»¤ä¿è¯å¯¹ volatile å˜é‡çš„è¯»å†™éƒ½æ˜¯æœ€æ–°çš„ï¼Œä¸”é€šè¿‡å†…å­˜å±éšœç¦æ­¢æŒ‡ä»¤é‡æ’åº</p><h4 id="volatile-å…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#volatile-å…³é”®å­—"><span>Volatile å…³é”®å­—</span></a></h4><p>Volatileå…³é”®å­—çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p><ol><li>ä¿è¯å˜é‡çš„å¯è§æ€§ï¼šæ¯æ¬¡å¯¹ volatile ä¿®é¥°çš„æœ¬åœ°å˜é‡ä¿®æ”¹æ—¶ï¼Œä¼šç«‹åˆ»åˆ·æ–°å›ä¸»å†…å­˜ï¼Œè¯»å–æ—¶ä¹Ÿä¼šå…ˆä»ä¸»å†…å­˜è¯»å…¥æœ¬åœ°å†…å­˜å†è®¿é—®</li><li>é€šè¿‡æ’å…¥ç‰¹å®šçš„å†…å­˜å±éšœï¼Œç¦æ­¢æŒ‡ä»¤é‡æ’åº</li></ol><h4 id="åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼"><span>åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼</span></a></h4><ol><li>ç»§æ‰¿ Thread åˆ›å»ºçº¿ç¨‹ç±»ï¼Œé‡å†™ run æ–¹æ³•ã€‚</li><li>å®ç° Runnable æ¥å£å®ç° run æ–¹æ³•ï¼Œå¹¶ä½œä¸ºå‚æ•°æ¥åˆ›å»º Threadã€‚</li><li>å®ç° Callable æ¥å£å®ç° call æ–¹æ³•ï¼Œå¹¶ä½œä¸ºå‚æ•°æ¥åˆ›å»º FutureTaskã€‚Callableå¯ä»¥è·å–åˆ°è¿”å›å€¼</li><li>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± æ¥åˆ›å»ºçº¿ç¨‹</li></ol><h4 id="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"><span>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</span></a></h4><p>Java çº¿ç¨‹åœ¨è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­æœ‰ 6 ç§ä¸åŒçŠ¶æ€ï¼š</p><ul><li>NEWï¼šçº¿ç¨‹åˆšè¢«åˆ›å»ºçš„åˆå§‹çŠ¶æ€</li><li>RUNNABLEï¼šè°ƒç”¨startåçš„è¿è¡ŒçŠ¶æ€</li><li>BLOCKEDï¼šé˜»å¡çŠ¶æ€ï¼Œéœ€è¦ç­‰å¾…é”é‡Šæ”¾</li><li>WAITINGï¼šç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹çš„ä¸€äº›ç‰¹æ®Šäº‹ä»¶ï¼Œå¦‚notify(), join()</li><li>TIMED_WAITINGï¼šæœ‰é™ç­‰å¾…</li><li>TERMINATEDï¼šçº¿ç¨‹æ‰§è¡Œå®Œæ¯•çš„ç»ˆæ­¢çŠ¶æ€<br>å…¶ä¸­ï¼ŒJavaä¸­çš„RunnnableçŠ¶æ€åŒ…å«OSå±‚é¢çº¿ç¨‹çš„Readyå’ŒRunningä¸¤ä¸ªçŠ¶æ€</li></ul><h4 id="å‡å°‘çº¿ç¨‹åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#å‡å°‘çº¿ç¨‹åˆ‡æ¢"><span>å‡å°‘çº¿ç¨‹åˆ‡æ¢</span></a></h4><ul><li>æ— é”å¹¶å‘ç¼–ç¨‹</li><li>CAS ç®—æ³•</li><li>ä½¿ç”¨æœ€å°‘çº¿ç¨‹</li><li>åç¨‹</li></ul><h4 id="çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± "><span>çº¿ç¨‹æ± </span></a></h4><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>é™ä½èµ„æºæ¶ˆè€—</li><li>æé«˜å“åº”é€Ÿåº¦</li><li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</li></ul><p><strong>Executor æ¡†æ¶ï¼š</strong><br>JDK 5 å¼•å…¥çš„ç®¡ç†çº¿ç¨‹æ± çš„æ¡†æ¶ï¼ŒåŒ…æ‹¬ä¸‰å¤§éƒ¨åˆ†ï¼š</p><ul><li>ä»»åŠ¡ Runnable / Callable <ul><li>Callableå¯ä»¥è¿”å›ç»“æœ/æŠ›å‡ºå¼‚å¸¸</li></ul></li><li>æ‰§è¡Œè€… Executor <ul><li>å®ç°ç±» ThreadPoolExecutorï¼Œé€šè¿‡ execute/submit æäº¤æ‰§è¡Œ</li></ul></li><li>å¼‚æ­¥è®¡ç®—ç»“æœ Future <ul><li>å®ç°ç±» FutureTask</li></ul></li></ul><p><strong>submit å’Œ execute åŒºåˆ«</strong></p><ul><li><code>submit</code> å¯ä»¥è·å¾—æ‰§è¡Œç»“æœã€‚å®ç°ä¸Šæ˜¯å°† Runnable/Callable å¯¹è±¡å°è£…æˆ RunnableFuture ä¼ é€’ç»™ execute æ‰§è¡Œï¼Œè€Œ RunnableFuture ç»§æ‰¿è‡ª Runnable å¹¶ä¸”å¯ä»¥ä¿å­˜æ‰§è¡Œç»“æœã€‚</li><li><code>execute</code> åªèƒ½æ‰§è¡Œ Runnableï¼Œå› æ­¤ä¸èƒ½è·å¾—æ‰§è¡Œç»“æœ</li></ul><p><img src="/img/Executor%E6%A1%86%E6%9E%B6.png#id=GBk0x&amp;originHeight=380&amp;originWidth=561&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>ThreadPoolExecutor</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ThreadPoolExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> corePoolSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // æŒ‡å®šå¸¸é©»çº¿ç¨‹æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                   int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> maximumPoolSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // æŒ‡å®šå…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                   long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> keepAliveTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å½“çº¿ç¨‹æ•°é‡è¶…è¿‡corePoolSizeåï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                   TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> unit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // keepAliveTimeå•ä½</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                   BlockingQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> workQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¿å­˜è¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                   ThreadFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> threadFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                   RejectedExecutionHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> handler   </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä»»åŠ¡è¿‡å¤šæ—¶çš„æ‹’ç»ç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                   )</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»»åŠ¡é˜Ÿåˆ— - BlockingQueueï¼šæŒ‡è¢«æäº¤ä½†æœªæ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªBlockingQueueæ¥å£çš„å¯¹è±¡ï¼Œä»…ç”¨äºå­˜æ”¾Runnableå¯¹è±¡ã€‚å¸¸ç”¨çš„é˜Ÿåˆ—å®ç°æœ‰ï¼š <ul><li><code>SynchronousQueue</code>: ç›´æ¥æäº¤çš„é˜Ÿåˆ—ï¼Œæ²¡æœ‰å®¹é‡ï¼Œæ¥ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œä¸€ä¸ªï¼Œæ²¡æœ‰å¤šä½™çº¿ç¨‹åˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥</li><li><code>ArrayBlockingQueue</code>: æœ‰ç•Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ„é€ æ—¶æŒ‡å®šå®¹é‡</li><li><code>LinkedBlockingQueue</code>: æ— ç•Œä»»åŠ¡é˜Ÿåˆ—ï¼Œä»»åŠ¡ç¹å¿™æ—¶ä¼šä¸€ç›´åˆ›å»ºçº¿ç¨‹æ‰§è¡Œï¼Œç›´è‡³èµ„æºè€—å°½</li><li><code>PriorityBlockingQueue</code>: å¸¦æœ‰æ‰§è¡Œä¼˜å…ˆçº§çš„æ— ç•Œé˜Ÿåˆ—</li></ul></li><li>æ‹’ç»ç­–ç•¥ - RejectedExecutionHandlerï¼šæŒ‡å®šå½“ä»»åŠ¡æ•°é‡è¶…è¿‡ç³»ç»Ÿå®é™…æ‰¿è½½èƒ½åŠ›æ—¶çš„ç­–ç•¥ï¼Œé€šå¸¸æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å·²ç»ç”¨å®Œï¼Œè¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ’é˜Ÿé˜Ÿåˆ—ä¹Ÿå·²æ»¡çš„æƒ…å†µã€‚ThreadPoolExecutoræä¾›äº†ä»¥ä¸‹ç­–ç•¥ï¼š <ul><li><code>AbortPolicy</code>: é»˜è®¤ç­–ç•¥ï¼Œä¸¢å¼ƒå¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸</li><li><code>CallersRunsPolicy</code>: ç»•è¿‡çº¿ç¨‹æ± ï¼Œç”±ä¸»çº¿ç¨‹ç›´æ¥è°ƒç”¨ä»»åŠ¡çš„run()æ–¹æ³•æ‰§è¡Œ</li><li><code>DiscardOldestPolicy</code>: æŠ›å¼ƒé˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ï¼Œç„¶åå°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡</li><li><code>DiscardPolicy</code>: ä¸¢å¼ƒä¸”ä¸æŠ›å¼‚å¸¸</li></ul></li></ul><p><strong>çº¿ç¨‹æ•°é‡è®¾å®š</strong></p><p>çº¿ç¨‹æ± çš„å¤§å°åº”è¯¥æ ¹æ®åº”ç”¨ç¨‹åºçš„è´Ÿè½½è¿›è¡Œè°ƒæ•´ï¼Œå¦‚æœçº¿ç¨‹æ± å¤ªå°ï¼Œå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸‹é™ï¼Œå› ä¸ºæ²¡æœ‰è¶³å¤Ÿçš„çº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰çš„è¯·æ±‚ã€‚å¦‚æœçº¿ç¨‹æ± å¤ªå¤§ï¼Œä¹Ÿä¼šå¯¼è‡´ç¨‹åºçš„æ€§èƒ½ä¸‹é™ï¼Œå› ä¸ºçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šæ¶ˆè€—å¤§é‡çš„CPUæ—¶é—´ã€‚</p><ul><li>CPU å¯†é›†å‹ï¼šè®¾ç½®ä¸€ä¸ªè¾ƒå°çš„çº¿ç¨‹æ•°é‡ï¼Œæ¯”å¦‚ N + 1ï¼ŒN æ˜¯ CPU æ ¸å¿ƒæ•°ï¼Œä½¿å¾—å¤„ç†ä»»åŠ¡æ—¶å……åˆ†åˆ©ç”¨ CPU</li><li>IO å¯†é›†å‹ï¼šè®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„çº¿ç¨‹æ•°é‡ï¼Œæ¯”å¦‚ 2N + 1ï¼Œä½¿å¾— CPU ç­‰å¾… IO å®Œæˆæ—¶å¯ä»¥å¤„ç†å…¶å®ƒä»»åŠ¡</li></ul><p><strong>çº¿ç¨‹æ‰§è¡Œé€»è¾‘</strong></p><p>åœ¨åº•å±‚å®ç°ä¸Šï¼Œæ˜¯ä¸åŒºåˆ†æ ¸å¿ƒ/éæ ¸å¿ƒçº¿ç¨‹çš„ï¼Œæ‰€æœ‰çº¿ç¨‹ç»Ÿä¸€æ”¾åœ¨ Condition çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå› æ­¤çº¿ç¨‹è°ƒåº¦æ—¶æ‰§è¡Œçš„æ˜¯è½®è¯¢ç­–ç•¥ï¼Œçº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹ä¾æ¬¡æ‰§è¡Œä»»åŠ¡ã€‚è€Œè¿‡æœŸé”€æ¯éæ ¸å¿ƒçº¿ç¨‹æ˜¯æ ¹æ®å½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°æ¥åˆ¤æ–­çš„ã€‚</p><h4 id="sleep-å’Œwait-å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#sleep-å’Œwait-å¯¹æ¯”"><span>sleep()å’Œwait()å¯¹æ¯”</span></a></h4><p>å…±åŒç‚¹ï¼šä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œ<br>åŒºåˆ«ï¼š</p><ul><li>sleep()ä¸é‡Šæ”¾é”ï¼Œè€Œwait()ä¼šé‡Šæ”¾å¯¹åº”çš„å¯¹è±¡é”</li><li>wait()æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„notify()æˆ–è€…notifyAll()æ–¹æ³•ã€‚é™¤éä½¿ç”¨ wait(long timeout) è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚</li><li>sleep()æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’</li></ul><p>å› æ­¤ï¼Œwait()å®šä¹‰åœ¨Objectç±»ä¸­ï¼Œé€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œè€Œsleep()æ˜¯Threadç±»çš„é™æ€æ–¹æ³•ï¼Œç”¨äºç®€å•åœ°æš‚åœæ‰§è¡Œã€‚</p><p>å¦å¤–ï¼Œyield() æ–¹æ³•æ˜¯æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚join() æ–¹æ³•å¯ä»¥ä½¿å¾—ä¸€ä¸ªçº¿ç¨‹åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ç»“æŸåå†æ‰§è¡Œ</p><h4 id="cas-åº•å±‚å®ç°" tabindex="-1"><a class="header-anchor" href="#cas-åº•å±‚å®ç°"><span>CAS åº•å±‚å®ç°</span></a></h4><p>CAS æ˜¯ä¸€ç§é€šè¿‡ç¡¬ä»¶å®ç°çš„ä¹è§‚é”å¹¶å‘å®‰å…¨çš„æŠ€æœ¯ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯ï¼Œç»™å®šä¸€ä¸ªå†…å­˜åœ°å€ï¼Œä¸€ä¸ªæœŸæœ›å€¼å’Œä¸€ä¸ªæ–°å€¼ï¼Œå¦‚æœè¯¥åœ°å€çš„å½“å‰å€¼å’ŒæœŸæœ›å€¼ç›¸ç­‰ï¼Œå°±ç”¨æ–°å€¼æ›¿æ¢å®ƒï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚åº•å±‚å®ç°ä¾èµ–äº CPU çš„ CAS æŒ‡ä»¤ï¼Œä¿è¯äº†æ“ä½œçš„åŸå­æ€§ï¼ŒJava ä¸­å¯ä»¥é€šè¿‡ Unsafe ç±»çš„æ–¹æ³•è°ƒç”¨ CAS æŒ‡ä»¤ã€‚</p><p>CAS å­˜åœ¨ ABA é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ç‰ˆæœ¬å·/æ ‡è®°ä½è§£å†³ã€‚</p><h4 id="threadlocal-åŸç†" tabindex="-1"><a class="header-anchor" href="#threadlocal-åŸç†"><span>ThreadLocal åŸç†</span></a></h4><p>æ¯ä¸ªçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª ThreadLocalMap å¯¹è±¡ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey-valueï¼‰æ˜ å°„ï¼Œå…¶ä¸­ key æ˜¯ ThreadLocal å®ä¾‹å¯¹è±¡æœ¬èº«çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯è¯¥çº¿ç¨‹å†…éƒ¨çš„å˜é‡å€¼ã€‚åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ª ThreadLocal å¯¹è±¡æ—¶ï¼Œå®é™…ä¸Šæ˜¯è®¿é—®äº†å„è‡ªçº¿ç¨‹å†…éƒ¨çš„ ThreadLocalMap å¯¹è±¡ä¸­çš„ä¸åŒ valueï¼Œä»è€Œé¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´å¯¹å˜é‡çš„å…±äº«å’Œè®¿é—®å†²çªã€‚</p><p><img src="/img/ThreadLocal%E7%BB%93%E6%9E%84.png#id=s38Y5&amp;originHeight=794&amp;originWidth=1072&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><ol><li>ä¾‹å¦‚ SimpleDateFormat/Random è¿™æ ·çš„å·¥å…·ç±»ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¦ç”¨åˆ°ï¼Œå¦‚æœæ¯ä¸ªçº¿ç¨‹éƒ½ new ä¸€ä¸ªå¾ˆéº»çƒ¦ï¼Œå› æ­¤å¯ä»¥æ”¹æˆstaticå…±ç”¨ã€‚ä½†æ˜¯å¯èƒ½ä¼šçº¿ç¨‹ä¸å®‰å…¨ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ threadLocal æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</li><li>å¯¹äºåŒä¸€ä¸ªçº¿ç¨‹å†…æ‰€æœ‰æ–¹æ³•éœ€è¦å…±äº«çš„èµ„æºï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ï¼Œä¸ºäº†é¿å…å‚æ•°ä¸€å±‚å±‚æ˜¾å¼ä¼ é€’ï¼ŒåŒæ—¶ä¿è¯çº¿ç¨‹çš„å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨ threadLocal ä¿å­˜ã€‚è¿™æ ·æ¯ä¸ªçº¿ç¨‹å†…è®¿é—®çš„éƒ½æ˜¯ç›¸åŒçš„èµ„æºï¼Œä¸åŒçº¿ç¨‹è®¿é—®çš„æ˜¯ä¸åŒèµ„æºã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆæ˜¯å¼±å¼•ç”¨</strong></p><p>å‡å¦‚ä½¿ç”¨å¼ºå¼•ç”¨ï¼Œå½“ThreadLocalä¸å†ä½¿ç”¨éœ€è¦å›æ”¶æ—¶ï¼Œå‘ç°æŸä¸ªçº¿ç¨‹ä¸­ThreadLocalMapå­˜åœ¨è¯¥ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œæ— æ³•å›æ”¶ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p><p>ä½¿ç”¨å¼±å¼•ç”¨å¯ä»¥é˜²æ­¢é•¿æœŸå­˜åœ¨çš„çº¿ç¨‹ï¼ˆé€šå¸¸ä½¿ç”¨äº†çº¿ç¨‹æ± ï¼‰å¯¼è‡´ThreadLocalæ— æ³•å›æ”¶é€ æˆå†…å­˜æ³„æ¼ã€‚</p><p><strong>å†…å­˜æ³„æ¼é—®é¢˜</strong></p><p>TheadLocalMap çš„ key æ‰€å…³è”çš„ ThreadLocal å®ä¾‹æ˜¯å¼±å¼•ç”¨ï¼Œå› æ­¤å¦‚æœ key æ²¡æœ‰å…¶å®ƒå…³è”çš„å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆ key å°±ä¼šè¢« GC è‡ªåŠ¨å›æ”¶ï¼Œè€Œ value æ˜¯å¼ºå¼•ç”¨ä¸ä¼šè¢«è‡ªåŠ¨å›æ”¶ï¼Œå¯¼è‡´ value ä¸€ç›´å­˜åœ¨ï¼Œäº§ç”Ÿå†…å­˜æ³„æ¼ã€‚å› æ­¤ ThreadLocal åœ¨åº•å±‚å®ç°ä¸Šä¼šè¿›è¡Œè¿‡æœŸ Entry çš„æ¸…ç†ã€‚</p><p><strong>Set() å®ç°</strong></p><ol><li>æ ¹æ®å½“å‰çº¿ç¨‹è·å– ThreadLocalMap å¯¹è±¡ï¼Œæ²¡æœ‰çš„è¯å°±æ–°å»º</li><li>è®¡ç®— key çš„å“ˆå¸Œï¼Œå†…éƒ¨çš„ nextHashCode() æ¯æ¬¡æ·»åŠ æ—¶è‡ªå¢ä¸€ä¸ªæ–æ³¢é‚£å¥‘æ•°/é»„é‡‘åˆ†å‰²æ•°ï¼Œæ¥å’Œæ•°ç»„/æ§½å®¹é‡ç›¸ä¸ï¼ˆä½¿å¾—å“ˆå¸Œåˆ†å¸ƒæ›´å‡åŒ€ï¼‰</li><li>å¦‚æœå“ˆå¸Œå¯¹åº”çš„æ§½ä¸ºç©ºï¼Œç›´æ¥æ”¾å…¥</li><li>å¦‚æœæ§½éç©º <ul><li>å¹¶ä¸” key ä¸º nullï¼Œå³è¯¥ Entry çš„ key å¼±å¼•ç”¨å·²è¢« GCï¼Œè¯´æ˜è¿™æ˜¯ä¸ªè¿‡æœŸçš„æ§½ staleSlotï¼Œæ‰§è¡Œ replaceStaleEntry() ç„¶åè¿”å›</li><li>å¹¶ä¸” key å’Œå½“å‰ ThreadLocal ä¸€è‡´ï¼Œç›´æ¥æ›´æ–°ï¼›ä¸ä¸€è‡´å°±å‘åéå†ç›´åˆ°æ‰¾åˆ°ç©ºæ§½</li></ul></li><li>è¿™æ—¶æ‰¾åˆ°äº†ä¸€ä¸ªç©ºæ§½ï¼Œåˆ›å»ºä¸€ä¸ªæ–° Entry æ”¾å…¥</li><li>æ‰§è¡Œ cleanSomeSlots() å¯å‘å¼æ¸…ç†ï¼› <ul><li>å¯å‘å¼æ¸…ç†ç»“æŸåï¼Œå¦‚æœ size è¶…è¿‡é˜ˆå€¼ï¼ˆå®¹é‡2/3ï¼‰ï¼Œè¿›è¡Œæ¢æµ‹å¼æ¸…ç† expungeStaleEntry()</li><li>æ¢æµ‹å¼æ¸…ç†ç»“æŸåï¼Œå¦‚æœ size è¶…è¿‡ 3/4 * thresh å°±æ‰§è¡Œ rehash()</li></ul></li></ol><p><strong>è¿‡æœŸ key çš„æ¸…ç†</strong></p><p>replaceStaleEntry()</p><ul><li>ä» staleSlot å‘å‰è¿­ä»£æ‰¾è¿‡æœŸæ§½ï¼Œæ›´æ–° slotToExpungeï¼Œç›´åˆ°ç©ºæ§½</li><li>ä» staleSlot å‘åè¿­ä»£æ‰¾ key ç›¸åŒçš„ï¼Œæ‰§è¡Œæ›´æ–°ï¼Œç›´åˆ°ç©ºæ§½</li><li>æœ€åä» slotToExpunge å¼€å§‹æ‰§è¡Œå¯å‘å¼è¿‡æœŸæ•°æ®æ¸…ç†</li></ul><p>å¯å‘å¼æ¸…ç† - cleanSomeSlots()</p><ul><li>å½“å®¹é‡/2çš„ä½ç½®å¼€å§‹æ¢æµ‹å¼æ¸…ç†</li></ul><p>æ¢æµ‹å¼æ¸…ç† - expungeStaleEntry()</p><ul><li>ä»¥å½“å‰ Entry å¾€åæ¸…ç†ï¼Œé‡åˆ°å€¼ä¸º null åˆ™ç»“æŸæ¸…ç†ï¼Œå±äºçº¿æ€§æ¢æµ‹æ¸…ç†</li></ul><p><strong>get() å®ç°</strong></p><ol><li>è®¡ç®— key çš„å“ˆå¸Œå®šä½æ§½ä½</li><li>å¦‚æœæ§½çš„ key ä¸€è‡´ç›´æ¥è¿”å›ï¼Œå¦åˆ™å‘åè¿­ä»£æŸ¥æ‰¾ <ul><li>è¿­ä»£è¿‡ç¨‹ä¸­å¦‚æœå‘ç°ç©ºæ§½ï¼Œè§¦å‘æ¢æµ‹å¼æ•°æ®å›æ”¶ expungeStaleEntry()</li></ul></li></ol><p><strong>InheritableThreadLocal</strong></p><p>ThreadLocal æ— æ³•åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ç»™å­çº¿ç¨‹å…±äº«çˆ¶çº¿ç¨‹ä¸­åˆ›å»ºçš„çº¿ç¨‹å‰¯æœ¬ï¼Œå¯ä»¥ä½¿ç”¨ InheritableThreadLocalï¼Œåœ¨ Thread æ„é€ æ–¹æ³•ä¸­ä¼ é€’æ•°æ®ã€‚<br>ä½†ä¸€èˆ¬å¼‚æ­¥å¤„ç†éƒ½ä½¿ç”¨çº¿ç¨‹æ± å¤ç”¨ï¼Œå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œå¯ä»¥ç”¨é˜¿é‡Œå¼€æºçš„ TransmittableThreadLocal ç»„ä»¶ã€‚</p><h4 id="synchronized-é”æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#synchronized-é”æœºåˆ¶"><span>Synchronized é”æœºåˆ¶</span></a></h4><p>æŒ‡å®šå¯¹è±¡/ç”¨äºæ™®é€šæ–¹æ³•ä¸Šæ˜¯å¯¹å®ä¾‹å¯¹è±¡åŠ é”ï¼ŒæŒ‡å®šç±»å¯¹è±¡/ç”¨äºé™æ€æ–¹æ³•å°±æ˜¯å¯¹ç±»åŠ é”ã€‚æœ¬è´¨ä¸Šæ˜¯ç«äº‰å¯¹è±¡å…³è”çš„ Monitor å¯¹è±¡çš„ Owner èº«ä»½ã€‚</p><p>JDK6 ä¹‹å‰æ˜¯åŸºäºç›‘è§†å™¨ Monitor çš„é‡é‡çº§é”æœºåˆ¶ï¼Œåœ¨ JDK6 å¼•å…¥äº†åå‘é”ã€è½»é‡çº§é”ç­‰ä¼˜åŒ–æœºåˆ¶ã€‚</p><ul><li>åå‘é”ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—å¹¶è·å¾—é”æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§çš„é”è®°å½•é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹ IDï¼Œç„¶åä¸‹ä¸€æ¬¡è¿™ä¸ªçº¿ç¨‹å†æ¬¡è®¿é—®åŒæ­¥å—æ—¶ï¼Œå¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰è¢«å…¶å®ƒçº¿ç¨‹ç«äº‰ï¼Œå°±å¯ä»¥ç›´æ¥è¿›å…¥ï¼Œä¸éœ€è¦è·å–é”èµ„æºã€‚ç›®çš„æ˜¯åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹ï¼Œå‡å°é”çš„è·å–å’Œé‡Šæ”¾çš„æ“ä½œï¼Œæé«˜ç¨‹åºçš„æ€§èƒ½ã€‚</li><li>è½»é‡çº§é”ï¼šç”¨äºå¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„åœºæ™¯ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾è¿›å…¥åŒæ­¥å—ï¼Œä½†æ˜¯å‘ç°å¯¹è±¡å¤´é‡Œé”åå‘çš„çº¿ç¨‹ ID ä¸æ˜¯è‡ªå·±ï¼Œå°±ä¼šå¼•å‘ç«äº‰ï¼Œè¿™æ—¶åå‘é”å°±ä¼šå‡çº§æˆè½»é‡çº§é”ã€‚è½»é‡çº§é”ä½¿ç”¨ CAS æ“ä½œæ¥å°è¯•è·å–é”ã€‚å¦‚æœCASæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºæœ‰ç«äº‰ï¼Œé”å°±ä¼šè†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚</li><li>é‡é‡çº§é”ï¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„äº’æ–¥é‡ï¼ˆMutexï¼‰æ¥å®ç°é”ã€‚åœ¨é‡é‡çº§é”çš„çŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è·å–åˆ°é”ã€‚</li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­è¿˜æœ‰è‡ªæ—‹ã€è‡ªé€‚åº”è‡ªæ—‹ç­‰ç­‰çš„ä¼˜åŒ–æªæ–½ã€‚</p><h4 id="aqs" tabindex="-1"><a class="header-anchor" href="#aqs"><span>AQS</span></a></h4><p>AbstractQueuedSynchronizer æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œä¸ºå»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€äº›é€šç”¨åŠŸèƒ½çš„æ˜¯å®ç°ï¼Œèƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨</p><p><strong>æ ¸å¿ƒæ€æƒ³</strong></p><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯åŸºäº CLH é”å®ç°çš„ã€‚</p><p>CLH é”æ˜¯å¯¹è‡ªæ—‹é”çš„ä¸€ç§æ”¹è¿›ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ï¼Œæš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹å°†è¢«åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚AQS å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é˜Ÿåˆ—é”çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚åœ¨ CLH é˜Ÿåˆ—é”ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆthreadï¼‰ã€ å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆwaitStatusï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆprevï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ã€‚</p><p><img src="/img/CLH%E9%98%9F%E5%88%97.png#id=ixnaN&amp;originHeight=304&amp;originWidth=1181&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>å®ç°</strong></p><p>AQS ä½¿ç”¨ int æˆå‘˜å˜é‡ state è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ— æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚</p><p>ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ï¼šExclusive ç‹¬å ã€Share å…±äº«ã€‚</p><p>åŸºäºAQSçš„åŒæ­¥å·¥å…·ç±»ï¼šSemaphore, CountDownLatch, CyclicBarrier...</p><h4 id="reentrantlock-åŸç†" tabindex="-1"><a class="header-anchor" href="#reentrantlock-åŸç†"><span>ReentrantLock åŸç†</span></a></h4><p>ReentrantLock å±äºä¹è§‚é”ç±»å‹ï¼Œé»˜è®¤éå…¬å¹³çš„ï¼Œå¤šçº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹ã€‚èƒ½ä¿è¯å…±äº«æ•°æ®å®‰å…¨æ€§ï¼Œçº¿ç¨‹é—´æœ‰åºæ€§ã€‚å®ƒé€šè¿‡åŸå­æ“ä½œå’Œé˜»å¡å®ç°é”æœºåˆ¶ï¼Œä¸€èˆ¬ä½¿ç”¨ lock è·å–é”ï¼Œunlock é‡Šæ”¾é”ã€‚</p><p>ReentrantLock çš„å¯é‡å…¥åŠŸèƒ½åŸºäº AQS çš„åŒæ­¥çŠ¶æ€ state å®ç°çš„ã€‚å½“æŸä¸€çº¿ç¨‹è·å–é”åï¼Œå°† state å€¼+1ï¼Œå¹¶è®°å½•ä¸‹å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå†æœ‰çº¿ç¨‹æ¥è·å–é”æ—¶ï¼Œåˆ¤æ–­è¿™ä¸ªçº¿ç¨‹ä¸æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œå°† state å€¼å† +1ï¼Œå¦‚æœä¸æ˜¯ï¼Œé˜»å¡çº¿ç¨‹ã€‚</p><h4 id="å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°"><span>å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°</span></a></h4><p>å…¬å¹³é”å’Œéå…¬å¹³é”æ˜¯ä¸¤ç§ä¸åŒçš„é”çš„å®ç°æ–¹å¼ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºæ˜¯å¦ä¿è¯ç­‰å¾…é”çš„çº¿ç¨‹æŒ‰ç…§å…ˆæ¥ååˆ°çš„é¡ºåºè·å–é”ã€‚å…¬å¹³é”ä¼šè®©çº¿ç¨‹è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…ï¼Œæ¯æ¬¡åªæœ‰é˜Ÿé¦–çš„çº¿ç¨‹èƒ½å¤Ÿè·å–é”ï¼Œè¿™æ ·å¯ä»¥é¿å…çº¿ç¨‹é¥¥é¥¿ï¼Œä½†æ˜¯ä¼šå¢åŠ çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚éå…¬å¹³é”åˆ™ä¸è€ƒè™‘ç­‰å¾…é¡ºåºï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰æœºä¼šæŠ¢å é”ï¼Œè¿™æ ·å¯ä»¥æé«˜å“åº”é€Ÿåº¦ï¼Œä½†æ˜¯å¯èƒ½å¯¼è‡´æŸäº›çº¿ç¨‹é•¿æ—¶é—´å¾—ä¸åˆ°é”ã€‚</p><p>ä»¥åŸºäº AQS çš„ ReentrantLock ä¸ºä¾‹ï¼Œå¦‚æœæ˜¯å…¬å¹³é”ï¼Œä¼šå…ˆåˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…¶ä»–ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥åŠ å…¥åˆ°é˜Ÿå°¾ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°è¯•ä¿®æ”¹stateå˜é‡çš„å€¼ã€‚éå…¬å¹³é”åˆ™ä¸ç®¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…¶ä»–ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œç›´æ¥å°è¯•ä¿®æ”¹ state å˜é‡çš„å€¼ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è·å–åˆ°äº†é”ï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™å†åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…¶ä»–ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åŠ å…¥åˆ°é˜Ÿå°¾ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å†æ¬¡å°è¯•ä¿®æ”¹stateå˜é‡çš„å€¼ã€‚</p><h3 id="jvm" tabindex="-1"><a class="header-anchor" href="#jvm"><span>JVM</span></a></h3><h4 id="å†…å­˜åŒºåŸŸ" tabindex="-1"><a class="header-anchor" href="#å†…å­˜åŒºåŸŸ"><span>å†…å­˜åŒºåŸŸ</span></a></h4><p><strong>çº¿ç¨‹ç§æœ‰ï¼š</strong></p><ul><li>ç¨‹åºè®¡æ•°å™¨ï¼š <ul><li>å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ï¼Œå„çº¿ç¨‹ç§æœ‰äº’ä¸å½±å“ï¼Œä¸ä¼š OOM</li></ul></li><li>è™šæ‹Ÿæœºæ ˆï¼š <ul><li>ç”±ä¸€ä¸ªä¸ªæ ˆå¸§ç»„æˆï¼Œæ ˆå¸§åŒ…æ‹¬å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯</li><li>å…¥æ ˆã€å‡ºæ ˆå¯¹åº”æ–¹æ³•çš„è°ƒç”¨å’Œç»“æŸï¼ˆæ­£å¸¸/å¼‚å¸¸ï¼‰</li><li>è‹¥æ ˆå†…å­˜ä¸å…è®¸åŠ¨æ€æ‰©å±•ï¼Œæ ˆæ·±è¶…è¿‡æœ€å¤§æ·±åº¦ -&gt; StackOverFlow</li><li>è‹¥æ ˆå†…å­˜å…è®¸åŠ¨æ€æ‰©å±•ï¼Œæ— æ³•ç”³è¯·è¶³å¤Ÿæ ˆç©ºé—´ -&gt; OOM</li></ul></li><li>æœ¬åœ°æ–¹æ³•æ ˆï¼š <ul><li>å’Œè™šæ‹Ÿæœºæ ˆåŸºæœ¬ç±»ä¼¼ï¼Œç”¨äº Native æ–¹æ³•</li><li>HotSpot è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€</li></ul></li></ul><p><strong>çº¿ç¨‹å…±äº«ï¼š</strong></p><ul><li>å †ï¼š <ul><li>JVM æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œç”¨äºå­˜æ”¾å‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ï¼ˆæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ç­‰æŠ€æœ¯é™¤å¤–ï¼‰</li><li>ç”±GCç®¡ç†ï¼Œåˆ†æ–°ç”Ÿä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ï¼ˆå…ƒç©ºé—´å–ä»£ï¼‰</li><li>å †ç©ºé—´ä¸è¶³ -&gt; OOM</li></ul></li><li>æ–¹æ³•åŒº: <ul><li>å­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€ä»£ç ç¼“å­˜ç­‰æ•°æ®</li><li>JDK 8 ä»¥å‰ç”¨æ°¸ä¹…ä»£å®ç°æ–¹æ³•åŒºï¼Œå®¹æ˜“ OOM</li><li>JDK 8 åä½¿ç”¨å…ƒç©ºé—´å®ç°æ–¹æ³•åŒºï¼Œä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œèƒ½åŠ è½½æ›´å¤šç±»ï¼Œä¸å®¹æ˜“ OOM</li></ul></li></ul><h4 id="å¯¹è±¡åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡åˆ›å»º"><span>å¯¹è±¡åˆ›å»º</span></a></h4><p><strong>åˆ›å»ºè¿‡ç¨‹ï¼š</strong></p><ol><li>ç±»åŠ è½½æ£€æŸ¥ <ul><li>é‡åˆ°newæŒ‡ä»¤æ—¶ï¼Œå…ˆæ£€æŸ¥å¯¹åº”çš„ç±»æ˜¯å¦å·²ç»åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰å…ˆæ‰§è¡Œç±»åŠ è½½è¿‡ç¨‹</li></ul></li><li>åˆ†é…å†…å­˜ <ul><li>ä»å †ä¸­åˆ†é…å†…å­˜</li><li>åˆ†é…æ–¹å¼ï¼šè§„æ•´çš„ç¢°æ’æŒ‡é’ˆæ³• æˆ– ä¸è§„æ•´çš„ç©ºé—²åˆ—è¡¨æ³•ï¼ˆå–å†³äºGCç®—æ³•ï¼‰</li><li>å¹¶å‘é—®é¢˜ï¼šCAS+å¤±è´¥é‡è¯• æˆ– TLABé¢„å…ˆåˆ†é…çš„ç¼“å†²å†…å­˜</li></ul></li><li>åˆå§‹åŒ–é›¶å€¼</li><li>è®¾ç½®å¯¹è±¡å¤´ <ul><li>Mark Wordï¼šHashCodeã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€ã€åå‘æ ‡è®°ç­‰</li><li>kClass Pointerï¼šæŒ‡å‘ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆ</li></ul></li><li>æ‰§è¡Œå¯¹è±¡çš„<code>&lt;init&gt;</code>æ–¹æ³•ï¼ˆçˆ¶ç±»<code>&lt;init&gt;</code> -&gt; å®ä¾‹åŸŸè¯­å¥ -&gt; æ„é€ æ–¹æ³•ï¼‰</li></ol><p><strong>å¯¹è±¡å†…å­˜å¸ƒå±€ï¼š</strong></p><ul><li>å¯¹è±¡å¤´ <ul><li>Mark Wordï¼šHashCodeã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€ã€åå‘æ ‡è®°ç­‰</li><li>kClass Pointerï¼šæŒ‡å‘ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆ</li></ul></li><li>å®ä¾‹æ•°æ®ï¼šå¯¹è±¡çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯</li><li>å¯¹é½å¡«å……ï¼š8Byteå¯¹é½</li></ul><p><strong>å¯¹è±¡è®¿é—®å®šä½ï¼š</strong><br>æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„referenceå¼•ç”¨ --&gt; å †ä¸­å¯¹è±¡å®ä¾‹ å’Œ æ–¹æ³•åŒºä¸­å¯¹è±¡ç±»å‹</p><ul><li>å¥æŸ„ï¼šå †ä¸­åˆ’åˆ†å¥æŸ„æ± ï¼Œè®°å½•å¯¹è±¡å®ä¾‹æŒ‡é’ˆå’Œå¯¹è±¡ç±»å‹æŒ‡é’ˆã€‚ä¼˜ç‚¹æ˜¯ç¨³å®šï¼Œå¯¹è±¡ç§»åŠ¨æ—¶åªè¦æ”¹å˜å¥æŸ„</li><li>ç›´æ¥æŒ‡é’ˆï¼šç›´æ¥æŒ‡å‘å †ä¸­å¯¹è±¡å®ä¾‹ã€‚ä¼˜ç‚¹æ˜¯é€Ÿåº¦å¿«ï¼ŒèŠ‚çœä¸€æ¬¡æŒ‡é’ˆå®šä½ã€‚</li></ul><h4 id="å¯¹è±¡å­˜æ´»åˆ¤æ–­" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡å­˜æ´»åˆ¤æ–­"><span>å¯¹è±¡å­˜æ´»åˆ¤æ–­</span></a></h4><p><strong>åˆ¤æ–­æ–¹æ³•</strong></p><ul><li>å¼•ç”¨è®¡æ•°æ³•ï¼šè®¡æ•°å™¨åŠ å‡ã€‚æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜</li><li>å¯è¾¾æ€§åˆ†æï¼šGC Roots å¼•ç”¨é“¾åˆ†æï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œå³ä¸å¯è¾¾å¯¹è±¡ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚GC Roots é€šå¸¸åŒ…æ‹¬ï¼š <ul><li>è™šæ‹Ÿæœºæ ˆ/æœ¬åœ°æ–¹æ³•æ ˆ ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚</li><li>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ã€‚</li><li>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ã€‚</li></ul></li></ul><p><strong>å¼•ç”¨ç±»å‹</strong></p><ul><li>å¼ºå¼•ç”¨<code>Strongly Reference</code>ï¼šä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å›æ”¶æ­¤å¯¹è±¡ï¼Œç”šè‡³æŠ›å‡ºOOM</li><li>è½¯å¼•ç”¨<code>Soft Reference</code>ï¼šå¯æœ‰å¯æ— ï¼Œå†…å­˜è¶³å¤Ÿå°±ä¸å›æ”¶ï¼Œå†…å­˜æº¢å‡ºå‰æ‰å›æ”¶</li><li>å¼±å¼•ç”¨<code>Weak Reference</code>ï¼šå¼±äºè½¯å¼•ç”¨ï¼ŒGCæ‰«æåˆ°å°±ç«‹å³å›æ”¶</li><li>è™šå¼•ç”¨<code>Phantom Reference</code>ï¼šä¹Ÿå«å¹»å½±å¼•ç”¨ï¼Œä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«å›æ”¶ï¼Œä¸»è¦ç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨</li></ul><h4 id="gc-ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#gc-ç®—æ³•"><span>GC ç®—æ³•</span></a></h4><ul><li>æ ‡è®°-æ¸…é™¤ç®—æ³• Mark-Sweep <ul><li>è¿‡ç¨‹ï¼šæ ‡è®°å‡ºéœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œç„¶åç»Ÿä¸€å›æ”¶</li><li>ç¼ºç‚¹ï¼šæ‰§è¡Œæ•ˆç‡éšå¯¹è±¡æ•°é‡å¢é•¿è€Œé™ä½ã€å†…å­˜ç¢ç‰‡åŒ–</li></ul></li><li>æ ‡è®°-å¤åˆ¶ç®—æ³• Mark-Copy <ul><li>å°†å†…å­˜åˆ’ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡ä½¿ç”¨å…¶ä¸­ä¸€å—ã€‚å½“ä¸€å—å†…å­˜ç”¨å®Œï¼Œå°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šé¢ï¼Œç„¶åæŠŠå·²ä½¿ç”¨çš„å†…å­˜å—ä¸€æ¬¡æ€§æ¸…ç†æ‰</li><li>ç¼ºç‚¹ï¼šå°†å¯ç”¨å†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠ</li><li>æ”¹è¿›ï¼šAppelå¼å›æ”¶ï¼Œåˆ’åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„<code>Eden</code>ç©ºé—´å’Œä¸¤å—è¾ƒå°çš„<code>Survivor</code>ç©ºé—´ï¼Œæ¯æ¬¡åˆ†é…åªç”¨<code>Eden</code>å’Œå…¶ä¸­ä¸€å—<code>Survivor</code></li></ul></li><li>æ ‡è®°-æ•´ç†ç®—æ³• Mark-Compact <ul><li>å…ˆæ ‡è®°å‡ºéœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œç„¶åè®©æ‰€æœ‰å­˜æ´»å¯¹è±¡ç§»å‘å†…å­˜ç©ºé—´çš„ä¸€ç«¯ï¼Œæœ€åç›´æ¥æ¸…ç†æ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜</li><li>ç¼ºç‚¹ï¼šç§»åŠ¨æ—¶å¿…é¡» STW</li></ul></li></ul><p>æ–°ç”Ÿä»£ï¼šä¸€èˆ¬ä½¿ç”¨ <strong>æ ‡è®°-å¤åˆ¶</strong> ç®—æ³•ï¼Œå› ä¸ºæ¯æ¬¡ GC éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡æ­»äº¡ï¼Œåªè¦å¤åˆ¶å°‘é‡å¯¹è±¡å³å¯å®Œæˆã€‚<br>è€å¹´ä»£ï¼šä¸€èˆ¬ä½¿ç”¨ <strong>æ ‡è®°-æ¸…é™¤</strong>ã€<strong>æ ‡è®°-æ•´ç†</strong> ç®—æ³•ï¼Œå› ä¸ºå…¶ä¸­çš„å¯¹è±¡å­˜æ´»å‡ ç‡è¾ƒé«˜ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–ç©ºé—´åˆ†é…æ‹…ä¿</p><h4 id="gc-åˆ†ç±»" tabindex="-1"><a class="header-anchor" href="#gc-åˆ†ç±»"><span>GC åˆ†ç±»</span></a></h4><p>JVM çš„å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£ã€è€å¹´ä»£ï¼Œåˆ†åˆ«å¯¹åº” Young GCã€Full GCã€‚åˆ’åˆ†ä¸åŒçš„å†…å­˜ç©ºé—´æ˜¯ä¸ºäº†ä¼˜åŒ– GC æ€§èƒ½ï¼Œæ–°ç”Ÿä»£çš„å¤åˆ¶ç®—æ³•èƒ½å¤Ÿå¿«é€Ÿå›æ”¶æ‰ç”Ÿå‘½å‘¨æœŸçŸ­æš‚çš„å¯¹è±¡ï¼Œè€Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶åˆ™æ›´åŠ è°¨æ…ï¼Œå› ä¸ºå®ƒåŒ…å«äº†è¾ƒé•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§åˆ†ä»£çš„è®¾è®¡æé«˜äº†åƒåœ¾å›æ”¶çš„æ•ˆç‡ï¼Œæä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå“åº”æ—¶é—´ã€‚</p><p><strong>Young GC</strong></p><p>æ–°ç”Ÿä»£æ˜¯ç”¨äºå­˜å‚¨æ–°åˆ›å»ºçš„å¯¹è±¡çš„åŒºåŸŸã€‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œå¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•ç­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬å¾ˆå¿«å°±ä¼šå˜å¾—ä¸å¯è¾¾å¹¶è¢«å›æ”¶ã€‚å› æ­¤ Young GC éå¸¸é¢‘ç¹ï¼Œå›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚å½“ Eden åŒºç©ºé—´ä¸è¶³æˆ– Survivor åŒºç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘ Young GCï¼Œå°† Eden åŒºå’Œ Survivor åŒºä¸­å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ª Survivor åŒºï¼Œç„¶åæ¸…ç©º Eden åŒºå’ŒåŸ Survivor åŒºã€‚</p><p>é¢‘ç¹ Young GC å¯èƒ½çš„åŸå› ï¼š</p><ul><li>Eden/Survivor åŒºç©ºé—´ä¸è¶³ï¼Œè§¦å‘ Young GC</li><li>å¯¹è±¡è¿‡å¤šï¼Œå¯¼è‡´ Eden/Survivor åŒºæ»¡äº†ï¼Œè§¦å‘ Full GCï¼Œé—´æ¥è§¦å‘ Young GC</li></ul><p>ä¼˜åŒ–ï¼š</p><ul><li>å¢åŠ  JVM å†…å­˜</li><li>è°ƒæ•´ JVM å‚æ•°</li><li>å‡å°‘å¯¹è±¡åˆ›å»ºã€å¯¹è±¡å¼•ç”¨ã€å¯¹è±¡å¤§å°</li></ul><p><strong>æ™‹å‡è€å¹´ä»£</strong></p><p>è€å¹´ä»£ç”¨äºå­˜å‚¨è¾ƒé•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡ã€‚å½“å¯¹è±¡åœ¨æ–°ç”Ÿä»£ç»è¿‡å¤šæ¬¡(15æ¬¡)åƒåœ¾å›æ”¶ä»ç„¶å­˜æ´»æ—¶ï¼Œå®ƒä»¬ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ã€‚æ­¤å¤–è¿˜æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼š</p><ol><li>å¯¹è±¡çš„å¤§å°å¤§äº Eden çš„äºŒåˆ†ä¹‹ä¸€ä¼šç›´æ¥åˆ†é…åœ¨ old åŒº</li><li>Young GC åï¼ŒSurvivor ä»ç„¶æ”¾ä¸ä¸‹åˆ™æ”¾åˆ°è€å¹´ä»£</li><li>åŠ¨æ€å¹´é¾„åˆ¤æ–­ï¼Œå¤§äºç­‰äºæŸä¸ªå¹´é¾„çš„å¯¹è±¡è¶…è¿‡äº† Survivor ç©ºé—´ä¸€åŠ ï¼Œå¤§äºç­‰äºæŸä¸ªå¹´é¾„çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</li></ol><p><strong>Full GC</strong></p><p>æŒ‡å¯¹æ•´ä¸ªå †å†…å­˜è¿›è¡Œåƒåœ¾å›æ”¶ï¼ŒåŒ…æ‹¬æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚Full GC çš„è¿‡ç¨‹æ˜¯ï¼šé¦–å…ˆä¼šæ‰§è¡Œä¸€æ¬¡ Young GCï¼Œç„¶åå¯¹æ•´ä¸ªå †è¿›è¡Œåƒåœ¾å›æ”¶ã€‚Full GC ä¼šæš‚åœæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œé€šå¸¸å¼€é”€è¾ƒå¤§ï¼Œé¢‘ç‡è¾ƒä½ã€‚</p><p>è§¦å‘ Full GC çš„æ—¶æœºï¼š</p><ul><li><code>System.gc()</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œä¸ä¸€å®šç«‹å³å›æ”¶</li><li>è€å¹´ä»£ç©ºé—´ä¸è¶³</li><li>æ°¸ä¹…ä»£/å…ƒç©ºé—´ä¸è¶³</li><li>Minor GC å‰ï¼Œä¼šæ£€æŸ¥è€å¹´ä»£æ˜¯å¦æœ‰è¶³å¤Ÿçš„è¿ç»­ç©ºé—´ï¼Œå¦‚æœå½“å‰è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´å°äºå¹³å‡å†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¤§å°ï¼Œåˆ™è§¦å‘ Full GCã€‚ï¼ˆæ’æŸ¥æ˜¯ä¸æ˜¯é¢‘ç¹åˆ›å»ºå¤§å¯¹è±¡ï¼‰</li><li>Minor GC åï¼Œæ–°ç”Ÿä»£ Survivor ç©ºé—´ä¸è¶³ï¼Œéœ€è¦æ”¾å…¥è€å¹´ä»£ï¼Œè€Œè€å¹´ä»£ç©ºé—´ä¹Ÿä¸è¶³ï¼Œåˆ™è§¦å‘Full GC</li></ul><h4 id="gc-å®ç°" tabindex="-1"><a class="header-anchor" href="#gc-å®ç°"><span>GC å®ç°</span></a></h4><p>åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®ºï¼Œè€Œåƒåœ¾æ”¶é›†å™¨å°±æ˜¯åƒåœ¾æ”¶é›†ç®—æ³•çš„å…·ä½“å®ç°ã€‚</p><p><strong>GCåˆ†ç±»:</strong></p><ul><li>éƒ¨åˆ†æ”¶é›† <code>Partial GC</code><ul><li>æ–°ç”Ÿä»£æ”¶é›† <code>Minor GC</code></li><li>è€å¹´ä»£æ”¶é›† <code>Major GC</code></li><li>æ··åˆæ”¶é›† <code>Mixed GC</code></li></ul></li><li>æ•´å †æ”¶é›† <code>Full GC</code></li></ul><p><strong>Serial</strong></p><ul><li>ç”¨äºæ–°ç”Ÿä»£ï¼Œå•çº¿ç¨‹ï¼ŒåŸºäºæ ‡è®°-å¤åˆ¶ç®—æ³•</li><li>ç®€å•é«˜æ•ˆï¼Œä½†GCæ—¶å¿…é¡»STW</li></ul><p><strong>Serial Old</strong></p><ul><li>ç”¨äºè€å¹´ä»£ï¼Œå•çº¿ç¨‹ï¼ŒåŸºäºæ ‡è®°-æ•´ç†ç®—æ³•</li><li><code>Serial</code>çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œå¯ä»¥ä½œä¸º CMS çš„åå¤‡æ–¹æ¡ˆ</li></ul><p><strong>ParNew</strong></p><ul><li>ç”¨äºæ–°ç”Ÿä»£ï¼Œå¤šçº¿ç¨‹ï¼ŒåŸºäºæ ‡è®°-å¤åˆ¶ç®—æ³•</li><li><code>Serial</code>çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼ŒGCæ—¶å¿…é¡»STW</li></ul><p><strong>Parallel Scavenge</strong></p><ul><li>ç”¨äºæ–°ç”Ÿä»£ï¼Œå¤šçº¿ç¨‹ï¼ŒåŸºäºæ ‡è®°-å¤åˆ¶ç®—æ³•</li><li>ç±»ä¼¼<code>ParNew</code>ï¼ŒåŒºåˆ«åœ¨äºç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§çš„ååé‡, å› æ­¤æä¾›äº†å¾ˆå¤šå‚æ•°è°ƒèŠ‚å’Œè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥</li></ul><p><strong>Parallel Old</strong></p><ul><li>ç”¨äºè€å¹´ä»£ï¼Œå¤šçº¿ç¨‹ï¼ŒåŸºäºæ ‡è®°-æ•´ç†ç®—æ³•</li><li><code>Parallel Scavenge</code>çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œæ³¨é‡ååé‡å’ŒCPUèµ„æº</li></ul><p><strong>CMS (Concurrent Mark-Sweep)</strong></p><ul><li>ç”¨äºè€å¹´ä»£ï¼Œå¤šçº¿ç¨‹ï¼ŒåŸºäºæ ‡è®°-æ¸…é™¤ç®—æ³•</li><li>å››ä¸ªæ­¥éª¤ï¼š <ul><li>åˆå§‹æ ‡è®°ï¼šæ ‡è®°<code>GC Roots</code>èƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ã€‚</li><li>å¹¶å‘æ ‡è®°ï¼šéå†å¯¹è±¡å›¾ã€‚ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘ã€‚</li><li>é‡æ–°æ ‡è®°ï¼šä¿®æ­£å¹¶å‘æ ‡è®°é˜¶æ®µäº§ç”Ÿçš„æ ‡è®°å˜åŠ¨(å› ç”¨æˆ·çº¿ç¨‹çš„å¹¶å‘æ‰§è¡Œ)ã€‚STWã€‚</li><li>å¹¶å‘æ¸…é™¤ï¼šæ¸…ç†æ ‡è®°æ­»äº¡çš„å¯¹è±¡ã€‚ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘</li></ul></li><li>ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ï¼Œä½åœé¡¿ã€‚ä»…é‡æ–°æ ‡è®°é˜¶æ®µéœ€è¦STW</li><li>ç¼ºç‚¹ï¼šå¯¹CPUèµ„æºæ•æ„Ÿï¼Œæ— æ³•å¤„ç†&quot;æµ®åŠ¨åƒåœ¾&quot;ï¼Œ å­˜åœ¨å¤§é‡å†…å­˜ç¢ç‰‡</li></ul><p>CMS å°½å¯èƒ½å‡å°åº”ç”¨ç¨‹åºçš„åœé¡¿æ—¶é—´ï¼Œé€‚åˆè¦æ±‚ä½å»¶è¿Ÿçš„åœºæ™¯ã€‚</p><p><strong>G1</strong></p><ul><li>é¢å‘å±€éƒ¨æ”¶é›†çš„è®¾è®¡æ€è·¯å’ŒåŸºäºRegionå†…å­˜å¸ƒå±€</li><li>Regionï¼š <ul><li>è¿ç»­çš„Javaå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹Regionï¼Œæ¯ä¸ªRegionæ ¹æ®éœ€è¦æ‰®æ¼”Eden/Survivor/è€å¹´ä»£</li><li>HumongousåŒºåŸŸä¸“é—¨å­˜å‚¨å¤§å¯¹è±¡</li><li>G1è·Ÿè¸ªå„ä¸ªRegioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„&quot;ä»·å€¼&quot;å¤§å°ã€‚ä»·å€¼å³å›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼Œåå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ã€‚</li></ul></li><li>å››ä¸ªæ­¥éª¤ï¼š <ul><li>åˆå§‹æ ‡è®°ï¼šæ ‡è®°<code>GC Roots</code>èƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œå¹¶ä¿®æ”¹TAMSæŒ‡é’ˆä»¥ä¾¿æ­£ç¡®åˆ†é…å¯¹è±¡ã€‚æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚</li><li>å¹¶å‘æ ‡è®°ï¼šéå†å¯¹è±¡å›¾ã€‚ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘ã€‚(ç”¨SATBåŸå§‹å¿«ç…§å¤„ç†å¼•ç”¨å˜åŒ–)</li><li>æœ€ç»ˆæ ‡è®°ï¼šå¤„ç†å¹¶å‘é˜¶æ®µç»“æŸåé—ç•™çš„å°‘é‡SATBè®°å½•ã€‚æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚</li><li>ç­›é€‰å›æ”¶ï¼šæ›´æ–°Regionçš„ç»Ÿè®¡æ•°æ®ï¼Œæ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©Regionå›æ”¶é›†ï¼Œç§»åŠ¨å­˜æ´»å¯¹è±¡å¹¶æ¸…ç†æ—§Regionçš„å…¨éƒ¨ç©ºé—´ã€‚æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚</li></ul></li><li>ç›®çš„ï¼šå»¶è¿Ÿå¯æ§çš„æƒ…å†µä¸‹ï¼Œè·å¾—å°½å¯èƒ½é«˜çš„ååé‡ã€‚</li><li>ç‰¹ç‚¹ï¼šå¹¶å‘ã€ç‹¬ç«‹GCåˆ†ä»£æ”¶é›†ã€ç©ºé—´æ•´åˆã€å¯é¢„æµ‹åœé¡¿</li></ul><p>G1 é€‚åˆå¤§å†…å­˜çš„åº”ç”¨ï¼Œèƒ½å¤Ÿè·å¾—æ›´é«˜çš„ååé‡ã€‚</p><h4 id="ç±»æ–‡ä»¶ç»“æ„" tabindex="-1"><a class="header-anchor" href="#ç±»æ–‡ä»¶ç»“æ„"><span>ç±»æ–‡ä»¶ç»“æ„</span></a></h4><p>é­”æ•°ã€Classæ–‡ä»¶ç‰ˆæœ¬å·ã€å¸¸é‡æ± ã€è®¿é—®æ ‡å¿—ã€å½“å‰ç±»ã€çˆ¶ç±»ã€æ¥å£çš„ç´¢å¼•é›†åˆã€å­—æ®µè¡¨é›†åˆã€æ–¹æ³•è¡¨é›†åˆã€å±æ€§è¡¨é›†åˆ åå¤§å—ã€‚</p><h4 id="ç±»åŠ è½½è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#ç±»åŠ è½½è¿‡ç¨‹"><span>ç±»åŠ è½½è¿‡ç¨‹</span></a></h4><ol><li><strong>åŠ è½½ï¼ˆLoadingï¼‰ï¼š</strong> ç±»çš„åŠ è½½é˜¶æ®µæ˜¯æŒ‡å°†ç±»çš„å­—èŠ‚ç æ•°æ®ä»æ–‡ä»¶æˆ–å…¶ä»–é€”å¾„è¯»å–åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„<code>java.lang.Class</code>å¯¹è±¡ã€‚ç±»åŠ è½½å™¨è´Ÿè´£å®ŒæˆåŠ è½½é˜¶æ®µçš„å·¥ä½œã€‚åŠ è½½æ¡ä»¶ï¼šä»…å½“æœ‰ç±»ä¸»åŠ¨å»ä½¿ç”¨è¯¥Classã€‚åŒ…æ‹¬newã€åå°„ã€å…‹éš†ã€ååºåˆ—åŒ–ã€è°ƒç”¨ç±»é™æ€æ–¹æ³•ã€è°ƒç”¨å…¶å­ç±»ã€mainæ–¹æ³•ç­‰ç­‰ã€‚</li><li><strong>é“¾æ¥ï¼ˆLinkingï¼‰ï¼š</strong> é“¾æ¥é˜¶æ®µåŒ…æ‹¬ä¸‰ä¸ªå­é˜¶æ®µï¼šéªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰ã€è§£æï¼ˆResolutionï¼‰ã€‚</li></ol><ul><li><strong>éªŒè¯ï¼š</strong> ç¡®ä¿è¢«åŠ è½½çš„ç±»çš„æ­£ç¡®æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶æ ¼å¼çš„éªŒè¯ã€å…ƒæ•°æ®çš„éªŒè¯ã€å­—èŠ‚ç çš„éªŒè¯ã€ç¬¦å·å¼•ç”¨çš„éªŒè¯ã€‚</li><li><strong>å‡†å¤‡ï¼š</strong> åœ¨æ–¹æ³•åŒºä¸­ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ã€‚</li><li><strong>è§£æï¼š</strong> å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œå¾—åˆ°ç±»/æ¥å£/å­—æ®µ/æ–¹æ³•åœ¨å†…å­˜ä¸­çš„æŒ‡é’ˆæˆ–åç§»é‡</li></ul><ol start="3"><li><strong>åˆå§‹åŒ–ï¼ˆInitializationï¼‰ï¼š</strong> è°ƒç”¨ç±»å¯¹è±¡çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•ï¼Œå¯¹ç±»å˜é‡èµ‹å€¼ã€‚<code>&lt;clinit&gt;</code>æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ï¼ˆ<code>static{}</code>å—ï¼‰ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„ã€‚å½“åˆå§‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå…¶çˆ¶ç±»å°šæœªåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„åˆå§‹åŒ–è¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li><li><strong>ä½¿ç”¨</strong></li><li><strong>å¸è½½</strong>ï¼šè¯¥ç±»çš„ <code>Classå¯¹è±¡</code> è¢«GCï¼Œè¦æ±‚ï¼š</li></ol><ul><li>è¯¥ç±»çš„æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡éƒ½å·²è¢« GCï¼Œä¹Ÿå°±æ˜¯è¯´å †ä¸å­˜åœ¨è¯¥ç±»çš„å®ä¾‹å¯¹è±¡ã€‚</li><li>è¯¥ç±»æ²¡æœ‰åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨</li><li>è¯¥ç±»çš„ç±»åŠ è½½å™¨çš„å®ä¾‹å·²è¢« GCï¼ˆæ‰€ä»¥JDKè‡ªå¸¦ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ä¸ä¼šè¢«å›æ”¶ï¼‰</li></ul><h4 id="ç±»åŠ è½½å™¨" tabindex="-1"><a class="header-anchor" href="#ç±»åŠ è½½å™¨"><span>ç±»åŠ è½½å™¨</span></a></h4><p><strong>å†…ç½®ç±»åŠ è½½å™¨ï¼š</strong></p><ul><li><code>BoostrapClassLoader</code> å¯åŠ¨ç±»åŠ è½½å™¨ï¼šC++å®ç°çš„é¡¶å±‚åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½java/baseä¸‹çš„æ ¸å¿ƒç³»ç»Ÿç±»</li><li><code>ExtentionClassLoader</code> æ‰©å±•ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½æ‰©å±•ç›®å½•ä¸‹çš„jaråŒ…å’Œç±»ã€‚JDK 9 ç§»é™¤ã€‚</li><li><code>PlatformClassLoader</code> æ¨¡å—åŠ è½½å™¨ï¼šJDK9å¼•å…¥å–ä»£Extï¼Œè´Ÿè´£åŠ è½½éæ ¸å¿ƒæ¨¡å—ç±»</li><li><code>AppClassLoader</code> åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½ç”¨æˆ·åº”ç”¨classpathä¸‹çš„æ‰€æœ‰jaråŒ…å’Œç±»</li></ul><p><strong>åŒäº²å§”æ´¾æ¨¡å‹ï¼š</strong></p><ul><li>é™¤ BootstrapClassLoader å¤–ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰å¯¹åº”çš„çˆ¶ç±»åŠ è½½å™¨ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨ä¸º nullï¼Œé»˜è®¤å°±æ˜¯ BootstrapClassLoaderï¼ˆè‡ªå®šä¹‰åŠ è½½å™¨ç»§æ‰¿ClassLoaderï¼‰</li><li>ä»»æ„ä¸€ä¸ª ClassLoader åœ¨å°è¯•åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œéƒ½ä¼šå…ˆè‡ªåº•å‘ä¸Šå°è¯•è°ƒç”¨çˆ¶ç±»çš„<code>loadClass()</code>æ–¹æ³•å»åŠ è½½ç±»ï¼Œå¦‚æœçˆ¶ç±»ä¸èƒ½åŠ è½½è¯¥ç±»ï¼Œå†è‡ªé¡¶å‘ä¸‹äº¤ç”±å­ç±»å»å®Œæˆã€‚</li><li>å¥½å¤„ï¼šé¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œé™åˆ¶ä½¿ç”¨è€…å¯¹JVMç³»ç»Ÿçš„å½±å“ã€‚ä¿è¯äº†Javaç¨‹åºçš„ç¨³å®šè¿è¡Œ</li></ul><h4 id="å†…å­˜æ’æŸ¥å·¥å…·" tabindex="-1"><a class="header-anchor" href="#å†…å­˜æ’æŸ¥å·¥å…·"><span>å†…å­˜æ’æŸ¥å·¥å…·</span></a></h4><p><strong>JMeter å‹æµ‹</strong></p><p>æ·»åŠ çº¿ç¨‹ç»„ -&gt; æŸ¥çœ‹ç»“æœæ ‘å’Œæ±‡æ€»æŠ¥å‘Š -&gt; åˆ†æå¼‚å¸¸æ¯”ä¾‹ã€ååé‡ã€å“åº”æ—¶é—´ç­‰ã€‚</p><p><strong>JConsole</strong></p><p>Java ç›‘è§†å’Œç®¡ç†æ§åˆ¶å°ï¼Œæ ¹æ® PID è¿æ¥æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹è™šæ‹Ÿæœºå†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬å †ç©ºé—´ã€Edenã€Survivorç­‰ï¼ŒåŒ…æ‹¬ Young GCã€Old GC æ—¶é—´ï¼Œä»¥åŠçº¿ç¨‹æ•°é‡ç­‰ä¿¡æ¯</p><p><strong>jmap</strong><br><code>jstack</code> æŸ¥çœ‹å †æ ˆä¿¡æ¯ï¼Œä»¥åŠæ’æŸ¥æ­»é”é—®é¢˜<br><code>jhsdb jmap --heap --pid 20536</code> æŸ¥çœ‹è¿›ç¨‹ä½¿ç”¨çš„GCç®—æ³•ã€å †é…ç½®ä¿¡æ¯å’Œå„å†…å­˜åŒºåŸŸå†…å­˜ä½¿ç”¨ä¿¡æ¯<br><code>jstat -gc -h3 31736 1000 10</code> æŸ¥çœ‹ GC æƒ…å†µï¼Œå„ä¸ªç©ºé—´çš„ä½¿ç”¨é‡<br><code>jmap -dump:format=b,file=dump.hprof 20536</code> ç”Ÿæˆå †è½¬å‚¨å¿«ç…§ heap profile -&gt; VisualVM/JProfile æŸ¥çœ‹å†…å­˜å ç”¨æƒ…å†µ -&gt; å®šä½å¤§å¯¹è±¡ -&gt; å®šä½ä»£ç ä¸­åˆ›å»ºçš„ä½ç½® -&gt; æ’æŸ¥ BUG</p><h3 id="å…¶å®ƒ" tabindex="-1"><a class="header-anchor" href="#å…¶å®ƒ"><span>å…¶å®ƒ</span></a></h3><h4 id="åå°„æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#åå°„æœºåˆ¶"><span>åå°„æœºåˆ¶</span></a></h4><p>åå°„å¯ä»¥åœ¨è¿è¡Œæ—¶åˆ†æç±»ä»¥åŠæ‰§è¡Œç±»ä¸­æ–¹æ³•ï¼Œé€šè¿‡åå°„å¯ä»¥è·å–ä»»æ„ä¸€ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œè¿˜å¯ä»¥è°ƒç”¨è¿™äº›æ–¹æ³•å’Œå±æ€§ã€‚ä¾‹å¦‚ Springã€MyBatis ç­‰æ¡†æ¶å¤§é‡ä½¿ç”¨åå°„æœºåˆ¶ï¼ŒåŠ¨æ€ä»£ç†çš„å®ç°ä¹Ÿä¾èµ–äºåå°„ã€‚</p><p>åå°„å¯ä»¥è®©ä»£ç æ›´åŠ çµæ´»ï¼Œä¸ºå„ç§æ¡†æ¶å¼€ç®±å³ç”¨æä¾›ä¾¿åˆ©ï¼›ä½†ä¹Ÿå¢åŠ äº†å®‰å…¨é—®é¢˜ï¼Œæ¯”å¦‚æ— è§†æ³›å‹å‚æ•°çš„å®‰å…¨æ£€æŸ¥ï¼Œæ€§èƒ½ä¹Ÿä¼šç¨å·®ä¸€ç‚¹ã€‚</p><p>è·å–Classå¯¹è±¡çš„å››ç§æ–¹æ³•ï¼š</p><ul><li>Target.class</li><li>Class.forName(...)</li><li>instance.getClass()</li><li>ClassLoader::loadClass(...)</li></ul><h4 id="ä»£ç†æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#ä»£ç†æ¨¡å¼"><span>ä»£ç†æ¨¡å¼</span></a></h4><p>ä»£ç†æ¨¡å¼æ˜¯ä¸€ç§ä½¿ç”¨ä»£ç†å¯¹è±¡æ¥ä»£æ›¿å¯¹çœŸå®å¯¹è±¡è®¿é—®çš„è®¾è®¡æ¨¡å¼ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚</p><p><strong>é™æ€ä»£ç†</strong></p><ul><li>å¯¹ç›®æ ‡å¯¹è±¡æ¯ä¸ªæ–¹æ³•çš„å¢å¼ºéƒ½æ‰‹åŠ¨å®Œæˆã€‚ï¼ˆåˆ›å»ºæ¥å£ï¼Œå®ç°ç±»å’Œä»£ç†ç±»ï¼Œå°†ç›®æ ‡å¯¹è±¡æ³¨å…¥è¿›ä»£ç†ç±»ï¼Œåœ¨ä»£ç†ç±»çš„å¯¹åº”æ–¹æ³•è°ƒç”¨ç›®æ ‡ç±»ä¸­çš„å¯¹åº”æ–¹æ³•å¹¶åšå¢å¼ºï¼‰</li><li>JVMå±‚é¢ä¸Šï¼Œé™æ€ä»£ç†åœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å®ç°ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ class æ–‡ä»¶ã€‚</li><li>ç¼ºç‚¹ï¼šä¸çµæ´»ä¸”éº»çƒ¦</li></ul><p><strong>åŠ¨æ€ä»£ç†</strong></p><ul><li>JVM å±‚é¢ä¸Šï¼ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»å­—èŠ‚ç ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­ã€‚æ›´åŠ çµæ´»ã€‚</li><li>JDK åŠ¨æ€ä»£ç†ï¼š <ul><li><code>Proxy.newProxyInstance(ClassLoader, Class[], InvocationHandler)</code> è·å¾—æŸä¸ªç±»çš„ä»£ç†å¯¹è±¡</li><li>å½“åŠ¨æ€ä»£ç†å¯¹è±¡è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘åˆ°å®ç° InvocationHandler æ¥å£ç±»çš„ <code>invoke(ProxyObject, Method, args)</code> æ–¹æ³•æ¥è°ƒç”¨</li><li>ç¼ºç‚¹ï¼šåªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»</li></ul></li><li>CGLIB åŠ¨æ€ä»£ç† <ul><li>ä¸€ä¸ªåŸºäºASMçš„å­—èŠ‚ç ç”Ÿæˆåº“ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹å’ŒåŠ¨æ€ç”Ÿæˆã€‚é€šè¿‡ç»§æ‰¿æ–¹å¼å®ç°ä»£ç†ã€‚</li><li>ä¾‹å¦‚ Spring çš„ AOP æ¨¡å—ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£ï¼Œåˆ™é»˜è®¤é‡‡ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦åˆ™é‡‡ç”¨ CGLIB åŠ¨æ€ä»£ç†ã€‚</li><li>Enhancer ç±»ç”¨äºåŠ¨æ€è·å–è¢«ä»£ç†ç±»</li><li>è‡ªå®šä¹‰ <code>MethodInterceptor::intercept(Object, method, args, proxy)</code> å®ç°å¢å¼ºã€‚å½“ä»£ç†ç±»è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ MethodInterceptor ä¸­çš„ intercept æ–¹æ³•ã€‚</li></ul></li></ul><p>JDK åŠ¨æ€ä»£ç†åŸºäºæ¥å£å®ç°ï¼Œåªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œè€Œ CGLIB åŸºäºç»§æ‰¿ï¼Œå¯ä»¥ä»£ç†ä»»ä½•ç±»ã€‚</p><h4 id="å¼‚å¸¸æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#å¼‚å¸¸æœºåˆ¶"><span>å¼‚å¸¸æœºåˆ¶</span></a></h4><p><strong>å¼‚å¸¸åˆ†ç±»</strong></p><ul><li><code>Throwable</code> æ˜¯æ‰€æœ‰å¼‚å¸¸å’Œé”™è¯¯çš„è¶…ç±» <ul><li><code>Error</code> é”™è¯¯ï¼šä¸€èˆ¬æ˜¯ä¸ JVM ç›¸å…³çš„é—®é¢˜ï¼Œå¦‚ç³»ç»Ÿå´©æºƒï¼Œå†…å­˜ç©ºé—´ä¸è¶³ï¼Œæ–¹æ³•è°ƒç”¨æ ˆæº¢å‡ºç­‰ã€‚Error ä¸€èˆ¬ä¼šå¯¼è‡´ç¨‹åºä¸­æ–­ï¼Œå¹¶ä¸”æ— æ³•æ¢å¤å’Œé¢„é˜²ã€‚ä¾‹å¦‚ OutOfMemoryError, StackOverFlowError</li><li><code>Exception</code> å¼‚å¸¸ï¼šç¨‹åºè¿è¡Œä¸­å¯ä»¥é¢„æ–™çš„æ„å¤–æƒ…å†µï¼Œå¹¶ä¸”åº”è¯¥è¢«æ•è·è¿›è¡Œå¤„ç†ï¼Œä½¿ç¨‹åºæ¢å¤è¿è¡Œ <ul><li><code>RuntimeException</code> è¿è¡Œæ—¶å¼‚å¸¸ï¼šéƒ½æ˜¯éæ£€æŸ¥å¼‚å¸¸ï¼Œä¾‹å¦‚ NullPointerException, ArrayIndexOutOfBounds, IllegalArgument...</li><li>éè¿è¡Œæ—¶å¼‚å¸¸ï¼šéƒ½æ˜¯æ£€æŸ¥å¼‚å¸¸/ç¼–è¯‘æ—¶å¼‚å¸¸ï¼Œä¾‹å¦‚ IOException, NoSuchMethodException</li></ul></li></ul></li></ul><p>æ£€æŸ¥å¼‚å¸¸åœ¨ç¼–è¯‘å‰éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼Œè¦ä¹ˆåœ¨æ–¹æ³•ä¸Šé€šè¿‡ <code>throws</code> æŠ›å‡ºï¼Œç”±è°ƒç”¨è¯¥æ–¹æ³•çš„æ–¹æ³•å¤„ç†å¼‚å¸¸ï¼Œè¦ä¹ˆ <code>try-catch</code> æ•è·å¼‚å¸¸è‡ªå·±å¤„ç†ã€‚æ£€æŸ¥å¼‚å¸¸ä¼šåœ¨æ–¹æ³•è°ƒç”¨é“¾ä¸Šæ˜¾å¼ä¼ é€’ï¼Œå› æ­¤æ¨èä½¿ç”¨éæ£€æŸ¥å¼‚å¸¸ã€‚</p><p><strong>finally å—åŸç†</strong></p><ul><li>å­—èŠ‚ç å±‚é¢ä¸Šï¼Œä¼šæŠŠ finally è¯­å¥å¤åˆ¶åˆ° try å’Œ catch å—çš„æœ«å°¾ã€‚</li><li>å¦‚æœ finally å—æœ‰ return è¯­å¥ï¼Œé‚£ä¹ˆ try/catch å—ä¸­çš„ return éƒ½ä¼šå¤±æ•ˆã€‚</li><li>å¦‚æœ finally å—æ²¡æœ‰ return è¯­å¥ï¼Œé‚£ä¹ˆæ— è®ºåœ¨ finally å—ä¸­æ˜¯å¦ä¿®æ”¹è¿”å›å€¼ï¼Œè¿”å›å€¼éƒ½ä¸ä¼šæ”¹å˜ï¼Œä»ç„¶æ˜¯æ‰§è¡Œ finally ä»£ç å—ä¹‹å‰çš„å€¼ã€‚</li><li>try-with-resources è¯­æ³•ç³–ç»è¿‡ç¼–è¯‘åè½¬æ¢ä¸º try-catch-finally è¯­å¥</li></ul><h4 id="static-å…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#static-å…³é”®å­—"><span>static å…³é”®å­—</span></a></h4><p>static å…³é”®å­—å¯ä»¥ä¿®é¥° ç±»ã€æ–¹æ³•ã€å˜é‡å’Œä»£ç å—ã€‚</p><ol><li>ä¿®é¥°ç±»ï¼šè¢« static ä¿®é¥°çš„ç±»ç§°ä¸ºé™æ€å†…éƒ¨ç±»ã€‚é™æ€å†…éƒ¨ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„é™æ€æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼Œä½†ä¸èƒ½è®¿é—®å¤–éƒ¨ç±»çš„éé™æ€æˆå‘˜ã€‚</li><li>ä¿®é¥°æ–¹æ³•ï¼šè¢« static ä¿®é¥°çš„æ–¹æ³•ç§°ä¸ºé™æ€æ–¹æ³•ã€‚é™æ€æ–¹æ³•å¯ä»¥ç›´æ¥é€šè¿‡ç±»åè°ƒç”¨ï¼Œä¸éœ€è¦å®ä¾‹åŒ–å¯¹è±¡ã€‚é™æ€æ–¹æ³•åªèƒ½è®¿é—®ç±»çš„é™æ€æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼Œä¸èƒ½è®¿é—®éé™æ€æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚</li><li>ä¿®é¥°å˜é‡ï¼šè¢« static ä¿®é¥°çš„å˜é‡ç§°ä¸ºé™æ€å˜é‡ï¼Œä¹Ÿç§°ä¸ºç±»å˜é‡ã€‚é™æ€å˜é‡åœ¨ç±»åŠ è½½æ—¶è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”æ‰€æœ‰å¯¹è±¡å…±äº«åŒä¸€ä¸ªé™æ€å˜é‡çš„å€¼ã€‚é™æ€å˜é‡å¯ä»¥é€šè¿‡ç±»åç›´æ¥è®¿é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¯¹è±¡åè®¿é—®ã€‚</li><li>ä¿®é¥°ä»£ç å—ï¼šè¢« static ä¿®é¥°çš„ä»£ç å—ç§°ä¸ºé™æ€ä»£ç å—ã€‚é™æ€ä»£ç å—åœ¨ç±»åŠ è½½æ—¶è¢«æ‰§è¡Œï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚é™æ€ä»£ç å—é€šå¸¸ç”¨äºåˆå§‹åŒ–é™æ€æˆå‘˜å˜é‡ã€‚</li></ol><p>å¦å¤–ï¼Œå­ç±»ä¸èƒ½è¦†å†™çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼ˆ@Overrideä¼šæŠ¥é”™ï¼‰ï¼Œä½†æ˜¯å¯ä»¥å®šä¹‰ç›¸åŒæ–¹æ³•å°†å…¶éšè—ã€‚</p><h4 id="equals-å’Œ-hashcode" tabindex="-1"><a class="header-anchor" href="#equals-å’Œ-hashcode"><span>equals() å’Œ hashcode()</span></a></h4><ul><li>åœ¨Javaä¸­ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„ equals() è¿”å› trueï¼Œåˆ™å®ƒä»¬çš„ hashcode() å¿…é¡»è¿”å›ç›¸åŒçš„å€¼ã€‚</li><li>å› ä¸ºåœ¨ Java ä¸­ï¼Œhashcode() ç”¨äºè·å–å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼Œè€Œå“ˆå¸Œå€¼ç”¨äºç¡®å®šå¯¹è±¡åœ¨å“ˆå¸Œè¡¨ä¸­çš„ç´¢å¼•ä½ç½®ã€‚å¦‚æœç´¢å¼•ä½ç½®ä¸Šå·²ç»æœ‰å…ƒç´ äº†ï¼Œä¼šè°ƒç”¨ equals() åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œç›¸åŒå°±æ·»åŠ å¤±è´¥ï¼Œä¸ç›¸åŒå°±æ•£åˆ—åˆ°å…¶å®ƒä½ç½®ä¸Šã€‚</li><li>å¦‚æœé‡å†™äº† equals(), ä½†æ²¡æœ‰é‡å†™ hashcode()ï¼Œä¼šå¯¼è‡´æ‰€æœ‰å¯¹è±¡çš„ hashcode éƒ½ä¸ç›¸åŒï¼Œéƒ½èƒ½æ·»åŠ æˆåŠŸï¼Œé‚£ä¹ˆåŸºäºå“ˆå¸Œçš„é›†åˆå°±ä¼šå‡ºç°å¾ˆå¤šé‡å¤å…ƒç´ </li></ul><h4 id="string-ç±»å‹" tabindex="-1"><a class="header-anchor" href="#string-ç±»å‹"><span>String ç±»å‹</span></a></h4><p><strong>å­˜å‚¨ä½ç½®</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åœ¨æ–¹æ³•åŒºçš„å¸¸é‡æ± ä¸­ï¼Œå¼•ç”¨å­˜å‚¨çš„ä¹Ÿæ˜¯å¸¸é‡æ± ä¸­çš„åœ°å€ï¼ˆå¸¸é‡æ± åœ¨ç¼–è¯‘æœŸé—´å°±ä¼šç”Ÿæˆï¼‰</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> str1 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> str2 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(str1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">str2);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å †ä¸­ï¼Œå¼•ç”¨å­˜å‚¨çš„ä¹Ÿæ˜¯å †ä¸­çš„åœ°å€</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> str3 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;é«˜å¤§å¤©&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> str4 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;é«˜å¤§å¤©&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(str3</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">str4);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œå¦‚æœéƒ½æ˜¯é™æ€å­—ç¬¦ä¸²ç›¸åŠ ï¼Œç»“æœä¼šåŠ å…¥å¸¸é‡æ± ï¼›å¦‚æœå«æœ‰å˜é‡åˆ™ä¸ä¼šè¿›å…¥å¸¸é‡æ± ã€‚String::intern() ä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹åº”çš„å¸¸é‡åŠ å…¥å¸¸é‡æ± ï¼Œå¹¶è¿”å›åœ¨å¸¸é‡æ± ä¸­çš„åœ°å€ã€‚</p><p><strong>ä¸å¯å˜å¯¹è±¡</strong></p><p>String åº•å±‚æ˜¯ final ä¿®é¥°çš„ char[] æ•°ç»„ï¼Œå› æ­¤æ˜¯ä¸å¯å˜çš„ã€‚å¥½å¤„æ˜¯ä¾¿äºå®ç°å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œä½¿å¤šçº¿ç¨‹å®‰å…¨ï¼Œé¿å…å®‰å…¨é—®é¢˜ï¼Œä»¥åŠåŠ å¿«å­—ç¬¦ä¸²å¤„ç†é€Ÿåº¦ã€‚StringBuilderä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€ŒStringBufferæ˜¯çº¿ç¨‹å®‰å…¨çš„</p><h2 id="mysql" tabindex="-1"><a class="header-anchor" href="#mysql"><span>MySQL</span></a></h2><h3 id="ä¸‰èŒƒå¼" tabindex="-1"><a class="header-anchor" href="#ä¸‰èŒƒå¼"><span>ä¸‰èŒƒå¼</span></a></h3><ul><li>ç¬¬ä¸€èŒƒå¼ï¼š è¦æ±‚ä»»ä½•ä¸€å¼ è¡¨å¿…é¡»æœ‰ä¸»é”®ï¼Œæ¯ä¸ªå­—æ®µéƒ½ä¸å¯å†åˆ†ã€‚</li><li>ç¬¬äºŒèŒƒå¼ï¼š å»ºç«‹åœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¹‹ä¸Šï¼Œè¦æ±‚æ‰€æœ‰éä¸»é”®å­—æ®µå®Œå…¨ä¾èµ–ä¸»é”®ï¼Œä¸è¦äº§ç”Ÿéƒ¨åˆ†ä¾èµ–ã€‚</li><li>ç¬¬ä¸‰èŒƒå¼ï¼š å»ºç«‹åœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¹‹ä¸Šï¼Œè¦æ±‚æ‰€æœ‰éä¸»é”®å­—æ®µç›´æ¥ä¾èµ–ä¸»é”®ï¼Œä¸è¦äº§ç”Ÿä¼ é€’ä¾èµ–ã€‚</li></ul><h3 id="sql-æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#sql-æ³¨å…¥"><span>SQL æ³¨å…¥</span></a></h3><p>æ‰€è°“SQLæ³¨å…¥ï¼Œå°±æ˜¯é€šè¿‡æŠŠSQLå‘½ä»¤æ’å…¥åˆ°Webè¡¨å•é€’äº¤æˆ–è¾“å…¥åŸŸåæˆ–é¡µé¢è¯·æ±‚çš„æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆè¾¾åˆ°æ¬ºéª—æœåŠ¡å™¨æ‰§è¡Œæ¶æ„çš„SQLå‘½ä»¤ã€‚</p><ol><li>å°½é‡ç”¨é¢„ç¼–è¯‘æœºåˆ¶ prepareStatementï¼Œå°‘ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ä¼ å‚ï¼Œå®ƒæ˜¯sqlæ³¨å…¥é—®é¢˜çš„æ ¹æºã€‚</li><li>è¦å¯¹ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ï¼Œæ¯”å¦‚ % ä½œä¸º like è¯­å¥ä¸­çš„å‚æ•°æ—¶ï¼Œè¦å¯¹å…¶è¿›è¡Œè½¬ä¹‰å¤„ç†</li><li>å¯¹æ‰€æœ‰çš„å¼‚å¸¸æƒ…å†µè¿›è¡Œæ•è·ï¼Œä¸è¦åœ¨æ¥å£ç›´æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼Œå› ä¸ºæœ‰äº›å¼‚å¸¸ä¿¡æ¯ä¸­åŒ…å«äº†sqlä¿¡æ¯ï¼Œæ¯”å¦‚åº“åï¼Œè¡¨åï¼Œå­—æ®µåç­‰ã€‚æ”»å‡»è€…æ‹¿ç€è¿™äº›ä¿¡æ¯ï¼Œå°±èƒ½é€šè¿‡sqlæ³¨å…¥éšå¿ƒæ‰€æ¬²çš„æ”»å‡»ä½ çš„æ•°æ®åº“äº†ã€‚</li><li>ä½¿ç”¨sqlMapç­‰ä»£ç æ£€æµ‹å·¥å…·ï¼Œå®ƒèƒ½æ£€æµ‹sqlæ³¨å…¥æ¼æ´ã€‚</li><li>éœ€è¦å¯¹æ•°æ®åº“sqlçš„æ‰§è¡Œæƒ…å†µè¿›è¡Œç›‘æ§ï¼Œæœ‰å¼‚å¸¸æƒ…å†µï¼ŒåŠæ—¶é‚®ä»¶æˆ–çŸ­ä¿¡æé†’ã€‚</li><li>å¯¹ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“å»ºç«‹å•ç‹¬çš„è´¦å·ï¼Œåªåˆ†é…DMLç›¸å…³æƒé™ï¼Œä¸”ä¸èƒ½è®¿é—®ç³»ç»Ÿè¡¨ã€‚åˆ‡å‹¿åœ¨ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ã€‚</li><li>å»ºç«‹ä»£ç reviewæœºåˆ¶ï¼Œèƒ½æ‰¾å‡ºéƒ¨åˆ†éšè—çš„é—®é¢˜ï¼Œæå‡ä»£ç è´¨é‡ã€‚</li><li>å¯¹äºä¸èƒ½ä½¿ç”¨é¢„ç¼–è¯‘ä¼ å‚æ—¶ï¼Œè¦ä¹ˆå¼€å¯druidçš„filteré˜²ç«å¢™ï¼Œè¦ä¹ˆè‡ªå·±å†™ä»£ç é€»è¾‘è¿‡æ»¤æ‰æ‰€æœ‰å¯èƒ½çš„æ³¨å…¥å…³é”®å­—ã€‚</li></ol><h3 id="æ¶æ„" tabindex="-1"><a class="header-anchor" href="#æ¶æ„"><span>æ¶æ„</span></a></h3><p>ä¸»è¦åˆ†ä¸ºä¸¤å±‚ï¼šServer å±‚å’Œå­˜å‚¨å¼•æ“å±‚ã€‚</p><ol><li>Server å±‚ï¼šè´Ÿè´£ MySQL çš„æ‰€æœ‰æ ¸å¿ƒæœåŠ¡ï¼ŒåŒ…æ‹¬è¿æ¥ç®¡ç†ã€å®‰å…¨è®¤è¯ã€SQL è§£æä¸æ‰§è¡Œã€äº‹åŠ¡ç®¡ç†ã€å¹¶å‘æ§åˆ¶ã€æ—¥å¿—è®°å½•ç­‰ã€‚Server å±‚ä¸å­˜å‚¨å¼•æ“å±‚ä¹‹é—´é€šè¿‡ API è¿›è¡Œé€šä¿¡ã€‚</li><li>å­˜å‚¨å¼•æ“å±‚ï¼šè´Ÿè´£ MySQL æ•°æ®çš„å­˜å‚¨å’Œè¯»å–ã€‚MySQL æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œå¦‚ InnoDBã€MyISAMã€Memoryã€CSV ç­‰ã€‚æ¯ä¸ªå­˜å‚¨å¼•æ“éƒ½æœ‰å…¶ç‹¬ç‰¹çš„æ•°æ®å­˜å‚¨å’Œç´¢å¼•ç»“æ„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸åŒçš„å­˜å‚¨å¼•æ“ï¼Œæé«˜æ•°æ®è®¿é—®æ•ˆç‡ã€‚</li></ol><p>åœ¨æ¶æ„ä¸Šï¼ŒMySQL çš„ Server å±‚å’Œå­˜å‚¨å¼•æ“å±‚æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ›¿æ¢å­˜å‚¨å¼•æ“æ¥æ”¹å˜ MySQL çš„æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œè€Œä¸ä¼šå½±å“ MySQL Server å±‚çš„å…¶ä»–åŠŸèƒ½ã€‚</p><p><img src="/img/MySQL%E6%9E%B6%E6%9E%84.webp#id=DyVTi&amp;originHeight=1440&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><h3 id="innodb-å’Œ-myisam-åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#innodb-å’Œ-myisam-åŒºåˆ«"><span>InnoDb å’Œ MyISAM åŒºåˆ«</span></a></h3><ol><li>InnoDB æ”¯æŒäº‹åŠ¡å’Œ MVCCï¼ŒMyISAM ä¸æ”¯æŒ</li><li>InnoDB æ”¯æŒå¤–é”®ï¼ŒMyISAM ä¸æ”¯æŒ</li><li>InnoDB æ”¯æŒè¡Œçº§é”å’Œè¡¨çº§é”ï¼Œå¹¶ä¸”é»˜è®¤å°±æ˜¯è¡Œçº§é”ï¼ŒMyISAM åªæ”¯æŒè¡¨çº§é”</li><li>InnoDB æ˜¯èšé›†ç´¢å¼•ï¼Œæ•°æ®å³ç´¢å¼•ï¼ŒMyISAM åªæœ‰äºŒçº§ç´¢å¼•ï¼Œæ•°æ®å’Œç´¢å¼•æ˜¯åˆ†ç¦»çš„</li><li>InnoDB ä¸æ”¯æŒå…¨æ–‡æ£€ç´¢ï¼ŒMyISAM æ”¯æŒ</li></ol><h3 id="myisam-çš„ä¼˜åŠ¿" tabindex="-1"><a class="header-anchor" href="#myisam-çš„ä¼˜åŠ¿"><span>MyISAM çš„ä¼˜åŠ¿</span></a></h3><ol><li>å¿«é€Ÿï¼šMyISAM å­˜å‚¨å¼•æ“ä½¿ç”¨è¡¨çº§é”ï¼Œå› æ­¤åœ¨è¯»å†™æ“ä½œæ—¶ä¸ä¼šå‡ºç°æ­»é”é—®é¢˜ï¼Œä¸”åœ¨è¯»æ“ä½œæ—¶ä¸éœ€è¦åŠ é”ï¼Œå› æ­¤è¯»å–é€Ÿåº¦è¾ƒå¿«ï¼Œé€‚åˆäºä»¥è¯»æ“ä½œä¸ºä¸»çš„åº”ç”¨åœºæ™¯ã€‚</li><li>ç´¢å¼•ï¼šMyISAM å­˜å‚¨å¼•æ“æ”¯æŒå…¨æ–‡æœ¬ç´¢å¼•å’Œç©ºé—´ç´¢å¼•ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„æŸ¥è¯¢éœ€æ±‚ã€‚</li><li>ä½å­˜å‚¨ç©ºé—´ï¼šMyISAM å­˜å‚¨å¼•æ“å¯¹æ•°æ®å­˜å‚¨çš„æ–¹å¼éå¸¸ç´§å‡‘ï¼Œæ•°æ®æ–‡ä»¶å¤§å°é€šå¸¸æ¯” InnoDB å­˜å‚¨å¼•æ“å°ï¼Œå› æ­¤å¯¹äºå­˜å‚¨ç©ºé—´æœ‰é™çš„åº”ç”¨åœºæ™¯æ¥è¯´ï¼ŒMyISAM æ›´ä¸ºé€‚åˆã€‚</li></ol><h3 id="å¯¹æ¯”-nosql" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”-nosql"><span>å¯¹æ¯” NoSQL</span></a></h3><ul><li>å…³ç³»å‹æ•°æ®åº“åŸºäºè¡¨çš„ç»“æ„ï¼Œé€‚ç”¨äºå¤„ç†ç»“æ„åŒ–æ•°æ®ï¼›NoSQL é€šå¸¸æ˜¯é”®å€¼å¯¹ã€æ–‡æ¡£ã€å›¾å½¢ç­‰æ•°æ®ç»“æ„ï¼Œé€‚åˆå­˜å‚¨åŠç»“æ„åŒ–/éç»“æ„åŒ–æ•°æ®</li><li>MySQL æ•°æ®è¡¨éœ€è¦ä¸¥è°¨çš„è®¾è®¡ï¼›NoSQL æ•°æ®åº“ä¸éœ€è¦äº‹å…ˆè®¾è®¡å¥½ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ å­—æ®µå’Œä¿®æ”¹ç»“æ„ï¼Œçµæ´»æ€§å’Œæ‰©å±•æ€§æ›´å¥½</li><li>MySQL ä½¿ç”¨ SQL è¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼Œæ”¯æŒå¤æ‚çš„å…³ç³»æŸ¥è¯¢å’Œèšåˆæ“ä½œï¼›NoSQL åˆ™ä½¿ç”¨å„ç§ä¸åŒçš„æŸ¥è¯¢è¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼Œä¸æ”¯æŒå¤æ‚å…³ç³»æŸ¥è¯¢ï¼Œä½†è¯»å–å’Œå†™å…¥æ•ˆç‡æ›´é«˜</li></ul><p>ä½¿ç”¨åœºæ™¯éœ€è¦åŸºäºåº”ç”¨çš„å®é™…éœ€æ±‚ã€æ•°æ®å¤„ç†é‡ã€æ•°æ®ç±»å‹å’Œæ•°æ®è®¿é—®æ¨¡å¼ç­‰è€ƒè™‘ã€‚MySQL é€‚åˆæ•°æ®ç»“æ„å›ºå®šã€éœ€è¦å¤„ç†äº‹åŠ¡ã€å¤„ç†æµ·é‡æ•°æ®ã€é«˜åº¦å…³è”çš„åº”ç”¨ã€‚NoSQL é€‚åˆå¤„ç†éç»“æ„åŒ–æ•°æ®ã€é«˜æ‰©å±•æ€§å’Œé«˜å¹¶å‘ã€å®æ—¶æŸ¥è¯¢ã€æ•°æ®åˆ†æçš„åœºæ™¯ã€‚</p><h3 id="ç´¢å¼•" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•"><span>ç´¢å¼•</span></a></h3><h4 id="ç´¢å¼•ç±»å‹" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•ç±»å‹"><span>ç´¢å¼•ç±»å‹</span></a></h4><ul><li>èšé›†ç´¢å¼•ï¼šæŒ‰è¡¨ä¸­çš„ä¸»é”®å»ºç«‹çš„ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜æ”¾çš„å°±æ˜¯å®é™…çš„è¡Œæ•°æ®ã€‚ï¼ˆä¸»é”®ç´¢å¼•ï¼‰</li><li>éèšé›†ç´¢å¼•ï¼šæŒ‰è¡¨ä¸­çš„éä¸»é”®å»ºç«‹çš„ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œå¦‚æœéœ€è¦å…¶ä»–åˆ—ä¿¡æ¯éœ€è¦è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚ï¼ˆéä¸»é”®/äºŒçº§ç´¢å¼•ï¼‰</li></ul><h4 id="b-æ ‘-å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#b-æ ‘-å¯¹æ¯”"><span>B+æ ‘ å¯¹æ¯”</span></a></h4><ul><li>ä½¿ç”¨å“ˆå¸Œè¡¨å¯ä»¥æŠŠæ£€ç´¢å•ä¸ªæ•°æ®çš„å¤æ‚åº¦è¿‘ä¼¼ä¸ºO(1)ï¼Œä½†æ˜¯å“ˆå¸Œè¡¨ä¸æ”¯æŒæ’åºå’ŒèŒƒå›´æŸ¥æ‰¾ï¼Œå¦‚æœæ˜¯å¸¦æ¡ä»¶çš„æ‰¹é‡æ£€ç´¢æ•°æ®å°±å¾—ä¸€æ¬¡æ¬¡ IO å»æŸ¥æ‰¾</li><li>çº¢é»‘æ ‘åœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œå¯èƒ½å¯¼è‡´æ£€ç´¢é€Ÿåº¦æ…¢çš„é—®é¢˜</li><li>B æ ‘ï¼ˆB- æ ‘ï¼‰ï¼Œä¸€ç§å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œå®ƒçš„æ‰€æœ‰èŠ‚ç‚¹æ—¢æ”¾é”®ï¼Œä¹Ÿæ”¾æ•°æ®ï¼Œæ‰€ä»¥ä¸€ä¸ªæ•°æ®é¡µä¸­å­˜å‚¨çš„é”®å€¼å¯¹æ¯”è¾ƒå°‘ï¼Œå› æ­¤ç©ºé—´åˆ©ç”¨ç‡è¾ƒä½ï¼Œè¿›è€Œå¯¼è‡´ IO æ¬¡æ•°å¢åŠ ï¼Œæ€§èƒ½é™ä½</li><li>è€Œ B+ æ ‘ï¼Œä»…åœ¨å¶å­èŠ‚ç‚¹å­˜æ”¾æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜æ”¾ä¸‹ä¸€å±‚çš„ç´¢å¼•ï¼Œå› æ­¤æŸ¥è¯¢æ•ˆç‡æ¯”è¾ƒç¨³å®šï¼›åœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œæ ‘çš„é«˜åº¦è¾ƒå°ï¼ŒæŸ¥è¯¢æ€§èƒ½å¥½ï¼›åŒæ—¶è¿˜æ”¯æŒæ’åºå’ŒèŒƒå›´æŸ¥æ‰¾ã€‚</li></ul><p>æ³¨ï¼šInnoDB çš„æ•°æ®æ˜¯æŒ‰æ•°æ®é¡µä¸ºå•ä½æ¥è¯»å†™çš„ï¼Œå½“éœ€è¦è¯»ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å°†è¿™ä¸ªè®°å½•æœ¬èº«ä»ç£ç›˜è¯»å‡ºæ¥ï¼Œè€Œæ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå°†å…¶æ•´ä½“è¯»å…¥å†…å­˜ã€‚åœ¨ InnoDB ä¸­ï¼Œæ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯ 16KBã€‚</p><h4 id="ç´¢å¼•å¤±æ•ˆæƒ…å†µ" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•å¤±æ•ˆæƒ…å†µ"><span>ç´¢å¼•å¤±æ•ˆæƒ…å†µ</span></a></h4><ul><li>ä½¿ç”¨ SELECT * è¿›è¡ŒæŸ¥è¯¢;</li><li>åˆ›å»ºäº†è”åˆç´¢å¼•ï¼Œä½†æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™;</li><li>åœ¨ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè®¡ç®—ã€å‡½æ•°ã€(æ˜¾å¼/éšå¼)ç±»å‹è½¬æ¢ç­‰æ“ä½œ(å¯èƒ½ç ´åç´¢å¼•å€¼çš„æœ‰åºæ€§ï¼Œå› æ­¤ä¼˜åŒ–å™¨ç›´æ¥æ”¾å¼ƒä½¿ç”¨ç´¢å¼•);</li><li>ä»¥ % å¼€å¤´çš„ LIKE æŸ¥è¯¢æ¯”å¦‚ like &#39;%abc&#39;;</li><li>æŸ¥è¯¢æ¡ä»¶ä¸­ä½¿ç”¨ orï¼Œä¸” or çš„å‰åæ¡ä»¶ä¸­æœ‰ä¸€ä¸ªåˆ—æ²¡æœ‰ç´¢å¼•ï¼Œæ¶‰åŠçš„ç´¢å¼•éƒ½ä¸ä¼šè¢«ä½¿ç”¨åˆ°;</li></ul><h4 id="ç´¢å¼•ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•ä¼˜åŒ–"><span>ç´¢å¼•ä¼˜åŒ–</span></a></h4><ul><li>åœ¨ç»å¸¸ç”¨äºæŸ¥è¯¢çš„åˆ—ä¸Šå»ºç«‹ç´¢å¼•</li><li>å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆç´¢å¼•è¦†ç›–äº†æŸ¥è¯¢éœ€æ±‚ï¼‰ï¼Œé¿å…å›è¡¨</li><li>é¿å…ç´¢å¼•å¤±æ•ˆ</li><li>ç´¢å¼•ä¹Ÿä¸èƒ½è¿‡å¤šï¼Œé€ æˆå†™å…¥æ€§èƒ½é™ä½ï¼ˆè‡ªå¢çš„ä¸»é”®å¯¹å†™å…¥æ€§èƒ½å½±å“å°ï¼Œè€Œéè‡ªå¢ä¸»é”®å¯èƒ½å¼•èµ·é¡µåˆ†è£‚å¯¼è‡´å†™æ€§èƒ½é™ä½ï¼‰</li><li>å¯¹å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼ˆå¦‚èº«ä»½è¯è¿™æ ·çš„é•¿å­—ç¬¦ä¸²ä¸é€‚åˆåšä¸»é”®ï¼Œç´¢å¼•ç©ºé—´å ç”¨è¿‡å¤šã€‚ä½†è¦åˆç†é€‰æ‹©å‰ç¼€çš„é•¿åº¦ï¼Œå¯ä»¥æ ¹æ®åŒºåˆ†åº¦æ¥é€‰æ‹©ï¼‰</li><li>ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼šåœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ï¼ˆè€Œä¸æ˜¯æ¯æ¡è®°å½•éƒ½å›è¡¨å†åˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼‰</li><li>è€ƒè™‘åŒºåˆ†åº¦ï¼šåŒºåˆ†åº¦æŒ‡çš„æ˜¯ç´¢å¼•åˆ—ä¸­ä¸åŒå€¼çš„ä¸ªæ•°ä¸æ€»è®°å½•æ•°ä¹‹æ¯”ï¼Œç”¨äºè¡¡é‡ç´¢å¼•åˆ—çš„åŒºåˆ†åº¦ã€‚åŒºåˆ†åº¦è¶Šé«˜ï¼Œç´¢å¼•æ•ˆæœè¶Šå¥½ï¼ŒæŸ¥è¯¢é€Ÿåº¦è¶Šå¿«ã€‚</li><li>ä½¿ç”¨ç¼“å­˜ã€åˆ†åº“åˆ†è¡¨ã€ä¼˜åŒ–ç¡¬ä»¶å’Œç³»ç»Ÿ</li></ul><h3 id="äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡"><span>äº‹åŠ¡</span></a></h3><h4 id="å››ä¸ªç‰¹å¾" tabindex="-1"><a class="header-anchor" href="#å››ä¸ªç‰¹å¾"><span>å››ä¸ªç‰¹å¾</span></a></h4><ol><li>åŸå­æ€§ï¼šäº‹åŠ¡ä¸­åŒ…å«çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ</li><li>ä¸€è‡´æ€§ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åï¼Œå³æ»¡è¶³æ‰€æœ‰çš„çº¦æŸæ¡ä»¶å’Œä¸šåŠ¡è§„åˆ™</li><li>éš”ç¦»æ€§ï¼šäº‹åŠ¡é—´äº’ä¸å¹²æ‰°ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸å—å…¶ä»–äº‹åŠ¡çš„å½±å“ï¼Œä¹Ÿä¸å½±å“å…¶ä»–äº‹åŠ¡ã€‚</li><li>æŒä¹…æ€§ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶å¯¹æ•°æ®åº“çš„ä¿®æ”¹å°±ä¼šæ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿å‘ç”Ÿç³»ç»Ÿæ•…éšœæˆ–å´©æºƒä¹Ÿä¸ä¼šä¸¢å¤±</li></ol><h4 id="å¹¶å‘é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘é—®é¢˜"><span>å¹¶å‘é—®é¢˜</span></a></h4><ul><li>è„å†™ï¼šä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®</li><li>è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†å¦ä¸€ä¸ªäº‹åŠ¡è¿˜æœªæäº¤çš„æ•°æ®</li><li>ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åŒä¸€æ¡è®°å½•ï¼ŒæœŸé—´å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´</li><li>å¹»è¯»ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æŸäº›æ¡ä»¶æŸ¥è¯¢ï¼ŒæœŸé—´å¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥äº†æ–°çš„æ•°æ®ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡å†æ¬¡æŸ¥è¯¢æ—¶å‘ç°å¤šå‡ºä¸€äº›è®°å½•</li></ul><h4 id="éš”ç¦»çº§åˆ«" tabindex="-1"><a class="header-anchor" href="#éš”ç¦»çº§åˆ«"><span>éš”ç¦»çº§åˆ«</span></a></h4><ul><li><code>Read_Uncommited</code>: è¯»æœªæäº¤ï¼Œå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å°šæœªæäº¤çš„æ•°æ®ã€‚å¯èƒ½äº§ç”Ÿè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ç­‰é—®é¢˜</li><li><code>Read_Commited</code>: è¯»å·²æäº¤ï¼Œå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»</li><li><code>Repeatable_Read</code>: å¯é‡å¤è¯»ï¼Œå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½ä¸€è‡´ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»é—®é¢˜</li><li><code>Serializable</code>: å¯ä¸²è¡ŒåŒ–ï¼Œæ‰€æœ‰äº‹åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œå¯ä»¥é˜»æ­¢æ‰€æœ‰å¹¶å‘é—®é¢˜ã€‚</li></ul><p>MySQLé»˜è®¤æ˜¯ RRï¼Œå¹¶ä¸”é€šè¿‡ MVVC æœºåˆ¶é˜»æ­¢äº†å¹»è¯»é—®é¢˜ã€‚</p><h3 id="ä¸‰å¤§æ—¥å¿—" tabindex="-1"><a class="header-anchor" href="#ä¸‰å¤§æ—¥å¿—"><span>ä¸‰å¤§æ—¥å¿—</span></a></h3><p>ä¸€ä¸ªäº‹åŠ¡çš„æ—¥å¿—æ“ä½œé¡ºåºï¼šåŠ è½½æ•°æ®é¡µ -&gt; å†™ Undo Log -&gt; å†™ Redo Log -&gt; å†™ Bin Log -&gt; æäº¤ Redo Log</p><h4 id="undo-log" tabindex="-1"><a class="header-anchor" href="#undo-log"><span>Undo Log</span></a></h4><p>æ›´æ–°è¡Œè®°å½•æ—¶ï¼Œé¦–å…ˆå°†æ•°æ®é¡µåŠ è½½åˆ° BufferPoolï¼Œç„¶åå°†æ—§å€¼å†™å…¥ Undo Logï¼Œå­˜å‚¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„æ•°æ®ç‰ˆæœ¬ã€‚ä½œç”¨æœ‰äºŒï¼š</p><ul><li>å½“äº‹åŠ¡å›æ»šæˆ–è€…å‘ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ Undo Log å°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ã€‚</li><li>ç”¨äº MVVCï¼Œè¯»å–è®°å½•æ—¶åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å¯¹å½“å‰äº‹åŠ¡å¯è§ï¼Œä»¥æ­¤å®ç°éé”å®šè¯»</li></ul><p>åˆ†ç±»ï¼š</p><ul><li>insert undo logï¼šinsertæ“ä½œä»…å¯¹æœ¬äº‹åŠ¡å¯è§ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤åå¯ç›´æ¥åˆ é™¤</li><li>update undo logï¼šupdate/deleteæ“ä½œï¼Œéœ€è¦æä¾›MVVCï¼Œå› æ­¤åˆ†ä¸¤é˜¶æ®µ delete_mark -&gt; purge</li></ul><h4 id="redo-log" tabindex="-1"><a class="header-anchor" href="#redo-log"><span>Redo Log</span></a></h4><p>æ‰§è¡Œå™¨æ›´æ–°å®Œ BufferPool é‡Œçš„æ•°æ®é¡µåï¼Œå†™å…¥ Redo Log é‡åšæ—¥å¿—ï¼Œè®°å½•äº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„ä¿®æ”¹ï¼Œä¿è¯åœ¨å‘ç”Ÿæ•°æ®åº“æ•…éšœæ—¶ï¼Œå¯ä»¥é€šè¿‡é‡åšæ—¥å¿—å°†æ•°æ®åº“æ¢å¤åˆ°äº‹åŠ¡æäº¤åçš„çŠ¶æ€ã€‚</p><p><strong>åŸå› ï¼š</strong><br>æ•°æ®åº“æŒ‰é¡µé¢ä»ç£ç›˜è¯»å–æ•°æ®åŠ è½½åˆ° Buffer Pool ä¸­ï¼Œåç»­çš„æ“ä½œéƒ½æ˜¯å¯¹ Buffer Pool è¿›è¡Œï¼Œå› æ­¤éœ€è¦å®šæ—¶æŠŠ Buffer Pool å†™å›ç£ç›˜ï¼Œä½†æ˜¯</p><ul><li>åˆ·æ–°æ•´ä¸ªé¡µé¢è¿‡äºæµªè´¹</li><li>å†™å…¥ç£ç›˜æ˜¯éšæœºIOï¼Œé€Ÿåº¦æ…¢</li></ul><p>å› æ­¤ï¼ŒMySQL åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ©ç”¨ Redo Logï¼Œè®°å½•ä¿®æ”¹çš„å…·ä½“ä¿¡æ¯ï¼Œè¿™æ ·å³ä½¿ç³»ç»Ÿå´©æºƒä¹Ÿèƒ½å¿«é€Ÿæ¢å¤æ•°æ®ï¼Œè€Œä¸”ï¼š</p><ul><li>å ç”¨ç©ºé—´å°</li><li>å†™å…¥æ˜¯é¡ºåºIOï¼Œé€Ÿåº¦å¿«</li></ul><p><strong>åˆ·ç›˜æ—¶æœºï¼š</strong><br>æ¯æ¡ redo è®°å½•ç”±&quot;è¡¨ç©ºé—´å·+æ•°æ®é¡µå·+åç§»é‡+ä¿®æ”¹æ•°æ®é•¿åº¦+å…·ä½“ä¿®æ”¹çš„æ•°æ®&quot;ç»„æˆã€‚innodb_flush_log_at_trx_commitå‚æ•°æ§åˆ¶åˆ·ç›˜ç­–ç•¥ï¼š</p><ul><li>0ï¼šäº‹åŠ¡æäº¤æ—¶ä¸ç«‹å³å‘ç£ç›˜åŒæ­¥redoæ—¥å¿—ï¼Œäº¤ç»™åå°çº¿ç¨‹</li><li>1ï¼šé»˜è®¤å€¼ï¼Œäº‹åŠ¡æäº¤æ—¶ç«‹å³åŒæ­¥ (fsync)</li><li>2ï¼šäº‹åŠ¡æäº¤æ—¶å°†redoæ—¥å¿—å†™å…¥OSç¼“å†²åŒºï¼Œä¸ä¿è¯ç«‹å³åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™ç§æ–¹å¼é™¤éDBå’ŒOSéƒ½æŒ‚äº†ï¼Œå¦åˆ™æ˜¯èƒ½å¤Ÿä¿è¯æŒä¹…æ€§çš„</li></ul><p><strong>æ—¥å¿—æ–‡ä»¶ç»„ï¼š</strong><br>ç¡¬ç›˜ä¸Šçš„Redo Logæ–‡ä»¶æœ‰å¤šä¸ªï¼Œæ„æˆä¸€ä¸ªç¯å½¢æ—¥å¿—æ–‡ä»¶ç»„ï¼Œå¾ªç¯å†™å…¥ã€‚<br>æ—¥å¿—ç»„ç»´æŠ¤ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ª write_pos æ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€ä¸ª checkpoint æ˜¯å·²ç»åˆ·ç›˜çš„ä½ç½®ã€‚</p><h4 id="bin-log" tabindex="-1"><a class="header-anchor" href="#bin-log"><span>Bin Log</span></a></h4><p>æ‰§è¡Œå™¨å†™å®Œ Redo Log åï¼Œå¼€å§‹å†™ Bin Logï¼Œæœ€åå†å†™ Redo Log å®Œæˆä¸¤é˜¶æ®µæäº¤ã€‚binlog æ˜¯ä¸€ç§é€»è¾‘æ—¥å¿—ï¼Œè®°å½•æ•°æ®åº“ä¸­æ‰€æœ‰çš„ä¿®æ”¹æ“ä½œï¼Œç”¨äºæ•°æ®å¤‡ä»½ã€ä¸»ä»å¤åˆ¶ä»¥åŠæ•°æ®æ¢å¤ã€‚</p><p><strong>ä¸‰ç§æ ¼å¼ï¼š</strong></p><ul><li>statementï¼šè®°å½•SQLåŸæ–‡ã€‚å¯èƒ½äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´ï¼Œä¾‹å¦‚æ—¶é—´å‡½æ•°now()</li><li>row: é»˜è®¤ã€‚è®°å½•SQLåŸæ–‡ä»¥åŠæ“ä½œçš„å…·ä½“æ•°æ®ã€‚å ç©ºé—´ï¼Œè€Œä¸”æ¶ˆè€—IOèµ„æº</li><li>mixedï¼šæ··åˆå‰ä¸¤ç§ï¼Œæ ¹æ®æ˜¯å¦å¯èƒ½å¼•èµ·æ•°æ®ä¸ä¸€è‡´é‡‡ç”¨row/statement</li></ul><p><strong>å†™å…¥æ—¶æœºï¼š</strong><br>äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œå…ˆå†™å…¥ <code>binlog cache</code>ï¼Œæäº¤æ—¶å†å†™å…¥ç£ç›˜ä¸Šçš„ <code>binlog</code> æ–‡ä»¶ã€‚<code>sync_binlog</code> å˜é‡æ§åˆ¶åˆ·ç›˜æ—¶æœºï¼š</p><ul><li>0ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡ä»… writeï¼ˆå†™å…¥ç³»ç»Ÿç¼“å­˜ï¼‰ï¼Œç”±OSè´Ÿè´£ fsync (å†™å…¥ç£ç›˜)</li><li>1ï¼šæ¯æ¬¡æäº¤ä»»åŠ¡éƒ½ fsync</li><li>Nï¼šæ¯æ¬¡æäº¤ä»»åŠ¡ä»… writeï¼Œç´¯ç§¯ N ä¸ªäº‹åŠ¡å fsync</li></ul><p><strong>ä¸¤é˜¶æ®µæäº¤ï¼š</strong><br>redo log è®© InnoDB å­˜å‚¨å¼•æ“æ‹¥æœ‰äº†å´©æºƒæ¢å¤èƒ½åŠ›ã€‚binlog ä¿è¯äº† MySQL çš„æ•°æ®æŒä¹…æ€§ã€‚å› æ­¤éœ€è¦ç¡®ä¿ä¸¤ä»½æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œä¸ºæ­¤é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤æœºåˆ¶ï¼š</p><ul><li>å°† redo log æ‹†åˆ†æˆ prepare å’Œ commit ä¸¤é˜¶æ®µï¼Œäº‹åŠ¡å†™å…¥ Redo Log åå°±å¤„äº prepare çŠ¶æ€</li><li>äº‹åŠ¡å†™å…¥ binlog åï¼Œå†å°† redo log è®¾ä¸º commit çŠ¶æ€ï¼Œæœ€åæäº¤äº‹åŠ¡</li><li>äº‹åŠ¡æœŸé—´å¦‚æœå‘ç”Ÿå¼‚å¸¸ <ul><li>æŸ¥è¯¢ redo log å¤„äº commit åˆ™ç›´æ¥æäº¤å°±è¡Œ</li><li>æŸ¥è¯¢ redo log å¤„äº prepareï¼Œä¸” redo log é‡Œé¢çš„ XID å’Œ bin log é‡Œé¢çš„ XID ä¸€è‡´ï¼Œè¯´æ˜ä¸¤ä»½æ—¥å¿—é€»è¾‘ä¸€è‡´ï¼Œå¯ä»¥ç›´æ¥æäº¤</li><li>å¦åˆ™å›æ»šäº‹åŠ¡</li></ul></li></ul><p>å¦‚æœä¸ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼Œæ— è®ºæ˜¯å…ˆå†™ Redo Log å†å†™ Bin Log è¿˜æ˜¯åè¿‡æ¥ï¼Œä¸€æ—¦æœŸé—´å‘ç”Ÿå´©æºƒï¼Œéƒ½ä¼šå¯¼è‡´ç”¨æ—¥å¿—æ¢å¤å‡ºæ¥çš„æ•°æ®å’ŒåŸåº“ä¸ä¸€è‡´ã€‚</p><p><img src="/img/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4.webp#id=AzFfx&amp;originHeight=1131&amp;originWidth=1440&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><h3 id="mvvc-æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#mvvc-æœºåˆ¶"><span>MVVC æœºåˆ¶</span></a></h3><p>MVVC åŸºäº Undo Log å®ç°äº†éé”å®šè¯»ã€‚</p><ul><li>å¿«ç…§è¯»ï¼šä¹Ÿå«éé”å®šè¯»ï¼Œè¯»å–æ“ä½œä¸ä¼šå»ç­‰å¾…è¡Œä¸Šé”çš„é‡Šæ”¾ï¼Œè€Œæ˜¯è¯»å–è¡Œçš„ä¸€ä¸ªå¿«ç…§æ•°æ®ï¼Œæ ¹æ®ç‰ˆæœ¬å·/æ—¶é—´æˆ³åˆ¤æ–­å¯è§æ€§</li><li>å½“å‰è¯»ï¼šä¹Ÿå«é”å®šè¯»ï¼Œé€šè¿‡åŠ é”ï¼Œæ€»æ˜¯è¯»å–æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬</li></ul><p><strong>è¡Œè®°å½•çš„éšè—å­—æ®µ</strong></p><ul><li>row_id: å¯é€‰ï¼Œæ²¡æœ‰ä¸»é”®/Uniqueå­—æ®µçš„è®°å½•ï¼Œå¼•æ“é»˜è®¤ç”Ÿæˆè¯¥éšè—åˆ—ä½œä¸ºä¸»é”®</li><li>transaction_id: æœ€åä¸€æ¬¡æ’å…¥æˆ–æ›´æ–°è¯¥è¡Œçš„äº‹åŠ¡ id</li><li>roll_pointer: å›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¡Œçš„ undo logï¼ˆæ„æˆçš„ç‰ˆæœ¬é“¾ï¼‰</li></ul><p><strong>ReadView</strong></p><table><thead><tr><th>å­—æ®µ</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>m_ids</td><td>ç”Ÿæˆ ReadView æ—¶ç³»ç»Ÿä¸­æ´»è·ƒçš„è¯»å†™äº‹åŠ¡çš„idåˆ—è¡¨</td></tr><tr><td>min_trx_id</td><td>ç”Ÿæˆ ReadView æ—¶ç³»ç»Ÿä¸­æ´»è·ƒçš„è¯»å†™äº‹åŠ¡æœ€å°id</td></tr><tr><td>max_trx_id</td><td>ç”Ÿæˆ ReadView æ—¶ç³»ç»Ÿåº”åˆ†é…ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„idå€¼ï¼ˆæœ€å¤§æ´»è·ƒäº‹åŠ¡id+1ï¼‰</td></tr><tr><td>creator_trx_id</td><td>ç”Ÿæˆè¯¥ ReadView çš„äº‹åŠ¡idï¼ˆä»…å®é™…å¢åˆ æ”¹æ—¶æ‰åˆ†é…ï¼Œåªè¯»äº‹åŠ¡idé»˜è®¤0ï¼‰</td></tr></tbody></table><p><strong>è®¿é—®è§„åˆ™</strong><br>æœ‰äº† ReadView åï¼ŒæŸ¥è¯¢è¿‡ç¨‹ä¼šé¡ºç€ç‰ˆæœ¬é“¾éå†ï¼Œæ ¹æ®ReadViewçš„è®¿é—®è§„åˆ™ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€æ¡å¯è®¿é—®çš„ç‰ˆæœ¬ï¼Œæˆ–ä¸å«è¯¥è®°å½•ã€‚å…¶ä¸­ï¼Œtrx_id ä¸ºè¢«è®¿é—®ç‰ˆæœ¬çš„ transaction_id å±æ€§å€¼ï¼š</p><table><thead><tr><th>æ¡ä»¶</th><th>æ˜¯å¦å¯ä»¥è®¿é—®</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>trx_id == creator_trx_id</td><td>å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬</td><td>æˆç«‹ï¼Œè¯´æ˜æ•°æ®æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±æ›´æ”¹çš„</td></tr><tr><td>trx_id &lt; min_trx_id</td><td>å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬</td><td>æˆç«‹ï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨å½“å‰äº‹åŠ¡ç”Ÿæˆ ReadView å‰å·²ç»æäº¤</td></tr><tr><td>trx_id &gt; max_trx_id</td><td>ä¸å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬</td><td>æˆç«‹ï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨å½“å‰äº‹åŠ¡ç”Ÿæˆ ReadView åæ‰å¼€å¯</td></tr><tr><td>min_trx_id &lt;= trx_id &lt;= max_trx_id</td><td>å¦‚æœtrx_idåœ¨m_idsä¸­ï¼Œä¸å¯ä»¥è®¿é—®ï¼›å¦åˆ™å¯ä»¥è®¿é—®</td><td>m_idså­˜åœ¨trx_idåˆ™è¯´æ˜è¯¥äº‹åŠ¡è¿˜æ˜¯æ´»è·ƒçš„ï¼Œä¸å­˜åœ¨åˆ™è¯´æ˜è¯¥äº‹åŠ¡å·²æäº¤</td></tr></tbody></table><p><strong>ä¸åŒéš”ç¦»çº§åˆ«</strong></p><ul><li>Read_Uncommited: è¯»å–è®°å½•æ—¶ç›´æ¥æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µ</li><li>Read_Commited: äº‹åŠ¡æ¯æ¬¡ SELECT æŸ¥è¯¢å‰éƒ½ä¼šç”Ÿæˆç‹¬ç«‹çš„ ReadViewï¼Œå› æ­¤å¯¼è‡´ä¸å¯é‡å¤è¯»</li><li>Repeatable_Read: äº‹åŠ¡åªåœ¨ç¬¬ä¸€æ¬¡ SELECT æŸ¥è¯¢å‰ç”Ÿæˆä¸€ä¸ª ReadViewï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´å…±äº«è¯¥ ReadViewï¼Œå› æ­¤å¯ä»¥é¿å…ä¸å¯é‡å¤è¯»çš„é—®é¢˜</li><li>Seriablizableï¼šåŠ é”æ¥é¿å…å¹¶å‘è®¿é—®</li></ul><p><strong>RR é˜²æ­¢å¹»è¯»</strong></p><ul><li>å¯¹äº æ™®é€šçš„selectï¼ŒRRä½¿ç”¨ MVVC å¿«ç…§è¯» è§£å†³å¹»è¯»é—®é¢˜</li><li>å¯¹äº select...for update/lock in share mode ç­‰å½“å‰è¯»ï¼ŒInnoDBä½¿ç”¨ä¸´é”®é”å¯¹æŸ¥è¯¢èŒƒå›´åŠ é”ä»¥é˜²æ­¢å¹»è¯»</li></ul><h3 id="é”æœºåˆ¶-1" tabindex="-1"><a class="header-anchor" href="#é”æœºåˆ¶-1"><span>é”æœºåˆ¶</span></a></h3><p>InnoDB æ”¯æŒå¤šç²’åº¦é”ï¼Œç‰¹å®šåœºæ™¯ä¸‹ï¼Œè¡Œçº§é”å¯ä»¥ä¸è¡¨çº§é”å…±å­˜ã€‚</p><h4 id="å…¨å±€é”" tabindex="-1"><a class="header-anchor" href="#å…¨å±€é”"><span>å…¨å±€é”</span></a></h4><p><code>flush tables with read lock</code> å¯¹æ•´ä¸ªåº“åŠ åªè¯»é”ï¼Œå¸¸ç”¨äºå…¨åº“çš„é€»è¾‘å¤‡ä»½ã€‚</p><p><code>mysqldump -single-transaction</code> é€‚ç”¨äºæ”¯æŒäº‹åŠ¡çš„å¼•æ“çš„é€»è¾‘å¤‡ä»½ã€‚</p><h4 id="è¡¨çº§é”" tabindex="-1"><a class="header-anchor" href="#è¡¨çº§é”"><span>è¡¨çº§é”</span></a></h4><p>è¡¨çº§é”å¯¹æ•´å¼ è¡¨ä¸Šé”ï¼Œå®ç°ç®€å•ç²’åº¦ç²—ï¼Œå› æ­¤å¹¶å‘æ€§èƒ½å·®ã€‚</p><p><code>lock tables ... read/write</code></p><p>æ„å‘é”ï¼šä¸€ç§ä¸ä¸è¡Œçº§é”å†²çªçš„è¡¨çº§é”ï¼Œç”±å¼•æ“ç»´æŠ¤ï¼Œæ— æ³•æ‰‹åŠ¨æ“ä½œçš„ã€‚åˆ†ï¼š</p><ul><li>æ„å‘å…±äº«é” Sï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ å…±äº«é”</li><li>æ„å‘æ’ä»–é” Xï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ æ’ä»–é”</li></ul><p>æ„å‘é”ä¸ä¼šä¸è¡Œçº§çš„å…±äº« / æ’ä»–é”äº’æ–¥ã€‚ä¸€ä¸ªäº‹åŠ¡æƒ³è¦å¯¹ä¸€ä¸ªæ•°æ®è¡ŒåŠ é”æ—¶ï¼Œä¼šå…ˆè·å–è¯¥æ•°æ®è¡Œæ‰€åœ¨è¡¨çš„æ„å‘é”ã€‚è¿™æ ·å…¶å®ƒäº‹åŠ¡å¯¹è¡¨åŠ æ’ä»–é”æ—¶å¯ä»¥ç›´æ¥æ£€æµ‹è¡¨çš„æ„å‘é”ï¼Œè€Œä¸ç”¨æ£€æµ‹æ¯ä¸€è¡Œæ˜¯å¦æœ‰æ’ä»–é”ã€‚</p><h4 id="è¡Œçº§é”" tabindex="-1"><a class="header-anchor" href="#è¡Œçº§é”"><span>è¡Œçº§é”</span></a></h4><p>è¡Œçº§é”å¯¹ä¸€ä¸ªè¡Œè®°å½•ä¸Šé”ï¼Œç²’åº¦ç»†ï¼Œå¹¶å‘æ€§èƒ½å¥½ã€‚</p><p>ç»†åˆ†çš„è¯ï¼Œè¡Œçº§é”åˆ†ä¸‰ç§ï¼š</p><ul><li>è®°å½•é”ï¼Œé”å®šå•ä¸ªè¡Œè®°å½•</li><li>é—´éš™é”ï¼Œå¯¹ç´¢å¼•è®°å½•çš„é—´éš™ä¸Šé”ï¼Œç¡®ä¿ç´¢å¼•è®°å½•é—´éš™ä¸å˜ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™æ’å…¥æ–°è®°å½•</li><li>ä¸´é”®é”ï¼Œæ˜¯è®°å½•é”å’Œé—´éš™é”çš„ç»„åˆï¼ŒåŒæ—¶é”ä½è¡Œè®°å½•å’Œè®°å½•å‰é¢çš„é—´éš™</li></ul><p>åŠ è¡Œé”æ—¶ï¼Œå®è¡Œä¸¤é˜¶æ®µåè®®ï¼šéœ€è¦æ—¶ä¸Šé”ï¼Œäº‹åŠ¡ç»“æŸ commit æ—¶æ‰é‡Šæ”¾ã€‚å› æ­¤ï¼Œä¸€èˆ¬è¦æŠŠå®¹æ˜“äº§ç”Ÿé”å†²çªã€å½±å“å¹¶å‘åº¦çš„åŠ é”è¯­å¥æ”¾åœ¨åé¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBåœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨ä¸´é”®é”æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œé¿å…å¹»è¯»é—®é¢˜ï¼Œä¸åŒéš”ç¦»çº§åˆ«ä½¿ç”¨çš„é”ä¸ä¸€æ ·ã€‚</p><h4 id="åŠ é”è¯­å¥" tabindex="-1"><a class="header-anchor" href="#åŠ é”è¯­å¥"><span>åŠ é”è¯­å¥</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- å¿«ç…§è¯»ï¼Œä¸åŠ é”</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- å¯¹æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è¡ŒåŠ ä¸Šè¡Œçº§å†™é”</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ... </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- åŠ å…±äº«è¯»é”</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ... LOCK </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">IN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SHARE MODE</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ... </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> share</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- åŠ è¡¨é”</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">LOCK TABLES</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">UNLOCK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> TABLES</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¸»ä»åŒæ­¥" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»åŒæ­¥"><span>ä¸»ä»åŒæ­¥</span></a></h3><p>ä¸»ä»åŒæ­¥æŒ‡å¤šä¸ªä»æœåŠ¡å™¨å®æ—¶å°†ä¸»æœåŠ¡å™¨ä¸Šçš„æ•°æ®åŒæ­¥åˆ°ä»æœåŠ¡å™¨ä¸Šï¼Œä»¥å®ç°æ•°æ®å¤‡ä»½ã€è´Ÿè½½å‡è¡¡ã€å®¹ç¾ç­‰åŠŸèƒ½ã€‚</p><ol><li>ä¸»æœåŠ¡å™¨å°†æ›´æ”¹è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ä¸­ï¼Œè®°å½•æ‰€æœ‰æ›´æ”¹æ•°æ®çš„æ—¥å¿—ã€‚</li><li>ä»æœåŠ¡å™¨é€šè¿‡ change master è®¾ç½®ä¸»åº“çš„ IPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ã€æ—¥å¿—æ–‡ä»¶ä½ç½®ç­‰</li><li>ä»æœåŠ¡å™¨æ‰§è¡Œ start slave å‘½ä»¤ï¼Œå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ª I/O çº¿ç¨‹ï¼Œä¸€ä¸ª SQL çº¿ç¨‹ <ul><li>IO çº¿ç¨‹è¯·æ±‚ä¸»åº“çš„ binlogï¼Œå†™å…¥è‡ªå·±çš„ Relay Log ä¸­ç»§æ—¥å¿—ä¸­ã€‚è€Œä¸»åº“ä¼šç”Ÿæˆ Log Dump çº¿ç¨‹è´Ÿè´£ç»™ä»åº“ IO çº¿ç¨‹ä¼ è¾“ BinLog</li><li>SQL çº¿ç¨‹è¯»å– Relay Logï¼Œå¹¶è§£ææˆå…·ä½“çš„æ“ä½œï¼Œå®ç°ä¸»ä»æ“ä½œçš„ä¸€è‡´æ€§ï¼Œæœ€ç»ˆæ•°æ®ä¿æŒä¸€è‡´</li></ul></li><li><code>show master status;</code> æŸ¥çœ‹ Master çŠ¶æ€</li><li><code>show slave status</code> æŸ¥çœ‹ Slave çŠ¶æ€</li></ol><p><img src="/img/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.webp#id=PE5BI&amp;originHeight=856&amp;originWidth=1142&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>ä¸»ä»å¤åˆ¶åŸç†</strong></p><ol><li>ä¸»åº“å°†æ•°æ®åº“ä¸­æ•°æ®çš„å˜åŒ–å†™å…¥åˆ° binlog</li><li>ä»åº“è¿æ¥ä¸»åº“</li><li>ä»åº“åˆ›å»ºä¸€ä¸ª I/O çº¿ç¨‹å‘ä¸»åº“è¯·æ±‚æ›´æ–°çš„ binlog</li><li>ä¸»åº“åˆ›å»ºä¸€ä¸ª binlog dump çº¿ç¨‹æ¥å‘é€ binlog ï¼Œä»åº“ä¸­çš„ I/O çº¿ç¨‹è´Ÿè´£æ¥æ”¶</li><li>ä»åº“çš„ I/O çº¿ç¨‹å°†æ¥æ”¶çš„ binlog å†™å…¥åˆ° relay log ä¸­</li><li>ä»åº“çš„ SQL çº¿ç¨‹è¯»å– relay log åŒæ­¥æ•°æ®æœ¬åœ°ï¼ˆä¹Ÿå°±æ˜¯å†æ‰§è¡Œä¸€é SQL ï¼‰ã€‚</li></ol><p>ä½†æ˜¯ç”±äºä¸»ä»åŒæ­¥å»¶è¿Ÿï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆï¼š</p><ol><li>å¼ºåˆ¶å°†è¯»è¯·æ±‚è·¯ç”±åˆ°ä¸»åº“å¤„ç†ï¼šä¾‹å¦‚ Sharding-JDBCï¼Œå®ç°ç®€å•ä½†ä¼šå¢åŠ ä¸»åº“å‹åŠ›</li><li>å»¶è¿Ÿè¯»å–</li></ol><p><strong>è¯»å†™åˆ†ç¦»</strong></p><p>è¯»å†™åˆ†ç¦»ä¸»è¦æ˜¯ä¸ºäº†å°†å¯¹æ•°æ®åº“çš„è¯»å†™æ“ä½œåˆ†æ•£åˆ°ä¸åŒçš„æ•°æ®åº“èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥å°å¹…æå‡å†™æ€§èƒ½ï¼Œå¤§å¹…æå‡è¯»æ€§èƒ½ã€‚</p><p>é€šè¿‡å¤šå°æ•°æ®åº“æœåŠ¡å™¨ï¼Œé…ç½®ä¸»ä»å¤åˆ¶ï¼Œç„¶åå†™è¯·æ±‚å‘ç»™ Masterï¼Œè¯»è¯·æ±‚å‘ç»™ Slavesã€‚å…·ä½“å®ç°æ–¹æ³•ï¼š</p><ol><li>ä»£ç†æ–¹å¼ï¼šä¾‹å¦‚ MyCatï¼ŒMySQL Routerç­‰</li><li>ç»„ä»¶æ–¹å¼ï¼šSharding-JDBC</li></ol><h3 id="åˆ†åº“åˆ†è¡¨" tabindex="-1"><a class="header-anchor" href="#åˆ†åº“åˆ†è¡¨"><span>åˆ†åº“åˆ†è¡¨</span></a></h3><p>è§ï¼š<a class="route-link" href="/coding/MySQL01.html">MySQL01</a></p><h3 id="sql-è¯­å¥" tabindex="-1"><a class="header-anchor" href="#sql-è¯­å¥"><span>SQL è¯­å¥</span></a></h3><h4 id="æ‰§è¡Œè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œè¿‡ç¨‹"><span>æ‰§è¡Œè¿‡ç¨‹</span></a></h4><ol><li>è¯­æ³•è§£æï¼šæ•°æ®åº“ä¼šé¦–å…ˆå¯¹ SQL è¯­å¥è¿›è¡Œè¯­æ³•è§£æï¼Œç¡®å®šæŸ¥è¯¢çš„è¯­ä¹‰å’Œæ‰§è¡Œçš„æ“ä½œï¼Œå¦‚æœè¯­æ³•ä¸æ­£ç¡®ï¼Œä¼šç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li><li>æŸ¥è¯¢ä¼˜åŒ–ï¼šæ•°æ®åº“ä¼šå¯¹ SQL è¯­å¥è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ŒåŒ…æ‹¬è¡¨é€‰æ‹©ã€è¿æ¥æ–¹å¼ã€ç´¢å¼•ä½¿ç”¨ç­‰ç­‰ï¼Œä»¥æ‰¾åˆ°æœ€ä¼˜çš„æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ã€‚</li><li>ç¼–è¯‘æ‰§è¡Œè®¡åˆ’ï¼šä¼˜åŒ–å™¨æ‰¾åˆ°æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’åï¼Œä¼šå°†è¯¥æ‰§è¡Œè®¡åˆ’ç¼–è¯‘æˆå¯æ‰§è¡Œçš„æœºå™¨ç ã€‚</li><li>æ‰§è¡ŒæŸ¥è¯¢ï¼šæ•°æ®åº“å¼•æ“å¼€å§‹æ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç ï¼ŒæŒ‰ç…§æ‰§è¡Œè®¡åˆ’ä»å­˜å‚¨å¼•æ“ä¸­è·å–æ•°æ®ï¼Œå¹¶è¿›è¡Œç­›é€‰ã€æ’åºã€èšåˆç­‰æ“ä½œï¼Œæœ€ç»ˆç”Ÿæˆç»“æœé›†ã€‚</li><li>è¿”å›ç»“æœï¼šæ‰§è¡Œå®Œæ¯•åï¼Œæ•°æ®åº“å°†ç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚</li></ol><p>ä¼˜åŒ–ï¼šåˆ›å»ºç´¢å¼•ã€æ•°æ®åˆ†åŒºã€é¿å…å…¨è¡¨æ‰«æã€åˆç†ä½¿ç”¨ç¼“å­˜</p><h4 id="è¯­æ³•è¯­å¥" tabindex="-1"><a class="header-anchor" href="#è¯­æ³•è¯­å¥"><span>è¯­æ³•è¯­å¥</span></a></h4><p>æ‰§è¡Œé¡ºåºï¼šfrom -&gt; where -&gt; group by -&gt; having -&gt; select -&gt; order by -&gt; limit (MySQL ä¸­ group by / having å¯ä»¥ä½¿ç”¨ select æŒ‡å®šçš„åˆ«å)</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sql"><span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- è¡¨æ¸…ç©ºï¼Œå¹¶é‡ç½®è‡ªå¢è®¡æ•°å™¨.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">truncate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ta_name;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- ä»…é‡ç½®è‡ªå¢è®¡æ•°å™¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ALTER</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_name auto_increment</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- count(*) ä¼šç»Ÿè®¡æ‰€æœ‰é null ä¸ªæ•°ï¼ŒåŒ…æ‹¬ 0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- sum(if(exp, 1, 0)) å¯ä»¥æ’é™¤ 0 å€¼æ±‚å’Œ</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- case æ¡ä»¶è¯­å¥ </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  CASE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          when</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> age </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 25</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;25å²ä»¥ä¸‹&#39;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          when</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> age </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 25</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;25å²åŠä»¥ä¸Š&#39;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        END</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> as</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> age_cnt, </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(*) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">number</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- if æ¡ä»¶è¯­å¥</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) ...</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- æ—¥æœŸæ ¼å¼åŒ–</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> date_format</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;%Y-%m&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> year</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)/</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">month</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- æ—¥æœŸå¢åŠ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> DATE_ADD(orderDate, INTERVAL </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> DAY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- æ—¥æœŸå·®ï¼Œä»¥ MINUTE/SECOND/HOUR ç­‰è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> TIMESTAMPDIFF(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">MINUTE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, start_time, end_time) ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- å–åé¢ä¸€è¡Œçš„ timestamp åˆ—</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> lead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">timestamp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">over</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  -- æŒ‰ trace_id æ°´å¹³åˆ†ç‰‡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  parition </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">by</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> trace_id</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  order by</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> timestamp</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> toTime </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- æˆªå–å­ä¸², start ä» 1 å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> substr(str, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, len) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- å°†å­—ç¬¦ä¸² str æŒ‰ , åˆ†å‰²ï¼Œé€‰å–ç¬¬nä¸ªå‰çš„å­—ç¬¦</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> substring_index(str, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;,&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- åˆ é™¤ str ä¸­ å‰å/å‰å¯¼/å°¾éš çš„ &quot;xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> trim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">( {</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">BOTH</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">LEADING</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TRAILING</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;xxx&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> str) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> concat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s1, s2, ...) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> xxx;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> upper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s)/</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">lower</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> xxx;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- ç»„å†…æ‹¼æ¥å­—ç¬¦ä¸²</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> group_concat(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">distinct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> concat_ws(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;:&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(start_time), tag) SEPARATOR </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> detail</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- çª—å£å‡½æ•°ï¼Œç”¨äºå¯¹æ•°æ®å®æ—¶åˆ†æå¤„ç†ï¼Œå³æœ¬è¡Œä»¥åŠä¹‹å‰çš„è¡Œè¿›è¡Œè®¡ç®—</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- å¦‚ rank(), dense_rank(), row_number() ä»¥åŠ èšåˆå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- group by åˆ†ç»„åæ¯ä¸ªç±»åˆ«èšåˆæˆä¸€è¡Œï¼Œè€Œçª—å£å‡½æ•°ä¸ä¼šå‡å°‘è¡Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">çª—å£å‡½æ•°</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> over</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">partition</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> by</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">åˆ†ç»„åˆ—</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> order by</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">æ’åºåˆ—</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> [UNIQUE | FULLTEXT]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> INDEX</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> index_name </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_name(col1, col2);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ALTER</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">è¡¨å</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ADD</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> [UNIQUE | FULLTEXT]</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> [INDEX]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> index_content(content);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">DROP</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> INDEX</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ç´¢å¼•å</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ON</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">è¡¨å</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ALTER</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">è¡¨å</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> DROP</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> INDEX</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ç´¢å¼•å</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- é‡æ–°ç»Ÿè®¡ç´¢å¼•ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">analyze </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">table</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- é‡å»ºè¡¨ï¼Œä½¿å¾—ç´¢å¼•ç´§å‡‘ï¼ŒèŠ‚çº¦å­˜å‚¨ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">alter</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> table</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t engine </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> InnoDB;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">optimize </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">table</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼• a</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">force</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(a) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="count-æ•ˆç‡" tabindex="-1"><a class="header-anchor" href="#count-æ•ˆç‡"><span>count æ•ˆç‡</span></a></h3><p><code>count(å­—æ®µ) &lt; count(ä¸»é”®id) &lt; count(1) â‰ˆ count(*)</code></p><p>InnoDB è®¡æ•°æ—¶éœ€è¦å…ˆè·å–æ‰€éœ€å­—æ®µï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å¯èƒ½ä¸ºç©ºï¼Œå¦‚æœä¸å¯èƒ½ä¸ºç©ºè®¡æ•°å™¨ç›´æ¥+1ï¼Œå¦åˆ™è¿˜è¦å–å‡ºå­—æ®µåˆ¤æ–­æ˜¯å¦ä¸ºç©ºå†ä¿®æ”¹è®¡æ•°å™¨ï¼Œå½±å“æ€§èƒ½ã€‚å› æ­¤åº”å°½é‡ä½¿ç”¨ count(*)ã€‚</p><h2 id="redis" tabindex="-1"><a class="header-anchor" href="#redis"><span>Redis</span></a></h2><h3 id="æ•°æ®ç»“æ„-1" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„-1"><span>æ•°æ®ç»“æ„</span></a></h3><ul><li>5 ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼š <ul><li>String å­—ç¬¦ä¸²ï¼šåŸºäº SDS ç®€å•åŠ¨æ€å­—ç¬¦ä¸²çš„ç»“æ„ï¼Œè®°å½•äº†å½“å‰é•¿åº¦ï¼Œä¿®æ”¹æ—¶å¯ä»¥æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦åŠ¨æ€æ‰©å±•</li><li>List åˆ—è¡¨ï¼šåŸºäºåŒå‘é“¾è¡¨çš„å®ç°</li><li>Hash æ•£åˆ—ï¼šåŸºäºå‹ç¼©åˆ—è¡¨æˆ–å“ˆå¸Œå­—å…¸ï¼Œæ˜¯ä¸€ä¸ª String ç±»å‹é”®å€¼å¯¹çš„æ˜ å°„è¡¨</li><li>Set é›†åˆï¼šåŸºäºå‹ç¼©åˆ—è¡¨æˆ–æ•´æ•°é›†åˆå®ç°çš„æ— åºé›†åˆï¼Œå…¶ä¸­çš„çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½å”¯ä¸€ï¼Œåº•å±‚ç”¨å“ˆå¸Œè¡¨å®ç°</li><li>Zset æœ‰åºé›†åˆï¼šåŸºäºå‹ç¼©åˆ—è¡¨æˆ–è·³è¡¨ï¼Œç›¸æ¯”äº Setï¼ŒZset å¢åŠ äº†ä¸€ä¸ªåˆ†æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­å…ƒç´ å¯ä»¥æŒ‰åˆ†å€¼è¿›è¡Œæœ‰åºæ’åˆ—</li></ul></li><li>3 ç§ç‰¹æ®Šæ•°æ®ç»“æ„ï¼š <ul><li>HyperLogLogs åŸºæ•°ç»Ÿè®¡</li><li>Bitmap ä½å­˜å‚¨ï¼šè¿ç»­çš„äºŒè¿›åˆ¶ä½ï¼Œæ¯ä¸ªbitè¡¨ç¤ºæŸä¸ªå…ƒç´ çš„å¯¹åº”å€¼æˆ–çŠ¶æ€</li><li>Geospatial åœ°ç†ä½ç½®</li></ul></li></ul><h3 id="é€Ÿåº¦å¿«çš„åŸå› " tabindex="-1"><a class="header-anchor" href="#é€Ÿåº¦å¿«çš„åŸå› "><span>é€Ÿåº¦å¿«çš„åŸå› </span></a></h3><ol><li>å†…å­˜å­˜å‚¨ï¼šIn-Memory å­˜å‚¨ï¼Œæ²¡æœ‰ç£ç›˜ IO å¼€é”€</li><li>å•çº¿ç¨‹æ¨¡å‹ï¼šä½¿ç”¨å•ä¸ªçº¿ç¨‹å¤„ç†è¯·æ±‚ï¼Œé¿å…äº†å¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢å’Œé”èµ„æºçš„å¼€é”€</li><li>éé˜»å¡IOï¼šRedis ä½¿ç”¨åŸºäº epoll å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œæé«˜äº†ç½‘ç»œ IO çš„æ€§èƒ½</li><li>ä¼˜åŒ–çš„æ•°æ®ç»“æ„</li><li>åº•å±‚æ¨¡å‹ï¼šRedis è‡ªå·±æ„å»ºäº† VM è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼ˆå†·çƒ­æ•°æ®åˆ†ç¦»ï¼‰</li></ol><p>å¦å¤–ï¼ŒRedis çš„äº‹åŠ¡æ¨¡å‹ä¸»è¦å…³æ³¨åŸå­æ€§å’Œéš”ç¦»æ€§ï¼Œè€Œä¸æä¾›ä¼ ç»Ÿæ•°æ®åº“çš„ä¸€è‡´æ€§ï¼ˆåœ¨ä¸€ä¸ª MULTI/EXEC äº‹åŠ¡å—ä¸­å‘ç”Ÿé”™è¯¯å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´ï¼‰å’ŒæŒä¹…æ€§ï¼ˆä¾èµ–æŒä¹…åŒ–æœºåˆ¶ï¼‰ã€‚</p><h3 id="çº¿ç¨‹æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ¨¡å‹"><span>çº¿ç¨‹æ¨¡å‹</span></a></h3><p>Redis æœåŠ¡å™¨æ˜¯åŸºäº Reactor æ¨¡å¼çš„å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨ç¨‹åºï¼Œå¤„ç†æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ã€‚</p><ul><li>æ—¶é—´äº‹ä»¶ï¼šå®šæ—¶/å‘¨æœŸæ€§æ“ä½œï¼Œç›®å‰æ˜¯åªæœ‰serverCronä¸€ä¸ªæ—¶é—´å‡½æ•°</li><li>æ–‡ä»¶äº‹ä»¶ï¼šRedis é€šè¿‡ IO å¤šè·¯å¤ç”¨ç¨‹åº æ¥ç›‘å¬å¤šä¸ªsocketï¼Œæ¯å½“ä¸€ä¸ªsocketå‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ã€å†™å…¥ã€è¯»å–ã€å…³é—­ç­‰æ“ä½œæ—¶ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–‡ä»¶äº‹ä»¶ã€‚ç„¶åæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šæ¥æ”¶I/Oå¤šè·¯å¤ç”¨ç¨‹åºä¼ æ¥çš„å¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—äº§ç”Ÿçš„äº‹ä»¶çš„ç±»å‹è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼Œä¹Ÿå°±æ˜¯ä¸ä¸åŒä»»åŠ¡çš„å¥—æ¥å­—å…³è”çš„ä¸€ä¸ªä¸ªå‡½æ•°ã€‚</li></ul><p>Redis 6 å¼•å…¥äº†å¤šçº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯ä»…ç”¨äºç½‘ç»œæ•°æ®çš„è¯»å†™è¿™ç±»è€—æ—¶æ“ä½œä¸Šï¼Œæ¥æé«˜ç½‘ç»œIOçš„è¯»å†™æ€§èƒ½ï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚</p><h3 id="è¿‡æœŸåˆ é™¤ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#è¿‡æœŸåˆ é™¤ç­–ç•¥"><span>è¿‡æœŸåˆ é™¤ç­–ç•¥</span></a></h3><ul><li>æƒ°æ€§åˆ é™¤ ï¼šåªä¼šåœ¨å–å‡º key çš„æ—¶å€™æ‰å¯¹æ•°æ®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ã€‚è¿™æ ·å¯¹ CPU æœ€å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå¤ªå¤šè¿‡æœŸ key æ²¡æœ‰è¢«åˆ é™¤ã€‚</li><li>å®šæœŸåˆ é™¤ ï¼š æ¯éš”ä¸€æ®µæ—¶é—´æŠ½å–ä¸€æ‰¹ key æ‰§è¡Œåˆ é™¤è¿‡æœŸ key æ“ä½œã€‚å¹¶ä¸”ï¼ŒRedis åº•å±‚ä¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ã€‚</li></ul><p>å®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´åŠ å‹å¥½ï¼Œæƒ°æ€§åˆ é™¤å¯¹ CPU æ›´åŠ å‹å¥½ã€‚ä¸¤è€…å„æœ‰åƒç§‹ï¼Œæ‰€ä»¥ Redis é‡‡ç”¨çš„æ˜¯ å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤ ç»“åˆçš„æ–¹å¼ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…åˆ†å¤šæ¬¡éå†æœåŠ¡å™¨ä¸­çš„å„ä¸ªæ•°æ®åº“ï¼Œä»expireså­—å…¸ä¸­éšæœºæ£€æŸ¥ä¸€éƒ¨åˆ†é”®çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶åˆ é™¤è¿‡æœŸé”®ã€‚</p><h3 id="ç¼“å­˜æ·˜æ±°æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜æ·˜æ±°æœºåˆ¶"><span>ç¼“å­˜æ·˜æ±°æœºåˆ¶</span></a></h3><ol><li>volatile-lruï¼ˆleast recently usedï¼‰ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</li><li>volatile-ttlï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</li><li>volatile-randomï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</li><li>allkeys-lruï¼ˆleast recently usedï¼‰ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼‰</li><li>allkeys-randomï¼šä»æ•°æ®é›†ï¼ˆserver.db[i].dictï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</li><li>no-evictionï¼šç¦æ­¢é©±é€æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚è¿™ä¸ªåº”è¯¥æ²¡äººä½¿ç”¨å§ï¼</li></ol><p>4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§ï¼š</p><ul><li>volatile-lfuï¼ˆleast frequently usedï¼‰ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</li><li>allkeys-lfuï¼ˆleast frequently usedï¼‰ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ key</li></ul><h3 id="æŒä¹…åŒ–æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#æŒä¹…åŒ–æœºåˆ¶"><span>æŒä¹…åŒ–æœºåˆ¶</span></a></h3><h4 id="rdb-å¿«ç…§" tabindex="-1"><a class="header-anchor" href="#rdb-å¿«ç…§"><span>RDB - å¿«ç…§</span></a></h4><p>å°†æŸä¸€æ—¶åˆ»çš„å†…å­˜æ•°æ®ï¼Œä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å†™å…¥ç£ç›˜ã€‚å¯ä»¥å°†å¿«ç…§å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ï¼Œä¹Ÿå¯ä»¥å°†å¿«ç…§ç•™åœ¨åŸåœ°ä»¥ä¾¿é‡å¯æœåŠ¡å™¨çš„æ—¶å€™ä½¿ç”¨ã€‚</p><p>ä¸¤ç§å‘½ä»¤ï¼š</p><ul><li>save å‘½ä»¤ï¼šä¸»çº¿ç¨‹æ‰§è¡Œï¼Œä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼›</li><li>bgsave : å­çº¿ç¨‹æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œé»˜è®¤é€‰é¡¹ã€‚</li></ul><p>RDB é»˜è®¤çš„ä¿å­˜æ–‡ä»¶ä¸º dump.rdbï¼Œä¼˜ç‚¹æ˜¯ä»¥äºŒè¿›åˆ¶å­˜å‚¨çš„ï¼Œå› æ­¤å ç”¨çš„ç©ºé—´æ›´å°ã€æ•°æ®å­˜å‚¨æ›´ç´§å‡‘ï¼Œä¸ AOF ç›¸æ¯”ï¼ŒRDB å…·å¤‡æ›´å¿«çš„é‡å¯æ¢å¤èƒ½åŠ›ã€‚ä½†æ˜¯æœ‰æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</p><h4 id="aof-ä»…è¿½åŠ æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#aof-ä»…è¿½åŠ æ–‡ä»¶"><span>AOF - ä»…è¿½åŠ æ–‡ä»¶</span></a></h4><p>æŒ‡å°†æ‰€æœ‰çš„æ“ä½œå‘½ä»¤ï¼Œä»¥æ–‡æœ¬çš„å½¢å¼è¿½åŠ åˆ°æ–‡ä»¶ä¸­ã€‚appendfsync å†³å®šä½•æ—¶å†™å…¥ç£ç›˜ï¼Œappendfsync é€‰é¡¹å€¼ï¼š</p><ul><li>alwaysï¼šæ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶ã€‚æ•ˆç‡æœ€æ…¢ï¼Œå®‰å…¨æ€§æœ€é«˜</li><li>everysecï¼šé»˜è®¤ï¼Œæ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œæ˜¾å¼åœ°å°†å¤šä¸ªå†™å‘½ä»¤åŒæ­¥åˆ°ç¡¬ç›˜ã€‚æ•ˆç‡é€‚ä¸­</li><li>noï¼šç”± OS å†³å®šä½•æ—¶è¿›è¡ŒåŒæ­¥ã€‚æ•ˆç‡æœ€é«˜å®‰å…¨æ€§æœ€å·®</li></ul><p>AOFé‡å†™ï¼š<br>ä¸ºäº†é¿å…å¤§é‡å†™å‘½ä»¤é€ æˆAOFæ–‡ä»¶ä½“ç§¯è¿‡å¤§ï¼Œä»¥åŠè¿˜åŸæ—¶é—´è¿‡é•¿ï¼Œéœ€è¦ç”¨ BGREWRITEAOF å‘½ä»¤ï¼Œé€šè¿‡è¯»å–æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹ï¼Œå¯¹AOFæ–‡ä»¶é‡å†™ã€‚åœ¨æ‰§è¡Œ BGREWRITEAOF å‘½ä»¤æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–° AOF æ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°çš„ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ AOF æ–‡ä»¶é‡å†™æ“ä½œã€‚</p><p>ä¼˜ç‚¹æ˜¯å­˜å‚¨é¢‘ç‡æ›´é«˜ï¼Œå› æ­¤ä¸¢å¤±æ•°æ®çš„é£é™©å°±è¶Šä½ï¼Œå¹¶ä¸” AOF å¹¶ä¸æ˜¯ä»¥äºŒè¿›åˆ¶å­˜å‚¨çš„ï¼Œæ‰€ä»¥å®ƒçš„å­˜å‚¨ä¿¡æ¯æ›´æ˜“æ‡‚ã€‚ç¼ºç‚¹æ˜¯å ç”¨ç©ºé—´å¤§ï¼Œé‡å¯ä¹‹åçš„æ•°æ®æ¢å¤é€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚</p><h3 id="ç¼“å­˜ä¸‰å¤§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ä¸‰å¤§é—®é¢˜"><span>ç¼“å­˜ä¸‰å¤§é—®é¢˜</span></a></h3><h4 id="ç¼“å­˜ç©¿é€" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ç©¿é€"><span>ç¼“å­˜ç©¿é€</span></a></h4><p>å¤§é‡è¯·æ±‚çš„ key ä¸åˆç†ï¼Œæ—¢ä¸å­˜åœ¨äºç¼“å­˜ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“ ã€‚å¯¼è‡´è¿™äº›è¯·æ±‚ç›´æ¥åˆ°è¾¾æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ ¹æœ¬ä¸ç»è¿‡ç¼“å­˜è¿™ä¸€å±‚ï¼Œä»è€Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚</p><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><ul><li>æ¥å£å±‚è¿›è¡Œæ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒï¼Œid åšåŸºç¡€æ ¡éªŒï¼Œid ä¸åˆæ³•çš„ç›´æ¥æ‹¦æˆª</li><li>ç¼“å­˜ä¸­è®¾ç½®æ— æ•ˆçš„ keyï¼Œä¾‹å¦‚ <code>set &lt;key&gt; nullObject</code></li><li>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆå¤šä¸ª hash å‡½æ•°ï¼Œkey å¯¹åº”çš„ hashCode éƒ½å­˜åœ¨ï¼Œè¯¥å…ƒç´ æ‰å¯èƒ½å­˜åœ¨ï¼‰</li></ul><h4 id="ç¼“å­˜å‡»ç©¿" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜å‡»ç©¿"><span>ç¼“å­˜å‡»ç©¿</span></a></h4><p>è¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯çƒ­ç‚¹æ•°æ® ï¼Œè¯¥æ•°æ®å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†å¯èƒ½ç”±äºç¼“å­˜è¿‡æœŸï¼Œä¸å­˜åœ¨äºç¼“å­˜ä¸­ã€‚è¿›è€Œå¯¼è‡´ç¬æ—¶å¤§é‡çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚</p><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><ul><li>é’ˆå¯¹çƒ­ç‚¹æ•°æ®æå‰é¢„çƒ­ï¼Œè®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ</li><li>é€šè¿‡åˆ†å¸ƒå¼é”ï¼Œä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªè¯·æ±‚ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œå¹¶å°†æ•°æ®å­˜å…¥ç¼“å­˜ã€‚åç»­çš„è¯·æ±‚å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›</li><li>æ¥å£é™æµã€ç†”æ–­ã€é™çº§</li></ul><h4 id="ç¼“å­˜é›ªå´©" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é›ªå´©"><span>ç¼“å­˜é›ªå´©</span></a></h4><p>ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œæˆ–ç¼“å­˜æœåŠ¡å™¨å®•æœºï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚</p><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><ul><li>æ­å»ºé«˜å¯ç”¨çš„ Redis é›†ç¾¤ï¼Œé¿å…å•ç‚¹æ•…éšœï¼ˆä¸»ä»ã€å“¨å…µã€é›†ç¾¤ï¼‰</li><li>è®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡ key å¤±æ•ˆã€‚ä¾‹å¦‚éšæœºè®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li></ul><h3 id="åˆ†å¸ƒå¼é”" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”"><span>åˆ†å¸ƒå¼é”</span></a></h3><p>åŸç†ï¼šåŸºäº Redisï¼ˆå•çº¿ç¨‹ï¼‰çš„åŸå­æ“ä½œ <code>set &lt;key&gt; &lt;random_value&gt; NX EX 30</code>ï¼Œä»…å½“ key ä¸å­˜åœ¨æ—¶æ‰ä¼šè®¾ç½®æˆåŠŸï¼Œå¦åˆ™è¿”å› nilã€‚</p><p>ä¼˜åŒ–ï¼š</p><ol><li>é˜²æ­¢è§£é”å¤±è´¥ï¼ˆæ‰çº¿/å®•æœºï¼‰é€ æˆç¨‹åºæ­»é”ï¼Œkey å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ä¸”å’ŒåŠ é”åº”æ˜¯åŸå­çš„</li><li>ä¸ºäº†é˜²æ­¢é”è¿‡æœŸåè§£é”æ“ä½œè¯¯åˆ äº†å…¶å®ƒçº¿ç¨‹åŠ çš„é”ï¼Œå› æ­¤å¯ä»¥ç»™ value è®¾ä¸ºè¯¥çº¿ç¨‹å”¯ä¸€çš„ UUIDï¼Œè§£é”æ—¶å…ˆè·å–é”çš„å€¼ï¼Œå’Œè‡ªå·±çš„ UUID ç›¸ç­‰æ‰åˆ é™¤ã€‚</li><li>ä¸ºäº†é˜²æ­¢ç½‘ç»œè¯·æ±‚çš„å»¶è¿Ÿï¼Œé€ æˆè¯¯åˆ å…¶å®ƒçº¿ç¨‹åŠ çš„é”ï¼Œè·å– value è¿›è¡Œå¯¹æ¯”å’Œ åˆ é™¤ key å¿…é¡»æ˜¯åŸå­çš„ï¼Œå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬å®ç°ã€‚</li><li>ä¸ºäº†é˜²æ­¢ä¸šåŠ¡è¿˜æœªå®Œæˆé”å·²ç»è¿‡æœŸé‡Šæ”¾äº†ï¼Œéœ€è¦å¯¹é”è¿›è¡Œè‡ªåŠ¨ç»­æœŸï¼Œæˆ–ç›´æ¥è®¾ç½®ä¸€ä¸ªå¾ˆé•¿çš„è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚ä¸šåŠ¡ä¸­å¯ä»¥è®¾ 300s</li></ol><h3 id="ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"><span>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</span></a></h3><p>æŒ‡ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä¸€èˆ¬ä¸è¦æ±‚å¼ºä¸€è‡´æ€§ï¼Œéƒ½æ˜¯è¿½æ±‚æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h4 id="æ›´æ–°æ•°æ®åº“-åˆ é™¤ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#æ›´æ–°æ•°æ®åº“-åˆ é™¤ç¼“å­˜"><span>æ›´æ–°æ•°æ®åº“ -&gt; åˆ é™¤ç¼“å­˜</span></a></h4><ul><li>å¹¶å‘æ—¶å¯èƒ½æœ‰æš‚æ—¶çš„è„æ•°æ®</li><li>è§£å†³æ–¹æ³•ï¼š <ul><li>é‡è¯•æœºåˆ¶ï¼Œä¾‹å¦‚é…åˆ MQ/Canal</li><li>åŠ åˆ†å¸ƒå¼é”ï¼ŒåŸå­åœ°æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜ã€‚ä½†æ˜¯å­˜åœ¨ç¼“å­˜èµ„æºæµªè´¹ã€æ€§èƒ½é™ä½çš„é—®é¢˜</li></ul></li></ul><h4 id="åˆ é™¤ç¼“å­˜-æ›´æ–°æ•°æ®åº“" tabindex="-1"><a class="header-anchor" href="#åˆ é™¤ç¼“å­˜-æ›´æ–°æ•°æ®åº“"><span>åˆ é™¤ç¼“å­˜ -&gt; æ›´æ–°æ•°æ®åº“</span></a></h4><ul><li>å¹¶å‘æ—¶ä¾ç„¶æœ‰ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆAåˆ é™¤ç¼“å­˜ï¼ŒBæŸ¥ç¼“å­˜ä¸å­˜åœ¨å–æ•°æ®åº“ï¼Œç„¶ååˆæŠŠæ—§æ•°æ®å­˜å…¥ç¼“å­˜ï¼‰</li><li>è§£å†³æ–¹æ³•ï¼šå»¶è¿ŸåŒåˆ ï¼Œå³åˆ é™¤ç¼“å­˜åæ›´æ–°æ•°æ®åº“ï¼Œç„¶åç­‰ä¸€æ®µæ—¶é—´å†åˆ é™¤ç¼“å­˜ã€‚ä½†å»¶è¿Ÿæ—¶é—´å¾ˆéš¾è¯„ä¼°</li></ul><h4 id="è®¾è®¡æ€è·¯" tabindex="-1"><a class="header-anchor" href="#è®¾è®¡æ€è·¯"><span>è®¾è®¡æ€è·¯</span></a></h4><ul><li>ç¼“å­˜æ•°æ®ä¸åº”è¯¥æ˜¯å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¶…é«˜çš„ï¼Œæ‰€ä»¥ç¼“å­˜ + è¿‡æœŸæ—¶é—´ï¼Œè¶³å¤Ÿè§£å†³å¤§éƒ¨åˆ†ä¸šåŠ¡å¯¹äºç¼“å­˜çš„è¦æ±‚</li><li>æ€§èƒ½å’Œä¸€è‡´æ€§ä¸èƒ½åŒæ—¶æ»¡è¶³ï¼Œä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œé€šå¸¸ä¼šé‡‡ç”¨ã€Œæœ€ç»ˆä¸€è‡´æ€§ã€çš„æ–¹æ¡ˆ</li><li>é‡åˆ°å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œå³ä½¿é€Ÿåº¦æ…¢ç‚¹ï¼Œä¹Ÿåº”è¯¥æŸ¥æ•°æ®åº“</li><li>æˆ‘ä»¬ä¸åº”è¯¥è¿‡åº¦è®¾è®¡ï¼Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§</li></ul><h3 id="é«˜å¯ç”¨æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#é«˜å¯ç”¨æ¨¡å¼"><span>é«˜å¯ç”¨æ¨¡å¼</span></a></h3><h4 id="ä¸»ä»å¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»å¤åˆ¶"><span>ä¸»ä»å¤åˆ¶</span></a></h4><ul><li>å°†ä¸€ä¸ª Redis å®ä¾‹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œå¤šä¸ª Redis å®ä¾‹ä½œä¸ºä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å°†è‡ªå·±çš„æ•°æ®åŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚ï¼ˆæ•°æ®çš„å®Œæ•´å‰¯æœ¬ï¼‰</li><li>ä»èŠ‚ç‚¹å¯ä»¥æä¾›è¯»å–æœåŠ¡ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚</li><li>å½“ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå¯ä»¥åœ¨ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹æ¥ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</li><li>ä¼˜ç‚¹æ˜¯éƒ¨ç½²ç®€å•ï¼Œå¹¶ä¸”ç”±äºä¿å­˜äº†æ•°æ®çš„å®Œæ•´å‰¯æœ¬ï¼Œå› æ­¤é™ä½äº†æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</li><li>ç¼ºç‚¹æ˜¯ä¸»èŠ‚ç‚¹å®•æœºåï¼Œéœ€è¦äººå·¥ä»‹å…¥æ‰‹åŠ¨æ¢å¤ï¼Œé€ æˆæœåŠ¡çš„ä¸å¯ç”¨</li></ul><h4 id="å“¨å…µæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å“¨å…µæ¨¡å¼"><span>å“¨å…µæ¨¡å¼</span></a></h4><ul><li>Sentinel æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºç›‘æ§ Redis å®ä¾‹çš„å·¥å…·ï¼Œé€šè¿‡ PING è‡ªåŠ¨æ£€æµ‹ Redis å®ä¾‹çš„çŠ¶æ€ï¼Œè‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œé€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</li><li>ä¼˜ç‚¹æ˜¯å®ç°äº†è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæ— éœ€äººå·¥å¹²é¢„</li><li>ç¼ºç‚¹æ˜¯åœ¨å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚</li></ul><h4 id="é›†ç¾¤æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æ¨¡å¼"><span>é›†ç¾¤æ¨¡å¼</span></a></h4><ul><li>å°†æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œå­˜å‚¨å’Œç®¡ç†ï¼Œé™ä½ç³»ç»Ÿå¯¹å•ä¸»èŠ‚ç‚¹çš„ä¾èµ–ï¼Œå¹¶ä¸”å¤§å¤§æé«˜ Redis æœåŠ¡çš„è¯»å†™æ€§èƒ½</li><li>é™¤äº†ä¸»ä»å’Œå“¨å…µçš„åŠŸèƒ½å¤–ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹ä¸åŒçš„ key æ”¾åˆ°ä¸åŒçš„ Redis ä¸­ï¼Œæ¯ä¸ª Redis å®ä¾‹è´Ÿè´£ä¸€éƒ¨åˆ†çš„æ§½ï¼Œå¯ä»¥å®ç°æ•°æ®åˆ†ç‰‡ã€‚</li><li>ä¼˜ç‚¹æ˜¯å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œæé«˜äº†å¹¶å‘è¯»å†™çš„èƒ½åŠ›</li><li>ç¼ºç‚¹æ˜¯é…ç½®è¾ƒä¸ºå¤æ‚ã€‚</li></ul><h2 id="spring" tabindex="-1"><a class="header-anchor" href="#spring"><span>Spring</span></a></h2><h3 id="ioc-1" tabindex="-1"><a class="header-anchor" href="#ioc-1"><span>IoC</span></a></h3><h4 id="ioc-ç†è§£" tabindex="-1"><a class="header-anchor" href="#ioc-ç†è§£"><span>IoC ç†è§£</span></a></h4><p>IoC çš„æ€æƒ³å°±æ˜¯å°†åŸæœ¬åœ¨ç¨‹åºä¸­æ‰‹åŠ¨åˆ›å»ºå¯¹è±¡çš„æ§åˆ¶æƒï¼Œäº¤ç”± Spring æ¡†æ¶æ¥ç®¡ç†ï¼Œç”± Spring å®¹å™¨ï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯ä¸ªMapï¼‰å®Œæˆå¯¹è±¡çš„æ³¨å…¥ã€‚è¿™æ ·å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šç®€åŒ–åº”ç”¨çš„å¼€å‘ï¼ŒæŠŠåº”ç”¨ä»å¤æ‚çš„ä¾èµ–å…³ç³»ä¸­è§£æ”¾å‡ºæ¥ã€‚</p><h4 id="å£°æ˜-bean" tabindex="-1"><a class="header-anchor" href="#å£°æ˜-bean"><span>å£°æ˜ Bean</span></a></h4><ul><li><code>@Component</code>ï¼šé€šç”¨çš„æ³¨è§£ï¼Œå¯æ ‡æ³¨ä»»æ„ç±»ä¸º Spring ç»„ä»¶ã€‚é€šè¿‡ç±»è·¯å¾„æ‰«ææ¥è‡ªåŠ¨ä¾¦æµ‹ä»¥åŠè‡ªåŠ¨è£…é…åˆ° Spring å®¹å™¨ä¸­</li><li><code>@Repository</code>: å¯¹åº”æŒä¹…å±‚ï¼Œä¸»è¦ç”¨äºæ•°æ®åº“ç›¸å…³æ“ä½œã€‚</li><li><code>@Service</code>: å¯¹åº”æœåŠ¡å±‚ï¼Œä¸»è¦æ¶‰åŠä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œéœ€è¦ç”¨åˆ° Dao å±‚ã€‚</li><li><code>@Controller</code>: å¯¹åº”æ§åˆ¶å±‚ï¼Œä¸»è¦ç”¨æˆ·æ¥å—ç”¨æˆ·è¯·æ±‚å¹¶è°ƒç”¨ Service å±‚è¿”å›æ•°æ®ç»™å‰ç«¯é¡µé¢</li><li><code>@Bean</code>: ä½œç”¨äºæ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºæ–¹æ³•è¿”å›çš„å®ä¾‹è£…é…åˆ°Springå®¹å™¨ä¸­ã€‚å¸¸ç”¨äºç¬¬ä¸‰æ–¹åº“çš„ç±»è£…é…</li><li><code>@Configuration</code>ï¼šå£°æ˜é…ç½®ç±»</li></ul><p>æ¡†æ¶å¯åŠ¨æ—¶ï¼ŒSpring é€šè¿‡æ‰«æå„ç§æ³¨è§£ï¼ŒæŠŠéœ€è¦äº¤ç»™ Spring ç®¡ç†çš„ Bean åˆå§‹åŒ–ä¸º BeanDefinition çš„åˆ—è¡¨ï¼Œè¿›è€Œåˆ›å»º Bean çš„å®ä¾‹ã€‚</p><h4 id="æ³¨å…¥-bean" tabindex="-1"><a class="header-anchor" href="#æ³¨å…¥-bean"><span>æ³¨å…¥ Bean</span></a></h4><ul><li><code>@Autowired</code>: Spring å†…ç½®æ³¨è§£ <ul><li>é»˜è®¤ byTypeï¼Œæ ¹æ®æ¥å£ç±»å‹å»åŒ¹é…æ³¨å…¥æ¥å£å®ç°ç±»</li><li>å½“ä¸€ä¸ªæ¥å£å­˜åœ¨å¤šä¸ªå®ç°ç±»ï¼Œè½¬ä¸º byNameï¼Œå³å˜é‡åå’Œç±»ååŒ¹é…</li><li>å»ºè®®<code>@Qualifier(value = &quot;serviceImpl1&quot;)</code>æ˜¾å¼æŒ‡å®šåç§°</li></ul></li><li><code>@Resource</code>ï¼šJDK æä¾›çš„æ³¨è§£ <ul><li>é»˜è®¤ byNameï¼Œå¦åˆ™ byType</li><li>å»ºè®®é€šè¿‡ name å±æ€§æ˜¾å¼æŒ‡å®šåç§°</li></ul></li><li><code>@Inject</code> åŸºæœ¬ä¸ç”¨</li></ul><h4 id="bean-ä½œç”¨åŸŸ" tabindex="-1"><a class="header-anchor" href="#bean-ä½œç”¨åŸŸ"><span>Bean ä½œç”¨åŸŸ</span></a></h4><ul><li>singletonï¼šé»˜è®¤ï¼Œå®¹å™¨ä¸­åªæœ‰å”¯ä¸€å®ä¾‹ã€‚</li><li>prototype: æ¯æ¬¡è·å–éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ã€‚</li><li>request(Web)ï¼šæ¯ä¸€æ¬¡ HTTP è¯·æ±‚éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°å®ä¾‹ï¼Œä¸”ä»…åœ¨å½“å‰ HTTP è¯·æ±‚å†…æœ‰æ•ˆã€‚</li><li>session(Web)ï¼šæ¯ä¸€æ¬¡æ¥è‡ªæ–° session çš„ HTTP è¯·æ±‚éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°å®ä¾‹ï¼Œä¸”ä»…åœ¨å½“å‰ session å†…æœ‰æ•ˆã€‚</li><li>application/global-session(Web)ï¼šæ¯ä¸ª Web åº”ç”¨åœ¨å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œä¸”ä»…åœ¨å½“å‰åº”ç”¨å¯åŠ¨æ—¶é—´å†…æœ‰æ•ˆã€‚</li><li>websocket(Web)ï¼šæ¯ä¸€æ¬¡ WebSocket ä¼šè¯äº§ç”Ÿä¸€ä¸ªæ–°å®ä¾‹</li></ul><h4 id="bean-ç”Ÿå‘½å‘¨æœŸ-1" tabindex="-1"><a class="header-anchor" href="#bean-ç”Ÿå‘½å‘¨æœŸ-1"><span>Bean ç”Ÿå‘½å‘¨æœŸ</span></a></h4><ol><li>å®ä¾‹åŒ–ï¼šé€šè¿‡åå°„æˆ–è€…å·¥å‚æ–¹æ³•åˆ›å»º Bean å¯¹è±¡ã€‚</li><li>å±æ€§æ³¨å…¥ï¼šé€šè¿‡é…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£ç»™ Bean å¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚</li><li>åˆå§‹åŒ–ï¼šè°ƒç”¨ Bean å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œæ¯”å¦‚ <code>@PostConstruct</code>æ³¨è§£çš„æ–¹æ³•ï¼Œæˆ–è€…å®ç°äº†<code>InitializingBean</code>æ¥å£çš„<code>afterPropertiesSet</code>æ–¹æ³•ï¼Œæˆ–è€…é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„<code>init-method</code>æ–¹æ³•ã€‚</li><li>é”€æ¯ï¼šè°ƒç”¨ Bean å¯¹è±¡çš„é”€æ¯æ–¹æ³•ï¼Œæ¯”å¦‚<code>@PreDestroy</code>æ³¨è§£çš„æ–¹æ³•ï¼Œæˆ–è€…å®ç°äº†<code>DisposableBean</code>æ¥å£çš„<code>destroy</code>æ–¹æ³•ï¼Œæˆ–è€…é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„<code>destroy-method</code>æ–¹æ³•ã€‚</li></ol><p>å…¶å®ƒæ‰©å±•ç‚¹ï¼šBeanPostProcessor, BeanFactoryPostProcessor, InstantiationAwareBeanPostProcessor, SmartInstantiationAwareBeanPostProcessor...</p><p><img src="/img/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.jpg#id=JyJIF&amp;originHeight=303&amp;originWidth=720&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><h4 id="è‡ªåŠ¨è£…é…" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨è£…é…"><span>è‡ªåŠ¨è£…é…</span></a></h4><p>Spring çš„è‡ªåŠ¨è£…é…é€šè¿‡æ³¨è§£æˆ–è€…ä¸€äº›ç®€å•çš„é…ç½®å°±èƒ½åœ¨ Spring Boot çš„å¸®åŠ©ä¸‹è‡ªåŠ¨å¯¼å…¥ä¸€äº›Beanæ¥å®ç°æŸäº›åŠŸèƒ½ã€‚</p><ol><li>æ•´ä¸ªSpringBooté¡¹ç›®çš„å¯åŠ¨ç±»éƒ½æ˜¯æ·»åŠ <code>@SpringBootApplication</code>æ³¨è§£çš„ï¼Œè¿™ä¸ªæ³¨è§£ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªå­æ³¨è§£: <ul><li>@SpringBootConfiguration è¡¨ç¤ºå½“å‰æ˜¯ä¸ªé…ç½®ç±»</li><li><a href="/ComponentScan">@ComponentScan </a> åŒ…æ‰«æ(å¹¶ä¸”å¯ä»¥æ’é™¤ä¸€äº›åŒ…/ç±»)</li><li>@EnableAutoConfiguration è‡ªåŠ¨è£…é…çš„å…³é”®æ³¨è§£</li></ul></li><li>@EnableAutoConfiguration åˆ†ä¸¤éƒ¨åˆ†ï¼š <ul><li>@AutoConfigurationPackage é‡Œé¢æ˜¯ <a href="/Import">@Import </a> æ³¨è§£å¯¼å…¥äº†ä¸€ä¸ª Registrar ç±»ï¼Œè´Ÿè´£æ‰«æä¸»å¯åŠ¨ç±»åŒ…åŠå…¶å­åŒ…çš„ç»„ä»¶å¹¶åŠ è½½åˆ° Spring å®¹å™¨ä¸­</li><li>å¦ä¸€ä¸ª <a href="/Import">@Import </a> å¯¼å…¥äº† AutoConfigurationImportSelector ç±»ï¼Œè¿™ä¸ªç±»å®ç°äº† ImportSelector æ¥å£ï¼Œå®ç°äº† selectImports æ–¹æ³•ï¼Œç”¨äºè·å–æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç±»çš„å…¨é™å®šç±»åï¼Œå¹¶åŠ è½½åˆ°å®¹å™¨ä¸­</li></ul></li><li>selectImports æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯äº†è‡ªåŠ¨è£…é…ï¼Œå¦‚æœå¼€å¯çš„è¯ç»§ç»­ã€‚</li><li>æ¥ç€è°ƒç”¨ SpringFactoriesLoader::loadMetaData æ‰«ææ‰€æœ‰ä¾èµ–é¡¹ç›®çš„ META-INF ç›®å½•ä¸‹çš„ spring.factories æ–‡ä»¶é‡Œï¼Œå®šä¹‰çš„ Key ä¸º EnableAutoConfiguration çš„ç±»çš„å…¨ç±»åï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰éœ€è¦è£…é…çš„ Bean</li><li>ç„¶åè°ƒç”¨ getAutoConfigurationEntry æ¥åŠ è½½è¿™äº› Beanï¼Œå…·ä½“çš„ï¼š <ul><li>åˆ¤æ–­è‡ªåŠ¨è£…é…æ˜¯å¦å¼€å¯</li><li>è·å– EnableAutoConfiguration æ³¨è§£ä¸­çš„ exclude å’Œ excludeName åšä¸€ä¸ªè¿‡æ»¤å¹¶ä¸”å»é‡ï¼Œç„¶åè¿”å›ä¸€ä¸ªéœ€è¦åŠ è½½çš„ Bean çš„ç»“æœé›†</li><li>ç„¶åæ ¹æ® Bean ä¸Šæ·»åŠ çš„ Conditional æ¡ä»¶æ³¨è§£å†åšä¸€æ¬¡è¿‡æ»¤</li></ul></li><li>æœ€åå°±å¯ä»¥æŠŠè¿™äº›å‰©ä¸‹çš„ Bean è£…å…¥å®¹å™¨äº†</li></ol><h4 id="è§£å†³å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#è§£å†³å¾ªç¯ä¾èµ–"><span>è§£å†³å¾ªç¯ä¾èµ–</span></a></h4><p>å¾ªç¯ä¾èµ–å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼ŒæŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªbeanäº’ç›¸æŒæœ‰å¯¹æ–¹ï¼Œå½¢æˆä¸€ä¸ªé—­ç¯ã€‚åˆ†ï¼š</p><ul><li>æ„é€ å™¨å¾ªç¯ä¾èµ–ï¼šæ— æ³•è§£å†³</li><li>Setter å¾ªç¯ä¾èµ–ï¼š <ul><li>å¯¹äº Singleton çš„ Beanï¼Œå¯ä»¥æå‰æš´éœ²ä¸€ä¸ªå•ä¾‹å·¥å‚æ–¹æ³•ï¼Œä½¿å¾—å…¶å®ƒBeanèƒ½å¤Ÿå¼•ç”¨åˆ°ï¼ˆå»æ‰æœ¬èº«çš„ @Beanï¼‰</li><li>å¯¹äº Prototype çš„ Beanï¼Œæ— æ³•è§£å†³ã€‚springå®¹å™¨ä¸ç¼“å­˜prototypeä½œç”¨åŸŸçš„beanï¼Œå› æ­¤æ— æ³•æå‰æš´éœ²ä¸€ä¸ªæ­£åœ¨åˆ›å»ºä¸­çš„beanã€‚</li></ul></li></ul><p><strong>åŸç†</strong></p><p>Spring é€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼š</p><ul><li>ä¸€çº§ç¼“å­˜ï¼šå•ä¾‹æ± ï¼Œé™åˆ¶ bean åœ¨ beanFactory ä¸­ä»…å­˜ä¸€ä»½<br><code>private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);</code></li><li>äºŒçº§ç¼“å­˜ï¼šæ—©æœŸæ›å…‰å¯¹è±¡<br><code>private final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16);</code></li><li>ä¸‰çº§ç¼“å­˜ï¼šæ—©æœŸæ›å…‰å¯¹è±¡å·¥å‚<br><code>private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);</code></li></ul><p><img src="/img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.webp#id=vQ1zV&amp;originHeight=619&amp;originWidth=1440&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p>å½“ Aã€B ä¸¤ä¸ªç±»å‘ç”Ÿå¾ªç¯å¼•ç”¨æ—¶ï¼Œåœ¨ A å®Œæˆå®ä¾‹åŒ–åï¼Œå°±ä½¿ç”¨å®ä¾‹åŒ–åçš„å¯¹è±¡å»åˆ›å»ºä¸€ä¸ªå¯¹è±¡å·¥å‚ï¼Œå¹¶æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œå¦‚æœ A è¢« AOP ä»£ç†ï¼Œé‚£ä¹ˆé€šè¿‡è¿™ä¸ªå·¥å‚è·å–åˆ°çš„å°±æ˜¯Aä»£ç†åçš„å¯¹è±¡ï¼Œå¦‚æœ A æ²¡æœ‰è¢« AOP ä»£ç†ï¼Œé‚£ä¹ˆè¿™ä¸ªå·¥å‚è·å–åˆ°çš„å°±æ˜¯ A å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚å½“ A è¿›è¡Œå±æ€§æ³¨å…¥æ—¶ï¼Œä¼šå»åˆ›å»º Bï¼ŒåŒæ—¶ B åˆä¾èµ–äº† Aï¼Œæ‰€ä»¥åˆ›å»º B çš„åŒæ—¶åˆä¼šå»è°ƒç”¨getBean(a) æ¥è·å–éœ€è¦çš„ä¾èµ–ï¼Œæ­¤æ—¶çš„ getBean(a) ä¼šä»ç¼“å­˜ä¸­è·å–ã€‚</p><ul><li>é¦–å…ˆä»ä¸€çº§ç¼“å­˜ä¸­è·å–ï¼Œä½† A æ²¡æœ‰å¡«å……å’Œåˆå§‹åŒ–å®Œæˆï¼Œå› æ­¤ä¸å­˜åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼›æ¥ç€å»äºŒçº§ç¼“å­˜è·å–ï¼Œä¹Ÿä¸å­˜åœ¨ï¼›æœ€åå»ä¸‰çº§ç¼“å­˜è·å–ï¼Œå¯ä»¥è·å–åˆ°ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨å¯¹è±¡å·¥å‚çš„getObjectæ–¹æ³•æ¥è·å–åˆ°å¯¹åº”çš„å¯¹è±¡ï¼Œå¾—åˆ°è¿™ä¸ªå¯¹è±¡åå°†å…¶æ³¨å…¥åˆ°Bä¸­ã€‚</li><li>ç´§æ¥ç€Bä¼šèµ°å®Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€åç½®å¤„ç†å™¨ç­‰ã€‚å½“Båˆ›å»ºå®Œåï¼Œä¼šå°†Bå†æ³¨å…¥åˆ°Aä¸­ï¼Œæ­¤æ—¶Aå†å®Œæˆå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚<br>è‡³æ­¤ï¼Œå¾ªç¯ä¾èµ–ç»“æŸï¼</li></ul><p><strong>ä¸ºä»€ä¹ˆä¸ç”¨äºŒçº§ç¼“å­˜ï¼Ÿ</strong></p><p>å¦‚æœè¦ä½¿ç”¨äºŒçº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Œæ„å‘³ç€æ‰€æœ‰Beanåœ¨å®ä¾‹åŒ–åå°±è¦å®ŒæˆAOPä»£ç†ï¼Œè¿™æ ·è¿èƒŒäº†Springè®¾è®¡çš„åŸåˆ™ï¼ŒSpringåœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯é€šè¿‡AnnotationAwareAspectJAutoProxyCreatorè¿™ä¸ªåç½®å¤„ç†å™¨æ¥åœ¨Beanç”Ÿå‘½å‘¨æœŸçš„æœ€åä¸€æ­¥æ¥å®ŒæˆAOPä»£ç†ï¼Œè€Œä¸æ˜¯åœ¨å®ä¾‹åŒ–åå°±ç«‹é©¬è¿›è¡ŒAOPä»£ç†ã€‚</p><h3 id="aop-1" tabindex="-1"><a class="header-anchor" href="#aop-1"><span>AOP</span></a></h3><h4 id="aop-ç†è§£" tabindex="-1"><a class="header-anchor" href="#aop-ç†è§£"><span>AOP ç†è§£</span></a></h4><p>Spring AOP å°±æ˜¯åŸºäºåŠ¨æ€ä»£ç†(å¦‚æœå®ç°äº†æ¥å£ä½¿ç”¨åŸºäºå®ç°çš„JDK Proxyï¼Œå¦åˆ™ä½¿ç”¨åŸºäºç»§æ‰¿çš„CGLibä»£ç†)ï¼Œèƒ½å¤Ÿå°†é‚£äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œå´ä¸ºä¸šåŠ¡æ¨¡å—æ‰€å…±åŒè°ƒç”¨çš„é€»è¾‘æˆ–è´£ä»»ï¼ˆä¾‹å¦‚äº‹åŠ¡å¤„ç†ã€æ—¥å¿—ç®¡ç†ã€æƒé™æ§åˆ¶ç­‰ï¼‰å°è£…èµ·æ¥ï¼Œä¾¿äºå‡å°‘ç³»ç»Ÿçš„é‡å¤ä»£ç ï¼Œé™ä½æ¨¡å—é—´çš„è€¦åˆåº¦ï¼Œæœ‰åˆ©äºæœªæ¥çš„å¯æ‹“å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><h4 id="é€šçŸ¥ç±»å‹" tabindex="-1"><a class="header-anchor" href="#é€šçŸ¥ç±»å‹"><span>é€šçŸ¥ç±»å‹</span></a></h4><p>Around<iconify-icon class="vp-icon" icon="before -&gt; Before -&gt; target" sizing="height" height="1em"></iconify-icon>proceed -&gt; Around::after -&gt; AfterReturning / AfterThrowing -&gt; After</p><h3 id="mvc" tabindex="-1"><a class="header-anchor" href="#mvc"><span>MVC</span></a></h3><h4 id="mvc-ç†è§£" tabindex="-1"><a class="header-anchor" href="#mvc-ç†è§£"><span>MVC ç†è§£</span></a></h4><p>MVC æ˜¯æ¨¡å‹(Model)ã€è§†å›¾(View)ã€æ§åˆ¶å™¨(Controller)çš„ç®€å†™ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å°†ä¸šåŠ¡é€»è¾‘ã€æ•°æ®ã€æ˜¾ç¤ºåˆ†ç¦»æ¥ç»„ç»‡ä»£ç ã€‚</p><p>Spring MVC ä¸‹æˆ‘ä»¬ä¸€èˆ¬æŠŠåç«¯é¡¹ç›®åˆ†ä¸ºï¼š</p><ul><li>Entityå±‚ï¼šå®ä½“ç±»</li><li>Daoå±‚ï¼šæ“ä½œæ•°æ®åº“</li><li>Serviceå±‚ï¼šå¤„ç†ä¸šåŠ¡</li><li>Controllerå±‚ï¼šè¿”å›æ•°æ®ç»™å‰å°é¡µé¢</li></ul><h4 id="æ ¸å¿ƒç»„ä»¶å’ŒåŸç†" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒç»„ä»¶å’ŒåŸç†"><span>æ ¸å¿ƒç»„ä»¶å’ŒåŸç†</span></a></h4><ul><li><code>DispatcherServlet</code>ï¼šæ ¸å¿ƒçš„ä¸­å¤®å¤„ç†å™¨ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚ã€åˆ†å‘ï¼Œå¹¶ç»™äºˆå®¢æˆ·ç«¯å“åº”ã€‚</li><li><code>HandlerMapping</code>ï¼šå¤„ç†å™¨æ˜ å°„å™¨ï¼Œæ ¹æ® uri å»åŒ¹é…æŸ¥æ‰¾èƒ½å¤„ç†çš„ Handler ï¼Œå¹¶ä¼šå°†è¯·æ±‚æ¶‰åŠåˆ°çš„æ‹¦æˆªå™¨å’Œ Handler ä¸€èµ·å°è£…ã€‚</li><li><code>HandlerAdapter</code>ï¼šå¤„ç†å™¨é€‚é…å™¨ï¼Œæ ¹æ® HandlerMapping æ‰¾åˆ°çš„ Handler ï¼Œé€‚é…æ‰§è¡Œå¯¹åº”çš„ Handlerï¼›</li><li><code>Handler</code>ï¼šè¯·æ±‚å¤„ç†å™¨ï¼Œå¤„ç†å®é™…è¯·æ±‚çš„å¤„ç†å™¨ã€‚</li><li><code>ViewResolver</code>ï¼šè§†å›¾è§£æå™¨ï¼Œæ ¹æ® Handler è¿”å›çš„é€»è¾‘è§†å›¾/è§†å›¾ï¼Œè§£æå¹¶æ¸²æŸ“çœŸæ­£çš„è§†å›¾ï¼Œä¼ é€’ç»™ DispatcherServlet å“åº”å®¢æˆ·ç«¯</li></ul><p><img src="/assets/MVC%E5%8E%9F%E7%90%86-DmcULmcP.png#id=jJqZb&amp;originHeight=419&amp;originWidth=737&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><h3 id="å…¶å®ƒ-1" tabindex="-1"><a class="header-anchor" href="#å…¶å®ƒ-1"><span>å…¶å®ƒ</span></a></h3><h4 id="spring-å¯åŠ¨æµç¨‹" tabindex="-1"><a class="header-anchor" href="#spring-å¯åŠ¨æµç¨‹"><span>Spring å¯åŠ¨æµç¨‹</span></a></h4><ol><li>é¦–å…ˆä»mainæ‰¾åˆ°run()æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œrun()æ–¹æ³•ä¹‹å‰newä¸€ä¸ªSpringApplicationå¯¹è±¡</li><li>è¿›å…¥run()æ–¹æ³•ï¼Œåˆ›å»ºåº”ç”¨ç›‘å¬å™¨SpringApplicationRunListenerså¼€å§‹ç›‘å¬</li><li>ç„¶ååŠ è½½SpringBooté…ç½®ç¯å¢ƒ(ConfigurableEnvironment)ï¼Œç„¶åæŠŠé…ç½®ç¯å¢ƒ(Environment)åŠ å…¥ç›‘å¬å¯¹è±¡ä¸­</li><li>ç„¶ååŠ è½½åº”ç”¨ä¸Šä¸‹æ–‡(ConfigurableApplicationContext)ï¼Œå½“åšrunæ–¹æ³•çš„è¿”å›å¯¹è±¡</li><li>æœ€ååˆ›å»ºSpringå®¹å™¨ï¼ŒrefreshContext(context)ï¼Œå®ç°starterè‡ªåŠ¨åŒ–é…ç½®å’Œbeançš„å®ä¾‹åŒ–ç­‰å·¥ä½œã€‚</li></ol><h4 id="å¸¸ç”¨æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#å¸¸ç”¨æ³¨è§£"><span>å¸¸ç”¨æ³¨è§£</span></a></h4><ol><li>@SpringBootApplication: å¯åŠ¨ç±»ï¼Œæ˜¯@SpringBootConfiguration, @EnalbeAutoConfiguration, @ComponentScanä¸‰ä¸ªæ³¨è§£çš„é›†åˆ</li><li>@Autowiredï¼šè‡ªåŠ¨è£…é…ï¼Œè¢«æ³¨å…¥çš„ç±»è¦è¢«Springå®¹å™¨ç®¡ç†</li><li>@Compoent, @Repository, @Service, @Controllerï¼šå£°æ˜ Bean</li><li>@RestController: <a href="/Controller">@Controller </a> + <a href="/ResponseBody">@ResponseBody </a> çš„é›†åˆï¼ŒRESTé£æ ¼çš„æ§åˆ¶å™¨ï¼Œå°†å‡½æ•°çš„è¿”å›å€¼ç›´æ¥å†™å…¥HTTPå“åº”ä½“</li><li><a href="/Scope">@Scope </a> å£°æ˜ä½œç”¨åŸŸ</li><li><a href="/Configuration">@Configuration </a> å£°æ˜é…ç½®ç±»</li><li><a href="/GetMapping">@GetMapping </a> è·å–èµ„æºï¼Œ<a href="/PostMapping">@PostMapping </a> åˆ›å»ºæ–°èµ„æºï¼Œ<a href="/PutMapping">@PutMapping </a> æ›´æ–°èµ„æºï¼Œ<a href="/DeleteMapping">@DeleteMapping </a> åˆ é™¤èµ„æº</li><li><a href="/PathVariable">@PathVariable </a> è·å–è·¯å¾„å‚æ•°ï¼Œ<a href="/RequestParam">@RequestParam </a> è·å–æŸ¥è¯¢å‚æ•°ï¼Œ<a href="/RequestBody">@RequestBody </a> è·å–è¯·æ±‚ä½“å‚æ•°å¹¶è‡ªåŠ¨ç»‘å®šåˆ°Javaå¯¹è±¡ï¼ˆåˆ©ç”¨HttpMessageConverterï¼Œä¸”ä¸€ä¸ªè¯·æ±‚æ–¹æ³•ä¸­ä»…èƒ½æœ‰ä¸€ä¸ªï¼‰</li><li>@Value(&quot;${...}&quot;) è¯»å–ç®€å•é…ç½®ä¿¡æ¯ï¼Œ[@ConfigurationProperties(prefix ](/ConfigurationProperties(prefix ) = &quot;...&quot;) è¯»å–é…ç½®å¹¶ç»‘å®šåˆ° Beanï¼Œ @PropertySource(&quot;xxx&quot;) è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶</li><li>å‚æ•°æ ¡éªŒï¼š<a href="/Validate">@Validate </a> åŠ åœ¨Controllerä¸Šå¼€å¯æ ¡éªŒï¼Œå…·ä½“è§„åˆ™æœ‰ @NotEmpty, @NotBlank, @Pattern, @Max, <a href="/Size...">@Size... </a> (åŠ åœ¨ Entity å®ä½“ç±»çš„å±æ€§ä¸Š)</li><li>å…¨å±€å¼‚å¸¸ï¼š<a href="/ControllerAdvice">@ControllerAdvice </a> å®šä¹‰å…¨å±€å¼‚å¸¸å¤„ç†ç±»ï¼Œ<a href="/ExceptionHandler">@ExceptionHandler </a> å£°æ˜å¼‚å¸¸å¤„ç†æ–¹æ³•</li><li>JPA ç›¸å…³ï¼š<a href="/Entity">@Entity </a> å®ä½“ç±»ï¼Œ<a href="/Table">@Table </a> è¡¨åï¼Œ @Id å£°æ˜ä¸»é”®ï¼Œ<a href="/GeneratedValue">@GeneratedValue </a> ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œ <a href="/Column">@Column </a> å£°æ˜å­—æ®µï¼Œ <a href="/Transient">@Transient </a> å£°æ˜ä¸æŒä¹…åŒ–å­—æ®µï¼ˆæˆ–ç”¨static/finalä¿®é¥°ï¼‰ï¼Œ<a href="/Lob">@Lob </a> å¤§å­—æ®µï¼Œ<a href="/Enumerated">@Enumerated </a> æšä¸¾ç±»å‹å­—æ®µï¼Œ@<a href="/EnableJpaAuditing">@EnableJpaAuditing </a> å¼€å¯JPAå®¡è®¡ï¼Œ<a href="/Transactional">@Transactional </a> å¼€å¯äº‹åŠ¡</li><li>Jsonæ•°æ®å¤„ç†ï¼š<a href="/JsonIgnoreProperties">@JsonIgnoreProperties </a> è¿‡æ»¤ç‰¹å®šå­—æ®µä¸è¿”å›/ä¸è§£æï¼Œ<a href="/JsonFormat">@JsonFormat </a> æ ¼å¼åŒ–Jsonæ•°æ®ï¼Œ<a href="/JsonUnwrapped">@JsonUnwrapped </a> æ‰å¹³åŒ–å¯¹è±¡</li><li>æµ‹è¯•ç›¸å…³ï¼š<a href="/ActiveProfiles">@ActiveProfiles </a> å£°æ˜ç”Ÿæ•ˆçš„Springé…ç½®æ–‡ä»¶ï¼Œ<a href="/Test">@Test </a> æµ‹è¯•æ–¹æ³•ï¼Œ<a href="/WithMockUser">@WithMockUser </a> æ¨¡æ‹ŸçœŸå®ç”¨æˆ·å’Œæƒé™</li></ol><h4 id="springboot-ä¼˜åŠ¿" tabindex="-1"><a class="header-anchor" href="#springboot-ä¼˜åŠ¿"><span>SpringBoot ä¼˜åŠ¿</span></a></h4><ul><li>SpringBoot ä¾é å¤§é‡æ³¨è§£å®ç°è‡ªåŠ¨åŒ–é…ç½®ï¼Œåªéœ€è¦æ·»åŠ ç›¸åº”çš„åœºæ™¯ä¾èµ–ï¼Œå°±å¯ä»¥å¿«é€Ÿæ„å»ºå‡ºä¸€ä¸ªç‹¬ç«‹çš„ Spring åº”ç”¨</li><li>é€šè¿‡è‡ªåŠ¨ starter ä¾èµ–ï¼Œç®€åŒ–äº†æ„å»ºé…ç½®</li><li>å†…åµŒæœåŠ¡å™¨ä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦å•ç‹¬éƒ¨ç½²</li><li>SpringBoot æ•´åˆäº†å¤§é‡ç¬¬ä¸‰æ–¹åŠŸèƒ½ï¼Œå¹¶æä¾›äº†é»˜è®¤é…ç½®ï¼Œä¾‹å¦‚ mybatisã€redisç­‰ï¼Œå®ç°å¼€ç®±å³ç”¨</li><li>SpringBoot æä¾›äº†ä¸€äº›ç”¨äºç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶çš„ç‰¹æ€§ï¼Œä¾‹å¦‚æŒ‡æ ‡ã€ç›‘æ§æ£€æŸ¥å’Œå¤–éƒ¨åŒ–é…ç½®ã€‚</li></ul><h4 id="springboot-ç¼ºç‚¹" tabindex="-1"><a class="header-anchor" href="#springboot-ç¼ºç‚¹"><span>SpringBoot ç¼ºç‚¹</span></a></h4><ul><li>ç¼ºå°‘çµæ´»æ€§ï¼Œæœ‰æ—¶éœ€è¦åœ¨é¡¹ç›®ä¸­æ‰©å±•ä¸€äº›åŠŸèƒ½å°±éœ€è¦æ‰‹åŠ¨é…ç½®</li><li>é›†æˆåº¦è¾ƒé«˜ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¸å¤ªå®¹æ˜“äº†è§£åº•å±‚ï¼›</li><li>éš¾ä»¥é€‚åº”è¾ƒä¸ºå¤æ‚çš„åœºæ™¯ï¼Œä¸€æ—¦é¡¹ç›®å˜å¾—å¤æ‚ï¼Œå°±éœ€è¦è€ƒè™‘åŠŸèƒ½çš„åˆ’åˆ†å’Œæ›´åŠ ç»†è‡´çš„é…ç½®</li></ul><h4 id="äº‹åŠ¡ä¼ æ’­è¡Œä¸º" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡ä¼ æ’­è¡Œä¸º"><span>äº‹åŠ¡ä¼ æ’­è¡Œä¸º</span></a></h4><p>Spring ç®¡ç†äº‹åŠ¡æœ‰ä¸¤ç§æ–¹å¼ï¼šç¼–ç¨‹å¼ï¼ˆæ‰‹åŠ¨ç¡¬ç¼–ç ï¼‰ã€å£°æ˜å¼ï¼ˆåŸºäº<code>@Transactional</code>çš„AOPï¼‰</p><ul><li><code>Propagation_Required</code>: <a href="/Transactional">@Transactional </a> é»˜è®¤æ¨¡å¼ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</li><li><code>Propagation_Requires_New</code>: æ€»æ˜¯åˆ›å»ºæ–°äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™æŒ‚èµ·ã€‚å¼€å¯çš„äº‹åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°</li><li><code>Propagation_Nested</code>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡æ¥è¿è¡Œï¼›å¦åˆ™æ–°å»ºäº‹åŠ¡</li><li><code>Propagation_Mandatory</code>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡å°±åŠ å…¥ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸</li></ul><p>å¦å¤–è¿˜æœ‰ä¸‰ç§å¯èƒ½ä¸å›æ»šçš„äº‹åŠ¡ï¼š</p><ul><li><code>Propagation_Supports</code>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡å°±åŠ å…¥ï¼›å¦åˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œ</li><li><code>Propagation_Not_Supported</code>: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·</li><li><code>Propagation_Never</code>: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™æŠ›å‡ºå¼‚å¸¸</li></ul><h4 id="äº‹åŠ¡éš”ç¦»çº§åˆ«" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡éš”ç¦»çº§åˆ«"><span>äº‹åŠ¡éš”ç¦»çº§åˆ«</span></a></h4><ul><li><code>Isolation_Default</code>: ä½¿ç”¨åç«¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œä¾‹å¦‚ MySQL é»˜è®¤ REPEATABLE_READ</li><li><code>Isolation_Read_Uncommited</code>: æœ€ä½çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»</li><li><code>Isolation_Read_Commited</code>: å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿ</li><li><code>Isolation_Repeatable_Read</code>: å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li><code>Isolation_Serializable</code>: æœ€é«˜çº§åˆ«ï¼Œå®Œå…¨æœä» ACIDï¼Œæ‰€æœ‰äº‹åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œå¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ç­‰é—®é¢˜ï¼Œå½“ä¸¥é‡å½±å“æ€§èƒ½ã€‚</li></ul><h4 id="spring-cache" tabindex="-1"><a class="header-anchor" href="#spring-cache"><span>Spring Cache</span></a></h4><p>Spring æ”¯æŒå¤šç§ç¼“å­˜çš„å®ç°æ–¹å¼ï¼Œä¾‹å¦‚ SimpleCache(ConcurrentMapå®ç°), RedisCache, EhCache, CaffeineCache... æœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ï¼š</p><ul><li><code>org.springframework.cache.Cache</code>ï¼šç”¨äºå®šä¹‰ç¼“å­˜çš„å„ç§æ“ä½œ</li><li><code>org.springframework.cache.CacheManager</code>ï¼šç”¨äºç®¡ç†å„ä¸ªcacheç¼“å­˜ç»„ä»¶</li></ul><p><strong>åŸç†</strong></p><ul><li>ç¼“å­˜çš„è‡ªåŠ¨é…ç½®ç±» CacheAutoConfiguration å‘å®¹å™¨ä¸­å¯¼å…¥äº† CacheConfigurationImportSelector</li><li>CacheConfigurationImportSelector çš„ selectImports() å¯¼å…¥æ‰€æœ‰ç¼“å­˜ç±»å‹çš„é…ç½®ç±»ï¼Œé»˜è®¤å¯ç”¨ SimpleCacheConfiguration</li><li>SimpleCacheConfiguration é…ç½®ç±»å‘å®¹å™¨ä¸­æ³¨å…¥äº†ä¸€ä¸ª ConcurrentMapCacheManager å®ä¾‹</li><li>ConcurrentMapCacheManager åº•å±‚åˆ›å»ºä¸€ä¸ª ConcurrentMapCache ç®¡ç†ç¼“å­˜</li></ul><p><strong>ç¼“å­˜æ³¨è§£</strong></p><ul><li><code>@EnableCaching</code>ï¼šç”¨äº SpringBoot çš„å¯åŠ¨ç±»å¼€å¯æ³¨è§£åŠŸèƒ½</li><li><code>@CacheConfig</code>ï¼šç”¨äºå¯¹ç±»è¿›è¡Œé…ç½®ï¼Œå¯¹æ•´ä¸ªç±»çš„ç¼“å­˜è¿›è¡Œé…ç½®ï¼Œå¯ç”¨ <a href="/Cacheable">@Cacheable </a> å–ä»£</li><li><code>@Cacheable</code>ï¼šé€šå¸¸ç”¨äºé…ç½®æ–¹æ³•ï¼Œå°†æ–¹æ³•çš„è¿”å›ç»“æœæ³¨å…¥åˆ°ç¼“å­˜å¯¹è±¡ä¸­ <ul><li>value/cacheNames: æŒ‡å®šç¼“å­˜åï¼ˆè·Ÿåœ¨ key-prefix åé¢ï¼‰</li><li>key/keyGeneratorï¼šæŒ‡å®šç¼“å­˜å¯¹åº”çš„ key å€¼ï¼Œé»˜è®¤ä½¿ç”¨æ–¹æ³•å‚æ•°ç”Ÿæˆï¼Œå¯ä»¥ä½¿ç”¨ spel æŒ‡å®š</li><li>condition/unless: æ¡ä»¶ç¼“å­˜</li><li>syncï¼šé»˜è®¤ falseï¼Œä¸º true æ—¶å¼€å¯åŒæ­¥é”</li></ul></li><li><code>@CacheEvict</code>ï¼šå¯ç”¨äºç±»æˆ–æ–¹æ³•ï¼Œç”¨äºæ¸…ç©ºç¼“å­˜ <ul><li>allEntries: true è¡¨ç¤ºåˆ é™¤åŸŸåä¸‹æ‰€æœ‰ç¼“å­˜</li></ul></li><li><code>@CachePut</code>ï¼šå¼ºåˆ¶æ‰§è¡Œæ–¹æ³•å¹¶å°†è¿”å›ç»“æœæ”¾å…¥ç¼“å­˜ï¼Œå¸¸ç”¨äºæ›´æ–° DB çš„æ–¹æ³• <ul><li>å±æ€§åŒ <a href="/Cacheable">@Cacheable </a></li></ul></li><li><code>@Caching</code>: <a href="/Cacheable">@Cacheable </a> + <a href="/CachePut">@CachePut </a> + <a href="/CacheEvict">@CacheEvict </a></li></ul><p><strong>ç¼ºé™·</strong></p><ul><li>è¯»ç¼“å­˜ï¼š <ul><li>ç¼“å­˜ç©¿é€ï¼šspring.cache.redis.cache-null-values æŒ‡å®šæ˜¯å¦ç¼“å­˜ç©ºæ•°æ®</li><li>ç¼“å­˜å‡»ç©¿ï¼šé»˜è®¤æ˜¯æ— åŠ é”çš„ï¼Œå¯ä»¥ç½® Cacheable çš„ sync ä¸º true</li><li>ç¼“å­˜é›ªå´©ï¼šå¯ä»¥è®¾ç½®éšæœºæ—¶é—´</li></ul></li><li>å†™ç¼“å­˜ï¼š <ul><li>è¯»å†™åŠ é”</li><li>å¼•å…¥ Canal</li><li>è¯»å¤šå†™å¤šçš„åœºæ™¯ï¼Œå¯ä»¥ç›´æ¥æŸ¥ DB</li></ul></li></ul><p>æ€»ç»“ï¼š</p><ul><li>å¸¸è§„æ•°æ®ï¼ˆè¯»å¤šå†™å°‘ï¼Œå³æ—¶æ€§ï¼Œä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„æ•°æ®ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ Spring-Cache</li><li>å†™æ¨¡å¼(åªè¦ç¼“å­˜çš„æ•°æ®æœ‰è¿‡æœŸæ—¶é—´å°±è¶³å¤Ÿäº†)</li><li>ç‰¹æ®Šæ•°æ®è¿›è¡Œç‰¹æ®Šè®¾è®¡</li></ul><h4 id="spring-å•ä¾‹å¹¶å‘é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#spring-å•ä¾‹å¹¶å‘é—®é¢˜"><span>Spring å•ä¾‹å¹¶å‘é—®é¢˜</span></a></h4><p>Spring ä¸­çš„ Bean é»˜è®¤éƒ½æ˜¯å•ä¾‹çš„ï¼ŒSpringä¹Ÿæ²¡æœ‰å¯¹ Bean æœ‰çº¿ç¨‹å®‰å…¨çš„æ§åˆ¶ç­–ç•¥ï¼Œå¹¶å‘å®‰å…¨é—®é¢˜ç”±å¼€å‘å†³å®šã€‚å•ä¾‹ Bean çš„å¹¶å‘å®‰å…¨å–å†³äº Bean æ˜¯æœ‰çŠ¶æ€è¿˜æ˜¯æ— çŠ¶æ€ï¼Œå³æ˜¯å¦æœ‰æ•°æ®å­˜å‚¨åŠŸèƒ½ï¼Œä¾‹å¦‚ User é‡Œé¢å­˜å‚¨äº†ç”¨æˆ·æ•°æ®ã€‚å› æ­¤ä¸åº”æŠŠæœ‰çŠ¶æ€çš„ Bean å®šä¹‰æˆå•ä¾‹ Beanã€‚è¦ä¹ˆä½¿ç”¨ prototype ä½œç”¨åŸŸï¼Œè¦ä¹ˆä½¿ç”¨æœ¬åœ°å˜é‡ ThreadLocalã€‚</p><h4 id="jpa-å–æ¶ˆæŒä¹…åŒ–" tabindex="-1"><a class="header-anchor" href="#jpa-å–æ¶ˆæŒä¹…åŒ–"><span>JPA å–æ¶ˆæŒä¹…åŒ–</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> transient1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // not persistent because of static</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> transient2 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Satish&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // not persistent because of final</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">transient</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> transient3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // not persistent because of transient</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Transient</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> transient4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // not persistent because of @Transient</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åˆ†å¸ƒå¼" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼"><span>åˆ†å¸ƒå¼</span></a></h2><h4 id="æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µ"><span>æ¦‚å¿µ</span></a></h4><ul><li>åˆ†å¸ƒå¼ï¼šæŠŠæ•´ä¸ªç³»ç»Ÿæ‹†åˆ†æˆä¸åŒçš„æœåŠ¡ï¼Œéƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨/é›†ç¾¤ä¸Šå‡è½»å•ä½“æœåŠ¡çš„å‹åŠ›ï¼Œæé«˜å¹¶å‘é‡å’Œæ€§èƒ½ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚</li><li>æ³¨å†Œä¸­å¿ƒï¼šè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åªåœ¨å¯åŠ¨æ—¶ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’ã€‚</li><li>ç›‘æ§ä¸­å¿ƒï¼šè´Ÿè´£ç»Ÿè®¡å„æœåŠ¡è°ƒç”¨æ¬¡æ•°ï¼Œè°ƒç”¨æ—¶é—´ç­‰ã€‚</li><li>è´Ÿè½½å‡è¡¡ï¼šæ”¹å–„è·¨å¤šä¸ªè®¡ç®—èµ„æºçš„å·¥ä½œè´Ÿè½½åˆ†å¸ƒï¼Œæ¥ä¼˜åŒ–èµ„æºä½¿ç”¨ï¼Œæœ€å¤§åŒ–ååé‡ï¼Œæœ€å°åŒ–å“åº”æ—¶é—´ï¼Œå¹¶é¿å…ä»»ä½•å•ä¸ªèµ„æºçš„è¿‡è½½ã€‚</li></ul><h4 id="cap-å’Œ-base" tabindex="-1"><a class="header-anchor" href="#cap-å’Œ-base"><span>CAP å’Œ BASE</span></a></h4><p><strong>CAP ç†è®º</strong></p><p>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåœ¨æ»¡è¶³ P çš„å‰æä¸‹ï¼Œåªèƒ½æ»¡è¶³ APï¼ˆå¦‚ZooKeeperï¼‰æˆ– CPï¼ˆEurekaï¼‰ï¼š</p><ul><li>Consistency: ä¸€è‡´æ€§ï¼Œæ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬</li><li>Availabilityï¼šå¯ç”¨æ€§ï¼Œéæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”</li><li>Partition Toleranceï¼šåˆ†åŒºå®¹é”™æ€§ï¼Œå‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ä»èƒ½å¯¹å¤–æä¾›æœåŠ¡</li></ul><p>åŸå› ï¼šè‹¥ç³»ç»Ÿå‡ºç°åˆ†åŒºï¼Œç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹åœ¨è¿›è¡Œå†™æ“ä½œã€‚ä¸ºäº†ä¿è¯ C ä¸€è‡´æ€§ï¼Œ å¿…é¡»è¦ç¦æ­¢å…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œï¼Œè¿™å°±å’Œ A å¯ç”¨æ€§å‘ç”Ÿå†²çªäº†ã€‚å¦‚æœä¸ºäº†ä¿è¯ A å¯ç”¨æ€§ï¼Œå…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œæ­£å¸¸çš„è¯ï¼Œé‚£å°±å’Œ C ä¸€è‡´æ€§å‘ç”Ÿå†²çªäº†ã€‚å¦‚æœä¸éœ€è¦ä¿è¯ Pï¼Œå³ç½‘ç»œåˆ†åŒºæ­£å¸¸ï¼Œé‚£ä¹ˆ C ä¸€è‡´æ€§å’Œ A å¯ç”¨æ€§å¯ä»¥åŒæ—¶ä¿è¯ã€‚</p><p><strong>BASE ç†è®º</strong></p><p>BASE ç†è®ºæ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä¹Ÿåº”é‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><ul><li>Basically-Available: åŸºæœ¬å¯ç”¨ï¼Œç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼ˆå“åº”æ—¶é—´ä¸Šçš„æŸå¤±/ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±ï¼‰</li><li>Soft-stateï¼šè½¯çŠ¶æ€ï¼Œå…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼ˆå…è®¸ä¸åŒèŠ‚ç‚¹çš„å‰¯æœ¬åŒæ­¥è¿‡ç¨‹å­˜åœ¨å»¶è¿Ÿï¼‰</li><li>Eventually-Consistentï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆè¾¾åˆ°ä¸€è‡´ã€‚</li></ul><p>BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§ C å’Œå¯ç”¨æ€§ A æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œæ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ï¼Œå®ƒå¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„è¦æ±‚ã€‚</p><h4 id="paxos" tabindex="-1"><a class="header-anchor" href="#paxos"><span>Paxos</span></a></h4><p>å…±è¯†ç®—æ³•ï¼šé€šè¿‡ä¿æŒå¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œå³ä½¿é¢å¯¹æ•…éšœï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥åœ¨å…±äº«çŠ¶æ€ä¸Šè¾¾æˆä¸€è‡´ã€‚</p><p>Paxos ç®—æ³•æ˜¯ç¬¬ä¸€ä¸ªè¢«è¯æ˜å®Œå¤‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿå…±è¯†ç®—æ³•ã€‚å…±è¯†ç®—æ³•çš„ä½œç”¨æ˜¯è®©åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´å¯¹æŸä¸ªææ¡ˆï¼ˆProposalï¼‰è¾¾æˆä¸€è‡´çš„çœ‹æ³•ã€‚ä¾‹å¦‚å“ªä¸ªèŠ‚ç‚¹æ˜¯ Leaderã€å¤šä¸ªäº‹ä»¶å‘ç”Ÿçš„é¡ºåºç­‰ã€‚</p><p>Paxos ä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><p><strong>1. Basic Paxos</strong></p><p>å¤šèŠ‚ç‚¹é—´å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆææ¡ˆï¼‰è¾¾æˆå…±è¯†</p><ul><li>Proposerï¼šä¹Ÿç§° Coordinatorï¼Œè´Ÿè´£æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶å‘èµ·ææ¡ˆï¼ˆææ¡ˆç¼–å·ã€æè®®å€¼ï¼‰</li><li>Acceptorï¼šä¹Ÿç§° Voterï¼Œè´Ÿè´£å¯¹æè®®è€…çš„ææ¡ˆè¿›è¡ŒæŠ•ç¥¨ï¼ŒåŒæ—¶éœ€è¦è®°ä½è‡ªå·±çš„æŠ•ç¥¨å†å²</li><li>Learnerï¼šå¦‚æœæœ‰è¶…è¿‡åŠæ•°æ¥å—è€…å°±æŸä¸ªæè®®è¾¾æˆäº†å…±è¯†ï¼Œé‚£ä¹ˆå­¦ä¹ è€…å°±éœ€è¦æ¥å—è¿™ä¸ªæè®®ï¼Œå¹¶å°±è¯¥æè®®ä½œå‡ºè¿ç®—ï¼Œç„¶åå°†è¿ç®—ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p><strong>2. Multi Paxos</strong></p><p>ä¸€ç§æ€æƒ³ï¼Œé€šè¿‡æ‰§è¡Œå¤šä¸ª Basic Paxosï¼Œå°±ä¸€ç³»åˆ—å€¼è¾¾æˆå…±è¯†ã€‚</p><p>é’ˆå¯¹å­˜åœ¨æ¶æ„èŠ‚ç‚¹çš„æƒ…å†µï¼ˆæ‹œå åº­é—®é¢˜ï¼‰ï¼Œä¸€èˆ¬ä½¿ç”¨ PoW å·¥ä½œé‡è¯æ˜ã€PoS æƒç›Šè¯æ˜ ç­‰å…¬å¼ç®—æ³•ã€‚</p><h4 id="raft" tabindex="-1"><a class="header-anchor" href="#raft"><span>Raft</span></a></h4><p><strong>èŠ‚ç‚¹ç±»å‹</strong></p><p>ä¸€ä¸ª Raft é›†ç¾¤åŒ…æ‹¬è‹¥å¹²æœåŠ¡å™¨ï¼Œä»»ä½•æ—¶é—´ç‚¹ï¼Œä»»æ„æœåŠ¡å™¨ä¸€å®šä¼šå¤„äºä»¥ä¸‹ä¸‰ä¸ªçŠ¶æ€ä¸­çš„ä¸€ä¸ªï¼š</p><ul><li>Leader: è´Ÿè´£å‘èµ·å¿ƒè·³ï¼Œå“åº”å®¢æˆ·ç«¯ï¼Œåˆ›å»ºæ—¥å¿—ï¼ŒåŒæ­¥æ—¥å¿—</li><li>Candidate: Leader é€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è§’è‰²ï¼Œç”± Follower è½¬åŒ–è€Œæ¥ï¼Œå‘èµ·æŠ•ç¥¨å‚ä¸ç«é€‰</li><li>Follower: æ¥å— Leader çš„å¿ƒè·³å’Œæ—¥å¿—åŒæ­¥æ•°æ®ï¼ŒæŠ•ç¥¨ç»™ Candidate</li></ul><p>åœ¨æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªæœåŠ¡å™¨æ˜¯ Leaderï¼Œå‰©ä¸‹çš„æœåŠ¡å™¨æ˜¯ Followerã€‚Follower æ˜¯è¢«åŠ¨çš„ï¼Œä¸ä¼šå‘é€ä»»ä½•è¯·æ±‚ï¼Œåªæ˜¯å“åº”æ¥è‡ª Leader å’Œ Candidate çš„è¯·æ±‚ã€‚</p><p><strong>é€‰ä¸¾</strong></p><p>ä»»æœŸï¼šRaft ç®—æ³•å°†æ—¶é—´åˆ’åˆ†ä¸ºä»»æ„é•¿åº¦çš„ä»»æœŸï¼ˆRedis ä¸­çš„é€‰ä¸¾è½®æ¬¡ï¼‰ï¼Œç”¨è¿ç»­çš„æ•°å­—è¡¨ç¤ºã€‚æ¯ä¸ªä»»æœŸéƒ½ä»¥ä¸€æ¬¡é€‰ä¸¾å¼€å§‹ã€‚</p><p>Raft ä½¿ç”¨å¿ƒè·³æœºåˆ¶æ¥è§¦å‘ Leader çš„é€‰ä¸¾ã€‚</p><ul><li>Leader é€šè¿‡å¿ƒè·³ä¿æŒ Leader çŠ¶æ€</li><li>Follower é€šè¿‡å¿ƒè·³ä¿æŒä¸º Follower çŠ¶æ€ï¼Œå¹¶ç¡®è®¤ Leader</li><li>å¦‚æœ Follower åœ¨ä¸€ä¸ªå‘¨æœŸå†…æ²¡æ”¶åˆ°å¿ƒè·³ï¼Œå°†å¼€å§‹ä¸€æ¬¡é€‰ä¸¾ <ul><li>è‡ªå¢è‡ªå·±çš„ term å¹¶è½¬æ¢ä¸º Candidateï¼Œå‘å…¶ä»–èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨</li><li>å¦‚æœè¶…è¿‡åŠæ•°èŠ‚ç‚¹æŠ•ç¥¨ç»™è‡ªå·±ï¼Œåˆ™æˆä¸º Leader</li><li>æœŸé—´ï¼Œå¦‚æœæ”¶åˆ°å…¶å®ƒèŠ‚ç‚¹å£°æ˜ Leader çš„å¿ƒè·³ï¼Œä¸” term å·å¤§äºç­‰äºè‡ªå·±çš„ termï¼Œåˆ™é€€å› Followerï¼Œå¦åˆ™æ‹’ç»è¯¥è¯·æ±‚å¹¶è®©è¯¥èŠ‚ç‚¹æ›´æ–°</li><li>å¦‚æœé€‰ä¸¾å¤±è´¥ï¼Œéšæœºä¸€ä¸ªæ–°çš„è¶…æ—¶æ—¶é—´ï¼Œä¹‹åé‡æ–°é€‰ä¸¾</li></ul></li></ul><p><strong>æ—¥å¿—å¤åˆ¶</strong></p><ul><li>Entryï¼š<code>&lt;term, index, cmd&gt;</code>çš„ç»“æ„ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶æˆä¸º entryï¼Œåªæœ‰ Leader å¯ä»¥åˆ›å»º entryã€‚</li><li>Logï¼šæœ‰ Entry æ„æˆçš„æ•°ç»„ï¼Œåªæœ‰ Leader æ‰å¯ä»¥æ”¹å˜å…¶ä»–èŠ‚ç‚¹çš„ logã€‚</li></ul><p>Leader æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œä¼šç”Ÿæˆä¸€ä¸ª entryï¼Œæ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—æœ«å°¾ï¼Œå¹¶å¹¿æ’­ç»™å…¶å®ƒæœåŠ¡å™¨ï¼Œå¦‚æœæ”¶åˆ°è¶…è¿‡åŠæ•°çš„æˆåŠŸå“åº”ï¼Œæ ‡è®°è¿™ä¸ª entry æ˜¯ committed çš„ã€‚Leader é€šè¿‡å¼ºåˆ¶ Follower å¤åˆ¶è‡ªå·±çš„æ—¥å¿—æ¥å¤„ç†æ—¥å¿—çš„ä¸ä¸€è‡´ã€‚</p><h4 id="api-ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#api-ç½‘å…³"><span>API ç½‘å…³</span></a></h4><p>ä¸»è¦åŠŸèƒ½ï¼šè¯·æ±‚è½¬å‘ã€è¯·æ±‚è¿‡æ»¤<br>åŸºäºè¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œç»§è€Œå®ç° å®‰å…¨è®¤è¯ã€æµé‡æ§åˆ¶ã€æ—¥å¿—ã€ç›‘æ§...</p><p>å¸¸è§ç½‘å…³ï¼šNetflix Zuul, Spring Cloud Gateway, Kong, APISIX, Shenyu...</p><h4 id="åˆ†å¸ƒå¼-id" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼-id"><span>åˆ†å¸ƒå¼ ID</span></a></h4><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„æ•°æ®èŠ‚ç‚¹è¦ä¸ºæ•°æ®ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”®ï¼Œä¹Ÿå³åˆ†å¸ƒå¼IDï¼Œéœ€è¦æ»¡è¶³ï¼š</p><ul><li>å…¨å±€å”¯ä¸€</li><li>é«˜æ€§èƒ½</li><li>é«˜å¯ç”¨</li><li>æ–¹ä¾¿æ˜“ç”¨</li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜åº”ä¿è¯å®‰å…¨ã€æœ‰åºé€’å¢ã€æœ‰å…·ä½“ä¸šåŠ¡å«ä¹‰ã€ç‹¬ç«‹éƒ¨ç½²</p><p><strong>å¸¸è§è§£å†³æ–¹æ¡ˆ</strong></p><ol><li>æ•°æ®åº“ä¸»é”®è‡ªå¢ï¼šå®ç°ç®€å•ï¼Œä½†å¾ˆå¤šç¼ºç‚¹</li><li>æ•°æ®åº“å·æ®µæ¨¡å¼ï¼šæ‰¹é‡è·å– IDï¼Œå­˜å…¥å†…å­˜ï¼Œéœ€è¦æ—¶å–ç”¨ã€‚</li><li>NoSQLï¼šä¾‹å¦‚åˆ©ç”¨ Redis Clusterå®ç° id åŸå­é€’å¢</li><li>UUID ç®—æ³•ï¼šåŸºäº MAC åœ°å€ã€æ—¶é—´æˆ³ã€å‘½åç©ºé—´ã€éšæœºæ•°ç­‰ä¿¡æ¯ç”Ÿæˆå”¯ä¸€ IDã€‚ä½†å ç”¨å­˜å‚¨ç©ºé—´è¿‡å¤§ï¼Œä¸”æ— åºï¼Œå½±å“DBæ€§èƒ½</li><li>Snowflake ç®—æ³•ï¼šé›ªèŠ±ç®—æ³•ï¼Œçµæ´»æœ‰åºã€‚ä½†å¦‚æœæœºå™¨æ—¶é—´ä¸æ­£ç¡®å¯èƒ½äº§ç”Ÿé‡å¤IDã€‚</li></ol><p>å¼€æºæ–¹æ¡ˆä¾‹å¦‚ ç™¾åº¦çš„ UidGeneratorï¼Œç¾å›¢çš„ Leafï¼Œæ»´æ»´çš„ Tinyid</p><h4 id="rpc" tabindex="-1"><a class="header-anchor" href="#rpc"><span>RPC</span></a></h4><p>RPCï¼ŒRemote Procedure Call è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œé€šè¿‡ç½‘ç»œç¼–ç¨‹å®ç°ä¸åŒæœåŠ¡å™¨ä¸Šçš„æ–¹æ³•è°ƒç”¨ã€‚</p><p>æ ¸å¿ƒåŠŸèƒ½çš„å®ç°ç”±ä»¥ä¸‹äº”ä¸ªéƒ¨åˆ†å®ç°ï¼š</p><ol><li>å®¢æˆ·ç«¯ï¼ˆæœåŠ¡æ¶ˆè´¹ç«¯ï¼‰ï¼šè°ƒç”¨è¿œç¨‹æ–¹æ³•çš„ä¸€ç«¯</li><li>å®¢æˆ·ç«¯ Stubï¼ˆæ¡©ï¼‰ï¼š æœ¬è´¨ä¸Šæ˜¯ä»£ç†ç±»ï¼ŒæŠŠè°ƒç”¨çš„ç±»ã€æ–¹æ³•ã€å‚æ•°ç­‰ä¿¡æ¯ä¼ é€’åˆ°æœåŠ¡ç«¯ï¼ˆåºåˆ—åŒ–/ååºåˆ—åŒ– + æ¥æ”¶/å‘é€ï¼‰</li><li>ç½‘ç»œä¼ è¾“ï¼š å°†è°ƒç”¨ä¿¡æ¯ä¼ è¾“åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ‰§è¡Œå®Œåé€šè¿‡ç½‘ç»œæŠŠç»“æœå†ä¼ è¾“å›æ¥ã€‚å®ç°æ–¹å¼æ¯”å¦‚æœ€åŸºæœ¬çš„ Socketã€æ€§èƒ½ä»¥åŠå°è£…æ›´ä¼˜ç§€çš„ Netty</li><li>æœåŠ¡ç«¯ Stubï¼ˆæ¡©ï¼‰ï¼šæŒ‡æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ‰§è¡Œè¯·æ±‚åï¼Œè°ƒç”¨å¤„ç†å™¨ç„¶åè¿”å›ç»“æœç»™å®¢æˆ·ç«¯çš„ç±»ï¼ˆåºåˆ—åŒ–/ååºåˆ—åŒ– + æ¥æ”¶/å‘é€ï¼‰</li><li>æœåŠ¡ç«¯ï¼ˆæœåŠ¡æä¾›ç«¯ï¼‰ï¼šæä¾›è¿œç¨‹æ–¹æ³•çš„ä¸€ç«¯</li></ol><p><strong>HTTP å’Œ RPC</strong></p><p>çº¯è£¸ TCP æ˜¯èƒ½æ”¶å‘æ•°æ®ï¼Œä½†å®ƒæ˜¯ä¸ªæ— è¾¹ç•Œçš„æ•°æ®æµï¼Œä¸Šå±‚éœ€è¦å®šä¹‰æ¶ˆæ¯æ ¼å¼ç”¨äºå®šä¹‰æ¶ˆæ¯è¾¹ç•Œã€‚äºæ˜¯å°±æœ‰äº†å„ç§åè®®ï¼ŒHTTP å’Œå„ç±» RPC åè®®å°±æ˜¯åœ¨ TCP ä¹‹ä¸Šå®šä¹‰çš„åº”ç”¨å±‚åè®®ã€‚RPCæœ¬è´¨ä¸Šæ˜¯ä¸€ç§è°ƒç”¨æ–¹å¼ï¼Œå…·ä½“çš„å®ç° gRPC/Thrift æ‰æ˜¯åè®®ï¼Œç›®çš„æ˜¯å¸Œæœ›ç¨‹åºå‘˜èƒ½åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•é‚£æ ·å»è°ƒç”¨è¿œç«¯çš„æœåŠ¡æ–¹æ³•ã€‚RPCä¹Ÿä¸ä¸€å®šéå¾—åŸºäºTCPã€‚</p><p>åŒºåˆ«ï¼š</p><ul><li>æœåŠ¡å‘ç°ï¼šRPCä¸€èˆ¬æœ‰ä¸“é—¨çš„ä¸­é—´æœåŠ¡ä¿å­˜æœåŠ¡åå’ŒIPä¿¡æ¯ï¼ˆHTTPå½“ç„¶ä¹Ÿèƒ½å®ç°ï¼‰</li><li>åº•å±‚è¿æ¥å½¢å¼ï¼šRPCä½¿ç”¨è¿æ¥æ± </li><li>ä¼ è¾“å†…å®¹ï¼šHTTPæŠ¥æ–‡éå¸¸å†—ä½™ï¼Œè€ŒRPCå®šåˆ¶åŒ–ç¨‹åº¦é«˜ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ã€‚æ˜¯å†…éƒ¨ç½‘ç»œä½¿ç”¨RPCçš„ä¸»è¦åŸå› </li></ul><p>å½“ç„¶HTTP/2é€šè¿‡å‹ç¼©åšäº†å¾ˆå¤šæ”¹è¿›ï¼Œç”šè‡³ä¼˜äºRPCï¼Œä½†ç”±äºå†å²åŸå› ï¼ŒRPCä»åœ¨ä½¿ç”¨ã€‚</p><h2 id="æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—"><span>æ¶ˆæ¯é˜Ÿåˆ—</span></a></h2><h3 id="åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><p>ä¸­é—´ä»¶ï¼šä¸€ç±»æä¾›ç³»ç»Ÿè½¯ä»¶å’Œåº”ç”¨è½¯ä»¶ä¹‹é—´è¿æ¥ã€ä¾¿äºè½¯ä»¶å„éƒ¨ä»¶ä¹‹é—´çš„æ²Ÿé€šçš„è½¯ä»¶ï¼Œåº”ç”¨è½¯ä»¶å¯ä»¥å€ŸåŠ©ä¸­é—´ä»¶åœ¨ä¸åŒçš„æŠ€æœ¯æ¶æ„ä¹‹é—´å…±äº«ä¿¡æ¯ä¸èµ„æºã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜æ”¾æ¶ˆæ¯çš„å®¹å™¨ï¼ŒFIFO æŒ‰åºæ¶ˆè´¹ã€‚å‚ä¸æ¶ˆæ¯ä¼ é€’çš„åŒæ–¹ç§°ä¸º ç”Ÿäº§è€… å’Œ æ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¶ˆæ¯ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>å¼‚æ­¥å¤„ç†ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œå‡å°‘å“åº”æ—¶é—´</li><li>å‰Šå³°/é™æµ</li><li>é™ä½ç³»ç»Ÿè€¦åˆæ€§</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>ç³»ç»Ÿå¯ç”¨æ€§é™ä½ï¼šä¾‹å¦‚æ¶ˆæ¯ä¸¢å¤±ï¼ŒMQå®•æœºç­‰é—®é¢˜</li><li>ç³»ç»Ÿå¤æ‚æ€§æé«˜ï¼šéœ€è¦ä¿è¯æ— é‡å¤æ¶ˆè´¹ã€æ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯ä¼ é€’é¡ºåºæ€§ç­‰é—®é¢˜</li><li>ä¸€è‡´æ€§é—®é¢˜ï¼šæ¶ˆè´¹è€…æ²¡æœ‰æ­£ç¡®æ¶ˆè´¹æ¶ˆæ¯çš„æƒ…å†µ</li></ul><p><strong>JMS</strong><br>Java Message Service Javaæ¶ˆæ¯æœåŠ¡çš„ä¸€å¥— API è§„èŒƒã€‚ä¾‹å¦‚ ActiveMQ</p><ul><li>æ¶ˆæ¯æ ¼å¼ï¼šStreamMessage, MapMessage, TextMessage, ObjectMessage, BytesMessage</li><li>æ¶ˆæ¯æ¨¡å‹ï¼šP2P ç‚¹å¯¹ç‚¹ã€PubSub è®¢é˜…æ¨¡å‹</li></ul><p><strong>AMQP</strong><br>Advanced Message Queuing Protocol é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œåº”ç”¨å±‚é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶å¼€å‘æ ‡å‡†åè®®ï¼Œæ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ï¼Œå…¼å®¹ JMSã€‚ä¾‹å¦‚ RabbitMQ</p><ul><li>ä»…æ”¯æŒ byte[] æ¶ˆæ¯ç±»å‹</li><li>åŸºäº Exchange æä¾›çš„è·¯ç”±ç®—æ³•ï¼Œæä¾›å¤šç§æ¶ˆæ¯æ¨¡å‹ï¼Œä¾‹å¦‚ direct exchange, fanout exchange, topic change, headers exchange, system exchange</li></ul><p><strong>å¸¸è§ MQ</strong></p><p>Kafkaã€RocketMQã€RabbitMQã€Pulsar</p><h3 id="kafka" tabindex="-1"><a class="header-anchor" href="#kafka"><span>Kafka</span></a></h3><p>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¼å¤„ç†å¹³å°ï¼Œç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—å’Œæ•°æ®å¤„ç†ã€‚æœ‰ä¸‰ä¸ªå…³é”®åŠŸèƒ½ï¼š</p><ol><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯æµï¼Œè¿™ä¸ªåŠŸèƒ½ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿæ˜¯ Kafka ä¹Ÿè¢«å½’ç±»ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„åŸå› ã€‚</li><li>å®¹é”™çš„æŒä¹…æ–¹å¼å­˜å‚¨è®°å½•æ¶ˆæ¯æµï¼š Kafka ä¼šæŠŠæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæœ‰æ•ˆé¿å…äº†æ¶ˆæ¯ä¸¢å¤±çš„é£é™©ã€‚</li><li>æµå¼å¤„ç†å¹³å°ï¼š åœ¨æ¶ˆæ¯å‘å¸ƒçš„æ—¶å€™è¿›è¡Œå¤„ç†ï¼ŒKafka æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æµå¼å¤„ç†ç±»åº“ã€‚</li></ol><p>ä¼˜ç‚¹ï¼šæè‡´çš„æ€§èƒ½ã€ç”Ÿæ€å…¼å®¹æ€§</p><p><strong>æ¶ˆæ¯æ¨¡å‹</strong></p><ul><li>é˜Ÿåˆ—æ¨¡å‹</li><li>PubSub å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼šä½¿ç”¨ Topic ä½œä¸ºæ¶ˆæ¯é€šä¿¡è½½ä½“ï¼Œå¹¿æ’­ç»™è®¢é˜…è€…</li></ul><p><strong>æ¦‚å¿µæ¨¡å‹</strong></p><ul><li>Consumer</li><li>Producer</li><li>Brokerï¼šä»£ç†ï¼Œä¸€ä¸ªç‹¬ç«‹çš„ Kafka å®ä¾‹ï¼Œå¤šä¸ª Broker ç»„æˆ Cluster</li><li>Topicï¼šä¸»é¢˜ï¼ŒProducer å‘é€æ¶ˆæ¯åˆ°ç‰¹å®šä¸»é¢˜ï¼ŒConsumer è®¢é˜…ç‰¹å®šä¸»é¢˜çš„æ¶ˆæ¯</li><li>Partition: Topic çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ª Topic å¯ä»¥æœ‰å¤šä¸ª Partition ï¼Œå¹¶ä¸”åŒä¸€ Topic ä¸‹çš„ Partition å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„ Broker ä¸Šï¼Œè¿™ä¹Ÿå°±è¡¨æ˜ä¸€ä¸ª Topic å¯ä»¥æ¨ªè·¨å¤šä¸ª Broker</li></ul><h3 id="rabbitmq" tabindex="-1"><a class="header-anchor" href="#rabbitmq"><span>RabbitMQ</span></a></h3><h4 id="æ¦‚å¿µ-1" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µ-1"><span>æ¦‚å¿µ</span></a></h4><p>RabbitMQ æ˜¯ä½¿ç”¨ Erlang è¯­è¨€å®ç°çš„ AMQP Â æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ•´ä½“ä¸Šæ˜¯ä¸€ä¸ªç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä¸»è¦è´Ÿè´£æ¥æ”¶ã€å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯ã€‚</p><p><img src="/img/RabbitMQ%E6%A8%A1%E5%9E%8B.jpg#id=q62UK&amp;originHeight=306&amp;originWidth=687&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>æ¶ˆæ¯</strong></p><ul><li>æ¶ˆæ¯å¤´ï¼šä¸€ç³»åˆ—å¯é€‰å±æ€§ï¼Œä¹Ÿå«æ ‡ç­¾ã€‚ä¾‹å¦‚ routing-key è·¯ç”±é”®, priority ä¼˜å…ˆæƒï¼Œdelivery-mode æŒä¹…æ€§å­˜å‚¨...</li><li>æ¶ˆæ¯ä½“ï¼špayload</li></ul><p><strong>Exchange äº¤æ¢æœº</strong></p><p>RabbitMQ ä¸­æ¶ˆæ¯å¿…é¡»å…ˆç»è¿‡ Exchangeï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™åˆ†é…åˆ°å¯¹åº”çš„ Queueã€‚å¦‚æœè·¯ç”±ä¸åˆ°ï¼Œå¯èƒ½è¿”å›ç»™ Producer æˆ–ç›´æ¥ä¸¢å¼ƒã€‚</p><p>RabbitMQ é€šè¿‡ Binding å°† Exchange å’Œ Queue ç»‘å®šå…³è”ï¼Œå¹¶æŒ‡å®šä¸€ä¸ª BindingKey ä½œä¸ºè·¯ç”±è§„åˆ™ã€‚Producer å‘é€æ¶ˆæ¯æ—¶éœ€è¦æŒ‡å®š RoutingKeyï¼Œä¸ BindingKey åŒ¹é…æ—¶å°±ä¼šè·¯ç”±åˆ°å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å¤šä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°åŒä¸€ä¸ª Exchange å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ BindingKeyï¼Œå…·ä½“è·¯ç”±è¿˜ä¾èµ–äºäº¤æ¢å™¨ç±»å‹ã€‚</p><p>åˆ†å››ç§ç±»å‹ï¼š</p><ul><li>directï¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£äº› Bindingkey ä¸ RoutingKey å®Œå…¨åŒ¹é…çš„ Queue ä¸­ã€‚å¸¸ç”¨äºå¤„ç†æœ‰ä¼˜å…ˆçº§çš„ä»»åŠ¡</li><li>fanoutï¼šæŠŠå‘é€åˆ°è¯¥ Exchange çš„æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸å®ƒç»‘å®šçš„ Queue ä¸­ï¼Œä¸éœ€è¦ä»»ä½•åˆ¤æ–­ï¼Œå› æ­¤é€Ÿåº¦æœ€å¿«</li><li>topicï¼šå°†æ¶ˆæ¯è·¯ç”±åˆ° BindingKey å’Œ RoutingKey ç›¸åŒ¹é…çš„é˜Ÿåˆ—ä¸­ï¼Œä¾‹å¦‚ * åŒ¹é…ä¸€ä¸ªå•è¯ï¼Œ# åŒ¹é…é›¶/å¤šä¸ªå•è¯</li><li>headersï¼šè·¯ç”±è§„åˆ™ä¸ä¾èµ–äºè·¯ç”±é”®çš„åŒ¹é…è§„åˆ™ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„ headers å±æ€§è¿›è¡ŒåŒ¹é…ï¼Œå®Œå…¨åŒ¹é…æ‰ä¼šè·¯ç”±</li></ul><p>å› æ­¤ï¼ŒRabbitMQ å·¥ä½œæ¨¡å¼æœ‰ ç®€å•æ¨¡å¼ã€work å·¥ä½œæ¨¡å¼ã€PubSub æ¨¡å¼ã€Routing è·¯ç”±æ¨¡å¼ã€Topic ä¸»é¢˜æ¨¡å¼</p><p><strong>Queue æ¶ˆæ¯é˜Ÿåˆ—</strong></p><p>Queue ç”¨æ¥ä¿å­˜æ¶ˆæ¯ï¼Œç›´åˆ°å‘é€ç»™æ¶ˆè´¹è€…ï¼Œä¸€ä¸ªæ¶ˆæ¯å¯ä»¥æŠ•å…¥ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚</p><p>å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™æ—¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šè¢«å¹³å‡åˆ†æ‘Šï¼ˆRound-Robinï¼Œå³è½®è¯¢ï¼‰ç»™å¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯å¹¶å¤„ç†ï¼Œè¿™æ ·é¿å…æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹ã€‚</p><p><strong>Broker æœåŠ¡èŠ‚ç‚¹</strong></p><p>ä¸€ä¸ª RabbitMQ å®ä¾‹å¯ä»¥çœ‹ä½œä¸€ä¸ª Brokerã€‚</p><h4 id="å¸¸è§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é—®é¢˜"><span>å¸¸è§é—®é¢˜</span></a></h4><ol><li>æ­»ä¿¡é˜Ÿåˆ—<br>Dead-Letter-Exchange ç§ä¿¡äº¤æ¢æœº/æ­»ä¿¡é˜Ÿåˆ—ï¼Œå½“æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡(dead message)ä¹‹åï¼Œå®ƒèƒ½é‡æ–°è¢«å‘é€åˆ°å¦ä¸€ä¸ªäº¤æ¢å™¨ä¸­ï¼Œè¿™ä¸ªäº¤æ¢å™¨å°±æ˜¯ DLXï¼Œç»‘å®š DLX çš„é˜Ÿåˆ—å°±ç§°ä¹‹ä¸ºæ­»ä¿¡é˜Ÿåˆ—ã€‚</li></ol><p>å¯¼è‡´æ­»ä¿¡çš„åŸå› ï¼š</p><ul><li>æ¶ˆæ¯è¢«æ‹’ï¼ˆBasic.Reject/Basic.Nackï¼‰ä¸” requeue = false</li><li>æ¶ˆæ¯ TTL è¿‡æœŸ</li><li>é˜Ÿåˆ—æ»¡äº†æ— æ³•æ·»åŠ </li></ul><ol start="2"><li>å»¶è¿Ÿé˜Ÿåˆ—<br>RabbitMQ æœ¬èº«ä¸æ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—ï¼Œä½†åˆä¸¤ç§å®ç°æ–¹å¼ï¼š</li></ol><ul><li>åˆ©ç”¨æ­»ä¿¡äº¤æ¢æœºå’Œæ¶ˆæ¯çš„å­˜æ´»æ—¶é—´ TTL æ¨¡æ‹Ÿå»¶è¿Ÿ</li><li>æ’ä»¶ rabbitmq-delayed-message-exchange</li></ul><ol start="3"><li>ä¼˜å…ˆçº§é˜Ÿåˆ—</li></ol><p>å¯ä»¥é€šè¿‡ x-max-priority å‚æ•°å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ä¸è¿‡ï¼Œå½“æ¶ˆè´¹é€Ÿåº¦å¤§äºç”Ÿäº§é€Ÿåº¦ä¸” Broker æ²¡æœ‰å †ç§¯çš„æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§æ˜¾å¾—æ²¡æœ‰æ„ä¹‰ã€‚</p><ol start="4"><li>æ¶ˆæ¯ä¼ è¾“</li></ol><p>RabbitMQ ä½¿ç”¨ä¿¡é“ Channel æ¥ä¼ è¾“æ•°æ®ï¼Œä¿¡é“æ˜¯å»ºç«‹åœ¨ TCP è¿æ¥ä¸Šçš„è™šæ‹Ÿè¿æ¥ï¼Œä¸€æ¡ TCP è¿æ¥ä¸Šå¯ä»¥æœ‰ä¸Šåƒæ¡ä¿¡é“å¤ç”¨ï¼Œæ¯æ¡ä¿¡é“éƒ½æœ‰å”¯ä¸€IDï¼Œå¹¶ä¸”å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚</p><ol start="5"><li>ä¿è¯æ¶ˆæ¯å¯é æ€§</li></ol><ul><li>Producer åˆ° RabbitMQï¼šäº‹åŠ¡æœºåˆ¶ æˆ– Confirm æœºåˆ¶</li><li>RabbitMQ ä¸­ï¼šæŒä¹…åŒ–ã€é›†ç¾¤ã€æ™®é€šæ¨¡å¼ã€é•œåƒæ¨¡å¼</li><li>RabbitMQ åˆ° Consumerï¼šbasicAck æœºåˆ¶ã€æ­»ä¿¡é˜Ÿåˆ—ã€æ¶ˆæ¯è¡¥å¿æœºåˆ¶</li></ul><ol start="6"><li>ä¿è¯æ¶ˆæ¯é¡ºåºæ€§</li></ol><ul><li>æ‹†åˆ†å¤šä¸ª Queueï¼Œæ¯ä¸ª Queue ä¸€ä¸ªæ¶ˆè´¹è€…</li><li>Consumer å†…éƒ¨ç”¨é˜Ÿåˆ—æ’é˜Ÿï¼Œåˆ†å‘ç»™åº•å±‚ä¸åŒçš„ worker å¤„ç†</li></ul><ol start="7"><li>ä¿è¯é«˜å¯ç”¨<br>RabbitMQ åŸºäºä¸»ä»åšé«˜å¯ç”¨ï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š</li></ol><ul><li>å•æœºæ¨¡å¼ï¼šç”Ÿäº§ç¯å¢ƒä¸ç”¨</li><li>æ™®é€šé›†ç¾¤ï¼šå¤šå°æœºå™¨å¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œåˆ›å»ºçš„ Queue åªæ”¾åœ¨ä¸€ä¸ªå®ä¾‹ä¸Šï¼Œå®ä¾‹ä¹‹é—´åŒæ­¥ Queue çš„å…ƒæ•°æ®ï¼Œä»¥æ‰¾åˆ° Queue æ‰€åœ¨çš„å®ä¾‹</li><li>é•œåƒé›†ç¾¤ï¼šåˆ›å»º Queue å­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Šï¼Œæ¯æ¬¡å†™æ¶ˆæ¯åˆ° Quee éƒ½ä¼šåŒæ­¥åˆ°æ‰€æœ‰å®ä¾‹ã€‚ç¼ºç‚¹å°±æ˜¯æ€§èƒ½å¼€é”€å¤§ï¼Œç½‘ç»œå‹åŠ›é‡</li></ul><h2 id="å¼€å‘å·¥å…·" tabindex="-1"><a class="header-anchor" href="#å¼€å‘å·¥å…·"><span>å¼€å‘å·¥å…·</span></a></h2><h3 id="linux" tabindex="-1"><a class="header-anchor" href="#linux"><span>Linux</span></a></h3><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># æ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿›ç¨‹IDã€å†…å­˜å ç”¨ç‡ã€CPUå ç”¨ç‡ç­‰</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">top</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">è¿›ç¨‹</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">å·&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">-u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ç”¨æˆ·</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">å&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ps</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ef</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼Œä¾‹å¦‚ -9 SIGKILL</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">kill</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pid</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># å¯åŠ¨/åœæ­¢/é‡å¯/é‡æ–°åŠ è½½é…ç½® ä¸€ä¸ªUnitæœåŠ¡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">restart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">reload</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">free</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # å¯ç”¨å†…å­˜å’Œå·²ä½¿ç”¨æƒ…å†µ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vmstat</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # è™šæ‹Ÿå†…å­˜ç»Ÿè®¡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">df</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # æ–‡ä»¶ç³»ç»Ÿç£ç›˜ç©ºé—´å ç”¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">iostat</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # IO ç»Ÿè®¡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ifstat</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # ç»Ÿè®¡ç½‘ç»œæ¥å£æµé‡çŠ¶æ€</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># é€’å½’ä¿®æ”¹æ–‡ä»¶æƒé™</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">chmod</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -R</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 777</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dir</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># æŸ¥çœ‹ç½‘ç»œé…åˆå’Œæ”¶å‘æ•°æ®åŒ…çš„ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ifconfig/ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># æŸ¥çœ‹ socketã€ç½‘ç»œåè®®æ ˆã€ç½‘å£ã€è·¯ç”±è¡¨ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ss/netstat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># æŸ¥çœ‹å½“å‰ç½‘ç»œçš„ååç‡å’Œ PPS</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sar</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># secure copy è¿œç¨‹å®‰å…¨æ‹·è´</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> local_file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> remote_username@remote_ip:remote_file</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ç»Ÿè®¡è¡Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -l</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># æ—¥å¿—å¤„ç† (awk å¤„ç†æ–‡æœ¬ -&gt; æ’åº -&gt; å»é‡ç»Ÿè®¡ -&gt; ç»Ÿè®¡ç»“æœé€†åº -&gt; top 3)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">awk</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;{print substr($4, 2, 11)}&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> access.log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">uniq</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sort</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -rn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">head</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ä»¥ 6 ä¸ªçº¿ç¨‹ï¼Œ3 ä¸‡ä¸ªè¿æ¥ï¼ŒæŒç»­ 60s å¯¹ç›®æ ‡è¿›è¡Œå‹æµ‹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wrk</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -t</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 30000</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 60s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://xxx:8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="maven" tabindex="-1"><a class="header-anchor" href="#maven"><span>Maven</span></a></h3><p><strong>ä½œç”¨</strong></p><ol><li>é¡¹ç›®æ„å»ºï¼šæä¾›æ ‡å‡†çš„ã€è·¨å¹³å°çš„è‡ªåŠ¨åŒ–é¡¹ç›®æ„å»ºæ–¹å¼ã€‚</li><li>ä¾èµ–ç®¡ç†ï¼šæ–¹ä¾¿å¿«æ·çš„ç®¡ç†é¡¹ç›®ä¾èµ–çš„èµ„æºï¼ˆjar åŒ…ï¼‰ï¼Œé¿å…èµ„æºé—´çš„ç‰ˆæœ¬å†²çªé—®é¢˜ã€‚</li><li>ç»Ÿä¸€å¼€å‘ç»“æ„ï¼šæä¾›æ ‡å‡†çš„ã€ç»Ÿä¸€çš„é¡¹ç›®ç»“æ„ã€‚</li></ol><p><strong>åæ ‡</strong></p><ul><li>groupIdï¼šé¡¹ç›®éš¶å±çš„ç»„ç»‡æˆ–å…¬å¸</li><li>artifactIdï¼šé¡¹ç›®çš„åç§°</li><li>version</li><li>å…¶å®ƒå¯é€‰ï¼špackagingï¼ˆjar/war/...ï¼‰ã€classifier</li></ul><p><strong>ä¾èµ–èŒƒå›´</strong><br>ä¸‰å¥—ä¸åŒçš„classpathï¼š</p><ul><li>ç¼–è¯‘ classpath ï¼šç¼–è¯‘ä¸»ä»£ç æœ‰æ•ˆ</li><li>æµ‹è¯• classpath ï¼šç¼–è¯‘ã€è¿è¡Œæµ‹è¯•ä»£ç æœ‰æ•ˆ</li><li>è¿è¡Œ classpath ï¼šé¡¹ç›®è¿è¡Œæ—¶æœ‰æ•ˆ</li></ul><p>ä¸åŒçš„ä¾èµ–èŒƒå›´ï¼š</p><ul><li>compileï¼šé»˜è®¤ï¼Œå¯¹ç¼–è¯‘ã€æµ‹è¯•ã€è¿è¡Œéƒ½æœ‰æ•ˆ</li><li>providedï¼šå¯¹ç¼–è¯‘ã€æµ‹è¯•æœ‰æ•ˆï¼Œå¦‚Servlet</li><li>testï¼šä»…ç”¨äºæµ‹è¯•ï¼Œå¦‚JUnit</li><li>runtimeï¼šä»…ç”¨äºè¿è¡Œï¼Œå¦‚JDBC Driver</li><li>systemï¼šå¿…é¡»é€šè¿‡systemPathæŒ‡å®šï¼Œä¸ä¾èµ–Maven</li></ul><p><strong>ä¾èµ–å†²çª</strong><br>éµå¾ª è·¯å¾„æœ€çŸ­ä¼˜å…ˆ -&gt; å£°æ˜é¡ºåºä¼˜å…ˆ ä¸¤å¤§åŸåˆ™ã€‚</p><p><code>&lt;exception&gt;</code> æ‰‹åŠ¨æ’é™¤ä¾èµ–</p><p><strong>Maven ä»“åº“</strong><br>é™¤äº†æœ¬åœ°ä»“åº“ï¼Œè¿œç¨‹ä»“åº“åˆ†ä¸‰ç±»ï¼š</p><ul><li>ä¸­å¤®ä»“åº“ï¼šMaven ç¤¾åŒºç»´æŠ¤</li><li>ç§æœï¼šè®¾åœ¨å±€åŸŸç½‘å†…çš„ä»“åº“æœåŠ¡</li><li>å…¶å®ƒå…¬å…±ä»“åº“ï¼šç”¨äºåŠ é€Ÿè®¿é—®ï¼Œæˆ–éƒ¨åˆ†æ„ä»¶ä¸å­˜åœ¨äºä¸­å¤®ä»“åº“</li></ul><p>ä¾èµ–æŸ¥æ‰¾é¡ºåºï¼šæœ¬åœ°ä»“åº“ -&gt; è¿œç¨‹ä»“åº“ -&gt; æŠ¥é”™</p><p><strong>ç”Ÿå‘½å‘¨æœŸ</strong></p><ul><li>default</li><li>clean</li><li>site</li></ul><p>æ¯ä¸ªç”Ÿå‘½å‘¨æœŸé‡ŒåŒ…å«å¤šä¸ªé˜¶æ®µï¼Œé˜¶æ®µé—´å‰åä¾èµ–ï¼Œå½“æ‰§è¡ŒæŸä¸ªé˜¶æ®µçš„æ—¶å€™ï¼Œä¼šå…ˆæ‰§è¡Œå®ƒå‰é¢çš„é˜¶æ®µã€‚</p><p><strong>å¤šæ¨¡å—ç®¡ç†</strong></p><ul><li>é™ä½ä»£ç ä¹‹é—´çš„è€¦åˆæ€§ï¼ˆä»ç±»çº§åˆ«çš„è€¦åˆæå‡åˆ° jar åŒ…çº§åˆ«çš„è€¦åˆï¼‰</li><li>å‡å°‘é‡å¤ï¼Œæå‡å¤ç”¨æ€§</li><li>æ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥æ˜¯è‡ªè§£é‡Šçš„ï¼ˆé€šè¿‡æ¨¡å—åæˆ–è€…æ¨¡å—æ–‡æ¡£ï¼‰</li><li>æ¨¡å—è¿˜è§„èŒƒäº†ä»£ç è¾¹ç•Œçš„åˆ’åˆ†ï¼Œå¼€å‘è€…å¾ˆå®¹æ˜“é€šè¿‡æ¨¡å—ç¡®å®šè‡ªå·±æ‰€è´Ÿè´£çš„å†…å®¹</li></ul><h3 id="git" tabindex="-1"><a class="header-anchor" href="#git"><span>Git</span></a></h3><p>Git ä¸åŒä¸å…¶å®ƒç‰ˆæœ¬æ§åˆ¶è®°å½•æ–‡ä»¶ä¿®æ”¹çš„å¢é‡ï¼Œè€Œæ˜¯ç›´æ¥ä¿å­˜ä¿®æ”¹æ–‡ä»¶çš„å¿«ç…§ã€‚</p><p><strong>æ–‡ä»¶ä¸‰ç§çŠ¶æ€</strong></p><ul><li>å·²æäº¤ï¼ˆcommittedï¼‰ï¼šæ•°æ®å·²ç»å®‰å…¨çš„ä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ã€‚</li><li>å·²ä¿®æ”¹ï¼ˆmodifiedï¼‰ï¼šå·²ä¿®æ”¹è¡¨ç¤ºä¿®æ”¹äº†æ–‡ä»¶ï¼Œä½†è¿˜æ²¡ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</li><li>å·²æš‚å­˜ï¼ˆstagedï¼‰ï¼šè¡¨ç¤ºå¯¹ä¸€ä¸ªå·²ä¿®æ”¹æ–‡ä»¶çš„å½“å‰ç‰ˆæœ¬åšäº†æ ‡è®°ï¼Œä½¿ä¹‹åŒ…å«åœ¨ä¸‹æ¬¡æäº¤çš„å¿«ç…§ä¸­ã€‚</li></ul><p>ç”±æ­¤å¼•å‡ºä¸‰ä¸ªå·¥ä½œåŒºï¼šå·¥ä½œç›®å½•ã€æš‚å­˜åŒºã€Git ä»“åº“</p><p><strong>å¸¸ç”¨å‘½ä»¤</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># æ·»åŠ è¿œç¨‹åœ°å€</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> remote</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> origin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">serve</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">r&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># è´®è—ä¿®æ”¹åˆ°æ ˆä¸Š</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stash</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># åº”ç”¨è´®è—çš„ä¿®æ”¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stash</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apply</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>merge å’Œ rebase åŒºåˆ«</strong></p><ul><li>merge åˆå¹¶åˆ†æ”¯ä¼šæ–°å¢ä¸€ä¸ªmerge commitï¼Œç„¶åå°†ä¸¤ä¸ªåˆ†æ”¯çš„å†å²è”ç³»èµ·æ¥ã€‚å¯¹ç°æœ‰åˆ†æ”¯ä¸ä¼šä»¥ä»»ä½•æ–¹å¼è¢«æ›´æ”¹ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å†å²è®°å½•ç›¸å¯¹å¤æ‚</li><li>rebase æ‰¾åˆ°ä¸¤ä¸ªåˆ†æ”¯æœ€è¿‘çš„å…±åŒç¥–å…ˆï¼Œå°†æ•´ä¸ªåˆ†æ”¯ç§»åŠ¨åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šï¼Œä¿®æ”¹å„è‡ªçš„å†²çªï¼Œæ•´åˆæ‰€æœ‰åˆ†æ”¯ä¸Šçš„æäº¤ã€‚å¥½å¤„æ˜¯å†å²è®°å½•æ›´åŠ æ¸…æ™°ï¼Œæ˜¯åœ¨åŸæœ‰æäº¤çš„åŸºç¡€ä¸Šå°†å·®å¼‚å†…å®¹åæ˜ è¿›å»ï¼Œæ¶ˆé™¤äº† git mergeæ‰€éœ€çš„ä¸å¿…è¦çš„åˆå¹¶æäº¤</li></ul><h3 id="docker" tabindex="-1"><a class="header-anchor" href="#docker"><span>Docker</span></a></h3><p><strong>ä¼˜åŠ¿</strong><br>Docker å¯ä»¥è®©å¼€å‘è€…æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªè½»é‡çº§ã€å¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linux æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚</p><ul><li>ä¸€è‡´çš„è¿è¡Œç¯å¢ƒï¼Œèƒ½å¤Ÿæ›´è½»æ¾åœ°è¿ç§»</li><li>å¯¹è¿›ç¨‹è¿›è¡Œå°è£…éš”ç¦»ï¼Œå®¹å™¨ä¸å®¹å™¨ä¹‹é—´äº’ä¸å½±å“ï¼Œæ›´é«˜æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æº</li><li>å¯ä»¥é€šè¿‡é•œåƒå¤åˆ¶å¤šä¸ªä¸€è‡´çš„å®¹å™¨</li></ul><p><strong>é‡è¦æ¦‚å¿µ</strong></p><ul><li>é•œåƒï¼šä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œé™¤äº†æä¾›å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€çš„ç¨‹åºã€åº“ã€èµ„æºã€é…ç½®ç­‰æ–‡ä»¶å¤–ï¼Œè¿˜åŒ…å«äº†ä¸€äº›ä¸ºè¿è¡Œæ—¶å‡†å¤‡çš„ä¸€äº›é…ç½®å‚æ•°</li><li>å®¹å™¨ï¼šé•œåƒè¿è¡Œæ—¶çš„å®ä½“ã€‚å®¹å™¨å¯ä»¥è¢«åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ã€æš‚åœç­‰ï¼Œæ¯ä¸ªå®¹å™¨ç›¸äº’éš”ç¦»</li><li>ä»“åº“ï¼šé›†ä¸­å­˜æ”¾é•œåƒæ–‡ä»¶çš„åœ°æ–¹</li></ul><p><strong>å®¹å™¨</strong></p><ul><li>å®¹å™¨é•œåƒæ˜¯è½»é‡çš„ã€å¯æ‰§è¡Œçš„ç‹¬ç«‹è½¯ä»¶åŒ… ï¼ŒåŒ…å«è½¯ä»¶è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼šä»£ç ã€è¿è¡Œæ—¶ç¯å¢ƒã€ç³»ç»Ÿå·¥å…·ã€ç³»ç»Ÿåº“å’Œè®¾ç½®ã€‚</li><li>å®¹å™¨åŒ–è½¯ä»¶é€‚ç”¨äºä¸åŒOSçš„åº”ç”¨ï¼Œåœ¨ä»»ä½•ç¯å¢ƒä¸­éƒ½èƒ½å¤Ÿå§‹ç»ˆå¦‚ä¸€åœ°è¿è¡Œã€‚</li><li>å®¹å™¨èµ‹äºˆäº†è½¯ä»¶ç‹¬ç«‹æ€§ï¼Œä½¿å…¶å…å—å¤–åœ¨ç¯å¢ƒå·®å¼‚çš„å½±å“</li></ul><p><strong>å¯¹æ¯”è™šæ‹Ÿæœº</strong></p><ul><li>å®¹å™¨æ˜¯ä¸€ä¸ªåº”ç”¨å±‚æŠ½è±¡ï¼Œç”¨äºå°†ä»£ç å’Œä¾èµ–èµ„æºæ‰“åŒ…åœ¨ä¸€èµ·ã€‚å¤šä¸ªå®¹å™¨å¯ä»¥åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œå…±äº«æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œä½†å„è‡ªä½œä¸ºç‹¬ç«‹çš„è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œã€‚å®¹å™¨å ç”¨ç©ºé—´å°‘ï¼Œå¯åŠ¨å¿«</li><li>è™šæ‹Ÿæœº (VM) æ˜¯ä¸€ä¸ªç‰©ç†ç¡¬ä»¶å±‚æŠ½è±¡ï¼Œç”¨äºå°†ä¸€å°æœåŠ¡å™¨å˜æˆå¤šå°æœåŠ¡å™¨ã€‚</li></ul><p><strong>å¸¸ç”¨å‘½ä»¤</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # æŸ¥çœ‹dockerç‰ˆæœ¬</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> images</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       # æŸ¥çœ‹æ‰€æœ‰å·²ä¸‹è½½é•œåƒï¼Œç­‰ä»·äºï¼šdocker image ls å‘½ä»¤</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> container</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #	æŸ¥çœ‹æ‰€æœ‰å®¹å™¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ps</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           #æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> image</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prune</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # æ¸…ç†ä¸´æ—¶çš„ã€æ²¡æœ‰è¢«ä½¿ç”¨çš„é•œåƒæ–‡ä»¶ã€‚-a, --all: åˆ é™¤æ‰€æœ‰æ²¡æœ‰ç”¨çš„é•œåƒï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸´æ—¶æ–‡ä»¶ï¼›</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> search</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mysql</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     # æŸ¥çœ‹mysqlç›¸å…³é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pull</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mysql:5.7</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   # æ‹‰å–mysqlé•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> image</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         # æŸ¥çœ‹æ‰€æœ‰å·²ä¸‹è½½é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rmi</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          # åˆ é™¤é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           # åˆ é™¤å®¹å™¨</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> restart</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stop</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kill</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> udpate</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --restart=always</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # è®¾ç½®å®¹å™¨è‡ªå¯åŠ¨</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> logs</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ft</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       # å®æ—¶æ˜¾ç¤ºæ—¥å¿—ï¼Œå¹¶æ‰“å°æ—¶é—´æˆ³</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> top</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # å®¹å™¨å†…è¿è¡Œäº†å“ªäº›è¿›ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bash</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # ä¸å®¹å™¨äº¤äº’</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx:dir</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # å°†æ–‡ä»¶ä»å®¿ä¸»æœºæ‹·è´åˆ°å®¹å™¨æŒ‡å®šä½ç½®ï¼Œåä¹‹ä¹Ÿå¯ä»¥</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> inspect</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xxx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        # æŸ¥çœ‹å®¹å™¨/æ•°æ®å·ç»†èŠ‚</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> volume:dir</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # å°†volume/å®¿ä¸»æœºç›®å½• æ˜ å°„åˆ° å®¹å™¨å†…çš„dir</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> commit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;æè¿°ä¿¡æ¯&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -a</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;é•œåƒä½œè€…&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tomcat01</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> my_tomcat:1.0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   # æ‰“åŒ…é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> save</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> my_tomcat:1.0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> my-tomcat-1.0.tar</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                    # å¤‡ä»½é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> load</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> my-tomcat-1.0.tar</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                                  # åŠ è½½æœ¬åœ°é•œåƒ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç³»ç»Ÿè®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿè®¾è®¡"><span>ç³»ç»Ÿè®¾è®¡</span></a></h2><h4 id="ç†”æ–­é™çº§" tabindex="-1"><a class="header-anchor" href="#ç†”æ–­é™çº§"><span>ç†”æ–­é™çº§</span></a></h4><p><strong>ç†”æ–­</strong></p><p>A æœåŠ¡è°ƒç”¨ B æœåŠ¡çš„æŸä¸ªåŠŸèƒ½ï¼Œç”±äºç½‘ç»œä¸ç¨³å®šé—®é¢˜ï¼Œæˆ–è€… B æœåŠ¡å¡æœºï¼Œå¯¼è‡´åŠŸèƒ½æ—¶é—´è¶…é•¿ã€‚å¦‚æœè¿™æ ·å­çš„æ¬¡æ•°å¤ªå¤šã€‚æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°† B æ–­è·¯äº†ï¼ˆA ä¸å†è¯·æ±‚ B æ¥å£ï¼‰ï¼Œå‡¡æ˜¯è°ƒç”¨ B çš„ç›´æ¥è¿”å›é™çº§æ•°æ®ï¼Œä¸å¿…ç­‰å¾… B çš„è¶…é•¿æ‰§è¡Œã€‚ è¿™æ · B çš„æ•…éšœé—®é¢˜ï¼Œå°±ä¸ä¼šçº§è”å½±å“åˆ° Aã€‚</p><p><strong>é™çº§</strong></p><p>æ•´ä¸ªç½‘ç«™å¤„äºæµé‡é«˜å³°æœŸï¼ŒæœåŠ¡å™¨å‹åŠ›å‰§å¢ï¼Œæ ¹æ®å½“å‰ä¸šåŠ¡æƒ…å†µåŠæµé‡ï¼Œå¯¹ä¸€äº›æœåŠ¡å’Œé¡µé¢è¿›è¡Œæœ‰ç­–ç•¥çš„é™çº§ï¼ˆåœæ­¢æœåŠ¡ï¼Œæ‰€æœ‰çš„è°ƒç”¨ç›´æ¥è¿”å›é™çº§æ•°æ®ï¼‰ã€‚ä»¥æ­¤ç¼“è§£æœåŠ¡å™¨èµ„æºçš„çš„å‹åŠ›ï¼Œä»¥ä¿è¯æ ¸å¿ƒä¸šåŠ¡çš„æ­£å¸¸è¿è¡Œï¼ŒåŒæ—¶ä¹Ÿä¿æŒäº†å®¢æˆ·å’Œå¤§éƒ¨åˆ†å®¢æˆ·çš„å¾—åˆ°æ­£ç¡®çš„ç›¸åº”ã€‚</p><p><strong>ç›¸åŒç‚¹</strong></p><ul><li>ä¸ºäº†ä¿è¯é›†ç¾¤å¤§éƒ¨åˆ†æœåŠ¡çš„å¯ç”¨æ€§å’Œå¯é æ€§ï¼Œé˜²æ­¢å´©æºƒï¼Œç‰ºç‰²ä¸€éƒ¨åˆ†æœåŠ¡</li><li>ç”¨æˆ·æœ€ç»ˆéƒ½æ˜¯ä½“éªŒåˆ°æŸä¸ªåŠŸèƒ½ä¸å¯ç”¨</li></ul><p><strong>ä¸åŒç‚¹</strong>ã€</p><ul><li>ç†”æ–­æ˜¯è¢«è°ƒç”¨æ–¹æ•…éšœï¼Œè§¦å‘ç³»ç»Ÿä¸»åŠ¨è§„åˆ™</li><li>é™çº§æ˜¯åŸºäºå…¨å±€è€ƒè™‘ï¼Œæ‰‹åŠ¨åœæ­¢ä¸€äº›æ­£å¸¸æœåŠ¡ï¼Œé‡Šæ”¾èµ„æº</li></ul><h4 id="æœåŠ¡é™æµ" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡é™æµ"><span>æœåŠ¡é™æµ</span></a></h4><p>é™æµå°±æ˜¯å¯¹è¯·æ±‚çš„é€Ÿç‡è¿›è¡Œé™åˆ¶ï¼Œé¿å…ç¬æ—¶çš„å¤§é‡è¯·æ±‚å‡»å®è½¯ä»¶ç³»ç»Ÿã€‚</p><p><strong>å›ºå®šçª—å£è®¡æ•°å™¨</strong></p><ul><li>å³æ—¶é—´çª—å£ï¼Œè§„å®šäº†å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚</li><li>ä¾‹å¦‚ç”¨ counter è®¡æ•°è¯·æ±‚ï¼Œè¶…è¿‡é˜ˆå€¼åæ‹’ç»è¯·æ±‚ï¼Œç­‰æ—¶é—´åˆ°äº†é‡ç½®</li><li>è¿™ç§é™æµç®—æ³•æ— æ³•ä¿è¯é™æµé€Ÿç‡ï¼Œå› è€Œæ— æ³•ä¿è¯çªç„¶æ¿€å¢çš„æµé‡ã€‚ä¾‹å¦‚ä¸€åˆ†é’Ÿå†…çš„å‰55sæ²¡æœ‰è¯·æ±‚ï¼Œå1sçªç„¶æœ‰1000ä¸ªè¯·æ±‚ï¼Œç³»ç»Ÿç›´æ¥è¢«å‡»å®</li></ul><p><strong>æ»‘åŠ¨çª—å£è®¡æ•°å™¨</strong></p><ul><li>åœ¨å›ºå®šçª—å£è®¡æ•°å™¨åŸºç¡€ä¸Šï¼ŒæŠŠæ—¶é—´ä»¥ä¸€å®šæ¯”ä¾‹åˆ†ç‰‡ï¼Œå¯¹çª—å£å†…è¯·æ±‚æ•°è®¡æ•°ã€‚</li><li>åˆ†ç‰‡è¶Šç»†ï¼Œçª—å£æ»šåŠ¨è¶Šå¹³æ»‘ï¼Œé™æµä¹Ÿå°±è¶Šç²¾ç¡®</li></ul><p><strong>æ¼æ¡¶ç®—æ³•</strong></p><ul><li>ç±»ä¼¼æ¼æ¡¶æ¼æ°´ï¼Œä»»æ„é€Ÿç‡æµå…¥ï¼Œå›ºå®šé€Ÿç‡æµå‡º</li><li>å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—ä¿å­˜è¯·æ±‚ï¼Œå®šæœŸä»é˜Ÿåˆ—ä¸­å–å‡ºè¯·æ±‚æ‰§è¡Œ</li></ul><p><strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong></p><ul><li>ä»¥ä¸€å®šé€Ÿç‡ç½‘æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œï¼Œæ¡¶æ»¡å°±ä¸å†æ·»åŠ </li><li>è¯·æ±‚åœ¨å¤„ç†å‰éœ€è¦æ‹¿åˆ°ä¸€ä¸ªä»¤ç‰Œï¼Œå¤„ç†å®Œæ¯•åå°†ä»¤ç‰Œä¸¢å¼ƒ</li></ul><h4 id="é«˜å¯ç”¨" tabindex="-1"><a class="header-anchor" href="#é«˜å¯ç”¨"><span>é«˜å¯ç”¨</span></a></h4><p>æè¿°ä¸€ä¸ªç³»ç»Ÿåœ¨å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯å¯ç”¨çš„ï¼Œå³ä½¿åœ¨å‘ç”Ÿç¡¬ä»¶æ•…éšœæˆ–è€…ç³»ç»Ÿå‡çº§çš„æ—¶å€™ï¼ŒæœåŠ¡ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚</p><p><strong>ç³»ç»Ÿä¸å¯ç”¨åŸå› </strong></p><ul><li>é»‘å®¢æ”»å‡»</li><li>ç¡¬ä»¶æ•…éšœ</li><li>å¹¶å‘é‡/ç”¨æˆ·è¯·æ±‚é‡æ¿€å¢</li><li>ä»£ç ä¸­çš„åå‘³é“å¯¼è‡´å†…å­˜æ³„æ¼æˆ–è€…å…¶ä»–é—®é¢˜ï¼Œè¿›è€Œå¼•å‘ç¨‹åºå´©æºƒ</li><li>ç½‘ç«™æ¶æ„ä¸­çš„æŸä¸ªç»„ä»¶å®•æœº</li><li>è‡ªç„¶ç¾å®³ã€äººä¸ºç ´å</li><li>......</li></ul><p><strong>æé«˜æ–¹æ³•</strong></p><ol><li>é›†ç¾¤ï¼Œé¿å…å•ç‚¹æ•…éšœ</li><li>é™æµï¼Œé¿å…ç¬æ—¶æµé‡é«˜å³°å†²å®ç³»ç»Ÿ</li><li>è¶…æ—¶å’Œé‡è¯•æœºåˆ¶</li><li>ç†”æ–­ï¼Œç³»ç»Ÿè‡ªåŠ¨æ”¶é›†æ‰€ä¾èµ–æœåŠ¡çš„èµ„æºä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½æŒ‡æ ‡ï¼Œå½“æ‰€ä¾èµ–çš„æœåŠ¡æ¶åŒ–æˆ–è€…è°ƒç”¨å¤±è´¥æ¬¡æ•°è¾¾åˆ°æŸä¸ªé˜ˆå€¼çš„æ—¶å€™å°±è¿…é€Ÿå¤±è´¥ï¼Œè®©å½“å‰ç³»ç»Ÿç«‹å³åˆ‡æ¢ä¾èµ–å…¶ä»–å¤‡ç”¨æœåŠ¡ã€‚</li><li>å¼‚æ­¥è°ƒç”¨ï¼Œæˆ–é…åˆæ¶ˆæ¯é˜Ÿåˆ—</li><li>ç¼“å­˜æœºåˆ¶</li></ol><p><strong>å†—ä½™è®¾è®¡</strong></p><ul><li>é«˜å¯ç”¨é›†ç¾¤ï¼šåŒä¸€ä»½æœåŠ¡éƒ¨ç½²ä¸¤ä»½æˆ–è€…å¤šä»½ï¼Œä»¥ä¾¿æ•…éšœæ—¶å¿«é€Ÿåˆ‡æ¢</li><li>åŒåŸ/å¼‚åœ°ç¾å¤‡ï¼Œå¤‡ç”¨æœåŠ¡ä¸å¤„ç†è¯·æ±‚</li><li>åŒåŸ/å¼‚åœ°å¤šæ´»ï¼Œå¤‡ç”¨æœåŠ¡ä¹Ÿå¤„ç†è¯·æ±‚</li></ul><h4 id="æ€§èƒ½æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½æµ‹è¯•"><span>æ€§èƒ½æµ‹è¯•</span></a></h4><ul><li>æ€§èƒ½æµ‹è¯•ï¼šé€šè¿‡æµ‹è¯•å·¥å…·æ¨¡æ‹Ÿç”¨æˆ·è¯·æ±‚ç³»ç»Ÿï¼Œç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•ç³»ç»Ÿçš„æ€§èƒ½æ˜¯å¦æ»¡è¶³è¦æ±‚</li><li>è´Ÿè½½æµ‹è¯•ï¼šå¯¹è¢«æµ‹è¯•çš„ç³»ç»Ÿç»§ç»­åŠ å¤§è¯·æ±‚å‹åŠ›ï¼Œç›´åˆ°æœåŠ¡å™¨çš„æŸä¸ªèµ„æºå·²ç»è¾¾åˆ°é¥±å’Œï¼Œè¾¾åˆ°ç³»ç»Ÿä¸Šé™</li><li>å‹åŠ›æµ‹è¯•ï¼šä¸å»ç®¡ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼Œå¯¹ç³»ç»Ÿç»§ç»­åŠ å¤§è¯·æ±‚å‹åŠ›ï¼Œç›´åˆ°æœåŠ¡å™¨å´©æºƒæ— æ³•å†ç»§ç»­æä¾›æœåŠ¡</li><li>ç¨³å®šæ€§æµ‹è¯•ï¼šæ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼Œç»™ç³»ç»Ÿä¸€å®šå‹åŠ›ï¼Œçœ‹çœ‹ä¸šåŠ¡æ˜¯å¦èƒ½ç¨³å®šè¿è¡Œ</li></ul><h4 id="restful" tabindex="-1"><a class="header-anchor" href="#restful"><span>RestFul</span></a></h4><p>Resource Representational State Transfer â€œèµ„æºâ€åœ¨ç½‘ç»œä¼ è¾“ä¸­ä»¥æŸç§â€œè¡¨ç°å½¢å¼â€è¿›è¡Œâ€œçŠ¶æ€è½¬ç§»â€ã€‚</p><ul><li>èµ„æºï¼šç‰¹å®š URI å¯¹åº”çš„å¯¹è±¡æ•°æ®</li><li>è¡¨ç°å½¢å¼ï¼šèµ„æºå…·ä½“çš„å‘ˆç°å½¢å¼ï¼Œå¦‚JSONã€XMLã€Imageç­‰</li><li>çŠ¶æ€è½¬ç§»ï¼šé€šè¿‡CRUDï¼Œä½¿å¾—æœåŠ¡å™¨ç«¯èµ„æºçŠ¶æ€çš„æ”¹å˜</li></ul><p><strong>åŠ¨ä½œ</strong></p><ul><li>GETï¼šè¯·æ±‚è·å–ç‰¹å®šèµ„æº</li><li>POSTï¼šåˆ›å»ºæ–°èµ„æº</li><li>PUTï¼šæ›´æ–°èµ„æº</li><li>DELETEï¼šåˆ é™¤èµ„æº</li><li>PATCHï¼šéƒ¨åˆ†æ›´æ–°</li></ul><h4 id="è½¯ä»¶å·¥ç¨‹" tabindex="-1"><a class="header-anchor" href="#è½¯ä»¶å·¥ç¨‹"><span>è½¯ä»¶å·¥ç¨‹</span></a></h4><p><strong>ç€‘å¸ƒæ¨¡å‹</strong></p><p>è½¯ä»¶æ¦‚å¿µ -&gt; éœ€æ±‚åˆ†æ -&gt; æ¶æ„è®¾è®¡ -&gt; è¯¦ç»†è®¾è®¡ -&gt; ç¼–ç  -&gt; æµ‹è¯•</p><p><strong>æ•æ·å¼€å‘æ¨¡å‹</strong><br>ä¸€ç§ä»¥äººä¸ºæ ¸å¿ƒã€è¿­ä»£ã€å¾ªåºæ¸è¿›çš„å¼€å‘æ–¹æ³•ã€‚åœ¨æ•æ·å¼€å‘ä¸­ï¼Œè½¯ä»¶é¡¹ç›®çš„æ„å»ºè¢«åˆ‡åˆ†æˆå¤šä¸ªå­é¡¹ç›®ï¼Œå„ä¸ªå­é¡¹ç›®çš„æˆæœéƒ½ç»è¿‡æµ‹è¯•ï¼Œå…·å¤‡é›†æˆå’Œå¯è¿è¡Œçš„ç‰¹å¾ã€‚æ¢è¨€ä¹‹ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªå¤§é¡¹ç›®åˆ†ä¸ºå¤šä¸ªç›¸äº’è”ç³»ï¼Œä½†ä¹Ÿå¯ç‹¬ç«‹è¿è¡Œçš„å°é¡¹ç›®ï¼Œå¹¶åˆ†åˆ«å®Œæˆï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­è½¯ä»¶ä¸€ç›´å¤„äºå¯ä½¿ç”¨çŠ¶æ€ã€‚</p><p><strong>å¼€å‘ç­–ç•¥</strong><br>è½¯ä»¶å¤ç”¨ã€åˆ†è€Œæ²»ä¹‹ã€é€æ­¥æ¼”è¿›ã€ä¼˜åŒ–æŠ˜ä¸­</p><h4 id="è®¤è¯æˆæƒ" tabindex="-1"><a class="header-anchor" href="#è®¤è¯æˆæƒ"><span>è®¤è¯æˆæƒ</span></a></h4><ul><li>è®¤è¯ï¼šéªŒè¯èº«ä»½å‡­æ®</li><li>æˆæƒï¼šç®¡ç†æ“ä½œæƒé™</li></ul><p>RBAC æ¨¡å‹ï¼šRole-Based Access Control åŸºäºè§’è‰²çš„æƒé™è®¿é—®æ§åˆ¶ï¼Œæƒé™ä¸è§’è‰²ç›¸å…³è”ï¼Œç”¨æˆ·é€šè¿‡æˆä¸ºé€‚å½“è§’è‰²çš„æˆå‘˜è€Œå¾—åˆ°è¿™äº›è§’è‰²çš„æƒé™ã€‚</p><p><strong>Cookie å’Œ Session</strong></p><p>Cookieï¼šä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œä¸€èˆ¬ç”¨æ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯ã€‚ï¼ˆä¾‹å¦‚å­˜æ”¾ SessionId ç”¨äºæœåŠ¡å™¨æ ‡è®°ç”¨æˆ·ï¼‰<br>Sessionï¼šä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œè®°å½•ç”¨æˆ·çš„çŠ¶æ€ã€‚ï¼ˆHTTPæ˜¯æ— çŠ¶æ€çš„ï¼Œéœ€è¦Sessionæ ‡è®°å¹¶è·Ÿè¸ªç‰¹å®šç”¨æˆ·ï¼‰</p><ul><li>ä¸€èˆ¬ Session çš„å®‰å…¨æ€§æ›´é«˜ï¼ŒCookieå°½é‡åŠ å¯†æ”¾åˆ°æœåŠ¡ç«¯è§£å¯†ã€‚</li><li>Session ä¸€èˆ¬ä¾èµ–äº Cookie å®ç°ã€‚ï¼Œä½†ä¹Ÿå¯ä»¥ä¸ç”¨ Cookieï¼Œä¾‹å¦‚ç›´æ¥æ”¾åœ¨ url ä¸­ï¼Œä½†å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒé™ä½ã€‚</li><li>Cookie æ— æ³•é˜²æ­¢ CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆä»¥ç”¨æˆ·èº«ä»½å‘é€è™šå‡è¯·æ±‚ï¼‰ï¼Œä½† Token ä»¤ç‰Œå¯ä»¥ç¦æ­¢ï¼ˆToken ä¿å­˜åœ¨ localStorage ä¸­ï¼Œå‰ç«¯è´Ÿè´£æºå¸¦ Tokenï¼‰</li><li>Cookie å’Œ Token éƒ½æ— æ³•é˜»æ­¢ XSS è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆæ³¨å…¥æ¶æ„ä»£ç ï¼Œé€šè¿‡è„šæœ¬ç›—ç”¨ä¿¡æ¯ï¼‰</li></ul><h4 id="sso" tabindex="-1"><a class="header-anchor" href="#sso"><span>SSO</span></a></h4><p>Single Sign On å•ç‚¹ç™»å½•ï¼Œåœ¨å¤šä¸ªåº”ç”¨çš„ç³»ç»Ÿä¸­ï¼Œåªéœ€è¦ç™»é™†ä¸€æ¬¡ï¼Œå°±å¯ä»¥è®¿é—®å…¶å®ƒç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿã€‚å¯¹äºåŒåŸŸä¸‹çš„ä¸åŒæœåŠ¡ï¼Œåªè¦æ‰©å¤§ Cookie ä½œç”¨åŸŸåˆ°é¡¶åŸŸï¼Œç„¶åå…±äº« session å³å¯ï¼ˆRedis ç»Ÿä¸€å­˜å‚¨ Sessionï¼‰ã€‚ä½†å¯¹äºä¸åŒåŸŸä¸‹çš„æœåŠ¡ï¼Œéœ€è¦å•ç‹¬éƒ¨ç½² SSO ç³»ç»Ÿï¼Œåªè¦ç™»å½•äº†è¿™ä¸ªå…¬å…±çš„ç™»é™†æœåŠ¡å°±ä»£è¡¨å¯¹åº”çš„æœåŠ¡ç¾¤éƒ½ç™»å½•äº†ã€‚</p><p><img src="/img/SSO.png#id=IasZY&amp;originHeight=931&amp;originWidth=737&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p><p><strong>è·¨åŸŸ SSO</strong></p><ul><li>ç”¨æˆ·è®¿é—® app1 ç³»ç»Ÿï¼Œapp1 æ²¡æœ‰ç™»å½•ï¼Œè·³è½¬åˆ°SSO</li><li>SSO ä¹Ÿæ²¡æœ‰ç™»å½•ï¼Œå¼¹å‡ºç”¨æˆ·ç™»å½•é¡µ</li><li>ç”¨æˆ·å¡«å†™ç”¨æˆ·åã€å¯†ç ï¼ŒSSO è¿›è¡Œè®¤è¯åï¼Œå°†ç™»å½•çŠ¶æ€å†™å…¥ SSO çš„ sessionï¼Œå¹¶é€šçŸ¥æµè§ˆå™¨ä¸­å†™å…¥ SSO åŸŸä¸‹çš„ Cookie</li><li>SSO ç™»å½•å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ª ST (Service Ticket)ï¼Œæºå¸¦å¹¶è·³è½¬åˆ° app1 ç³»ç»Ÿ</li><li>app1 æ‹¿åˆ° ST åï¼Œå‘ SSO å‘é€è¯·æ±‚éªŒè¯ ST æ˜¯å¦æœ‰æ•ˆ</li><li>éªŒè¯é€šè¿‡åï¼Œapp1 å°†ç™»å½•çŠ¶æ€å†™å…¥ Session å¹¶è®¾ç½® app1 åŸŸä¸‹çš„ Cookie</li></ul><p><strong>è®¿é—® App2</strong></p><ul><li>ç”¨æˆ·è®¿é—® app2 ç³»ç»Ÿï¼Œapp2 æ²¡æœ‰ç™»å½•ï¼Œè·³è½¬åˆ°SSO</li><li>ç”±äº SSO å·²ç»ç™»å½•äº†ï¼Œä¸éœ€è¦é‡æ–°ç™»å½•è®¤è¯</li><li>SSO ç”Ÿæˆ STï¼Œæºå¸¦å¹¶è·³è½¬åˆ° app2 ç³»ç»Ÿ</li><li>app2 æ‹¿åˆ° ST åï¼Œå‘ SSO å‘é€è¯·æ±‚éªŒè¯ ST æ˜¯å¦æœ‰æ•ˆ</li><li>éªŒè¯æˆåŠŸåï¼Œapp2 å°†ç™»å½•çŠ¶æ€å†™å…¥ Session å¹¶è®¾ç½® app2 åŸŸä¸‹çš„ Cookie</li></ul><h4 id="è®¾è®¡æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#è®¾è®¡æ¨¡å¼"><span>è®¾è®¡æ¨¡å¼</span></a></h4><h5 id="å•ä¾‹" tabindex="-1"><a class="header-anchor" href="#å•ä¾‹"><span>å•ä¾‹</span></a></h5><p>ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ‡’æ±‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> instance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> private</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (){}</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> synchronized</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getInstance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (instance </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        instance </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> instance;  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// é¥¿æ±‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> instance </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  private</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (){}</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getInstance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> instance;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŒé‡æ ¡éªŒé”</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // å®ä¾‹åŒ–å¯¹è±¡åˆ†ä¸‰ä¸ªæ­¥éª¤ï¼šåˆ†é…å†…å­˜å¯¹è±¡ -&gt; åˆå§‹åŒ–å¯¹è±¡ -&gt; å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Volatile ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œé˜²æ­¢å¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªåˆå§‹åŒ–æœªå®Œæˆçš„å¯¹è±¡ï¼ˆ2ã€3æ­¥é‡æ’åºï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  private</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (){}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Singleton</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getSingleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (singleton </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // åªæœ‰ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ‰éœ€è¦åŠ é”ï¼Œåç»­ä¸éœ€è¦  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      synchronized</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡äº†ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢ç¬¬äºŒä¸ªè¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹å†æ¬¡åˆ›å»ºå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (singleton </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          singleton </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Singleton</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> singleton;  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="å·¥å‚æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å·¥å‚æ¨¡å¼"><span>å·¥å‚æ¨¡å¼</span></a></h5><p>é€šè¿‡å®šä¹‰å·¥å‚ç±»æ¥åˆ›å»ºå¯¹è±¡ï¼Œè®©ä½¿ç”¨è€…ä¸ç”¨çŸ¥é“å…·ä½“çš„å‚æ•°å°±å¯ä»¥åˆ›å»ºå‡ºæ‰€éœ€çš„äº§å“ç±»ã€‚</p><h5 id="é€‚é…å™¨æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#é€‚é…å™¨æ¨¡å¼"><span>é€‚é…å™¨æ¨¡å¼</span></a></h5><p>è§£å†³ä¸¤ä¸ªè½¯ä»¶å®ä½“é—´çš„æ¥å£ä¸å…¼å®¹çš„é—®é¢˜</p><h5 id="ç­–ç•¥æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#ç­–ç•¥æ¨¡å¼"><span>ç­–ç•¥æ¨¡å¼</span></a></h5><p>ç›¸åŒçš„ç›®æ ‡ï¼Œç”¨ä¸åŒçš„æ–¹æ³•å®ç°ã€‚ä¾‹å¦‚ Spring ä¸­åŠ è½½ BeanDefinition å¯ä»¥ä»ç±»è·¯å¾„åŠ è½½ã€æ–‡ä»¶ç³»ç»ŸåŠ è½½ã€ç½‘ç»œèµ„æºåŠ è½½ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„ç±»ï¼Œå®ç°å…±åŒçš„æ¥å£æ¥å®ç°ã€‚</p><h5 id="ä»£ç†æ¨¡å¼-1" tabindex="-1"><a class="header-anchor" href="#ä»£ç†æ¨¡å¼-1"><span>ä»£ç†æ¨¡å¼</span></a></h5><p>ä¸€ä¸ªç±»ä»£è¡¨å¦ä¸€ä¸ªç±»çš„åŠŸèƒ½ã€‚åœ¨ä»£ç†æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºå…·æœ‰ç°æœ‰å¯¹è±¡çš„å¯¹è±¡ï¼Œä»¥ä¾¿å‘å¤–ç•Œæä¾›åŠŸèƒ½æ¥å£ã€‚</p><h2 id="æ‰‹æ’•ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#æ‰‹æ’•ç®—æ³•"><span>æ‰‹æ’•ç®—æ³•</span></a></h2><h4 id="lru" tabindex="-1"><a class="header-anchor" href="#lru"><span>LRU</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> LRUCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> _key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> _value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _key; value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _value;}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> head</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> LRUCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> capacity;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // ä½¿ç”¨ä¼ªå¤´éƒ¨å’Œä¼ªå°¾éƒ¨èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        head </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        tail </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tail;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> head;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å¦‚æœ key å­˜åœ¨ï¼Œå…ˆé€šè¿‡å“ˆå¸Œè¡¨å®šä½ï¼Œå†ç§»åˆ°å¤´éƒ¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        moveToHead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // å¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> newNode</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // æ·»åŠ è¿›å“ˆå¸Œè¡¨</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, newNode);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // æ·»åŠ è‡³åŒå‘é“¾è¡¨çš„å¤´éƒ¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            addToHead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(newNode);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            ++size;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (size </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> capacity) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // å¦‚æœè¶…å‡ºå®¹é‡ï¼Œåˆ é™¤åŒå‘é“¾è¡¨çš„å°¾éƒ¨èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tail</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> removeTail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // åˆ é™¤å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„é¡¹</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                --size;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // å¦‚æœ key å­˜åœ¨ï¼Œå…ˆé€šè¿‡å“ˆå¸Œè¡¨å®šä½ï¼Œå†ä¿®æ”¹ valueï¼Œå¹¶ç§»åˆ°å¤´éƒ¨</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            moveToHead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> addToHead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> head;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> removeNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> moveToHead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DLinkedNode</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        removeNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        addToHead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DLinkedNode</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> removeTail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        DLinkedNode</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> res</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        removeNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(res);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> res;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å †æ’" tabindex="-1"><a class="header-anchor" href="#å †æ’"><span>å †æ’</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Solution</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> heapSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> heapSize</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        buildHeap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, heapSize);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i--) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot; &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, i);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            --heapSize;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            heapify</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, heapSize); </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> buildHeap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> heapSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> heapSize </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i--) </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            heapify</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, i, heapSize);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> heapify</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> heapSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> l</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, r </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> maxIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(l </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> heapSize </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[maxIdx] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[l])</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            maxIdx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> l;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(r </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> heapSize </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[maxIdx] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[r])</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            maxIdx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(maxIdx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i){</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, i, maxIdx);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            heapify</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, maxIdx, heapSize);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> j</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tmp</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[i];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        nums[i] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[j];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        nums[j] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tmp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¿«æ’" tabindex="-1"><a class="header-anchor" href="#å¿«æ’"><span>å¿«æ’</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Solution</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Random</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rand </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Random</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sortArray</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        quickSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> quickSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> left</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> right</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> right)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> r</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> rand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nextInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(right </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, left, left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pivot</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> left;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lt</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, gt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> right;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(lt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> right </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[lt] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[pivot])    lt++;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(gt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[gt] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[pivot])  gt--;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(lt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> gt)    </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, lt++ ,gt--);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, pivot, gt);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        quickSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, left, gt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        quickSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, gt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, right);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> swap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> j</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tmp</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[i];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        nums[i] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[j];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        nums[j] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tmp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å½’å¹¶æ’åº" tabindex="-1"><a class="header-anchor" href="#å½’å¹¶æ’åº"><span>å½’å¹¶æ’åº</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Solution</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">[] tmp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sortArray</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        tmp </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        mergeSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mergeSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nums</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (l </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> mid</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (l </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        mergeSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, l, mid);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        mergeSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nums, mid </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, r);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> l, j </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mid </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cnt</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mid </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nums[i] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[j]) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                tmp[cnt++] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[i++];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                tmp[cnt++] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[j++];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mid) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            tmp[cnt++] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[i++];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (j </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            tmp[cnt++] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nums[j++];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> k</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; k </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> l </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; ++k) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            nums[k </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> l] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tmp[k];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="èƒŒåŒ…" tabindex="-1"><a class="header-anchor" href="#èƒŒåŒ…"><span>èƒŒåŒ…</span></a></h4><p><strong>0-1èƒŒåŒ…</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å‰ i ä»¶å•†å“ï¼Œæ€»é‡é‡ j çš„å‰æä¸‹çš„æœ€å¤§ä»·å€¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">dp[i][j] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Math</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">max</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(dp[i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][j], dp[i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][j </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> w[i]] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> v[i])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®Œå…¨èƒŒåŒ…</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å‰ i ç§ç¡¬å¸ï¼ˆå¯é‡å¤ï¼‰ï¼Œæ€»é‡‘é¢ j çš„ç»„åˆæ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">dp[i][j] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> dp[i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">][j] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> dp[i][j </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> coins[i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">]]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ–æ³¢é‚£å¥‘" tabindex="-1"><a class="header-anchor" href="#æ–æ³¢é‚£å¥‘"><span>æ–æ³¢é‚£å¥‘</span></a></h4><p>ä¸è¦å†™é€’å½’ï¼ï¼ï¼å¤æ‚åº¦ $O(2^n)$!!!</p><p>å†™ DPï¼Œå¤æ‚åº¦ O(n)</p><h4 id="äºŒåˆ†ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#äºŒåˆ†ç»†èŠ‚"><span>äºŒåˆ†ç»†èŠ‚</span></a></h4><ol><li>while(l &lt; r)</li><li>å¦‚æœæ›´æ–°æ—¶ l = mid + 1 å’Œ r = mid; åˆ™ mid = left + (right - left + 1) / 2;</li><li>å¦‚æœæ›´æ–°æ—¶ l = mid å’Œ r = mid - 1; åˆ™ mid = left + (right - left + 1) / 2;</li><li>è¿”å›æ—¶ä¼˜å…ˆå– rï¼Œé¿å…è¶Šç•Œ</li></ol><blockquote><p>äºŒåˆ†çš„æœ¬è´¨æ˜¯ã€ŒäºŒæ®µæ€§ã€è€Œéã€Œå•è°ƒæ€§ã€<br>äºŒåˆ†ä¸ä»…é€‚ç”¨äº 01 ç‰¹æ€§ï¼ˆæ»¡è¶³/ä¸æ»¡è¶³ï¼‰ï¼Œè¿˜é€‚ç”¨äº** ä¸€å®šæ»¡è¶³/ä¸ä¸€å®šæ»¡è¶³** è¿™æ ·çš„ç‰¹æ€§</p></blockquote><h2 id="åœºæ™¯é¢˜" tabindex="-1"><a class="header-anchor" href="#åœºæ™¯é¢˜"><span>åœºæ™¯é¢˜</span></a></h2><p>40äº¿ bit ~= 500 MBï¼›1äº¿æ•´æ•° ~= 400 MB</p><ol><li>ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«æœ‰ 50äº¿ URLï¼Œæ‰¾å‡ºå…¶ä¸­ç›¸åŒçš„ URL</li></ol><p>å…ˆå“ˆå¸Œåˆ‡åˆ†å¤šä¸ªå°æ–‡ä»¶ï¼Œå¯¹æ¯ä¸ªæ–‡ä»¶å»ºç«‹ HashSetï¼ŒæŸ¥æ‰¾ç›¸åŒçš„ URLï¼›ä¼˜åŒ–ï¼šå‰ç¼€å­—å…¸æ ‘ï¼Œé™ä½å­˜å‚¨æˆæœ¬æé«˜æŸ¥è¯¢æ•ˆç‡</p><ol start="2"><li>å¤§é‡æ•°æ®æ‰¾å‡º Top 100 é¢‘åº¦çš„å­—ç¬¦ä¸²</li></ol><p>åˆ†è€Œæ²»ä¹‹ï¼Œå“ˆå¸Œå–ä½™ -&gt; HashMap ç»Ÿè®¡é¢‘åº¦ -&gt; å®¹é‡ K çš„å°é¡¶å †æ±‚ Top K</p><ol start="3"><li>å¤§é‡æ•°æ®ä¸­æ‰¾å‡ºä¸é‡å¤çš„æ•°å­—</li></ol><p>åˆ†æ²»æ³•ï¼šåˆ‡åˆ†å°æ–‡ä»¶ -&gt; Hashset/HashMap æ‰¾å‡ºæ¯ä¸ªå°æ–‡ä»¶ä¸é‡å¤çš„æ•´æ•° -&gt; åˆå¹¶æ¯ä¸ªå­ç»“æœ</p><p>ä½å›¾æ³•ï¼šç”¨ä¸¤ä½ bit è¡¨ç¤ºæ•°å­—çŠ¶æ€ï¼Œ00æ²¡å‡ºç°ï¼Œ01å‡ºç°ä¸€æ¬¡ï¼Œ10å‡ºç°å¤šæ¬¡ã€‚å‰ææ˜¯å†…å­˜å¯ä»¥å®¹çº³æ‰€æœ‰ bit</p><ol start="4"><li>å¤§é‡æ•°æ®ä¸­åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦å­˜åœ¨</li></ol><p>åˆ†æ²»æ³•ï¼š/<br>ä½å›¾æ³•ï¼šæ¯ä¸ªå­˜åœ¨çš„æ•´æ•°å¯¹åº”çš„ bit ç½® 1ï¼Œç„¶åç›´æ¥æŸ¥è¯¢è¯¥æ•°å¯¹åº”ä½æ˜¯å¦ä¸º 1ã€‚</p><ol start="5"><li>5äº¿ä¸ªæ•°ä¸­æ‰¾å‡ºä¸­ä½æ•°</li></ol><p>åŒå †æ³•ï¼šä¸€ä¸ªå¤§æ ¹å †ï¼Œä¸€ä¸ªå°æ ¹å †ã€‚å¤§æ ¹å †çš„æœ€å¤§å…ƒç´ å°äºå°æ ¹å †çš„æœ€å°å…ƒç´ ï¼Œä¿è¯ä¸¤ä¸ªå †çš„å…ƒç´ ä¸ªæ•°ä¸è¶…è¿‡ 1ã€‚å¦‚æœæ•°æ®æ€»æ•°ä¸ºå¶æ•°ï¼Œä¸­ä½æ•°å°±æ˜¯ä¸¤ä¸ªå †é¡¶çš„å¹³å‡å€¼ï¼Œå¦åˆ™æ˜¯å®¹é‡è¾ƒå¤§çš„å †çš„å †é¡¶å…ƒç´ ã€‚</p><p>åˆ†æ²»æ³•: å…ˆéå†ä¸€è½®ï¼ŒäºŒè¿›åˆ¶æœ€é«˜ä½ä¸º 1 çš„å†™å…¥ file1ï¼Œå¦åˆ™å†™å…¥ file0ï¼Œåˆ™ä¸­ä½æ•°ä½äºæ•°é‡è¾ƒå¤šçš„æ–‡ä»¶ä¸­ã€‚ç»§ç»­æŒ‰ ä½ åˆ’åˆ†ï¼Œç›´åˆ°å¯ä»¥å®šä½åˆ°ä¸­ä½æ•°ã€‚</p><ol start="6"><li>Redis æ•°æ®ç»“æ„çš„åº”ç”¨</li></ol><p>ZSet å¯ä»¥ç”¨äºå®ç°æ’è¡Œæ¦œæ•°æ®ï¼Œä¾‹å¦‚æ ¹æ®æŸä¸ªæƒé‡æ’åºï¼Œè·å¾—æ’åé¡ºåºã€‚</p><p>Set å¯ä»¥ç”¨äºé›†åˆçš„äº¤é›†ã€å¹¶é›†è®¡ç®—ç­‰ã€‚ä¾‹å¦‚è®¡ç®—æ¯æ—¥æ–°å¢ç”¨æˆ·æ•°ï¼Œç”¨ä¸¤å¤©çš„ç”¨æˆ· set ä½œå·®ï¼ˆsdiffstoreå‘½ä»¤ï¼‰</p><p>Bitmap ä¸è®°å½•æ•°æ®æœ¬èº«ï¼Œåªèƒ½åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå¯ä»¥ç”¨äºæ¯æœˆçš„ç­¾åˆ°è®°å½•çš„åœºæ™¯ã€‚</p></div><!----><!----><!----></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;"><div style="display: flex;align-items: center;justify-content: center;height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">Powered by <a href="https://theme-hope.vuejs.press/zh/">VuePress Theme Hope</a></div><div class="vp-copyright">ç‹¬ç«‹æ€è€ƒï¼Œæ˜è¾¨æ˜¯éï¼Œå°Šé‡ä»–äººå‘½è¿</div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CN1e8mfj.js" defer></script>
  </body>
</html>

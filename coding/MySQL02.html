<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.59" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://xchanper.github.io/coding/MySQL02.html"><meta property="og:site_name" content="chanper"><meta property="og:title" content="MySQL 深入原理"><meta property="og:description" content="配置文件与变量 一般是安装目录或用户home目录下的ini/cnf文件，不同目录下的配置文件有优先级顺序，命令行中的参数优先级最高，多个组重复选项则后出现的优先级高。选项只能使用长形式。 配置文件中大多数选项对应了MySQL中的某个系统变量，系统变量分为Global和Session两个作用域。 此外，运行时MySQL还包括上百个状态变量，也分Globa..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-06-22T07:34:10.000Z"><meta property="article:tag" content="MySQL"><meta property="article:published_time" content="2023-01-28T00:00:00.000Z"><meta property="article:modified_time" content="2025-06-22T07:34:10.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"MySQL 深入原理","image":[""],"datePublished":"2023-01-28T00:00:00.000Z","dateModified":"2025-06-22T07:34:10.000Z","author":[]}</script><script type="text/javascript" src="//js.users.51.la/21843597.js"></script><script src="https://www.googletagmanager.com/gtag/js?id=G-MXLC6EJHG0"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){ dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-MXLC6EJHG0');
            </script><link rel="icon" href="/assets/favicon.ico"><title>MySQL 深入原理 | chanper</title><meta name="description" content="配置文件与变量 一般是安装目录或用户home目录下的ini/cnf文件，不同目录下的配置文件有优先级顺序，命令行中的参数优先级最高，多个组重复选项则后出现的优先级高。选项只能使用长形式。 配置文件中大多数选项对应了MySQL中的某个系统变量，系统变量分为Global和Session两个作用域。 此外，运行时MySQL还包括上百个状态变量，也分Globa...">
    <link rel="preload" href="/assets/style-CGRCDUe8.css" as="style"><link rel="stylesheet" href="/assets/style-CGRCDUe8.css">
    <link rel="modulepreload" href="/assets/app-CHBNztBQ.js"><link rel="modulepreload" href="/assets/MySQL02.html-NjNuvaJX.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-C80gTbuV.js" as="script"><link rel="prefetch" href="/assets/intro.html-CtnDevkb.js" as="script"><link rel="prefetch" href="/assets/AQS.html-GFifGa0S.js" as="script"><link rel="prefetch" href="/assets/Authorization.html-C7tB0WbT.js" as="script"><link rel="prefetch" href="/assets/Elasticsearch.html-BsulRCKM.js" as="script"><link rel="prefetch" href="/assets/Guava.html-BQwA_x3X.js" as="script"><link rel="prefetch" href="/assets/Guide-RPC.html-B7ACLCvq.js" as="script"><link rel="prefetch" href="/assets/Hive-SQL.html-DqWWgyJE.js" as="script"><link rel="prefetch" href="/assets/JUC.html-Ca6sqt9f.js" as="script"><link rel="prefetch" href="/assets/JVM-GC.html-CGHNTDeH.js" as="script"><link rel="prefetch" href="/assets/JVM-reference-type.html-MyDFFpia.js" as="script"><link rel="prefetch" href="/assets/JVM-runtime-memory.html-DJUY8fYN.js" as="script"><link rel="prefetch" href="/assets/JVM.html--kyl5EmA.js" as="script"><link rel="prefetch" href="/assets/Java_base.html-CSdKT0LU.js" as="script"><link rel="prefetch" href="/assets/LockSupport.html-Q02L0oiW.js" as="script"><link rel="prefetch" href="/assets/Logging.html-BwhD-jSB.js" as="script"><link rel="prefetch" href="/assets/MQ_Abstract.html-DhCsvyrV.js" as="script"><link rel="prefetch" href="/assets/MQ_Kafka.html-IZiBFP0H.js" as="script"><link rel="prefetch" href="/assets/MyBatis.html-hR7mrUN8.js" as="script"><link rel="prefetch" href="/assets/MySQL-Lock.html-DycH4YiQ.js" as="script"><link rel="prefetch" href="/assets/MySQL01.html-Cgxbv0QH.js" as="script"><link rel="prefetch" href="/assets/NIO.html-8UMHqTs1.js" as="script"><link rel="prefetch" href="/assets/Netty01.html-5u4RnztT.js" as="script"><link rel="prefetch" href="/assets/Netty02.html-Dnm3pxoV.js" as="script"><link rel="prefetch" href="/assets/index.html-BHmmbecG.js" as="script"><link rel="prefetch" href="/assets/Redis01.html-DQcmMhQY.js" as="script"><link rel="prefetch" href="/assets/Redis02.html-Cjecwv6g.js" as="script"><link rel="prefetch" href="/assets/Redis03.html-uCMzGM7H.js" as="script"><link rel="prefetch" href="/assets/Redis04.html-DWPv-S8C.js" as="script"><link rel="prefetch" href="/assets/Shred_Algorithm.html-Y9OOalGr.js" as="script"><link rel="prefetch" href="/assets/SmallSpring.html-CyFO21vT.js" as="script"><link rel="prefetch" href="/assets/SpringTransaction.html-l0GtkdJD.js" as="script"><link rel="prefetch" href="/assets/Stream.html-DGc2w7zM.js" as="script"><link rel="prefetch" href="/assets/Synchronized.html-CUcBG7PX.js" as="script"><link rel="prefetch" href="/assets/Thread.html-DIBruGsC.js" as="script"><link rel="prefetch" href="/assets/ThreadPoolExecutor.html-dTHirGa6.js" as="script"><link rel="prefetch" href="/assets/Thrift.html-D3xS1kG5.js" as="script"><link rel="prefetch" href="/assets/Unsafe.html-BwJdlrBk.js" as="script"><link rel="prefetch" href="/assets/Windows-WSL-MySQL.html-BkeCnTeG.js" as="script"><link rel="prefetch" href="/assets/Zookeeper.html-JacviOHV.js" as="script"><link rel="prefetch" href="/assets/bigdata-hadoop.html-C_RQjeRz.js" as="script"><link rel="prefetch" href="/assets/cache-migration.html-DhUvrO5e.js" as="script"><link rel="prefetch" href="/assets/code-review.html-B3fLblQ2.js" as="script"><link rel="prefetch" href="/assets/distributed-cache.html-BEpfNctq.js" as="script"><link rel="prefetch" href="/assets/distributed-transaction.html-_JGLDyKC.js" as="script"><link rel="prefetch" href="/assets/gateway.html-CAN2G3Gq.js" as="script"><link rel="prefetch" href="/assets/git-pro.html-DFiiOgKI.js" as="script"><link rel="prefetch" href="/assets/interview-java.html-Bjt-Tqla.js" as="script"><link rel="prefetch" href="/assets/leetcode-bitcalc.html-CS905sYt.js" as="script"><link rel="prefetch" href="/assets/leetcode-permutation.html-Gh0UxFN9.js" as="script"><link rel="prefetch" href="/assets/linux-cmd.html-DFvceA6-.js" as="script"><link rel="prefetch" href="/assets/mock-test.html-M-8WSZPp.js" as="script"><link rel="prefetch" href="/assets/AirBiz.html-CDr8v78v.js" as="script"><link rel="prefetch" href="/assets/index.html-Bp2Dz8ZP.js" as="script"><link rel="prefetch" href="/assets/arabs-history.html-D_MCAhiz.js" as="script"><link rel="prefetch" href="/assets/beijing-intern.html-Ck6vHW18.js" as="script"><link rel="prefetch" href="/assets/blog-actions.html-HuPRc53A.js" as="script"><link rel="prefetch" href="/assets/cycling.html-C60UMp1_.js" as="script"><link rel="prefetch" href="/assets/first-camera.html-BGr0jdpZ.js" as="script"><link rel="prefetch" href="/assets/movie-guide.html-D2UsXN6j.js" as="script"><link rel="prefetch" href="/assets/summary_2023.html-4dkFvqrb.js" as="script"><link rel="prefetch" href="/assets/summary_2024.html-Day_HgY3.js" as="script"><link rel="prefetch" href="/assets/travel-tibet.html-BeLEEgGJ.js" as="script"><link rel="prefetch" href="/assets/webrtc-study.html-CKzDJFU9.js" as="script"><link rel="prefetch" href="/assets/windows-dash.html-CSQ7Hsbe.js" as="script"><link rel="prefetch" href="/assets/youtube-dl-ffmpeg.html-CqZVlLYx.js" as="script"><link rel="prefetch" href="/assets/404.html-DF0F6Eot.js" as="script"><link rel="prefetch" href="/assets/index.html-B-d_w5d1.js" as="script"><link rel="prefetch" href="/assets/index.html-BDo2cFIE.js" as="script"><link rel="prefetch" href="/assets/index.html-AKkq_oht.js" as="script"><link rel="prefetch" href="/assets/index.html-vivLFBnF.js" as="script"><link rel="prefetch" href="/assets/index.html-CcZa8umk.js" as="script"><link rel="prefetch" href="/assets/index.html-DaURobZi.js" as="script"><link rel="prefetch" href="/assets/index.html-BDc6AGGy.js" as="script"><link rel="prefetch" href="/assets/index.html-C8suiVm7.js" as="script"><link rel="prefetch" href="/assets/index.html-BQV0J9RK.js" as="script"><link rel="prefetch" href="/assets/index.html-CPDQFVZB.js" as="script"><link rel="prefetch" href="/assets/index.html-zX9FIeTe.js" as="script"><link rel="prefetch" href="/assets/index.html-Dl8hSVVY.js" as="script"><link rel="prefetch" href="/assets/index.html-CyVbMr7S.js" as="script"><link rel="prefetch" href="/assets/index.html-oGqjRIyw.js" as="script"><link rel="prefetch" href="/assets/index.html-WI16dtLz.js" as="script"><link rel="prefetch" href="/assets/index.html-BzYxC6c7.js" as="script"><link rel="prefetch" href="/assets/index.html-D2yPWCCN.js" as="script"><link rel="prefetch" href="/assets/index.html-BC2g6pxj.js" as="script"><link rel="prefetch" href="/assets/index.html-DK_PkwC1.js" as="script"><link rel="prefetch" href="/assets/index.html-Bh444kai.js" as="script"><link rel="prefetch" href="/assets/index.html-DVQMPtpG.js" as="script"><link rel="prefetch" href="/assets/index.html-ZXc4VrYs.js" as="script"><link rel="prefetch" href="/assets/index.html-DZJMrI2s.js" as="script"><link rel="prefetch" href="/assets/index.html-CRtHj9iO.js" as="script"><link rel="prefetch" href="/assets/index.html-PsIJ3dA4.js" as="script"><link rel="prefetch" href="/assets/index.html-B3YqC7Mn.js" as="script"><link rel="prefetch" href="/assets/index.html-CLTOukKL.js" as="script"><link rel="prefetch" href="/assets/index.html-Dywvu_HC.js" as="script"><link rel="prefetch" href="/assets/index.html-DxQy-NRp.js" as="script"><link rel="prefetch" href="/assets/index.html-BlzPDJPQ.js" as="script"><link rel="prefetch" href="/assets/index.html-B03wZ6ZC.js" as="script"><link rel="prefetch" href="/assets/index.html-BsTUA1fn.js" as="script"><link rel="prefetch" href="/assets/index.html-CfGL3zJ9.js" as="script"><link rel="prefetch" href="/assets/index.html-B2Vz9Xss.js" as="script"><link rel="prefetch" href="/assets/index.html-B7IszEYX.js" as="script"><link rel="prefetch" href="/assets/index.html-DOrMoJzh.js" as="script"><link rel="prefetch" href="/assets/index.html-BVDJGg9_.js" as="script"><link rel="prefetch" href="/assets/index.html-BjHeiQfM.js" as="script"><link rel="prefetch" href="/assets/index.html-BWmweQ4t.js" as="script"><link rel="prefetch" href="/assets/index.html-Bi0St468.js" as="script"><link rel="prefetch" href="/assets/index.html-Dws5fSNh.js" as="script"><link rel="prefetch" href="/assets/index.html-XJa2Zi4V.js" as="script"><link rel="prefetch" href="/assets/index.html-CJ8lBl89.js" as="script"><link rel="prefetch" href="/assets/index.html-Dj9Pc_yu.js" as="script"><link rel="prefetch" href="/assets/index.html-DJjBzR0W.js" as="script"><link rel="prefetch" href="/assets/index.html-BgBncU8f.js" as="script"><link rel="prefetch" href="/assets/index.html-D1dNmDkf.js" as="script"><link rel="prefetch" href="/assets/index.html-BYNFZDU1.js" as="script"><link rel="prefetch" href="/assets/index.html-DJqR5LWd.js" as="script"><link rel="prefetch" href="/assets/index.html-BLSTo8YU.js" as="script"><link rel="prefetch" href="/assets/index.html-B8NLqo5c.js" as="script"><link rel="prefetch" href="/assets/index.html-0hoRa111.js" as="script"><link rel="prefetch" href="/assets/index.html-RhOKCeDv.js" as="script"><link rel="prefetch" href="/assets/index.html-Cxp-0I67.js" as="script"><link rel="prefetch" href="/assets/giscus-1zs_z9NH.js" as="script"><link rel="prefetch" href="/assets/flowchart-CmM7Z9UD.js" as="script"><link rel="prefetch" href="/assets/mermaid.esm.min-DRjGR9jh.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-D2Nf-uDI.js" as="script"><link rel="prefetch" href="/assets/SearchResult-CMib_yoW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="/assets/avatar.jpg" alt><!----><span class="vp-site-name hide-in-pad">chanper</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="HOME"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="solar:home-smile-angle-bold" width="1em" height="1em"></iconify-icon><!--]-->HOME<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/coding/" aria-label="Coding"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="streamline:code-monitor-1" width="1em" height="1em"></iconify-icon><!--]-->Coding<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/life/" aria-label="Life"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icomoon-free:finder" width="1em" height="1em"></iconify-icon><!--]-->Life<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/coding/AQS.html" aria-label="AQS 源码解析"><!---->AQS 源码解析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/code-review.html" aria-label="Code Review"><!---->Code Review<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Elasticsearch.html" aria-label="Elasticsearch 学习"><!---->Elasticsearch 学习<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Guava.html" aria-label="Guava 笔记"><!---->Guava 笔记<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Guide-RPC.html" aria-label="Guide-RPC 代码阅读"><!---->Guide-RPC 代码阅读<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Hive-SQL.html" aria-label="Hive SQL 语法大全"><!---->Hive SQL 语法大全<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/NIO.html" aria-label="Java NIO"><!---->Java NIO<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Java_base.html" aria-label="Java 基础"><!---->Java 基础<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JUC.html" aria-label="Java 并发学习"><!---->Java 并发学习<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM-reference-type.html" aria-label="Java 引用类型"><!---->Java 引用类型<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Logging.html" aria-label="Java 日志框架"><!---->Java 日志框架<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM.html" aria-label="Java 虚拟机笔记"><!---->Java 虚拟机笔记<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM-GC.html" aria-label="JVM 垃圾回收"><!---->JVM 垃圾回收<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/JVM-runtime-memory.html" aria-label="JVM 运行时数据区"><!---->JVM 运行时数据区<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/leetcode-bitcalc.html" aria-label="LeetCode-位运算"><!---->LeetCode-位运算<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/leetcode-permutation.html" aria-label="LeetCode-排列组合"><!---->LeetCode-排列组合<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/linux-cmd.html" aria-label="Linux 命令备忘录"><!---->Linux 命令备忘录<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/LockSupport.html" aria-label="LockSupport 源码阅读"><!---->LockSupport 源码阅读<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/mock-test.html" aria-label="Mock 测试"><!---->Mock 测试<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MQ_Kafka.html" aria-label="MQ-Kafka"><!---->MQ-Kafka<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MyBatis.html" aria-label="MyBatis 深入学习"><!---->MyBatis 深入学习<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MySQL01.html" aria-label="MySQL 基础"><!---->MySQL 基础<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/coding/MySQL02.html" aria-label="MySQL 深入原理"><!---->MySQL 深入原理<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MySQL-Lock.html" aria-label="MySQL 锁机制"><!---->MySQL 锁机制<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Netty01.html" aria-label="Netty 网络框架 01"><!---->Netty 网络框架 01<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Netty02.html" aria-label="Netty 网络框架 02"><!---->Netty 网络框架 02<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/git-pro.html" aria-label="Pro Git 阅读笔记"><!---->Pro Git 阅读笔记<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis02.html" aria-label="Redis 单机"><!---->Redis 单机<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis03.html" aria-label="Redis 多机"><!---->Redis 多机<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis01.html" aria-label="Redis 数据结构"><!---->Redis 数据结构<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Redis04.html" aria-label="Redis 独立功能"><!---->Redis 独立功能<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/cache-migration.html" aria-label="Redis 缓存迁移实践"><!---->Redis 缓存迁移实践<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Thrift.html" aria-label="RPC-Thrift"><!---->RPC-Thrift<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/SpringTransaction.html" aria-label="Spring 事务"><!---->Spring 事务<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Stream.html" aria-label="Stream 流"><!---->Stream 流<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Synchronized.html" aria-label="Synchronized 锁机制"><!---->Synchronized 锁机制<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Thread.html" aria-label="Thread 源码阅读"><!---->Thread 源码阅读<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/ThreadPoolExecutor.html" aria-label="ThreadPoolExecutor 源码分析"><!---->ThreadPoolExecutor 源码分析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Unsafe.html" aria-label="Unsafe 源码阅读"><!---->Unsafe 源码阅读<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Windows-WSL-MySQL.html" aria-label="Windows-WSL 实现MySQL主从同步"><!---->Windows-WSL 实现MySQL主从同步<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Zookeeper.html" aria-label="Zookeeper 学习笔记"><!---->Zookeeper 学习笔记<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/gateway.html" aria-label="关于网关"><!---->关于网关<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/distributed-transaction.html" aria-label="分布式事务"><!---->分布式事务<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/distributed-cache.html" aria-label="分布式缓存"><!---->分布式缓存<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/bigdata-hadoop.html" aria-label="大数据 - Hadoop 概述"><!---->大数据 - Hadoop 概述<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Shred_Algorithm.html" aria-label="手撕算法"><!---->手撕算法<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/SmallSpring.html" aria-label="手撸 Spring 项目"><!---->手撸 Spring 项目<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/MQ_Abstract.html" aria-label="消息队列概述"><!---->消息队列概述<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Authorization.html" aria-label="认证登录"><!---->认证登录<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/interview-java.html" aria-label="面试八股"><!---->面试八股<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->MySQL 深入原理</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2023年1月28日</span><meta property="datePublished" content="2023-01-28T00:00:00.000Z"></span><!----><!----><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color7 clickable" role="navigation">数据库</span><!--]--><meta property="articleSection" content="数据库"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color6 clickable" role="navigation">MySQL</span><!--]--><meta property="keywords" content="MySQL"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc" vp-toc><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#配置文件与变量">配置文件与变量</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#通信流程">通信流程</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#数据目录">数据目录</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#字符集和比较规则">字符集和比较规则</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#系统工具">系统工具</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#存储引擎">存储引擎</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#mysql三大存储引擎">MySQL三大存储引擎</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#存储引擎特点">存储引擎特点</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#存储引擎选择">存储引擎选择</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#innodb-记录格式">InnoDB-记录格式</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#compact-行格式">Compact 行格式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#redundant-行格式">Redundant 行格式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#行溢出">行溢出</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#dynamic-和-compressed-行格式">Dynamic 和 Compressed 行格式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#innodb-数据页">InnoDB-数据页</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#user-records">User Records</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#page-directory">Page Directory</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#其它部分">其它部分</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#innodb-表空间">InnoDB-表空间</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#区-extent">区 - Extent</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#段-segment">段 - Segment</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#表空间-tablespace">表空间 - Tablespace</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#索引原理⭐">索引原理⭐</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#索引概述">索引概述</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#索引结构">索引结构</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#索引分类">索引分类</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#索引用法">索引用法</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#索引语法">索引语法</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#最左前缀法则">最左前缀法则</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#索引失效情况">索引失效情况</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#优化方案">优化方案</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#设计原则">设计原则</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#单表查询">单表查询</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#访问方法">访问方法</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#注意事项">注意事项</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#多表查询">多表查询</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#多表连接">多表连接</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#连接原理">连接原理</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#基于成本的优化">基于成本的优化</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#成本常数">成本常数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#单表查询的成本">单表查询的成本</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#多表查询的成本">多表查询的成本</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#innodb-统计数据">InnoDB-统计数据</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#永久性数据">永久性数据</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#非永久性数据">非永久性数据</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#重复值的说明">重复值的说明</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#基于规则的优化">基于规则的优化</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#条件化简">条件化简</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#外连接消除">外连接消除</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#子查询优化">子查询优化</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#explain-执行计划">Explain 执行计划</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#字段含义">字段含义</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#查询成本">查询成本</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#innodb-缓冲池">InnoDB-缓冲池</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#buffer-pool结构">Buffer Pool结构</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#lru-链表">LRU 链表</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#事务⭐">事务⭐</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#事务语法">事务语法</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#四大特性-acid">四大特性 ACID</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#并发问题">并发问题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#隔离级别">隔离级别</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#redo-log">Redo Log</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#redo日志格式">Redo日志格式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#log-sequence-number">Log Sequence Number</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#checkpoint">Checkpoint</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#崩溃恢复">崩溃恢复</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#undo-log">Undo Log</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#事务id">事务Id</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#undo日志格式">Undo日志格式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#日志存储">日志存储</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#页面重用">页面重用</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#回滚段">回滚段</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#mvvc">MVVC</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#版本链">版本链</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readview">ReadView</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#锁机制⭐">锁机制⭐</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content" vp-content><h2 id="配置文件与变量" tabindex="-1"><a class="header-anchor" href="#配置文件与变量"><span>配置文件与变量</span></a></h2><p>一般是安装目录或用户home目录下的<code>ini/cnf</code>文件，不同目录下的配置文件有优先级顺序，命令行中的参数优先级最高，多个组重复选项则后出现的优先级高。选项只能使用长形式。</p><div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" data-title="properties" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置文件分多个组，用于特定的命令程序。还可以指定用于特定版本</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">[mysqld]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">option1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">option2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> val</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 但server组用于所有服务器程序，client组用于所有客户端程序</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">[server]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">[client]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件中大多数选项对应了MySQL中的某个系统变量，系统变量分为<code>Global</code>和<code>Session</code>两个作用域。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">- 查看系统变量, 默认session</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">show </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">global</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">session</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> variable </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">like</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;defualt%&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">- 设置系统变量，默认session</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> [@@]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">global</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">session</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> default_storage_engine </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> xxx;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，运行时MySQL还包括上百个状态变量，也分<code>Global</code>和<code>Session</code>两个作用域。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">- 查看状态变量，默认session</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">show </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">global</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">session</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> like</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;thread%&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="通信流程" tabindex="-1"><a class="header-anchor" href="#通信流程"><span>通信流程</span></a></h2><p>MySQL客户端向服务器进程发送请求并得到回复的过程本质上是一个进程间通信的过程，MySQL支持三种客户端进程和服务器进程的通信方式：</p><ul><li><strong>TCP/IP</strong>: 通过网络协议进行通讯，客户端启动时用<code>-h 指定主机 -P 指定端口</code></li><li><strong>命名管道和共享内存</strong>: 对于Windows用户，可以使用<code>--enabled-named-pipe/--protocol=pipe 或 --shared-memory/--protocol=memory</code>参数开启</li><li><strong>Unix域套接字</strong>: 对于类Unix系统，如果指定主机为<code>localhost</code>或者使用<code>--protocol=socket</code>参数，可以利用套接字通信</li></ul><p>MySQL服务器处理客户端请求的流程：</p><figure><img src="/assets/MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82-CppuHVQP.jpg" alt="MySQL服务器处理客户端请求" tabindex="0" loading="lazy"><figcaption>MySQL服务器处理客户端请求</figcaption></figure><ul><li>连接管理：客户端进程采用上述的三种通信方式来与服务器进程建立连接。每个连接分配一个单独的线程处理，因此会用到连接池、线程复用等技术。</li><li>解析与优化： <ul><li>查询缓存：完全一样的语句才会缓存，但需要额外的缓存维护开销。MySQL 8中已废弃。</li><li>语法解析：词法解析、语法分析、语义分析等等</li><li>查询优化：优化生成执行计划，可以用<code>explain 语句</code>查看某个语句的执行计划</li></ul></li><li><a href="#-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E">存储引擎</a>：提供真实存取数据的功能，各种不同的存储引擎向上面的MySQL Server层提供统一的调用接口，包含十几个底层函数。</li></ul><h2 id="数据目录" tabindex="-1"><a class="header-anchor" href="#数据目录"><span>数据目录</span></a></h2><p>InnoDB, MyISAM等存储引擎本质上把表数据存储在OS的文件系统上，读写时需要与文件系统进行交互。</p><ul><li>MySQL的数据目录通过变量<code>datadir</code>定义</li><li>每创建一个数据库，数据目录下就会新建一个同名的子目录</li><li>InnoDB引擎中，每创建一个表，该db的子目录下就会新建一个<code>表名.idb</code>文件（默认独立表空间<code>innodb_file_per_table</code>）</li><li>MyISAM引擎中，每创建一个表，生成<code>表名.frm</code>格式文件，<code>表名.MYD</code>数据文件，<code>表名.MYI</code>索引文件。</li><li>其它文件包括服务器进程文件、服务器日志文件、证书密钥等</li><li>OS的文件系统影响库名/表名的长度、文件大小、特殊字符处理等等</li></ul><p>系统数据库：</p><table><thead><tr><th>数据库</th><th>含义</th></tr></thead><tbody><tr><td>mysql</td><td>核心数据库，存储MySQL服务器正常运行所需要的各种信息，包括时区、主从、用户、权限等</td></tr><tr><td>information_schema</td><td>提供了访问数据库元数据的各种表和视图，包含数据库、表、字段类型及访问权限等</td></tr><tr><td>performance_schema</td><td>为MySQL服务器运行时状态提供了一个底层监控功能，主要用于收集数据库服务器性能参数</td></tr><tr><td>sys</td><td>包含了一系列方便 DBA 和开发人员利用 performance_schema性能数据库进行性能调优和诊断的视图</td></tr></tbody></table><h2 id="字符集和比较规则" tabindex="-1"><a class="header-anchor" href="#字符集和比较规则"><span>字符集和比较规则</span></a></h2><p>MySQL共支持40多种字符集，查看支持的字符集的命令： <code>show [character set | charset];</code> 其中：</p><ul><li>utf8: 在MySQL中指阉割过的<code>utf8mb3</code>字符集，长度1~3个字节</li><li>utf8mb4: 正宗UTF8字符集，长度1~4个字节</li></ul><p>每个字符集有若干种比较规则，且有一个默认的规则，查看比较规则的命令： <code>show collation;</code> 例如，utf8mb3默认比较规则是<code>utf8mb3_general_ci</code>，表示针对通用语言且不区分大小写的规则。</p><p>MySQL中有四个等级的字符集和比较规则：</p><ul><li>服务器级别：<code>character_set_server, collation_server</code></li><li>数据库级别：<code>character_set_database, collation_database</code></li><li>表级别：<code>create ... character set utf8mb4 collate utf8_general_ci;</code></li><li>列级别：<code>column type character set utf8mb4 collate utf8_general_ci</code> 如果没有指定，则会自底向上确定默认的字符集和比较规则。</li></ul><p>服务器处理请求时可能发生多次字符集转换：</p><ul><li>解码请求时使用<code>character_set_client</code>字符集</li><li>处理请求时将转码为<code>character_set_connection</code>字符集</li><li>处理过程中如果与字段的字符集不一致也会进行额外的转码</li><li>返回结果时转换为<code>character_set_results</code>字符集</li></ul><h2 id="系统工具" tabindex="-1"><a class="header-anchor" href="#系统工具"><span>系统工具</span></a></h2><ul><li><p>mysql mysql客户端工具</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">语法</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysql</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] [database]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">选项</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -u,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       #指定用户名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -p,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --password[</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">name]</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #指定密码</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -h,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --host=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       #指定服务器IP或域名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -P,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --port=port</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       #指定连接端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -e,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --execute=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    #执行SQL语句并退出。方便执行批处理脚本</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">示例：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysql</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -uroot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> –p123456</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> study</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;select * from tb_sku&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>mysqladmin 执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">语法:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqladmin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] command ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">选项:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -u,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       #指定用户名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -p,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --password[</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">name]</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #指定密码</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -h,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --host=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       #指定服务器IP或域名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -P,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --port=port</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       #指定连接端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">示例：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqladmin</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -uroot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> –p1234</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> drop</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;test01&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>mysqlbinlog 服务器生成的日志文件以二进制格式保存，需用mysqlbinlog查看这些文本</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">语法</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqlbinlog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] log-files1 log-files2 ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">选项</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -d,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --database=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   #指定数据库名称，只列出指定的数据库相关操作。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --offset=n</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        #忽略掉日志中的前n行命令。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -r,--result-file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #将输出的文本格式日志输出到指定文件。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -s,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --short-form</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      #显示简单格式， 省略掉一些信息。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  --start-datatime</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">date1</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --stop-datetime</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">date2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #指定日期间隔内的所有日志。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  --start-position</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">pos1</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --stop-position</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">pos2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    #指定位置间隔内的所有日志。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">示例：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqlbinlog</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> binlog.00008</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">语法</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqlshow</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] [db_name [table_name [col_name]]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">选项</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  --count</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   #显示数据库及表的统计信息（数据库，表 均可以不指定）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -i</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        #显示指定数据库或者指定表的状态信息</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">示例：</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #查询test库中book表的详细情况</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqlshow</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -uroot</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p2143</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> book</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --count</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>mysqldump 用来备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SQL语句。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">语法</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqldump</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] db_name [tables]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqldump</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] --database/-B db1 [db2 db3...]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqldump</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] --all-databases/-A</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">连接选项</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -u,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         #指定用户名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -p,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --password[</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">name]</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   #指定密码</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -h,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --host=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         #指定服务器ip或域名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -P,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --port=p</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            #指定连接端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">输出选项：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  --add-drop-database</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     #在每个数据库创建语句前加上 drop database 语句</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  --add-drop-table</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        #在每个表创建语句前加上 drop table 语句 , 默认开启 ; 不开启 (--skip-add-drop-table)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -n,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --no-create-db</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      #不包含数据库的创建语句</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -t,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --no-create-info</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    #不包含数据表的创建语句</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -d,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --no-data</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           #不包含数据</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -T,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --tab=name</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          #自动生成两个文件：一个.sql文件，创建表结构的语句；一个.txt文件，数据文件</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">示例：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqldump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -uroot</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p1234</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -T</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> D:/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> db01</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tb_score</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>mysqlimport / source 客户端数据导入工具，用来导入mysqldump 加 -T 参数后导出的文本文件。如果需要导入sql文件,可以使用mysql中的source 指令</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">语法：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqlimport</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [options] db_name textfile1 [textfile2...]</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">  source</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /root/xxxxx.sql</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">示例：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  mysqlimport</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -uroot</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p2143</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /tmp/city.txt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="存储引擎" tabindex="-1"><a class="header-anchor" href="#存储引擎"><span>存储引擎</span></a></h2><h3 id="mysql三大存储引擎" tabindex="-1"><a class="header-anchor" href="#mysql三大存储引擎"><span>MySQL三大存储引擎</span></a></h3><p>存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎基于表而非基于库，因此也被称为表引擎。</p><p>相关语法：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询建表语句</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">show </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">create</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> table</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> account;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 建表时指定存储引擎</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> 表名</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) ENGINE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">INNODB;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查看当前数据库支持的存储引擎</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">show engines;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/MySQL%E5%BC%95%E6%93%8E%E5%88%97%E8%A1%A8-Dv8xCBWM.png" alt="MySQL引擎列表" tabindex="0" loading="lazy"><figcaption>MySQL引擎列表</figcaption></figure><h4 id="innodb" tabindex="-1"><a class="header-anchor" href="#innodb"><span>InnoDB</span></a></h4><blockquote><p>InnoDB是一种兼顾高可靠性和高性能的通用存储引擎，在MySQL 5.5之后，InnoDB是默认的MySQL引擎。</p></blockquote><p>特点:</p><ul><li>DML 操作遵循 ACID 模型，支持<strong>事务</strong></li><li><strong>行级锁</strong>，提高并发访问性能</li><li>支持<strong>外键</strong>约束，保证数据的完整性和正确性</li></ul><p>文件：</p><ul><li>表名.ibd: InnoDB引擎的每张表都会对应这样一个独立表空间文件，存储该表的表结构、数据和索引</li><li>innodb_file_per_table 参数决定多张表共用一个系统表空间还是每张表独立表空间 <code>show variables like &#39;innodb_file_per_table&#39;;</code> 从idb文件提取表结构数据的工具： <code>ibd2sdi xxx.ibd</code></li></ul><h4 id="myisam" tabindex="-1"><a class="header-anchor" href="#myisam"><span>MyISAM</span></a></h4><blockquote><p>MyISAM 是 MySQL 早期的默认存储引擎。</p></blockquote><p>特点：</p><ul><li>不支持事务，不支持外键</li><li>支持表锁，不支持行锁</li><li>访问速度快</li></ul><p>文件：</p><ul><li>xxx.frm: 存储表结构信息</li><li>xxx.MYD: 存储数据</li><li>xxx.MYI: 存储索引</li></ul><h4 id="memory" tabindex="-1"><a class="header-anchor" href="#memory"><span>Memory</span></a></h4><blockquote><p>Memory 引擎的表数据存储在内存中，受硬件、断电等问题的影响，因此只能将这些表作为临时表或缓存使用。缓存场景更多使用Redis。</p></blockquote><p>特点：</p><ul><li>存放在内存中，速度快</li><li>默认hash索引</li></ul><p>文件：</p><ul><li>xxx.frm: 存储表结构信息</li></ul><h3 id="存储引擎特点" tabindex="-1"><a class="header-anchor" href="#存储引擎特点"><span>存储引擎特点</span></a></h3><table><thead><tr><th style="text-align:center;">特点</th><th style="text-align:center;">InnoDB</th><th style="text-align:center;">MyISAM</th><th style="text-align:center;">Memory</th></tr></thead><tbody><tr><td style="text-align:center;">存储限制</td><td style="text-align:center;">64TB</td><td style="text-align:center;">有</td><td style="text-align:center;">有</td></tr><tr><td style="text-align:center;">事务安全</td><td style="text-align:center;">支持</td><td style="text-align:center;">-</td><td style="text-align:center;">-</td></tr><tr><td style="text-align:center;">锁机制</td><td style="text-align:center;">行锁</td><td style="text-align:center;">表锁</td><td style="text-align:center;">表锁</td></tr><tr><td style="text-align:center;">B+tree索引</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;">Hash索引</td><td style="text-align:center;">-</td><td style="text-align:center;">-</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;">全文索引</td><td style="text-align:center;">支持（5.6版本之后）</td><td style="text-align:center;">支持</td><td style="text-align:center;">-</td></tr><tr><td style="text-align:center;">空间使用</td><td style="text-align:center;">高</td><td style="text-align:center;">低</td><td style="text-align:center;">N/A</td></tr><tr><td style="text-align:center;">内存使用</td><td style="text-align:center;">高</td><td style="text-align:center;">低</td><td style="text-align:center;">中等</td></tr><tr><td style="text-align:center;">批量插入速度</td><td style="text-align:center;">低</td><td style="text-align:center;">高</td><td style="text-align:center;">高</td></tr><tr><td style="text-align:center;">支持外键</td><td style="text-align:center;">支持</td><td style="text-align:center;">-</td><td style="text-align:center;">-</td></tr></tbody></table><p>总结InnoDB和MyISAM的区别：</p><ul><li>InnoDB支持事务, 而MyISAM不支持</li><li>InnoDB支持行锁和表锁, 而MyISAM仅支持表锁, 不支持行锁</li><li>InnoDB支持外键, 而MyISAM不支持</li></ul><h3 id="存储引擎选择" tabindex="-1"><a class="header-anchor" href="#存储引擎选择"><span>存储引擎选择</span></a></h3><ul><li>InnoDB 如果应用对事物的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，则 InnoDB 是比较合适的选择</li><li>MyISAM 如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不高，那这个存储引擎是非常合适的</li><li>Memory 将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。Memory 的缺陷是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性</li></ul><blockquote><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</p></blockquote><h2 id="innodb-记录格式" tabindex="-1"><a class="header-anchor" href="#innodb-记录格式"><span>InnoDB-记录格式</span></a></h2><p>实际的数据库数据在不同存储引擎中存放的格式一般是不同的，相同存储引擎也有不同的记录格式(行格式)。InnoDB将数据划分为若干页，以页作为磁盘和内存之间交互的基本单位，页大小为16KB。</p><p>InnoDB设计了四种行格式：<code>Compact, Redundant, Dynamic, Compressed</code>，可以在创建或修改的表语句中指定<code>ROW_FORMAT</code>，默认Dynamic行格式。</p><h3 id="compact-行格式" tabindex="-1"><a class="header-anchor" href="#compact-行格式"><span>Compact 行格式</span></a></h3><figure><img src="/assets/Compact%E8%A1%8C%E6%A0%BC%E5%BC%8F-BHGUO41e.jpg" alt="Compact行格式" tabindex="0" loading="lazy"><figcaption>Compact行格式</figcaption></figure><p>一条完整的记录分为<code>记录的额外信息</code>和<code>记录的真实数据</code>两部分组成。</p><ul><li><p>记录的额外信息</p><ul><li><strong>变长字段长度列表</strong>：非NULL的变长字段/可变字符集字段的实际长度，按列逆序存放，每列占1~2个字节</li><li><strong>NULL值列表</strong>：允许NULL的列的标志位，1为NULL，0非NULL，按列逆序，高位用0补齐至整字节。</li><li><strong>记录头信息</strong>：固定的5个字节组成 <img src="/assets/Compact%E8%A1%8C%E6%A0%BC%E5%BC%8F_%E8%AE%B0%E5%BD%95%E5%A4%B4%E4%BF%A1%E6%81%AF-CRs22L-y.jpg" alt="Compact行格式_记录头信息" loading="lazy"></li></ul></li><li><p>记录的真实数据：真实列数据，以及三个隐藏字段</p><ul><li><strong>row_id</strong>: 可选，没有主键/Unique字段的记录，引擎默认生成该隐藏列作为主键</li><li><strong>transaction_id</strong>: 最后一次插入或更新该行的事务 id</li><li><strong>roll_pointer</strong>: 回滚指针，指向该行的 undo log</li></ul></li></ul><h3 id="redundant-行格式" tabindex="-1"><a class="header-anchor" href="#redundant-行格式"><span>Redundant 行格式</span></a></h3><p>MySQL 5.0 之前使用的行格式</p><figure><img src="/assets/Redundant%E8%A1%8C%E6%A0%BC%E5%BC%8F-C8d2APQo.jpg" alt="Redundant行格式" tabindex="0" loading="lazy"><figcaption>Redundant行格式</figcaption></figure><h3 id="行溢出" tabindex="-1"><a class="header-anchor" href="#行溢出"><span>行溢出</span></a></h3><ul><li>对于定长字段，无论真实数据大小，都会占用固定大小的空间，用0/空格补齐</li><li>VARCHAR类型最多占用65535字节，但还依赖于字符集、列的限制等</li><li>对于Compact和Redundant，如果某一列数据过大，只会存储该列前768个字节，然后用20个字节指向存储溢出数据的另一个页</li><li>MySQL规定一个页中至少存放两行记录，以及列的数量，都会影响行溢出的临界点</li></ul><h3 id="dynamic-和-compressed-行格式" tabindex="-1"><a class="header-anchor" href="#dynamic-和-compressed-行格式"><span>Dynamic 和 Compressed 行格式</span></a></h3><p>MySQL 8.0 默认行格式就是<code>Dynamic</code>，与Compact类似，区别在于行溢出时，真实数据处仅有一个指针，指针存储所有数据字节的其它页。而<code>Compressed</code>会采用压缩算法对页面进行压缩，以节省空间</p><h2 id="innodb-数据页" tabindex="-1"><a class="header-anchor" href="#innodb-数据页"><span>InnoDB-数据页</span></a></h2><p>InnoDB设计了多种类型的页，存放不同的信息，其中存放表中记录的是数据页，也称索引页（InnoDB中索引即数据）。</p><figure><img src="/assets/%E6%95%B0%E6%8D%AE%E9%A1%B5%E7%BB%93%E6%9E%84-BYy8zIKr.jpg" alt="数据页结构" tabindex="0" loading="lazy"><figcaption>数据页结构</figcaption></figure><table><thead><tr><th>名称</th><th>中文名</th><th>占用空间大小</th><th>描述</th></tr></thead><tbody><tr><td>File Header</td><td>文件头部</td><td>38字节</td><td>页的一些通用信息</td></tr><tr><td>Page Header</td><td>页面头部</td><td>56字节</td><td>数据页专有的一些信息</td></tr><tr><td>Infimum + Supremum</td><td>最小记录和最大记录</td><td>26不确定</td><td>两个虚拟行记录</td></tr><tr><td>User Records</td><td>用户记录</td><td>不确定</td><td>实际存储的行记录内容</td></tr><tr><td>Free Space</td><td>空闲空间</td><td>不确定</td><td>页中尚未使用的空间</td></tr><tr><td>Page Directory</td><td>页面目录</td><td>不确定</td><td>页中某些记录的相对位置</td></tr><tr><td>File Trailer</td><td>文件尾部</td><td>8字节</td><td>校验页是否完整</td></tr></tbody></table><h3 id="user-records" tabindex="-1"><a class="header-anchor" href="#user-records"><span>User Records</span></a></h3><p>每插入一条记录，都会从<code>Free Space</code>分配一条记录的空间给<code>User Records</code>，Free Space分配完毕则该页使用完毕。<strong>若干个记录以及两个伪记录按主键大小串成一个单链表。</strong></p><figure><img src="/assets/%E6%95%B0%E6%8D%AE%E9%A1%B5%E5%8D%95%E9%93%BE%E8%A1%A8-BTm93e5S.jpg" alt="数据页单链表" tabindex="0" loading="lazy"><figcaption>数据页单链表</figcaption></figure><p>其中每条记录的记录头部分：</p><ul><li><strong>delete_mask</strong>: <ul><li>标记当前记录是否被删除</li><li>删除后仅修改标志位和链表指针，记录空间成为可重用空间</li><li>插入新纪录时会复用可重用空间</li></ul></li><li><strong>min_rec_mask</strong>: B+树每层非叶子结点的最小记录</li><li><strong>n_owned</strong>: 该记录组所含的记录数，见页目录部分</li><li><strong>heap_no</strong>: <ul><li>当前记录在本页中的位置</li><li>其中0、1对应最小(<code>Infimum</code>)和最大(<code>Supremum</code>)的伪记录</li><li>完整记录之间根据主键大小排序。</li></ul></li><li><strong>record_type</strong>: 当前记录类型 <ul><li>0 普通记录</li><li>1 为B+树非叶节点记录</li><li>2 最小记录(即<code>Infimum</code>伪记录)</li><li>3 最大记录(即<code>Supremum</code>伪记录)。</li></ul></li><li><strong>next_record</strong>: 当前记录真实数据到下一条记录真实数据的地址偏移量 (按列逆序放置正是为了提高缓冲命中率)</li></ul><h3 id="page-directory" tabindex="-1"><a class="header-anchor" href="#page-directory"><span>Page Directory</span></a></h3><p>对整个单链表查找记录性能低，因此采取分组索引策略：</p><ul><li>所有正常记录 (包括最小、最大记录，排除已删除记录) 划分为若干组</li><li>每组最后一条记录（即最大记录）的头记录中的<code>n_owned</code>标记该组内记录数</li><li>每组最后一条记录的地址偏移量抽取成索引，存放在<code>Page Directory</code>中构成页目录，其中每个偏移量称为槽</li></ul><p>槽的更新：</p><ul><li>初始时仅<code>Infimum</code>和<code>Supremum</code>两个组</li><li>每插入一条记录，从页目录中找到主键值大于本记录的最小槽，然后把该槽的<code>n_owned</code>加一，直到该组内记录达到8条</li><li>一个组内的记录达到8条后，再次插入新记录时，将该组拆分为一个4条记录的组和一个5条记录的组，并新增对应的槽</li></ul><figure><img src="/assets/%E6%95%B0%E6%8D%AE%E9%A1%B5%E9%A1%B5%E7%9B%AE%E5%BD%95-Y0Qx62w6.jpg" alt="数据页页目录" tabindex="0" loading="lazy"><figcaption>数据页页目录</figcaption></figure><p>因此，查找时:</p><ul><li>通过二分法确定该记录所在的槽，并借助前一个槽找到所在槽中主键值最小的记录</li><li>通过记录的<code>next_record</code>遍历该槽查找记录</li></ul><h3 id="其它部分" tabindex="-1"><a class="header-anchor" href="#其它部分"><span>其它部分</span></a></h3><ul><li><strong>Page Header</strong>: 针对数据页，存储本页记录的状态信息，占56字节</li><li><strong>File Header</strong>: 针对所有页，存储页的通用信息，如前后页指针构成双链表，占38字节</li><li><strong>File Trailer</strong>: 针对所有页，用于同步正确性检验，占8字节，前4字节校验和，后四字节日志序列位置LSN</li></ul><figure><img src="/assets/%E9%80%9A%E7%94%A8%E9%A1%B5%E7%BB%93%E6%9E%84-D-O-ChFd.png" alt="通用页结构" tabindex="0" loading="lazy"><figcaption>通用页结构</figcaption></figure><h2 id="innodb-表空间" tabindex="-1"><a class="header-anchor" href="#innodb-表空间"><span>InnoDB-表空间</span></a></h2><figure><img src="/assets/InnoDB%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84-Dk7QJJl9.png" alt="InnoDB逻辑存储结构" tabindex="0" loading="lazy"><figcaption>InnoDB逻辑存储结构</figcaption></figure><h3 id="区-extent" tabindex="-1"><a class="header-anchor" href="#区-extent"><span>区 - Extent</span></a></h3><ul><li><strong><a href="#-innodb-%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F">行 - Row</a></strong>：InnoDB 是面向行的，即数据是按行进行存放的</li><li><strong><a href="#-innodb-%E6%95%B0%E6%8D%AE%E9%A1%B5">页 - Page</a></strong>：页是组成区的最小单元，页也是InnoDB磁盘管理的最小单元</li></ul><ul><li>区是表空间的单元结构，每个区的大小固定1M，每256个页划为一组</li><li>一个区包含64个大小为16K的Page页，其中每个区的前几页是固定存储属性信息的页类型</li><li>每个区对应了一个<code>XDES_Entry</code>，记录属性的结构</li><li>区的类型有四种 <ul><li><code>Free</code>: 空闲的区</li><li><code>Free_Frag</code>: 有剩余空间的碎片区</li><li><code>Full_Frag</code>: 没有剩余空间的碎片区</li><li><code>FSEG</code>: 附属于某个段的区，用于特殊作用段的区</li></ul></li><li>其中前三种区是独立直属于表空间的，各自构成一个双链表；而从属于段的<code>FSEG</code>通过维护<code>FREE、NOT_FULL、FULL</code>三个链表进行查询使用。因此，对于一个只有聚簇索引的表，共有2*3+3=9个链表需要维护。</li><li>上述的每个链表对应一个<code>List Base Node</code>结构，存储链表头、尾以及包含节点数</li></ul><h3 id="段-segment" tabindex="-1"><a class="header-anchor" href="#段-segment"><span>段 - Segment</span></a></h3><p>表空间是由各个段组成的， 常见的段有数据段、索引段、回滚段等。一个段是一些零散的页面以及一些完整的Extent区的集合，属于逻辑概念。InnoDB中对于段的管理，都是引擎自身完成，不需要人为对其控制。</p><ul><li>段以区为单位申请空间，为了节省空间还包含一些零散的页</li><li>一个索引对应生成两个段： <ul><li>叶子节点有自己独有的区，这些区的集合为叶子节点段</li><li>非叶子节点也有独有的区，这些区的集合为非叶子节点段</li></ul></li><li>每个段对应一个<code>INODE_Entry</code>结构记录段中的属性</li></ul><h3 id="表空间-tablespace" tabindex="-1"><a class="header-anchor" href="#表空间-tablespace"><span>表空间 - Tablespace</span></a></h3><p>上面讲述的都是独立表空间，除此之外，整个MySQL进程还有一个系统表空间。</p><ul><li>InnoDB 存储引擎逻辑结构的最高层，ibd文件即表空间文件。</li><li>系统表空间和独立表空间类似，额外记录了一些关于系统信息的页面</li><li>数据字典：存储引擎启动时会读写一些内部系统表来记录数据库元信息，例如所有表的字段、类型、对应外键等等，重点包括：<code>SYS_TABLES, SYS_COLUMNS, SYS_INDEXES, SYS_FIELDS</code>四张基本系统表，可以通过<code>information_schema</code>系统数据库查询</li></ul><p>表空间全局图： <img src="/assets/%E8%A1%A8%E7%A9%BA%E9%97%B4%E5%85%A8%E5%B1%80%E5%9B%BE-DskWy4Yp.svg" alt="表空间全局图" loading="lazy"></p><h2 id="索引原理⭐" tabindex="-1"><a class="header-anchor" href="#索引原理⭐"><span>索引原理⭐</span></a></h2><h3 id="索引概述" tabindex="-1"><a class="header-anchor" href="#索引概述"><span>索引概述</span></a></h3><blockquote><p>如果没有索引，只能依次遍历所有记录，效率十分低下。除了实际存储的数据，DBS 还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，可以借此实现高效的查找算法。这种数据结构就是索引。</p></blockquote><p>优点：</p><ul><li>提高数据检索效率，降低数据库的IO成本</li><li>通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗</li></ul><p>缺点：</p><ul><li>索引列需要占用额外空间</li><li>索引大大提高了查询效率，但降低了增删改的速度</li></ul><p>MySQL的索引是在存储引擎层实现的，不同的存储引擎支持不同的索引结构，主要包含以下几种：</p><table><thead><tr><th>索引结构</th><th>描述</th><th style="text-align:center;">InnoDB</th><th style="text-align:center;">MyISAM</th><th style="text-align:center;">Memory</th></tr></thead><tbody><tr><td>B+Tree</td><td>最常见的索引类型，大部分引擎都支持B+树索引</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td>Hash</td><td>底层数据结构是用哈希表实现，只有精确匹配索引列的查询才有效，不支持范围查询</td><td style="text-align:center;">不支持</td><td style="text-align:center;">不支持</td><td style="text-align:center;">支持</td></tr><tr><td>R-Tree(空间索引)</td><td>空间索引是 MyISAM 引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少</td><td style="text-align:center;">不支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">不支持</td></tr><tr><td>Full-Text(全文索引)</td><td>是一种通过建立倒排索引，快速匹配文档的方式，类似于 Lucene, Solr, ES</td><td style="text-align:center;">5.6版本后支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">不支持</td></tr></tbody></table><p>注：如果没有特别指明，一般指<code>B+树</code>结构组织的索引。</p><h3 id="索引结构" tabindex="-1"><a class="header-anchor" href="#索引结构"><span>索引结构</span></a></h3><ul><li><p>二叉树</p><ul><li>根据值构造二叉排序树，树的形状依赖于插入顺序</li><li>顺序插入时会形成一个链表，大大降低查询性能</li><li>大数据量情况下，层级较深，检索速度慢</li></ul></li><li><p>红黑树</p><ul><li>自平衡二叉树</li><li>仍然存在大数据量情况下，层级较深，检索速度慢的问题</li></ul></li><li><p>B-Tree</p><ul><li>B树是一种<strong>多叉平衡查找树</strong>，相对于二叉树，B树每个节点可以有多个分支，即多叉。</li><li>如果一棵B树的最大度数为n (n阶)，则这棵B树每个节点最多存储 n-1 个key，以及 n 个指针</li><li>一旦节点存储的key数量到达n，就会裂变，中间元素向上分裂形成新的节点</li><li>B树中，非叶子节点和叶子节点都会存放实际数据</li><li>树的度数：一个节点的子节点个数，实现上即指针个数</li></ul><figure><img src="/assets/B-Tree-ekHpCAeE.png" alt="B-Tree" tabindex="0" loading="lazy"><figcaption>B-Tree</figcaption></figure></li><li><p><strong>B+Tree</strong></p><ul><li>B+Tree是B-Tree的变种</li><li>非叶子节点仅作为索引，存储所指向的数据页中的最小键，不存储数据</li><li>叶子节点存储实际数据，且所有叶子节点形成一个单向链表</li></ul><figure><img src="/assets/B_Tree-DgquP7BR.png" alt="B+Tree" tabindex="0" loading="lazy"><figcaption>B+Tree</figcaption></figure><ul><li>MySQL索引数据结构对经典的B+Tree进行了优化。每层节点按照索引值从小到大的顺序排序而组成了双向链表，每个页内的记录按索引列排序形成单链表。</li><li>所有结点本质上都是一个数据页，一页至少2条记录。目录项记录只存储主键值和对应的页号。</li><li>非叶子结点中的记录头<code>record_type</code>存1标识记录项记录，叶子结点中的记录头<code>record_type</code>存0标识数据记录</li><li>实际新增数据时，从根节点开始，存满后页分裂，向下生长树枝。因此根节点始终保持不动，并存储在数据字典中。</li><li>这种B+Tree提高了区间访问的性能，利于排序</li><li>另外，MyISAM中索引和数据分离，叶子节点存储的都是数据记录的地址，因此MyISAM的索引都是二级索引</li></ul><figure><img src="/assets/MySQL_B_Tree-BIMOplj-.png" alt="MySQL_B+Tree" tabindex="0" loading="lazy"><figcaption>MySQL_B+Tree</figcaption></figure></li><li><p>Hash索引</p><ul><li>哈希索引就是采用一定的hash算法，将键值换算成新的Hash值，映射到对应的槽位上，然后存储在Hash表中。</li><li>如果两个(或多个)键值，映射到一个相同的槽位上，他们就产生了Hash冲突（也称为Hash碰撞），可以通过链表来解决。</li><li>特点： <ul><li>Hash索引只能用于对等比较<code>(=，in)</code>，不支持范围查询<code>(between，&gt;，&lt; ，...)</code></li><li>无法利用索引完成排序操作</li><li>查询效率高，通常 (不存在hash冲突的情况下) 只需要一次检索，效率通常高于B+Tree索引</li></ul></li><li>存储引擎支持： <ul><li>Memory存储引擎支持Hash索引</li><li>InnoDB具有自适应Hash功能，其索引根据B+Tree索引在指定条件下自动构建</li></ul></li></ul><figure><img src="/assets/Hash%E7%B4%A2%E5%BC%95-BYMt0BdH.png" alt="Hash索引" tabindex="0" loading="lazy"><figcaption>Hash索引</figcaption></figure></li></ul><blockquote><p>综上，InnoDB选择B+Tree索引结构的原因有：</p><ul><li>相对于二叉树，层级更少，搜索效率高</li><li>相对于 B-Tree，无论是叶子节点还是非叶子节点，都会保存数据，导致一页中存储的键值减少，指针也跟着减少，需要保存大量数据时，只能增加树的高度，导致性能降低</li><li>相对于 Hash 索引，B+Tree 支持范围匹配及排序操作</li></ul></blockquote><h3 id="索引分类" tabindex="-1"><a class="header-anchor" href="#索引分类"><span>索引分类</span></a></h3><ul><li><p>MySQL中，索引的具体类型主要分为以下几类：</p><table><thead><tr><th>分类</th><th>含义</th><th>特点</th><th style="text-align:center;">关键字</th></tr></thead><tbody><tr><td>主键索引</td><td>针对于表中主键创建的索引</td><td>默认自动创建，只能有一个</td><td style="text-align:center;">PRIMARY</td></tr><tr><td>唯一索引</td><td>避免同一个表中某数据列中的值重复</td><td>可以有多个</td><td style="text-align:center;">UNIQUE</td></tr><tr><td>常规索引</td><td>快速定位特定数据</td><td>可以有多个</td><td style="text-align:center;"></td></tr><tr><td>全文索引</td><td>全文索引查找的是文本中的关键词，而不是比较索引中的值</td><td>可以有多个</td><td style="text-align:center;">FULLTEXT</td></tr></tbody></table></li><li><p>InnoDB存储引擎中，根据索引的存储形式，又可以分为以下两种：</p><table><thead><tr><th>分类</th><th>含义</th><th>特点</th></tr></thead><tbody><tr><td>聚集索引 (Clustered Index)</td><td>将数据存储与索引放一块，索引结构的叶子节点直接保存了行数据</td><td>必须有且只有一个；索引即数据，数据即索引。</td></tr><tr><td>二级索引 (Secondary Index)</td><td>非主键生成的索引，索引结构的叶子节点关联的是对应的主键</td><td>可以存在多个；需要回表查询</td></tr></tbody></table><p>聚集索引选取规则：</p><ul><li>如果存在主键，主键索引就是聚集索引</li><li>如果不存在主键，将使用第一个唯一(UNIQUE)索引作为聚集索引</li><li>如果表没有主键或没有合适的唯一索引，则使用 InnoDB 自动生成的<code>rowid</code>作为隐藏的聚集索引</li></ul><br><figure><img src="/assets/%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E5%92%8C%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95-Vfa0rfb6.png" alt="聚集索引和二级索引" tabindex="0" loading="lazy"><figcaption>聚集索引和二级索引</figcaption></figure><ul><li>聚集索引的叶子节点下挂的是这一行的数据</li><li>二级索引的叶子节点下挂的是该字段值对应的主键值（实际非叶子节点为了保证目录项唯一，也要保存主键值）</li><li><strong>回表查询过程： 二级索引 -&gt; 主键值 -&gt; 聚集索引</strong></li></ul></li></ul><br><figure><img src="/assets/%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E6%9F%A5%E6%89%BE%E8%BF%87%E7%A8%8B-ql6CwfFT.png" alt="二级索引查找过程" tabindex="0" loading="lazy"><figcaption>二级索引查找过程</figcaption></figure><ul><li><p>单列索引与联合索引</p><ul><li>单列索引：即一个索引只包含单个列</li><li>联合索引：即一个索引关联多个列</li></ul><blockquote><p>在业务场景中，如果存在多个查询条件，考虑针对查询字段建立索引时，建议建立联合索引，而非单列索引。多条件联合查询时，MySQL优化器会评估哪个字段的索引效率更高，选择该索引完成本次查询。</p></blockquote><p>联合索引结构图： <img src="/assets/%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84-DLzd2DF8.png" alt="联合索引结构" loading="lazy"></p></li></ul><h2 id="索引用法" tabindex="-1"><a class="header-anchor" href="#索引用法"><span>索引用法</span></a></h2><h3 id="索引语法" tabindex="-1"><a class="header-anchor" href="#索引语法"><span>索引语法</span></a></h3><ul><li><p>创建索引：<br><code>CREATE [ UNIQUE | FULLTEXT ] INDEX index_name ON table_name (index_col_name, ...);</code><br> 如果 CREATE 后面不加索引类型参数，则创建的是常规索引</p></li><li><p>查看索引：<br><code>SHOW INDEX FROM table_name;</code></p></li><li><p>删除索引：<br><code>DROP INDEX index_name ON table_name;</code></p></li></ul><p>示例：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- name字段为姓名字段，该字段的值可能会重复，为该字段创建索引</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">create</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> index</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> idx_user_name</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_user(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- phone手机号字段的值非空，且唯一，为该字段创建唯一索引</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">create</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> unique index</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> idx_user_phone</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_user (phone);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 为profession, age, status创建联合索引</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">create</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> index</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> idx_user_pro_age_stat</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_user(profession, age, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 删除索引</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">drop</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> idx_user_name </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_user;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="最左前缀法则" tabindex="-1"><a class="header-anchor" href="#最左前缀法则"><span>最左前缀法则</span></a></h3><ul><li>联合索引遵守最左前缀法则，即查询从索引的最左列开始，并且不跳过索引中的列。</li><li>如果跳跃某一列，后面字段的排序就无法保证，因此后面字段的索引将失效。</li><li>最左前缀法则在select的时候，和字段书写的位置没有关系。</li><li>联合索引中，如果出现范围查询（&lt;, &gt;），其后的列索引将失效。可以用 &gt;= 或者 &lt;= 来规避索引失效问题。</li></ul><p>例如，一个联合索引的顺序是 profession -&gt; age -&gt; status (创建索引时定义的顺序), 只要select没有选中某一列，那么其后的索引都将失效，即查询时不会使用该列之后的字段索引。</p><h3 id="索引失效情况" tabindex="-1"><a class="header-anchor" href="#索引失效情况"><span>索引失效情况</span></a></h3><ol><li><p>在索引列上进行运算操作，索引将失效 如：<code>explain select * from tb_user where substring(phone, 10, 2) = &#39;15&#39;;</code></p></li><li><p>字符串类型不加引号，索引将失效 如：<code>explain select * from tb_user where phone = 17799990015;</code></p></li><li><p>模糊查询中对头部模糊匹配，索引将失效 如：<code>explain select * from tb_user where profession like &#39;%工程&#39;;</code>， 对前后都模糊匹配也会失效：<code>explain select * from tb_user where profession like &#39;%工%&#39;;</code> 仅对尾部模糊匹配不会失效：<code>explain select * from tb_user where profession like &#39;软件%&#39;;</code></p></li><li><p>用 or 连接的条件，左右两侧字段都有索引时，索引才会生效 因为只要有一个没有索引，另一个用不用索引没有意义，仍要进行全表扫描，所以无需用索引。</p></li><li><p>数据分布的影响 如果 MySQL 评估使用索引比全表更慢，则不使用索引。因为索引是用来索引少量数据的，如果通过索引查询返回大批量的数据，则还不如走全表扫描来的快，此时索引就会失效。</p></li></ol><h3 id="优化方案" tabindex="-1"><a class="header-anchor" href="#优化方案"><span>优化方案</span></a></h3><h4 id="指定索引" tabindex="-1"><a class="header-anchor" href="#指定索引"><span>指定索引</span></a></h4><p>优化数据库的一个重要手段，在SQL语句中加入一些手动提示，优化MySQL的索引使用策略，以提升性能</p><ul><li>建议使用索引 - use index <code>explain select * from tb_user use index(idx_user_pro) where profession=&quot;软件工程&quot;;</code></li><li>忽略索引 - ignore index <code>explain select * from tb_user ignore index(idx_user_pro) where profession=&quot;软件工程&quot;;</code></li><li>强制使用索引 - force index <code>explain select * from tb_user force index(idx_user_pro) where profession=&quot;软件工程&quot;;</code></li></ul><h4 id="覆盖索引" tabindex="-1"><a class="header-anchor" href="#覆盖索引"><span>覆盖索引</span></a></h4><p>应尽量使用覆盖索引，减少 <code>select *</code>。即需要查询的数据在单个索引结构中能够全部获取到，避免回表查询</p><p>explain 执行计划中 extra 字段含义：</p><ul><li><code>using index condition</code>：查找使用了索引，但是需要回表查询数据</li><li><code>using where; using index;</code>：查找使用了索引，但是需要的数据都在索引列中能找到，不需要回表查询。因此性能更高</li></ul><p>非覆盖索引查询示意： <img src="/assets/%E9%9D%9E%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2-BBgPRvm8.png" alt="非覆盖索引查询" loading="lazy"></p><h4 id="前缀索引" tabindex="-1"><a class="header-anchor" href="#前缀索引"><span>前缀索引</span></a></h4><p>当字段类型为字符串（varchar, text等）时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘IO，影响查询效率。此时可以只对字符串的一部分前缀，建立索引，这样可以大大节约索引空间，从而提高索引效率。</p><p><strong>语法：</strong><code>create index idx_xxxx on table_name(columnn(n));</code></p><p><strong>前缀长度：</strong> 可以根据索引的选择性来决定。选择性指不重复的索引值（基数）和数据表的记录总数的比值，索引选择性越高则查询效率越高。唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的。</p><p>求选择性公式：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 全长度索引选择性</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">distinct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> email) / </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(*) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_user;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 前缀索引选择性</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">distinct</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> substring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(email, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) / </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(*) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tb_user;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>前缀索引查询示意：</strong></p><figure><img src="/assets/%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2-BZCoyPPo.png" alt="前缀索引查询" tabindex="0" loading="lazy"><figcaption>前缀索引查询</figcaption></figure><ul><li>索引具体结构和索引创建时的字段声明顺序有关</li><li>前缀索引中有可能碰到相同索引的情况，因此拿到一个叶子节点(lvbu6)获取id后，需要回表查询row是否与where条件一致</li><li>回表查询结束后，还要对该叶子节点的后续节点(xiaoy)查询是否符合where条件，不符合则结束查询</li></ul><h3 id="设计原则" tabindex="-1"><a class="header-anchor" href="#设计原则"><span>设计原则</span></a></h3><ol><li>针对数据量较大，且查询比较频繁的表建立索引</li><li>针对常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引</li><li>考虑列的基数(区分度)，最好为基数大的列建立索引</li><li>索引列的类型尽量小</li><li>如果是字符串类型的字段，字段长度较长，可以针对字段的特点，建立前缀索引</li><li>尽量使用联合索引，减少单列索引。查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</li><li>避免冗余和重复索引，索引并不是多多益善，索引越多，维护索引结构的代价就越大，会影响增删改的效率</li><li>如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</li><li>主键按序插入能够提高性能，最好定义auto_increment</li></ol><h2 id="单表查询" tabindex="-1"><a class="header-anchor" href="#单表查询"><span>单表查询</span></a></h2><h3 id="访问方法" tabindex="-1"><a class="header-anchor" href="#访问方法"><span>访问方法</span></a></h3><p>MySQL执行查询语句的方式称为访问方法/访问类型</p><ul><li><code>const</code>： <ul><li>通过主键/唯一二级索引列来定位一条记录的访问方式，表示常数级别</li><li>仅用于等值比较</li><li>NULL值不保证仅有一条记录，因此也不是const</li></ul></li><li><code>ref</code>： <ul><li>采用二级索引进行等值查询的访问方式</li><li>索引结果可能匹配多条记录，效率略低于const</li><li>可NULL的列最多使用ref方式</li><li>对于联合二级索引，必须最左边的连续索引列都是等值比较才生效</li></ul></li><li><code>ref_or_null</code>： <ul><li>采用二级索引进行等值查询或匹配NULL的访问方式</li></ul></li><li><code>range</code>： <ul><li>利用索引进行范围匹配的访问方式</li><li>等值匹配称单点区间</li><li>否则称连续范围区间</li></ul></li><li><code>index</code>： <ul><li>遍历二级索引记录的执行方式</li><li>二级索引叶子节点包含全部所需的查询条件</li></ul></li><li><code>all</code>： <ul><li>使用全表扫描执行查询的方式</li></ul></li></ul><h3 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项"><span>注意事项</span></a></h3><ul><li>一般情况下，只能利用单个二级索引执行查询 <ul><li>且只会用到索引相关的列，其它条件在回表时才会进行过滤</li></ul></li><li>所有条件都可以使用某个索引时，进行条件的范围合并</li><li>一个使用索引的条件和一个没有使用索引的条件用OR连接后无法使用该索引</li><li><code>index merge</code>：使用多个索引来完成一次查询的执行方法 <ul><li><code>intersection合并</code>：从多个二级索引中取交集（除主键外必须等值匹配）</li><li><code>union合并</code>：从多个二级索引中取并集（除主键外必须等值匹配，或intersection索引合并的搜索条件）</li><li><code>sort-union合并</code>：先按照二级索引记录的主键值进行排序，之后按照union合并执行</li><li>另外，可以新建联合索引替代intersection合并</li></ul></li></ul><h2 id="多表查询" tabindex="-1"><a class="header-anchor" href="#多表查询"><span>多表查询</span></a></h2><h3 id="多表连接" tabindex="-1"><a class="header-anchor" href="#多表连接"><span>多表连接</span></a></h3><p>涉及多表的查询大致执行过程为：</p><ol><li>首先确定第一个需要查询的表，称为驱动表，选取代价最低的单表访问方法执行查询语句，得到一个结果集。驱动表只需访问一次。</li><li>针对结果集中的每一条记录，分别到另一张表，即被驱动表中查找匹配的记录。被驱动表可能被访问多次。</li></ol><figure><img src="/assets/%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B-ZLXsDFEE.png" alt="多表查询过程" tabindex="0" loading="lazy"><figcaption>多表查询过程</figcaption></figure><p>具体连接类型可分为：</p><ul><li>内连接：驱动表中的记录如果在被驱动表中找不到匹配的记录，则不会加入最后的结果集。对于内连接，驱动表和被驱动表可互换，不影响结果。</li><li>外连接：驱动表中的记录即使在被驱动表中找不到匹配的记录，也会加入最后的结果集 <ul><li>左外连接：选取左侧表为驱动表</li><li>右外连接：选取右侧表为驱动表</li></ul></li></ul><p>不同的条件子句：</p><ul><li><code>WHERE</code>子句：不论内连接还是外连接，不符合where条件的都不会加入结果集</li><li><code>ON</code>子句：对于内连接和where子句等价。对于外连接，也称过滤条件，无法匹配的字段将置NULL并加入结果集</li></ul><h3 id="连接原理" tabindex="-1"><a class="header-anchor" href="#连接原理"><span>连接原理</span></a></h3><ul><li><strong>嵌套循环连接</strong> 驱动表只访问一次，被驱动表可能被多次访问。访问次数决定于驱动表执行单表查询后的结果集中的记录条数。</li><li><strong>使用索引加快连接速度</strong> 连接查询中对被驱动表使用主键或唯一二级索引列进行等值查询称为<code>eq_ref</code></li><li><strong>基于块的嵌套循环连接</strong> 如果表的数据过大，需要多次磁盘IO，因此为了尽量减少访问被驱动表的次数，把多条驱动表的结果集装入<code>join buffer</code>中，每次对载入内存中的被驱动表记录和<code>join buffer</code>中的多条驱动记录进行匹配。可通过<code>join_buffer_size</code>配置缓冲区大小。</li></ul><h2 id="基于成本的优化" tabindex="-1"><a class="header-anchor" href="#基于成本的优化"><span>基于成本的优化</span></a></h2><h3 id="成本常数" tabindex="-1"><a class="header-anchor" href="#成本常数"><span>成本常数</span></a></h3><p>MySQL中定义了一些成本估算使用的常量，按使用位置存储在<code>engine_cost</code>和<code>server_cost</code>两张表中。其中关键的常量有：</p><ul><li><strong>I/O成本</strong>：从磁盘加载数据到内存的开销。MySQL中记读取一个页面的成本为1.0</li><li><strong>CPU成本</strong>：读取以及检测记录是否满足条件的开销。MySQL中每条记录成本为0.1</li></ul><h3 id="单表查询的成本" tabindex="-1"><a class="header-anchor" href="#单表查询的成本"><span>单表查询的成本</span></a></h3><p>MySQL在执行单表查询前，会先找出所有可能的方案，对比找出成本最低的方案，即执行计划，然后才真正执行查询。具体步骤：</p><ol><li>根据搜索条件，找出所有可能使用的索引</li><li>计算全表扫描的代价</li><li>计算使用不同索引执行查询的代价</li><li>对比各种执行方案的代价，找出成本最低的那一个</li></ol><p>注：</p><ul><li>实际计算时，需要用到一些估算值，例如记录数，页面数等，可以通过<code>show table status like &#39;表名&#39;</code>查询</li><li>MySQL优先计算唯一二级索引，然后再计算普通二级索引</li><li>查询优化器假定读取索引的一个范围和读取一个页面相同</li><li>需要回表的记录数通过区间最左记录和区间最右记录进行估算</li><li>这种通过直接访问索引对应的B+树来计算范围区间对应的索引记录条数的方式称为index dive</li><li>MySQL会把index dive和索引的基数Cardinality进行比较，判断是否使用索引统计数据进行估算。基数通过<code>show index from 表名</code>查询</li></ul><h3 id="多表查询的成本" tabindex="-1"><a class="header-anchor" href="#多表查询的成本"><span>多表查询的成本</span></a></h3><p>MySQL连接查询采用嵌套循环连接算法，因此对于两表表连接查询： <code>查询成本 = 单次查询驱动表的成本 + 驱动表扇出数 * 单次查询被驱动表的成本</code> 其中扇出数即驱动表查询结果集的记录条数。在全表扫描或索引执行的单表查询，扇出数需要估算，称为<code>condition filtering</code>。</p><ul><li>对于外连接，只需要分别为驱动表和被驱动表选择成本最低的访问方法</li><li>而对于内连接，还需要考虑表连接顺序，即谁作为驱动表，谁作为被驱动表</li><li>成本的重点在减少扇出数对被驱动表的访问成本</li></ul><h2 id="innodb-统计数据" tabindex="-1"><a class="header-anchor" href="#innodb-统计数据"><span>InnoDB-统计数据</span></a></h2><p>InnoDB会定期以表为单位，收集并存储数据库的统计数据（估计值）。按存储方式分两种，通过<code>innodb_stats_persistent</code>变量（默认ON）配置：</p><ul><li>永久性统计数据：存储在磁盘上</li><li>非永久性统计数据：存储在内存中</li></ul><h3 id="永久性数据" tabindex="-1"><a class="header-anchor" href="#永久性数据"><span>永久性数据</span></a></h3><p>统计数据实际存放在两张表中，并定期进行更新，<code>innodb_stats_auto_recalc</code>变量控制是否异步自动更新，也可以用<code>analyze table 表名</code>语句手动同步更新。</p><ul><li><p><strong>innodb_table_stats</strong>: 存储关于表的统计数据，每条记录对应一张表</p><ul><li><code>n_rows</code>统计项是表中记录行数，根据<code>innodb_stats_persistent_sample_pages</code>变量采样一定数量的页面，计算平均记录数再乘以全部叶子节点数，得到估算的总记录数</li><li><code>clustered_index_size</code> 表的聚簇索引占用的页面数量</li><li><code>sum_of_other_index_sizes</code> 表的其它索引占用的页面数量</li></ul></li><li><p><strong>innodb_index_stats</strong>: 存储关于索引的统计数据，每条记录对应一个索引的某一个统计项</p><ul><li>n_leaf_pages: 该索引的叶子节点占用页面数</li><li>size: 索引共占用页面数</li><li>n_diff_pfxNN: 对应索引列不重复的值个数</li><li>sample_size: 采样页面数</li></ul></li></ul><h3 id="非永久性数据" tabindex="-1"><a class="header-anchor" href="#非永久性数据"><span>非永久性数据</span></a></h3><p><code>innodb_stats_auto_recalc</code>变量为OFF时，数据会存储在内存中，因此会产生经常变化的执行计划。新版MySQL很少使用。</p><h3 id="重复值的说明" tabindex="-1"><a class="header-anchor" href="#重复值的说明"><span>重复值的说明</span></a></h3><ul><li>索引重复值常用于单表查询中但点区间太多，以及连接查询中被驱动表拥有索引的情况</li><li>对NULL值的处理由innodb_stats_method控制，取值有三个： <ul><li>nulls_equal: 默认值，认为所有NULL值都相等。倾向于不适用索引</li><li>nulls_unequal: 认为所有NULL值不相等，倾向于使用索引</li><li>nulls_ignored: 忽略NULL值</li></ul></li></ul><h2 id="基于规则的优化" tabindex="-1"><a class="header-anchor" href="#基于规则的优化"><span>基于规则的优化</span></a></h2><h3 id="条件化简" tabindex="-1"><a class="header-anchor" href="#条件化简"><span>条件化简</span></a></h3><ul><li>移除不必要的括号</li><li>常量传递</li><li>等值传递</li><li>移除没用的条件</li><li>表达式计算（列必须单独出现）</li><li>HAVING子句和WHERE子句合并</li><li>常量表检测（表记录为0/1、主键/唯一二级索引等值匹配）</li></ul><h3 id="外连接消除" tabindex="-1"><a class="header-anchor" href="#外连接消除"><span>外连接消除</span></a></h3><p>相对于外连接，内连接可能通过优化表的连接顺序来降低整体的查询成本。</p><ul><li>优化器首先把右外连接查询转换成左外连接查询</li><li>在外连接查询中，where子句如果（显式/隐式）包含被驱动表中的列不为NULL的条件称为<code>空值拒绝</code>。满足<code>空值拒绝</code>的外连接查询可以和内连接相互转换</li><li>继而查询优化器可以评估表的不同连接顺序，选择成本最低的执行方案</li></ul><h3 id="子查询优化" tabindex="-1"><a class="header-anchor" href="#子查询优化"><span>子查询优化</span></a></h3><ul><li>对于包含不相关的标量子查询或者行子查询，MySQL会分别独立执行外层查询和子查询</li><li><code>IN子查询</code>如果符合<code>semi-join</code>半连接条件，则优化器会先转换，再评估以下五种半连接策略，选择成本最低的执行方案： <ul><li>Table pullout 表上拉</li><li>DuplicateWeedout 重复值消除</li><li>LooseScan 松散索引扫描</li><li>Materialization 物化</li><li>FirstMatch 首次匹配</li></ul></li><li><code>IN子查询</code>如果不符合<code>semi-join</code>条件，则评估以下两种策略： <ul><li>子查询物化（结果集写入临时表，用于不相关子查询）</li><li>执行<code>IN -&gt; EXISTS</code>转换</li></ul></li><li>ANY/ALL子查询可以转换，例如<code>&lt;ANY 转换成 &lt;(SELECT MAX(...) ...)</code></li><li>派生表（FROM后面的子查询）优化： <ul><li>首先派生表和外层表合并，转换为没有派生表的形式</li><li>合并失败，则尝试派生表物化（延迟物化）</li></ul></li></ul><h2 id="explain-执行计划" tabindex="-1"><a class="header-anchor" href="#explain-执行计划"><span>Explain 执行计划</span></a></h2><p>一条查询语句经过MySQL查询优化器的各种基于成本、规则的优化后会生成一个执行计划，描述具体执行查询的方式，例如多表连接的顺序、每个表的访问方式等。通过<code>Explain</code>命令查看。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 直接在select语句之前加上关键字 explain / desc</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">EXPLAIN </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 字段列表 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 表名 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">WHERE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 条件;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字段含义" tabindex="-1"><a class="header-anchor" href="#字段含义"><span>字段含义</span></a></h3><ul><li><strong>id</strong><ul><li>（经优化后的）语句中每个SELECT对应一个id</li><li>如果FROM后跟有多个表，每个表都会有一条记录，且这些记录的id值都是相同的。记录在前的是驱动表，记录在后的是被驱动表。</li></ul></li><li><strong>select_type</strong><ul><li>每个SELECT对应的类型</li><li>SIMPLE：不包含UNION/子查询的简单查询</li><li>PRIMARY：最左边的SELECT小查询</li><li>UNION, UNION RESULT, SUBQUERY, DEPENDENT SUBQUERY, DEPENDENT UNION, DERIVED, MATERIALIZED...</li></ul></li><li><strong>table</strong><ul><li>explain的每条记录都对应着某个单表的访问方法</li></ul></li><li><strong>partitions</strong></li><li><strong>type</strong><ul><li>该表的访问方法</li><li>system: 用于仅包含一条记录，且存储引擎的统计数据是精确的表，例如MyISAM、Memory</li><li>const：根据主键/唯一二级索引进行等值匹配</li><li>eq_ref：被驱动表根据主键/唯一二级索引进行等值匹配</li><li>ref：通过普通二级索引进行等值匹配可能采用ref方式</li><li>ref_or_full：通过普通二级索引进行等值匹配，且该列可为NULL，则可能是ref_or_full</li><li>index_merge：使用Intersection, Union, Sort_Union三种索引合并的方式来执行查询</li><li>ALL：全表扫描</li><li>range：使用索引获取某些范围区间可能用到</li><li>index: 使用索引覆盖，但需要扫描全部索引记录</li><li>fulltext, unique_subquery, index_subquery</li></ul></li><li><strong>possible_keys</strong><ul><li>可能用到的索引</li></ul></li><li><strong>key</strong><ul><li>估算成本后，实际用到的索引</li></ul></li><li><strong>key_len</strong><ul><li>使用的索引记录的最大长度，由三部分相加而得： <ul><li>对于定长类型索引列，实际占用的存储空间就是该固定值</li><li>如果该索引列可以为NULL，则key_len加1</li><li>对于变长字段，额外有2字节存储该列的实际长度</li></ul></li></ul></li><li><strong>ref</strong><ul><li>索引列等值匹配的值/列的类型，如const表示常量、某个列名、func表示函数</li><li>即访问方法是const, eq_ref, ref, ref_or_null, unique_subquery, index_subquery其中之一</li></ul></li><li><strong>rows</strong><ul><li>对于全表扫描，即预计需要扫描的行数</li><li>对于索引查询，即预计需要扫描的索引记录行数</li></ul></li><li><strong>filtered</strong><ul><li>对于全表扫描，即估算的满足搜索条件的记录总数占rows之比</li><li>对于索引查询，即除索引条件外满足其它搜索条件的记录数占rows之比</li></ul></li><li><strong>Extra</strong><ul><li>额外信息</li><li>No tables used, Using join buffer, Using index ...</li></ul></li></ul><h3 id="查询成本" tabindex="-1"><a class="header-anchor" href="#查询成本"><span>查询成本</span></a></h3><p>语法：<code>explain format=JSON select ...;</code></p><p>输出JSON的<code>cost_info</code>字段包含了执行计划的成本，包括：</p><ul><li><strong>read_cost</strong> 包括两部分： <ul><li>IO成本</li><li>检测<code>rows * (1 - filter)</code>条记录的CPU成本</li></ul></li><li><strong>eval_cost</strong><ul><li>检测<code>rows * filter</code>条记录的成本</li></ul></li><li>prefix_cost <ul><li>整个查询的成本，即<code>read_cost + eval_cost</code></li></ul></li><li><code>data_read_per_join</code> 此次查询中需要读取的数据量</li></ul><p>最后，explain结束结束后，可以通过<code>show warnings;</code>查看与该执行计划相关的扩展信息，包括Level 等级，Code 代码，Message 消息三部分，其中Message字段类似于查询优化器重写后的执行语句。</p><p>另外，<code>OPTIMIZER_TRACE</code>表记录了内部具体的优化策略过程，使用步骤： 1. set optimizer_trace=&quot;enabled=on&quot;; 2. 执行语句 3. select * from information_schema.OPTIMIZER_TRACE; 4. set optimizer_trace=&quot;enabled=off&quot;; 输出结果中QUERY为查询语句，TRACE即优化过程，分为<code>prepare、optimize、execute</code>三个阶段。</p><h2 id="innodb-缓冲池" tabindex="-1"><a class="header-anchor" href="#innodb-缓冲池"><span>InnoDB-缓冲池</span></a></h2><p>缓存数据页、锁信息、自适应哈希索引等信息的内存空间。其中包含若干个16K的缓存页和对应的控制块，控制块存储页面对应的表空间编号、页号、缓冲池中的地址等等信息。 语句<code>show engine innodb status\G;</code>查看当前缓冲池状态。</p><h3 id="buffer-pool结构" tabindex="-1"><a class="header-anchor" href="#buffer-pool结构"><span>Buffer Pool结构</span></a></h3><figure><img src="/assets/BufferPool-BhqMdV9K.png" alt="BufferPool" tabindex="0" loading="lazy"><figcaption>BufferPool</figcaption></figure><ul><li>MySQL以<code>表空间号+页号</code>作为Key，缓存页作为value，构建哈希表来判断缓存是否命中</li><li>可以通过<code>innodb_buffer_pool_instances</code>控制缓冲池实例个数，所有实例均分总空间innodb_buffer_pool_size，以此提高并发处理能力</li><li>MySQL以chunk为单位申请内存，每个chunk都是一块连续的空间，大小由<code>innodb_buffer_pool_chunk_size</code>（默认128M，不含控制块空间）控制</li><li>缓冲池中所有空闲页对应的控制块组成一个<code>Free空闲链表</code></li><li>缓冲池中的页被修改后就和磁盘上的数据不一致了，称为脏页，所有脏页对应的控制块构成<code>Flush待刷新链表</code>。刷新时间有以下几种： <ul><li><code>BUF_FLUSH_LRU</code>: 从LRU链表的冷数据中刷新一部分页面到磁盘。数量由innodb_lru_scan_depth控制</li><li><code>BUF_FLUSH_LIST</code>: 从flush链表中刷新一部分页面到磁盘</li><li><code>BUF_FLUSH_SINGLE_PAGE</code>: 强制需要腾出缓存空间时必须进行的单页刷新</li></ul></li><li>其它结构还有例如：unzip LRU链表管理解压页，zip clean链表管理未解压页，zip free数组构成伙伴系统为压缩页提供内存空间</li></ul><h3 id="lru-链表" tabindex="-1"><a class="header-anchor" href="#lru-链表"><span>LRU 链表</span></a></h3><p>控制块按照<code>LRU 最近最少使用原则</code>构建链表，使用到某个缓存页时将它调整到链表头部，缓冲池存满时从链表尾淘汰页面。</p><p><strong>存在的两个问题：</strong></p><ul><li>预读： <ul><li>预先加载部分可能访问的页面到缓冲池中，分以下两类： <ul><li>线性预读：如果顺序访问了某个区的一些页面，会异步预读下一个区的全部页面。阈值由<code>innodb_read_ahead_threshold</code>（默认56）控制。</li><li>随机预读：如果已经缓存了某个区的一些连续页面，不论是否顺序读取，都会异步预读该区中的所有其它页面。阈值由<code>innodb_random_read_ahead</code>（默认13）控制。</li></ul></li><li>但如果预读的页面没用到，就会大大降低缓存命中率</li></ul></li><li>全表扫描： <ul><li>全表扫描时会大量更新LRU的节点，严重影响其它查询对Buffer Pool的使用，大大降低缓存命中率。</li></ul></li></ul><p><strong>优化方案：</strong></p><ul><li>LRU链表分为两部分： <ul><li>高频访问缓存页，称<code>热数据/Young区域</code></li><li>低频访问缓存页，称<code>冷数据/Old区域</code></li><li>划分比例由<code>innodb_old_blocks_pct</code>控制（默认37%）</li></ul></li><li>针对预读产生的问题，每次加载新页面时，对应的控制块放到Old区域的头部</li><li>针对全表扫描问题，则 <ul><li>对处在Old区域的页面进行第一次访问（新缓存）时，在控制块中记录访问时间</li><li>后续再次访问时，如果时间间隔在某个阈值内，就不移动到Young区域头部，超过阈值就移动到Young区域头部</li><li>阈值由<code>innodb_old_blocks_time</code>控制（默认1000ms）</li></ul></li><li>除此之外，还有很多其它优化手段，例如对Young区域继续划分等。最终目的都是提高Buffer Pool的缓存命中率。</li></ul><h2 id="事务⭐" tabindex="-1"><a class="header-anchor" href="#事务⭐"><span>事务⭐</span></a></h2><p>事务是一组操作的集合，事务会把所有操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。事务大致上可以分为五种状态：<strong>活动的、部分提交的、失败的、中止的、提交的</strong>。MySQL中仅InnoDB和NDB存储引擎支持事务。</p><figure><img src="/assets/%E4%BA%8B%E5%8A%A1%E7%8A%B6%E6%80%81-CgaRvgTq.png" alt="事务状态" tabindex="0" loading="lazy"><figcaption>事务状态</figcaption></figure><h3 id="事务语法" tabindex="-1"><a class="header-anchor" href="#事务语法"><span>事务语法</span></a></h3><ul><li><p><strong>控制事务方式一</strong>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查看事务提交方式</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> @@AUTOCOMMIT;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 设置事务提交方式，1为自动提交，0为手动提交，该设置只对当前会话有效</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SET</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> @@AUTOCOMMIT </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 提交事务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">COMMIT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 回滚事务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ROLLBACK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>控制事务方式二</strong>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 手动开启事务：（暂时关闭autocommit）</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">START TRANSACTION</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> [read only|read write, with consistent snapshot]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 或 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">BEGIN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- DML</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> account </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;张三&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> account </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> money</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> money</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> - </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;张三&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> account </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> money</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> money</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> + </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;李四&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 提交事务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">COMMIT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 或回滚事务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ROLLBACK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>隐式提交语句</strong>：</p><ul><li>数据定义语言DDL</li><li>隐式使用/修改系统数据库mysql库中的表</li><li>事务控制或关于锁的语句，如<code>lock tables</code>...</li><li>加载数据的语句，如<code>load data</code></li><li>关于MySQL复制的语句，如<code>start slave, stop slave...</code></li><li>其他语句，如<code>analyze, repair, reset...</code></li></ul></li><li><p><strong>保存点 savepoint</strong>:</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 定义保存点</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SAVEPOINT sp_name;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 回滚到某个保存点</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ROLLBACK</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TO</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> [SAVEPOINT]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sp_name;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 删除保存点</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">RELEASE SAVEPOINT sp_name;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="四大特性-acid" tabindex="-1"><a class="header-anchor" href="#四大特性-acid"><span>四大特性 ACID</span></a></h3><ul><li><strong>原子性 Atomicity</strong>：事务是不可分割的最小操作单元，要么全部成功，要么全部失败</li><li><strong>一致性 Consistency</strong>：事务完成时，必须使所有数据都保持一致状态</li><li><strong>隔离性 Isolation</strong>：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行</li><li><strong>持久性 Durability</strong>：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的</li></ul><p>其中，原子性、一致性、持久性这三大特性由 Redo Log 和 Undo Log 两份日志来保证。而隔离性由锁机制和MVCC保证。</p><h3 id="并发问题" tabindex="-1"><a class="header-anchor" href="#并发问题"><span>并发问题</span></a></h3><table><thead><tr><th style="text-align:left;">问题</th><th>描述</th></tr></thead><tbody><tr><td style="text-align:left;">脏写</td><td>一个事务修改了另一个未提交事务修改过的数据</td></tr><tr><td style="text-align:left;">脏读</td><td>一个事务读到了另一个事务还未提交的数据</td></tr><tr><td style="text-align:left;">不可重复读</td><td>一个事务先后读取同一条记录，期间另一个事务修改了数据，导致第一个事务两次读取的数据不同</td></tr><tr><td style="text-align:left;">幻读</td><td>一个事务按照某些条件查询，期间另一个事务插入了新的数据，导致第一个事务再次查询时发现多出一些记录</td></tr></tbody></table><p>按严重程度排序：脏写 &gt; 脏读 &gt; 不可重复读 &gt; 幻读</p><h3 id="隔离级别" tabindex="-1"><a class="header-anchor" href="#隔离级别"><span>隔离级别</span></a></h3><p>为了解决并发事务所引发的问题，数据库系统引入了事务隔离级别，主要有以下几种：</p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>Read Uncommitted</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Read Committed</td><td>×</td><td>√</td><td>√</td></tr><tr><td>Repeatable Read</td><td>×</td><td>×</td><td>√</td></tr><tr><td>Serializable</td><td>×</td><td>×</td><td>×</td></tr></tbody></table><p>√表示在当前隔离级别下该问题可能会出现。</p><ul><li>隔离级别越低，越严重的问题越可能发生</li><li>事务隔离级别越高，数据越安全，但是性能越低</li><li>脏写问题十分严重，任何隔离级别都不允许</li><li>在MySQL数据中，默认隔离级别为<code>Repeatable Read</code>，且可以禁止幻读发生</li></ul><ul><li>查看事务隔离级别：<br><code>SELECT @@TRANSACTION_ISOLATION;</code></li><li>设置事务隔离级别：<br><code>SET [SESSION|GLOBAL] TRANSACTION ISOLATION LEVEL xxx;</code><ul><li>如果指定GLOBAL，则对语句执行完后的<strong>新会话</strong>有效，当前已存在的会话无效</li><li>如果指定SESSION，则对当前会话的所有<strong>后续事务</strong>有效</li><li>如果不指定，则仅对当前会话的<strong>下一个事务</strong>有效，且执行完后恢复原级别</li></ul></li></ul><h2 id="redo-log" tabindex="-1"><a class="header-anchor" href="#redo-log"><span>Redo Log</span></a></h2><p>为了实现事务的持久性，必须在事务提交之前将所有修改的页面刷新到磁盘，这种方式存在一些问题：</p><ul><li>刷新整个页面过于浪费</li><li>随机IO速度慢</li></ul><p>因此，MySQL在事务执行过程中利用<code>Redo Log</code>重做日志，记录修改的具体信息，这样即使系统崩溃也能快速恢复数据，而且：</p><ul><li>占用空间小</li><li>顺序IO速度快</li></ul><h3 id="redo日志格式" tabindex="-1"><a class="header-anchor" href="#redo日志格式"><span>Redo日志格式</span></a></h3><p><strong>日志记录</strong></p><figure><img src="/assets/redo_log%E6%A0%BC%E5%BC%8F-Ds7rX1cd.png" alt="redo_log格式" tabindex="0" loading="lazy"><figcaption>redo_log格式</figcaption></figure><ul><li>通用格式中： <ul><li>type: redo日志类型</li><li>space ID：表空间ID</li><li>page number：页号</li><li>data：日志具体内容</li></ul></li><li>对于简单日志类型，一般直接把修改的偏移量和内容写入data区域中。如MLOG_1|2|3|4BYTE</li><li>对于复杂日志类型，修改的内容会非常多，一般data区存储修改所需的参数，然后调用相应的函数进行更改。如MLOG_COMP_REC_INSERT</li></ul><p><strong>Mini-Transaction</strong> 语句执行可能修改多个页面，且这些语句不可分割。例如对于插入语句，分乐观插入（修改少量数据）和悲观插入（页分裂，修改大量内部数据结构），这些日志记录必须保持一致，否则B+树结构将不完整。</p><figure><img src="/assets/mtr%E7%B1%BB%E5%9E%8B-DJ96OR32.png" alt="mtr类型" tabindex="0" loading="lazy"><figcaption>mtr类型</figcaption></figure><ul><li><code>MLOG_MULTI_REC_END</code>日志类型标识一个需要保证原子性的redo日志组结束</li><li>对于需要保证原子性的操作如果只产生一条redo日志，则类型type字段首位置1</li></ul><p>整体上，一个事务可以包含若干条语句，每条语句由若干Mini-Transaction(mtr)组成，每个mtr又包含若干条redo日志。</p><p><strong>Redo Log Block</strong></p><figure><img src="/assets/redo_log_block-BTvgqTD3.png" alt="redo_log_block" tabindex="0" loading="lazy"><figcaption>redo_log_block</figcaption></figure><ul><li>mtr生成的Redo日志以及一些控制信息放在512Byte的页中，称Block</li><li>Block Header部分12Byte <ul><li>LOG_BLOCK_HDR_NO: 唯一标号</li><li>LOG_BLOCK_HDR_DATA_LEN: 已使用字节数</li><li>LOG_BLOCK_FIRST_REC_GROUP: 首个mtr日志组的偏移量</li><li>LOG_BLOCK_CHECKPOINT_NO: checkpoint序号</li></ul></li><li>Block Trailer部分4Byte <ul><li>LOG_BLOCK_CHECKSUM: 正确性校验值</li></ul></li></ul><p><strong>Redo日志缓冲区</strong> 与Buffer Pool同理，内存中开辟一块连续的空间用于解决磁盘速度过慢的问题，默认16MB，划分为若干Redo Log Block，从前往后顺序写入。</p><figure><img src="/assets/redo_log_buffer-C9HWGMY0.png" alt="redo_log_buffer" tabindex="0" loading="lazy"><figcaption>redo_log_buffer</figcaption></figure><ul><li>全局变量<code>buf_free</code>记录当前空闲区域的头部</li><li>全局变量<code>buf_next_to_write</code>记录已经刷新到磁盘的位置末尾</li></ul><p><strong>日志文件组</strong> MySQL数据目录下的<code>ib_logfile/ib_redo</code>文件即redo日志，通常有多个文件构成一个日志文件组，从前往后循环覆写。文件数由innodb_log_files_in_group控制。</p><figure><img src="/assets/redo%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E7%BB%84-CKrEn5Hj.png" alt="redo日志文件组" tabindex="0" loading="lazy"><figcaption>redo日志文件组</figcaption></figure><ul><li>日志文件组中每个文件大小一样，默认48M，存储Block镜像</li><li>文件由两部分组成，前4个Block(2048Bytes)存储管理信息，后面是log buffer中的block镜像</li><li>头部的管理信息包括<code>log file header</code>和checkpoints</li></ul><figure><img src="/assets/redo_log_header-B_WPhtpS.png" alt="redo_log_header" tabindex="0" loading="lazy"><figcaption>redo_log_header</figcaption></figure><p><strong>刷盘时机</strong></p><ul><li>Log Buffer使用一半左右空间时</li><li>事务提交时</li><li>后台线程自动刷新</li><li>正常关闭服务器时</li><li>创建checkpoint时</li><li>其它情况...</li></ul><p>另外，innodb_flush_log_at_trx_commit变量控制事务提交时的redo日志行为：</p><ul><li>0：事务提交时不立即向磁盘同步redo日志，交给后台线程</li><li>1：默认值，事务提交时立即同步</li><li>2：事务提交时将redo日志写入OS缓冲区，不保证立即刷新到磁盘。这种方式除非DB和OS都挂了，否则是能够保证持久性的</li></ul><h3 id="log-sequence-number" tabindex="-1"><a class="header-anchor" href="#log-sequence-number"><span>Log Sequence Number</span></a></h3><ul><li>lsn初始值为8704，每写入一个mtr生成的redo日志就增加lsn，增量包括日志量、block header以及block trailer</li><li>每组mtr生成的redo日志都有一个唯一的LSN值与其对应，LSN值越小说明日志产生的越早</li><li><code>flushed_to_disk_lsn</code>表示已经刷新到磁盘的日志序列号，初始值和LSN一致（涉及OS的读写缓存）</li><li>另外，mtr执行过程中可能修改页面。Buffer Pool中的Flush链表中的脏页按照修改发生的时间顺序排序，即oldest_modification代表的LSN值，被多次更新的页面不会重复插入Flush链表，但会更新newest_modification属性值，即最近一次mtr对应的LSN。</li></ul><figure><img src="/assets/LSN_flush%E9%93%BE%E8%A1%A8-BbwbmLE1.png" alt="LSN_flush链表" tabindex="0" loading="lazy"><figcaption>LSN_flush链表</figcaption></figure><h3 id="checkpoint" tabindex="-1"><a class="header-anchor" href="#checkpoint"><span>Checkpoint</span></a></h3><p>redo日志文件组是有限的，不得不循环使用，可能导致日志追尾。因此，需要即时把已经刷写回磁盘的脏页对应的redo日志释放，即checkpoint。</p><figure><img src="/assets/checkpoint_lsn-CMKr-P64.png" alt="checkpoint_lsn" tabindex="0" loading="lazy"><figcaption>checkpoint_lsn</figcaption></figure><ul><li>全局变量<code>checkpoint_lsn</code>表示当前系统可以被覆盖的redo日志总量，初始值也是8704</li><li>全局变量<code>checkpoint_no</code>表示当前执行checkpoint的次数</li><li>当脏页刷新到磁盘后，可以进行增加checkpoint_lsn操作，称为做一次checkpoint。具体分为两步： <ul><li>计算当前可被覆盖的redo日志对应的最大LSN</li><li>将checkpoint_lsn、对应的redo日志组偏移量，以及此次checkpoint编号写入文件组第一个日志文件的管理信息中。编号为偶写入checkpoint1，否则写入checkpoint2</li></ul></li><li><code>show engine innodb status;</code>可以查看各个LSN值</li></ul><h3 id="崩溃恢复" tabindex="-1"><a class="header-anchor" href="#崩溃恢复"><span>崩溃恢复</span></a></h3><p><strong>恢复起点</strong> checkpoint_lsn之后的redo日志。具体的，从redo日志文件组的第一个文件的管理信息checkpoint1、checkpoint2中选择较大的checkpoint_no，即最近一次的checkpoint信息，拿到对应的checkpoint_lsn和checkpoint_offset。</p><p><strong>恢复终点</strong> Log Block Header中LOG_BLOCK_HDR_DATA_LEN记录当前块已使用的字节数，对于填满的块，该值为512，否则即为最后一个需要恢复的Block。</p><p><strong>恢复步骤</strong></p><ul><li>根据日志的space ID和page number作为key，构建有序的redo日志哈希表，以此减少随机IO，加快恢复速度</li><li>顺序扫描哈希表，逐条记录恢复</li></ul><p>对于部分已经刷新到磁盘的页面，可以从页的File Header中取FIL_PAGE_LSN值，即最近一次修改页面对应的LSN值（newest_modification），如果该值大于checkpoint_lsn说明该页已经刷新回磁盘，该页小于FIL_PAGE_LSN的redo日志就不需要恢复了。</p><h2 id="undo-log" tabindex="-1"><a class="header-anchor" href="#undo-log"><span>Undo Log</span></a></h2><h3 id="事务id" tabindex="-1"><a class="header-anchor" href="#事务id"><span>事务Id</span></a></h3><p>InnoDB中聚簇索引行记录除了用户数据外，还有几个隐藏列，其中trx_id即事务id，roll_pointer指向该行记录对应的undo日志。系统会维护一个全局变量，保证事务id按时间先后递增。</p><ul><li>对于只读事务，仅能增删改临时表。当它第一次对<strong>用户创建的</strong>临时表执行增删改时会自动分配一个事务id</li><li>对于读写事务，当它第一次对某个表执行增删改时会自动分配一个事务id</li></ul><h3 id="undo日志格式" tabindex="-1"><a class="header-anchor" href="#undo日志格式"><span>Undo日志格式</span></a></h3><p>InnoDB每次执行增删改某个记录时，都会先记下对应的Undo日志，每条日志对应一个唯一的编号undo_no，从0开始每条记录自增1。Undo日志记录在FIL_PAGE_UNDO_LOG类型的页面中，从系统表空间/Undo表空间中分配。</p><h4 id="insert-undo日志" tabindex="-1"><a class="header-anchor" href="#insert-undo日志"><span>INSERT Undo日志</span></a></h4><figure><img src="/assets/insert_undo_log-BfuPRNhy.png" alt="insert_undo_log" tabindex="0" loading="lazy"><figcaption>insert_undo_log</figcaption></figure><ul><li>类型为TRX_UNDO_INSERT_REC</li><li>主键可能包含多个列，对应的长度和值都会记录下来</li><li>增删改对聚簇索引、二级索引都需要修改，此处仅以聚簇索引为例</li></ul><h4 id="delete-undo日志" tabindex="-1"><a class="header-anchor" href="#delete-undo日志"><span>DELETE Undo日志</span></a></h4><p>页面中的记录根据<code>delete_mask</code>标志位分正常记录链表和垃圾链表，Page Header中Page Free属性指向垃圾链表的头节点。DELETE语句删除正常记录分两个阶段：</p><ul><li>阶段一 <strong>delete mark</strong>：将记录的delete_mask置1。此时记录处于中间状态</li><li>阶段二 <strong>purge</strong>：当删除事务提交后，后台线程执行真正的删除，即将该记录从正常记录链表移到垃圾链表头部，并修改相应的其它信息</li></ul><figure><img src="/assets/undo_log_delete_%E4%B8%AD%E9%97%B4%E7%8A%B6%E6%80%81-DgNQkUGy.png" alt="undo_log_delete_中间状态" tabindex="0" loading="lazy"><figcaption>undo_log_delete_中间状态</figcaption></figure><p>删除语句提交前，只会经历阶段一，所以只有delete_mask对应TRX_UNDO_DEL_REC类型Undo日志，提交后就不用回滚了，因此purge阶段不需要Undo日志。Delete Undo日志中：</p><ul><li>old_roll_pointer指向旧的roll_pointer，构成该记录的版本链</li><li>如果某列包含在某个索引中，则相关信息需要保存至<strong>索引列信息</strong>中，包括位置、长度、实际值三部分，用于purge阶段执行真正的删除</li></ul><figure><img src="/assets/undo_log_delete_mask--etH6e7O.png" alt="undo_log_delete_mask" tabindex="0" loading="lazy"><figcaption>undo_log_delete_mask</figcaption></figure><h4 id="update-undo日志" tabindex="-1"><a class="header-anchor" href="#update-undo日志"><span>UPDATE Undo日志</span></a></h4><p><strong>不更新主键的情况</strong></p><ul><li>如果更新记录时，记录的每列更新前后所占空间一样，就可以<strong>原地更新</strong></li><li>如果任何一列更新前后大小不一致，则先删除旧记录，再插入新记录。 <ul><li>这里的删除是完整的删除，由用户线程同步执行</li><li>如果新记录空间不超过旧空间，可以重用旧记录的空间</li></ul></li></ul><p>两种情况都对应TRX_UNDO_UPD_EXIST_REC类型的Undo日志:</p><figure><img src="/assets/undo_log_update1-BmtQRMAl.png" alt="undo_log_update1" tabindex="0" loading="lazy"><figcaption>undo_log_update1</figcaption></figure><p><strong>更新主键的情况</strong> InnoDB在聚簇索引中分两步处理，会产生TRX_UNDO_DEL_MARK_REC、TRX_UNDO_INSERT_REC两条Undo日志</p><ul><li>将旧记录进行delete_mark <ul><li>事务提交后再交由专门线程执行purge</li><li>原因在于实现MVCC</li></ul></li><li>根据更新后各列的值创建一条新记录，重新定位并插入聚簇索引</li></ul><h3 id="日志存储" tabindex="-1"><a class="header-anchor" href="#日志存储"><span>日志存储</span></a></h3><p><strong>Undo 页面</strong> Undo日志专门存放于FIL_PAGE_UNDO_LOG类型的页面中，除了通用的页面头和页面尾，Undo页面特有Undo Page Header:</p><figure><img src="/assets/undo_page_header-BV8BBdIt.png" alt="undo_page_header" tabindex="0" loading="lazy"><figcaption>undo_page_header</figcaption></figure><ul><li>TRX_UNDO_PAGE_TYPE: 本页面存储的Undo日志类型，为服务MVVC分两大类，不可混存 <ul><li>TRX_UNDO_INSERT: 涉及插入的Undo日志，例如TRX_UNDO_INSERT_REC</li><li>TRX_UNDO_UPDATE: 涉及删除、修改的Undo日志</li></ul></li><li>TRX_UNDO_PAGE_START: 第一天Undo日志起始位置</li><li>TRX_UNDO_PAGE_FREE: 新的Undo日志存储（空闲区域）位置</li><li>TRX_UNDO_PAGE_NODE: 链表普通结点</li></ul><p><strong>Undo 页面链表</strong></p><figure><img src="/assets/Undo%E9%A1%B5%E9%9D%A2%E9%93%BE%E8%A1%A8-CmTZsUE8.png" alt="Undo页面链表" tabindex="0" loading="lazy"><figcaption>Undo页面链表</figcaption></figure><ul><li>不同事务对应不同的页面链表</li><li>每个事务对普通表、临时表分别使用不同的链表</li><li>对不同表又按存储的日志类型分insert undo链表、update undo链表</li><li>链表中第一个页面称为first_undo_page，记录段相关信息。其它称normal_undo_page</li><li>一个事务最多对应4条Undo页面链表，每个链表都是按需分配，实际用到时才会创建</li></ul><p><strong>Undo 日志段头部</strong></p><figure><img src="/assets/undo_log_segment_header-CpXpy0jK.png" alt="undo_log_segment_header" tabindex="0" loading="lazy"><figcaption>undo_log_segment_header</figcaption></figure><ul><li>每个Undo页面链表对应一个段，称Undo Log Segment</li><li>first_undo_page中存有Undo Log Segment Header，包含对应段的信息 <ul><li>TRX_UNDO_STATE: 本Undo页面链表所处状态 <ul><li>TRX_UNDO_ACTIVE: 活跃状态，一个活跃的事务正往此段内写入Undo日志</li><li>TRX_UNDO_CACHED: 被缓存状态，等待被其它事务重用</li><li>TRX_UNDO_TO_FREE: 事务提交后不能被重用的insert undo链表</li><li>TRX_UNDO_TO_PURGE: 事务提交后不能被重用的update undo链表</li><li>TRX_UNDO_PREPARED: 包含处于PREPARE阶段的事务产生的undo日志</li></ul></li><li>TRX_UNDO_LAST_LOG:本Undo页面链表最后一个Undo Log Header位置</li><li>TRX_UNDO_FSEG_HEADER: 本Undo页面链表对应段头信息(找到段对应INODE Entry)</li><li>TRX_UNDO_PAGE_LIST: Undo页面链表的基结点</li></ul></li></ul><p><strong>Undo 日志头</strong></p><figure><img src="/assets/undo_log_header-BaEjHU4p.png" alt="undo_log_header" tabindex="0" loading="lazy"><figcaption>undo_log_header</figcaption></figure><ul><li>同一个事务向一个Undo页面链表写入的Undo日志记为一个组</li><li>每写入一组Undo日志都会在这组日志前先记录关于这个组的属性，即Undo Log Header <ul><li>TRX_UNDO_TRX_ID: 生成本组日志的事务id</li><li>TRX_UNDO_TRX_NO:标记事务的提交顺序</li><li>TRX_UNDO_DEL_MARKS: 标记本组是否含delete mark产生的日志</li><li>TRX_UNDO_LOG_START: 本组第一条日志在页面中的偏移量</li><li>TRX_UNDO_XID_EXISTS: 本组是否含XID信息</li><li>TRX_UNDO_DICT_TRANS: 标记本组日志是否由DDL语句产生</li><li>TRX_UNDO_TABLE_ID: 如果DICT_TRANS为真，表示DDL操作的表Id</li><li>TRX_UNDO_NEXT_LOG: 下一组日志在页面中开始的偏移量</li><li>TRX_UNDO_PREV_LOG: 上一组日志在页面中开始的偏移量</li></ul></li></ul><p>因此，整体上，Undo页面链表的first undo page会填充Undo Page Header, Undo Log Segment Header, Undo Log Header三部分，而普通页面仅填充Undo Page Header。</p><figure><img src="/assets/undo%E9%A1%B5%E9%9D%A2%E9%93%BE%E8%A1%A8%E6%80%BB%E7%BB%93-CKttjxvh.png" alt="undo页面链表总结" tabindex="0" loading="lazy"><figcaption>undo页面链表总结</figcaption></figure><h3 id="页面重用" tabindex="-1"><a class="header-anchor" href="#页面重用"><span>页面重用</span></a></h3><p>大部分事务仅修改若干条记录，产生少量的Undo日志，但需要创建完整的Undo页面链表，造成空间浪费。为此，MySQL在事务提交后可以判断是否重用该事务的Undo页面链表。</p><p><strong>是否重用的条件</strong></p><ul><li>该链表仅包含一个Undo页面</li><li>该Undo页面已经使用的空间小于整个页面空间的3/4</li></ul><p><strong>处理逻辑</strong></p><ul><li><p>对于insert undo链表，仅存储TRX_UNDO_INSERT_REC的undo日志，提交后就可以被删除，因此新事务的日志可以直接覆盖原有的空间 <img src="/assets/%E9%87%8D%E7%94%A8insert_undo-C3i2QquJ.png" alt="重用insert_undo" loading="lazy"></p></li><li><p>对于update undo链表，为了MVVC，事务提交后不能立即删除，因此重用会直接在空闲区域写入日志，即同一个Undo页面中写入了多组日志 <img src="/assets/%E9%87%8D%E7%94%A8update_undo-D4vPd4E4.png" alt="重用update_undo" loading="lazy"></p></li></ul><h3 id="回滚段" tabindex="-1"><a class="header-anchor" href="#回滚段"><span>回滚段</span></a></h3><p>为了更好的管理Undo页面链表，MySQL设计了Rollback Segment Header类型的页面，存放各个Undo页面链表的first undo page页号（称为undo slot）。</p><figure><img src="/assets/rollback_segment_header-DUhWP4kb.png" alt="rollback_segment_header" tabindex="0" loading="lazy"><figcaption>rollback_segment_header</figcaption></figure><ul><li>每个Rollback Segment Header对应一个Rollback Segment，其中仅含一个页面</li><li>TRX_RSEG_MAX_SIZE: 本回滚段管理的所有Undo页面链表中页面数量之和的上限</li><li>TRX_RSEG_HISTORY_SIZE: History链表占用的页面数量</li><li>TRX_RSEG_HISTORY: History链表的基结点</li><li>TRX_RSEG_FSEG_HEADER: 本回滚段对应的10Byte 段头部信息，对应此段的INODE Entry</li><li>TRX_RSEG_UNDO_SLOTS: 各个Undo页面链表的first undo page页号集合，即undo slot集合，共1024个</li></ul><p><strong>策略</strong></p><ul><li>如果某个undo slot指向的链表可重用，则处于被缓存状态，并根据类型加入insert/update undo cached两个缓存链表</li><li>分配重用Undo链表时，先从对应的缓存链表中找，没有空闲的再到回滚段头页面中找</li><li>为了提高事务并发效率，MySQL定义了128个回滚段，对应128个回滚段头，段头地址存放在系统表空间第5号页面中。其中 <ul><li>第0号、第33~127号属于一类，用于对普通表的分配</li><li>第1~32号属于一类，用于对临时表的分配</li><li>区别处理的原因在于修改普通表回滚段中的Undo页面需要记录对应的Redo日志，而临时表不需要</li><li>段的数量由innodb_rollback_segments控制</li></ul></li></ul><figure><img src="/assets/%E5%A4%9A%E4%B8%AA%E5%9B%9E%E6%BB%9A%E6%AE%B5-BRtHCGm5.png" alt="多个回滚段" tabindex="0" loading="lazy"><figcaption>多个回滚段</figcaption></figure><h2 id="mvvc" tabindex="-1"><a class="header-anchor" href="#mvvc"><span>MVVC</span></a></h2><p>MVCC 全称 Multi-Version Concurrency Control 多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突。MVCC的具体实现依赖于<strong>记录中的隐式字段、Undo Log、ReadView</strong>三部分。</p><h3 id="版本链" tabindex="-1"><a class="header-anchor" href="#版本链"><span>版本链</span></a></h3><p>前面提到过，对记录的删改操作对应的Undo日志里有old roll pointer字段指向旧的Undo日志，从而构成一个记录的版本链。链表的头部就是当前记录的最新值。</p><figure><img src="/assets/undo_log_%E7%89%88%E6%9C%AC%E9%93%BE-PkWkGTjZ.png" alt="undo_log_版本链" tabindex="0" loading="lazy"><figcaption>undo_log_版本链</figcaption></figure><h3 id="readview" tabindex="-1"><a class="header-anchor" href="#readview"><span>ReadView</span></a></h3><ul><li><p>对于READ_UNCOMMITTED隔离级别，不禁止不可重复读，读取记录时直接查看最新版本</p></li><li><p>对于Serializable隔离级别，MySQL使用锁机制避免不可重复读问题</p></li><li><p>而对于READ_COMMITTED和REPEATABLE_READ，需要判断版本链中哪个版本是当前事务可见的，为此提出了ReadView。ReadView含四个部分，其中：</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>m_ids</td><td>生成ReadView时系统中活跃的读写事务的id列表</td></tr><tr><td>min_trx_id</td><td>生成ReadView时系统中活跃的读写事务最小id</td></tr><tr><td>max_trx_id</td><td>生成ReadView时系统应分配给下一个事务的id值（最大活跃事务id+1）</td></tr><tr><td>creator_trx_id</td><td>生成该ReadView的事务id（仅实际增删改时才分配，只读事务id默认0）</td></tr></tbody></table></li></ul><p><strong>访问规则</strong> 有了ReadView后，查询过程会顺着版本链遍历，根据ReadView的访问规则，直到找到一条可访问的版本，或不含该记录。其中，trx_id为被访问版本的trx_id属性值：</p><table><thead><tr><th>条件</th><th>是否可以访问</th><th>说明</th></tr></thead><tbody><tr><td>trx_id == creator_trx_id</td><td>可以访问该版本</td><td>成立，说明数据是当前事务自己更改的</td></tr><tr><td>trx_id &lt; min_trx_id</td><td>可以访问该版本</td><td>成立，说明该版本在当前事务生成ReadView前已经提交</td></tr><tr><td>trx_id &gt; max_trx_id</td><td>不可以访问该版本</td><td>成立，说明该版本在当前事务生成ReadView后才开启</td></tr><tr><td>min_trx_id &lt;= trx_id &lt;= max_trx_id</td><td>如果trx_id在m_ids中，不可以访问；否则可以访问</td><td>m_ids存在trx_id则说明该事务还是活跃的，不存在则说明该事务已提交</td></tr></tbody></table><p><strong>生成时机</strong> 对于READ_COMMITTED和REPEATABLE_READ，最大的区别在于它们生成ReadView的时机不同。也正因此，READ_COMMITTED无法禁止不可重复读问题。</p><ul><li>READ_COMMITTED事务每次SELECT查询前都会生成独立的ReadView</li><li>REPEATABLE_READ事务只在第一次SELECT查询前生成一个共享的ReadView</li></ul><p>另外，为了支持MVCC，insert undo日志在事务提交后即可释放，而update undo日志不能立即删除；删除时需要分两阶段，第一阶段仅做delete mark。</p><h2 id="锁机制⭐" tabindex="-1"><a class="header-anchor" href="#锁机制⭐"><span>锁机制⭐</span></a></h2><p>See: <a class="route-link" href="/coding/MySQL-Lock.html">MySQL 锁机制</a></p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">Powered by <a href="https://theme-hope.vuejs.press/zh/">VuePress Theme Hope</a></div><div class="vp-copyright">独立思考，明辨是非，尊重他人命运</div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CHBNztBQ.js" defer></script>
  </body>
</html>
